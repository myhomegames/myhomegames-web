import{r as a,j as g,c as V,u as z}from"./react-vendor-jNdKP8wU.js";import{u as D,b as O,a as q,c as W,E as B,d as Z,C as J,e as K,f as X,g as Q,h as Y}from"./page-CollectionDetail.tsx-DYxPNzRb.js";import{g as _,A as H}from"./page-AddGamePage.tsx-CGFUTWrs.js";import{u as F}from"./i18n-vendor-mPXi0JFR.js";const U=a.createContext(void 0);function he({children:s}){const[u,i]=a.useState([]),[b,y]=a.useState(!1),[C,v]=a.useState(null),{isLoading:L,token:x}=D(),T=a.useCallback(async()=>{if(!(L||!(_()||x))){y(!0),v(null);try{const l=O(H,"/libraries/library/games",{sort:"title"}),t=await fetch(l,{headers:q({Accept:"application/json"})});if(!t.ok)throw new Error(`HTTP ${t.status}`);const f=((await t.json()).games||[]).map(e=>({id:String(e.id),title:e.title,summary:e.summary,cover:e.cover,background:e.background,day:e.day,month:e.month,year:e.year,stars:e.stars,genre:e.genre,criticratings:e.criticratings,userratings:e.userratings,executables:e.executables||null,themes:e.themes||null,platforms:e.platforms||null,gameModes:e.gameModes||null,playerPerspectives:e.playerPerspectives||null,websites:e.websites||null,ageRatings:e.ageRatings||null,developers:e.developers||null,publishers:e.publishers||null,franchise:e.franchise||null,collection:e.collection||null,screenshots:e.screenshots||null,videos:e.videos||null,gameEngines:e.gameEngines||null,keywords:e.keywords||null,alternativeNames:e.alternativeNames||null,similarGames:e.similarGames||null}));i(f)}catch(l){const t=String(l.message||l);console.error("Error fetching library games:",t),v(t)}finally{y(!1)}}},[L,x]);a.useEffect(()=>{L||T()},[L,T]),a.useEffect(()=>{const r=n=>{const e=n.detail?.game;e&&i(j=>j.map(k=>String(k.id)===String(e.id)?e:k))},l=n=>{const e=n.detail?.gameId;e&&i(j=>j.filter(k=>String(k.id)!==String(e)))},t=n=>{const e=n.detail?.game;e&&i(j=>j.some(k=>String(k.id)===String(e.id))?j.map(k=>String(k.id)===String(e.id)?e:k):[...j,e].sort((k,c)=>(k.title||"").localeCompare(c.title||"")))},h=()=>{T()};return window.addEventListener("gameUpdated",r),window.addEventListener("gameDeleted",l),window.addEventListener("gameAdded",t),window.addEventListener("metadataReloaded",h),()=>{window.removeEventListener("gameUpdated",r),window.removeEventListener("gameDeleted",l),window.removeEventListener("gameAdded",t),window.removeEventListener("metadataReloaded",h)}},[T]);const E=a.useCallback(async()=>{await T()},[T]),d=a.useCallback(r=>{i(l=>l.some(t=>String(t.id)===String(r.id))?l.map(t=>String(t.id)===String(r.id)?r:t):[...l,r].sort((t,h)=>(t.title||"").localeCompare(h.title||"")))},[]),G=a.useCallback(r=>{i(l=>l.map(t=>String(t.id)===String(r.id)?r:t))},[]),m=a.useCallback(r=>{i(l=>l.filter(t=>String(t.id)!==String(r)))},[]),o=a.useMemo(()=>({games:u,isLoading:b,error:C,refreshGames:E,addGame:d,updateGame:G,removeGame:m}),[u,b,C,E,d,G,m]);return g.jsx(U.Provider,{value:o,children:s})}function ee(){const s=a.useContext(U);if(s===void 0)throw new Error("useLibraryGames must be used within a LibraryGamesProvider");return s}function te(s,u=!0){const{collectionGameIds:i,isLoading:b,getCollectionGameIds:y}=W(),{games:C,isLoading:v}=ee(),[L,x]=a.useState(!1);return a.useEffect(()=>{!u||!s||b||v||i.get(String(s))||(x(!0),y(s).then(()=>{x(!1)}).catch(()=>{x(!1)}))},[s,u,b,v]),a.useMemo(()=>{if(!u||!s)return{hasPlayableGame:null,isLoading:!1};if(b||v||L)return{hasPlayableGame:null,isLoading:!0};const E=i.get(String(s));return!E||E.length===0?{hasPlayableGame:!1,isLoading:!1}:{hasPlayableGame:E.some(G=>{const m=C.find(o=>String(o.id)===String(G));return m&&m.executables&&m.executables.length>0}),isLoading:!1}},[s,u,i,C,b,v,L])}function se({games:s,scrollContainerRef:u,itemRefs:i,ascending:b=!0,virtualizedGridRef:y,virtualizedListRef:C,viewMode:v,coverSize:L}){const[x,T]=a.useState(!1);a.useEffect(()=>{const o=()=>{const n=u.current;if(!n){T(!1);return}requestAnimationFrame(()=>{if(!n){T(!1);return}const f=n,e=f.__virtualizedGridRef?.current,j=f.__virtualizedListRef?.current;if(y?.current||C?.current||e||j){T(s.length>10);return}const c=n.scrollHeight>n.clientHeight;T(c)})};o();const r=setTimeout(o,100),l=setTimeout(o,300),t=setTimeout(o,500),h=setTimeout(o,1e3);if(window.addEventListener("resize",o),u.current){const n=new ResizeObserver(()=>{setTimeout(o,50)});n.observe(u.current);const f=new MutationObserver(()=>{setTimeout(o,50)});return f.observe(u.current,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),()=>{clearTimeout(r),clearTimeout(l),clearTimeout(t),clearTimeout(h),window.removeEventListener("resize",o),n.disconnect(),f.disconnect()}}return()=>{clearTimeout(r),clearTimeout(l),clearTimeout(t),clearTimeout(h),window.removeEventListener("resize",o)}},[s,u,y,C]);const E=b?["#",..."ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("")]:[..."ZYXWVUTSRQPONMLKJIHGFEDCBA".split(""),"#"],d=o=>{const r=o.trim().charAt(0).toUpperCase();if(/[A-Z]/.test(r))return r;if(/[0-9]/.test(r))return"#";{const l=o.match(/[A-Z]/i);return l?l[0].toUpperCase():"#"}},G=o=>s.some(r=>d(r.title)===o),m=o=>{const r=u.current;if(!r)return;const l=s.findIndex(p=>d(p.title)===o);if(l===-1)return;const t=s[l],h=r,n=h.__virtualizedGridRef?.current,f=h.__virtualizedListRef?.current,e=y?.current||n,j=C?.current||f;if(e&&v==="grid"){const p=e;if(p&&typeof p.scrollToCell=="function"){const S=r.clientWidth,M=(L||150)+40,w=Math.max(1,Math.floor((S+40)/M)),A=Math.floor(l/w),I=l%w;p.scrollToCell({rowIndex:A,columnIndex:I,align:"start",behavior:"smooth"});return}}if(j&&v==="detail"){const p=j;if(p&&typeof p.scrollToRow=="function"){p.scrollToRow({index:l,align:"start",behavior:"smooth"});return}}if(i?.current){const p=i.current.get(t.id);if(p){const S=r.getBoundingClientRect(),M=p.getBoundingClientRect(),w=r.querySelector("thead"),A=w?w.offsetHeight:0,I=A>0?A+4:20,P=r.scrollTop+M.top-S.top-I;r.scrollTo({top:P,behavior:"smooth"});return}}const k=Math.floor(r.clientWidth/200),R=Math.floor(l/k)*200;r.scrollTo({top:R,behavior:"smooth"})};return!x||s.length===0?null:g.jsx("div",{className:"home-page-alphabet-container",children:g.jsx("div",{className:"alphabet-navigator",children:E.map(o=>{const r=G(o);return g.jsx("button",{onClick:()=>m(o),disabled:!r,className:"alphabet-button",children:o},o)})})})}function re(s){try{const u=sessionStorage.getItem(s);if(!u)return null;const i=JSON.parse(u);return{scrollTop:i.scrollTop||0,scrollLeft:i.scrollLeft||0}}catch{return null}}function ne(s,u,i){try{sessionStorage.setItem(s,JSON.stringify({scrollTop:u,scrollLeft:i}))}catch{}}const N=40,ie=2;function oe({collections:s,coverSize:u,containerRef:i,itemRefs:b,onCollectionClick:y,onPlay:C,onEditClick:v,onCollectionDelete:L,onCollectionUpdate:x,buildCoverUrl:T}){const E=V(),[d,G]=a.useState({width:0,height:0}),[m,o]=a.useState(!1),r=a.useRef(null),l=a.useRef(!1),t=a.useRef(null),h=`${E.pathname}:collections`,n=a.useMemo(()=>{if(d.width===0)return 1;const c=u+N;return Math.max(1,Math.floor((d.width+N)/c))},[d.width,u]),f=a.useMemo(()=>Math.ceil(s.length/n),[s.length,n]),e=u,j=u*1.5+N;a.useEffect(()=>{const c=()=>{if(i.current){const p=i.current.getBoundingClientRect();G({width:p.width-40,height:p.height||window.innerHeight-200})}};c(),window.addEventListener("resize",c);const R=new ResizeObserver(c);return i.current&&R.observe(i.current),()=>{window.removeEventListener("resize",c),R.disconnect()}},[i]),a.useEffect(()=>{const c=re(h);if(!c||c.scrollTop===0&&c.scrollLeft===0){o(!0);return}if(d.height===0||f===0||n===0)return;l.current=!0,o(!1);const R=(S=0)=>{const M=r.current;if(!M){S<50?setTimeout(()=>R(S+1),50):l.current=!1;return}let w=null;if(M.element)w=M.element;else if(i.current){const A=i.current.querySelector('[style*="overflow"]');A&&(A.scrollHeight>A.clientHeight||A.scrollWidth>A.clientWidth)&&(w=A)}if(!w){S<50?setTimeout(()=>R(S+1),50):(l.current=!1,o(!0));return}try{w.scrollTop=c.scrollTop,w.scrollLeft=c.scrollLeft,setTimeout(()=>{const A=w.scrollTop,I=w.scrollLeft;(Math.abs(A-c.scrollTop)>10||Math.abs(I-c.scrollLeft)>10)&&S<5&&(w.scrollTop=c.scrollTop,w.scrollLeft=c.scrollLeft),setTimeout(()=>{l.current=!1,o(!0)},50)},50)}catch{S<10?setTimeout(()=>R(S+1),100):(l.current=!1,o(!0))}},p=setTimeout(()=>{R()},300);return()=>{clearTimeout(p),l.current=!1}},[E.pathname,h,d.height,f,n]),a.useEffect(()=>{let c=null,R=null;const p=(S=0)=>{const M=r.current;if(!M){S<20&&setTimeout(()=>p(S+1),100);return}let w=null;if(M.element)w=M.element;else if(i.current){const I=i.current.querySelector('[style*="overflow"]');I&&(I.scrollHeight>I.clientHeight||I.scrollWidth>I.clientWidth)&&(w=I)}if(!w){S<20&&setTimeout(()=>p(S+1),100);return}const A=()=>{l.current||(c&&clearTimeout(c),c=setTimeout(()=>{const I=w.scrollTop,P=w.scrollLeft;(!t.current||t.current.scrollTop!==I||t.current.scrollLeft!==P)&&(ne(h,I,P),t.current={scrollTop:I,scrollLeft:P})},150))};w.addEventListener("scroll",A,{passive:!0}),R=()=>{c&&clearTimeout(c),w.removeEventListener("scroll",A)}};return p(),()=>{R&&R()}},[r.current,h,j,e,f,n]),a.useEffect(()=>{i&&"current"in i&&i.current&&(i.current.__virtualizedGridRef=r)},[i]);const k=({columnIndex:c,rowIndex:R,style:p})=>{const S=R*n+c;if(S>=s.length)return g.jsx("div",{style:p});const M=s[S];return g.jsx("div",{style:{...p,paddingLeft:c===0?0:N/2,paddingRight:c===n-1?0:N/2,paddingTop:R===0?0:N/2,paddingBottom:R===f-1?0:N/2},children:g.jsx($,{collection:M,onCollectionClick:y,onPlay:C,onEditClick:v,onCollectionDelete:L,onCollectionUpdate:x,buildCoverUrl:T,coverSize:u,itemRefs:b})})};return d.width===0||d.height===0?g.jsx("div",{style:{width:"100%",height:"100%"}}):g.jsx("div",{style:{opacity:m?1:0,transition:m?"opacity 0.1s":"none"},children:g.jsx(B,{gridRef:r,className:"virtualized-collections-grid",columnCount:n,columnWidth:e+N,defaultHeight:d.height,defaultWidth:d.width,rowCount:f,rowHeight:j,overscanCount:ie,cellComponent:k,cellProps:{},style:{height:d.height,width:d.width},onResize:c=>{G({width:c.width,height:c.height})}})})}const le=100;function $({collection:s,onCollectionClick:u,onPlay:i,onEditClick:b,onCollectionDelete:y,onCollectionUpdate:C,buildCoverUrl:v,coverSize:L,itemRefs:x}){const{t:T}=F(),E=L*1.5,{hasPlayableGame:d}=te(s.id,!0),G=async()=>{if(i)try{const m=O(H,`/collections/${s.id}/games`),o=await fetch(m,{headers:{Accept:"application/json","X-Auth-Token":_()}});if(o.ok){const t=((await o.json()).games||[]).find(h=>h.executables&&h.executables.length>0);if(t){const h={id:t.id,title:t.title,summary:t.summary||"",cover:t.cover,day:t.day||null,month:t.month||null,year:t.year||null,stars:t.stars||null,genre:t.genre||null,executables:t.executables||null};i(h)}}}catch(m){console.error("Error fetching collection games for play:",m)}};return g.jsx("div",{ref:m=>{m&&x?.current&&x.current.set(String(s.id),m)},className:"group cursor-pointer collections-list-item",style:{width:`${L}px`,minWidth:`${L}px`},children:g.jsx(J,{title:s.title,coverUrl:v(H,s.cover,!0),width:L,height:E,onPlay:i?G:void 0,onClick:()=>u(s),onEdit:()=>b(s),collectionId:s.id,collectionTitle:s.title,onCollectionDelete:y?m=>{s.id===m&&y(s)}:void 0,onCollectionUpdate:C?m=>{const o={id:m.id,title:m.title,summary:m.summary,cover:m.cover,gameCount:s.gameCount};o.id===s.id&&C(o)}:void 0,showTitle:!0,subtitle:s.gameCount!==void 0?`${s.gameCount} ${T("common.elements")}`:void 0,detail:!0,play:d===!0,showBorder:!0},`${s.id}-${s.cover}`)})}function ae({collections:s,onCollectionClick:u,onPlay:i,onCollectionUpdate:b,onCollectionDelete:y,buildCoverUrl:C,coverSize:v=150,itemRefs:L,scrollContainerRef:x}){const{t:T}=F(),[E,d]=a.useState(!1),[G,m]=a.useState(null);if(s.length===0)return g.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",minHeight:"400px"},children:g.jsx("div",{className:"text-gray-400 text-center",children:T("collections.noCollectionsFound")})});const o=n=>{const f={id:n.id,title:n.title,summary:n.summary,cover:n.cover,background:n.background};m(f),d(!0)},r=()=>{d(!1),m(null)},l=n=>{if(b){const f={id:n.id,title:n.title,summary:n.summary,cover:n.cover,background:n.background};b(f)}r()},t=s.length>le,h=a.useRef(null);return g.jsxs(g.Fragment,{children:[g.jsx("div",{ref:h,className:"collections-list-container",style:{gridTemplateColumns:t?void 0:`repeat(auto-fill, ${v}px)`,height:t?"100%":void 0},children:t?g.jsx(oe,{collections:s,coverSize:v,containerRef:x||h,itemRefs:L,onCollectionClick:u,onPlay:i,onEditClick:o,onCollectionDelete:y,onCollectionUpdate:b,buildCoverUrl:C}):s.map(n=>g.jsx($,{collection:n,onCollectionClick:u,onPlay:i,onEditClick:o,onCollectionDelete:y,onCollectionUpdate:b,buildCoverUrl:C,coverSize:v,itemRefs:L},String(n.id)))}),G&&g.jsx(Z,{isOpen:E,onClose:r,collection:G,onCollectionUpdate:l})]})}function fe({onPlay:s,coverSize:u}){const{setLoading:i}=K(),{collections:b,isLoading:y,updateCollection:C,removeCollection:v}=W(),L=z(),[x,T]=a.useState(!1),[E]=a.useState(!0),d=a.useRef(null),G=a.useRef(new Map);a.useEffect(()=>{i(y||!x)},[y,x,i]),X(d);function m(t){L(`/collections/${t.id}`)}const o=t=>{C(t)},r=t=>{v(t.id)},l=a.useMemo(()=>{const h=[...b.filter((n,f,e)=>f===e.findIndex(j=>String(j.id)===String(n.id)))];return h.sort((n,f)=>{const e=Q(n.title||"",f.title||"");return E?e:-e}),h},[b,E]);return a.useLayoutEffect(()=>{y?y&&T(!1):requestAnimationFrame(()=>{requestAnimationFrame(()=>{T(!0)})})},[y,l.length]),g.jsx("main",{className:"flex-1 home-page-content",children:g.jsxs("div",{className:"home-page-layout",children:[g.jsx("div",{className:"home-page-content-wrapper",style:{opacity:x?1:0,transition:"opacity 0.2s ease-in-out"},children:g.jsx("div",{ref:d,className:"home-page-scroll-container",children:!y&&g.jsx(ae,{collections:l,onCollectionClick:m,onPlay:s,onCollectionUpdate:o,onCollectionDelete:r,buildCoverUrl:Y,coverSize:u,itemRefs:G,scrollContainerRef:d})})}),x&&g.jsx(se,{games:l,scrollContainerRef:d,itemRefs:G,ascending:E,virtualizedGridRef:d.current?d.current.__virtualizedGridRef:void 0,viewMode:"grid",coverSize:u})]})})}export{se as A,fe as C,he as L,te as a,ee as u};
