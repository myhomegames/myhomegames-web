import{r,j as h,u as P}from"./react-vendor-COHXxlBx.js";import{b as T,C as N,u as R,c as U,d as M}from"./page-CategoriesPage.tsx-5ovgj7yS.js";import{A as x,g as I,u as A}from"./page-AddGamePage.tsx-kNlLaymQ.js";import{E as O}from"./page-CollectionDetail.tsx-DcL8wk48.js";import{u as b}from"./i18n-vendor-ClaDN9Oc.js";import{c as G,A as X}from"./page-CategoryPage.tsx-CK7WlBuw.js";function D(e,v=!0){const[l,i]=r.useState(null),[u,w]=r.useState(!1);return r.useEffect(()=>{if(!v||!e){i(null),w(!1);return}w(!0),(async()=>{try{const d=T(x,`/collections/${e}/games`),g=await fetch(d,{headers:{Accept:"application/json","X-Auth-Token":I()}});if(g.ok){const p=((await g.json()).games||[]).some(a=>!!a.command);i(p)}else i(!1)}catch{i(!1)}finally{w(!1)}})()},[e,v]),{hasPlayableGame:l,isLoading:u}}const L=r.createContext(void 0),_="";function Z({children:e}){const[v,l]=r.useState(null),[i,u]=r.useState(null),[w,f]=r.useState(!0),d=async()=>{f(!0);try{const a=new URLSearchParams(window.location.search),t=a.get("twitch_token"),s=a.get("user_id");if(t&&s){localStorage.setItem("twitch_token",t),localStorage.setItem("twitch_user_id",s),window.history.replaceState({},document.title,window.location.pathname),await g(t),A();return}const m=localStorage.getItem("twitch_token");if(m){await g(m),A();return}l(null),u(null)}catch(a){console.error("Auth check error:",a),l(null),u(null)}finally{f(!1)}},g=async a=>{const t=localStorage.getItem("twitch_client_id");try{const s={"X-Auth-Token":a};t&&(s["X-Twitch-Client-Id"]=t);const m=await fetch(`${x}/auth/me`,{headers:s});if(m.ok){const o=await m.json();l(o),u(a)}else localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),l(null),u(null)}catch(s){console.error("Failed to fetch user info:",s),l(null),u(null)}},C=async()=>{const a=localStorage.getItem("twitch_client_id"),t=localStorage.getItem("twitch_client_secret");if(!a||!t){alert(`Credenziali Twitch non trovate. Assicurati di averle configurate in localStorage:
- twitch_client_id
- twitch_client_secret`);return}try{const s=await fetch(`${x}/auth/twitch`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:a,clientSecret:t})});if(s.ok){const m=await s.json();window.location.href=m.authUrl}else{const m=await s.text().catch(()=>"Unknown error");let o;try{o=JSON.parse(m)}catch{o={error:m}}alert(`Errore durante il login: ${o.error||s.statusText}`)}}catch(s){console.error("Login error:",s),s instanceof Error&&alert(`Errore durante il login: ${s.message}`)}},y=()=>{localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),l(null),u(null),A(),i&&fetch(`${x}/auth/logout`,{method:"POST",headers:{"X-Auth-Token":i}}).catch(console.error)};r.useEffect(()=>{d()},[]);const p={user:v,token:i,isLoading:w,login:C,logout:y,checkAuth:d};return h.jsx(L.Provider,{value:p,children:e})}function F(){const e=r.useContext(L);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e}function H({collection:e,onCollectionClick:v,onPlay:l,onEditClick:i,onCollectionDelete:u,onCollectionUpdate:w,buildCoverUrl:f,coverSize:d,itemRefs:g}){const{t:C}=b(),y=d*1.5,{hasPlayableGame:p}=D(e.id,!0),a=async()=>{if(l)try{const t=T(x,`/collections/${e.id}/games`),s=await fetch(t,{headers:{Accept:"application/json","X-Auth-Token":I()}});if(s.ok){const c=((await s.json()).games||[]).find(n=>!!n.command);if(c){const n={id:c.id,title:c.title,summary:c.summary||"",cover:c.cover,day:c.day||null,month:c.month||null,year:c.year||null,stars:c.stars||null,genre:c.genre||null,command:c.command||null};l(n)}}}catch(t){console.error("Error fetching collection games for play:",t)}};return h.jsx("div",{ref:t=>{t&&g?.current&&g.current.set(e.id,t)},className:"group cursor-pointer collections-list-item",style:{width:`${d}px`,minWidth:`${d}px`},children:h.jsx(N,{title:e.title,coverUrl:f(x,e.cover,!0),width:d,height:y,onPlay:l?a:void 0,onClick:()=>v(e),onEdit:()=>i(e),collectionId:e.id,collectionTitle:e.title,onCollectionDelete:u?t=>{e.id===t&&u(e)}:void 0,onCollectionUpdate:w?t=>{const s={id:t.id,title:t.title,summary:t.summary,cover:t.cover,gameCount:e.gameCount};s.id===e.id&&w(s)}:void 0,showTitle:!0,subtitle:e.gameCount!==void 0?`${e.gameCount} ${C("common.elements")}`:void 0,detail:!0,play:p===!0,showBorder:!0},`${e.id}-${e.cover}`)},e.id)}function q({collections:e,onCollectionClick:v,onPlay:l,onCollectionUpdate:i,onCollectionDelete:u,buildCoverUrl:w,coverSize:f=150,itemRefs:d}){const{t:g}=b(),[C,y]=r.useState(!1),[p,a]=r.useState(null);if(e.length===0)return h.jsx("div",{className:"text-gray-400 text-center",children:g("table.noGames")});const t=o=>{const c={id:o.id,title:o.title,summary:o.summary,cover:o.cover,background:o.background};a(c),y(!0)},s=()=>{y(!1),a(null)},m=o=>{if(i){const c={id:o.id,title:o.title,summary:o.summary,cover:o.cover,background:o.background};i(c)}s()};return h.jsxs(h.Fragment,{children:[h.jsx("div",{className:"collections-list-container",style:{gridTemplateColumns:`repeat(auto-fill, ${f}px)`},children:e.map(o=>h.jsx(H,{collection:o,onCollectionClick:v,onPlay:l,onEditClick:t,onCollectionDelete:u,onCollectionUpdate:i,buildCoverUrl:w,coverSize:f,itemRefs:d},o.id))}),p&&h.jsx(O,{isOpen:C,onClose:s,collection:p,onCollectionUpdate:m})]})}function z({onPlay:e,coverSize:v}){const{setLoading:l,isLoading:i}=R(),{isLoading:u}=F(),w=P(),[f,d]=r.useState([]),[g,C]=r.useState(!1),[y]=r.useState(!0),p=r.useRef(null),a=r.useRef(new Map);U(p),r.useEffect(()=>{u||t()},[u]),r.useEffect(()=>{const n=()=>{t()};return window.addEventListener("metadataReloaded",n),()=>{window.removeEventListener("metadataReloaded",n)}},[]),r.useLayoutEffect(()=>{!i&&f.length>0?requestAnimationFrame(()=>{requestAnimationFrame(()=>{C(!0)})}):i&&C(!1)},[i,f.length]);async function t(){l(!0);try{const n=I(),j=T(x,"/collections"),k=await fetch(j,{headers:{Accept:"application/json","X-Auth-Token":n}});if(!k.ok)throw new Error(`HTTP ${k.status}`);const $=((await k.json()).collections||[]).map(S=>({id:S.id,title:S.title,summary:S.summary,cover:S.cover,background:S.background,gameCount:S.gameCount}));d($)}catch(n){const j=String(n.message||n);console.error("Error fetching collections:",j)}finally{l(!1)}}function s(n){w(`/collections/${n.id}`)}const m=n=>{d(j=>j.map(k=>String(k.id)===String(n.id)?n:k)),window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collection:n}}))},o=n=>{d(j=>j.filter(k=>k.id!==n.id))},c=r.useMemo(()=>{const n=[...f];return n.sort((j,k)=>{const E=G(j.title||"",k.title||"");return y?E:-E}),n},[f,y]);return h.jsx("main",{className:"flex-1 home-page-content",children:h.jsxs("div",{className:"home-page-layout",children:[h.jsx("div",{className:"home-page-content-wrapper",style:{opacity:g?1:0,transition:"opacity 0.2s ease-in-out"},children:h.jsx("div",{ref:p,className:"home-page-scroll-container",children:!i&&h.jsx(q,{collections:c,onCollectionClick:s,onPlay:e,onCollectionUpdate:m,onCollectionDelete:o,buildCoverUrl:M,coverSize:v,itemRefs:a})})}),g&&h.jsx(X,{games:c,scrollContainerRef:p,itemRefs:a,ascending:y})]})})}export{Z as A,z as C,D as a,F as u};
