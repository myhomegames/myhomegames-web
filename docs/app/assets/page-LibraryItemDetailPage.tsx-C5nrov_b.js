import{j as t,r as a,b as at,c as ot,u as it,d as lt}from"./react-vendor-jNdKP8wU.js";import{A as re,g as ce,b as He}from"./page-AddGamePage.tsx-CGFUTWrs.js";import{u as Xe,h as oe,e as ct,l as We,E as dt,m as ut,n as mt,a as ht,j as ft,b as gt,c as pt,d as qe,o as vt,T as yt,D as bt,p as wt}from"./page-CollectionsPage.tsx-DjVo-48O.js";import{u as et,a as tt,S as xt}from"./page-IGDBGameDetailPage.tsx--k99xBec.js";import{u as Oe}from"./i18n-vendor-mPXi0JFR.js";import{B as jt,u as St,L as Tt}from"./page-HomePage.tsx-DvziKYYh.js";/* empty css                                   */function kt({t:s,title:n,summary:e,year:I,month:c,day:u,saving:g,setTitle:i,setSummary:L,setYear:k,setMonth:z,setDay:X}){return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("label",{htmlFor:"edit-game-title",children:s("gameDetail.title","Title")}),t.jsx("input",{id:"edit-game-title",name:"title",type:"text",value:n,onChange:w=>i(w.target.value),disabled:g})]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("label",{htmlFor:"edit-game-summary",children:s("gameDetail.summary","Summary")}),t.jsx("textarea",{id:"edit-game-summary",name:"summary",value:e,onChange:w=>L(w.target.value),disabled:g,rows:5})]}),t.jsxs("div",{className:"edit-game-modal-row",children:[t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("label",{htmlFor:"edit-game-year",children:s("gameDetail.year","Year")}),t.jsx("input",{id:"edit-game-year",name:"year",type:"number",value:I,onChange:w=>k(w.target.value),disabled:g,placeholder:"YYYY"})]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("label",{htmlFor:"edit-game-month",children:s("gameDetail.month","Month")}),t.jsx("input",{id:"edit-game-month",name:"month",type:"number",value:c,onChange:w=>z(w.target.value),disabled:g,placeholder:"MM",min:"1",max:"12"})]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("label",{htmlFor:"edit-game-day",children:s("gameDetail.day","Day")}),t.jsx("input",{id:"edit-game-day",name:"day",type:"number",value:u,onChange:w=>X(w.target.value),disabled:g,placeholder:"DD",min:"1",max:"31"})]})]})]})}function Te({selectedTags:s,onTagsChange:n,disabled:e=!1,placeholder:I,mode:c="categories",availableTags:u,getDisplayName:g,allowCreate:i=!0}){const{t:L}=Oe(),{setLoading:k}=Xe(),{categories:z,addCategory:X}=et(),[w,C]=a.useState(""),[N,E]=a.useState(!1),D=c==="categories";async function f(m){if(!D)return null;try{k(!0),E(!0);const M=oe(re,"/categories"),R=await fetch(M,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Auth-Token":ce()},body:JSON.stringify({title:m})});if(!R.ok){const v=await R.json();throw new Error(v.error||`HTTP ${R.status}`)}const H=(await R.json()).category,q=typeof H=="string"?H:H.title,ae=typeof H=="string"?H:H.id;return X({id:ae,title:q}),q}catch(M){return console.error("Error creating category:",M),null}finally{k(!1),E(!1)}}const O=m=>{n(s.filter(M=>M!==m))},y=m=>{s.includes(m)||(n([...s,m]),C(""))},F=async m=>{if(m.key==="Enter"&&w.trim()&&!N){m.preventDefault();const M=w.trim(),R=M.toLowerCase();if(D){const Q=z.find(q=>{const ae=q.title.toLowerCase(),v=L(`genre.${q.title}`,q.title).toLowerCase();return ae===R||v===R||v.includes(R)});if(Q&&!s.includes(Q.title)){y(Q.title);return}const H=await f(M);H&&!s.includes(H)&&y(H)}else{const H=(u||[]).find(q=>q.toLowerCase()===R);if(H&&!s.includes(H)){y(H);return}i&&y(M)}}},K=D?z.map(m=>m.title):u||[],p=m=>D?L(`genre.${m}`,m):g?g(m):m,U=K.filter(m=>{if(s.includes(m))return!1;const M=w.toLowerCase();if(!M)return!1;if(D){const Q=L(`genre.${m}`,m).toLowerCase();return m.toLowerCase().includes(M)||Q.includes(M)}const R=p(m).toLowerCase();return m.toLowerCase().includes(M)||R.includes(M)});return t.jsxs("div",{className:"tag-editor-container",children:[t.jsxs("div",{className:"tag-editor-tags",children:[s.map(m=>t.jsxs("span",{className:"tag-editor-tag",children:[p(m),t.jsx("button",{type:"button",className:"tag-editor-tag-remove",onClick:()=>O(m),disabled:e,children:"×"})]},m)),t.jsx("input",{id:"tag-editor-input",name:"tag",type:"text",value:w,onChange:m=>C(m.target.value),onKeyDown:F,disabled:e,placeholder:I||L("gameDetail.addTag","Add tag..."),className:"tag-editor-input","aria-label":I||L("gameDetail.addTag","Add tag...")})]}),w&&U.length>0&&t.jsx("div",{className:"tag-editor-suggestions",children:U.slice(0,5).map(m=>t.jsx("button",{type:"button",className:"tag-editor-suggestion",onClick:()=>y(m),disabled:e,children:p(m)},m))})]})}function Ze(s){if(!s||!s.trim())return 0;let n=0;const e=s.trim();for(let I=0;I<e.length;I++)n=(n<<5)-n+e.charCodeAt(I),n=n|0;return n>>>0}function Et({t:s,isOpen:n,gameId:e,selectedGenres:I,selectedThemes:c,selectedKeywords:u,selectedPlatforms:g,selectedGameModes:i,selectedPlayerPerspectives:L,selectedGameEngines:k,selectedFranchise:z,selectedSeries:X,saving:w,setSelectedGenres:C,setSelectedThemes:N,setSelectedKeywords:E,setSelectedPlatforms:D,setSelectedGameModes:f,setSelectedPlayerPerspectives:O,setSelectedGameEngines:y,setSelectedFranchise:F,setSelectedSeries:K}){const{tagLabels:p}=tt(),[U,m]=a.useState([]),[M,R]=a.useState([]),[Q,H]=a.useState([]),[q,ae]=a.useState([]),[v,x]=a.useState([]),[$,W]=a.useState([]),[ne,V]=a.useState([]),[te,Z]=a.useState([]);return a.useEffect(()=>{n&&(m(Array.from(p.themes.values())),R(Array.from(p.platforms.values())),H(Array.from(p.gameModes.values())),ae(Array.from(p.playerPerspectives.values())),x(Array.from(p.gameEngines.values())),V(Array.from(p.franchises.entries()).map(([P,A])=>({id:Number(P),name:A}))),Z(Array.from(p.series.entries()).map(([P,A])=>({id:Number(P),name:A}))))},[n,p]),a.useEffect(()=>{!n||!ce()||fetch(oe(re,"/keywords"),{headers:ct({Accept:"application/json"})}).then(P=>P.ok?P.json():{keywords:[]}).then(P=>W(Array.isArray(P.keywords)?P.keywords:[])).catch(()=>{})},[n]),t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:s("gameDetail.genre","Genre")}),n&&t.jsx(Te,{selectedTags:I,onTagsChange:C,disabled:w,placeholder:s("gameDetail.addGenre","Add genre...")},`tag-editor-genres-${e}-${n}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:s("gameDetail.themes","Themes")}),n&&t.jsx(Te,{mode:"freeform",selectedTags:c,onTagsChange:N,disabled:w,placeholder:s("gameDetail.addTheme","Add theme..."),availableTags:U},`tag-editor-themes-${e}-${n}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:s("gameDetail.keywords","Keywords")}),n&&t.jsx(Te,{mode:"freeform",selectedTags:u,onTagsChange:E,disabled:w,placeholder:s("gameDetail.addKeyword","Add keyword..."),availableTags:$},`tag-editor-keywords-${e}-${n}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:s("gameDetail.platforms","Platforms")}),n&&t.jsx(Te,{mode:"freeform",selectedTags:g,onTagsChange:D,disabled:w,placeholder:s("gameDetail.addPlatform","Add platform..."),availableTags:M},`tag-editor-platforms-${e}-${n}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:s("gameDetail.gameModes","Game Modes")}),n&&t.jsx(Te,{mode:"freeform",selectedTags:i,onTagsChange:f,disabled:w,placeholder:s("gameDetail.addGameMode","Add game mode..."),getDisplayName:P=>s(`gameModes.${P}`,P),availableTags:Q},`tag-editor-game-modes-${e}-${n}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:s("gameDetail.playerPerspectives","Player Perspectives")}),n&&t.jsx(Te,{mode:"freeform",selectedTags:L,onTagsChange:O,disabled:w,placeholder:s("gameDetail.addPlayerPerspective","Add player perspective..."),getDisplayName:P=>s(`playerPerspectives.${P}`,P),availableTags:q},`tag-editor-player-perspectives-${e}-${n}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:s("gameDetail.gameEngines","Game Engines")}),n&&t.jsx(Te,{mode:"freeform",selectedTags:k,onTagsChange:y,disabled:w,placeholder:s("gameDetail.addGameEngine","Add game engine..."),availableTags:v},`tag-editor-game-engines-${e}-${n}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:s("igdbInfo.franchise","Franchise")}),n&&t.jsx(Te,{mode:"freeform",selectedTags:z.map(P=>P.name),onTagsChange:P=>F(P.filter(A=>A.trim()).map(A=>{const ie=ne.find(_=>_.name===A);if(ie)return ie;const ue=z.find(_=>_.name===A);return ue||{id:Ze(A),name:A.trim()}})),disabled:w,placeholder:s("gameDetail.addFranchise","Add franchise..."),availableTags:ne.map(P=>P.name),allowCreate:!0},`tag-editor-franchise-${e}-${n}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:s("igdbInfo.series","Series")}),n&&t.jsx(Te,{mode:"freeform",selectedTags:X.map(P=>P.name),onTagsChange:P=>K(P.filter(A=>A.trim()).map(A=>{const ie=te.find(_=>_.name===A);if(ie)return ie;const ue=X.find(_=>_.name===A);return ue||{id:Ze(A),name:A.trim()}})),disabled:w,placeholder:s("gameDetail.addSeries","Add series..."),availableTags:te.map(P=>P.name),allowCreate:!0},`tag-editor-series-${e}-${n}`)]})]})}function Dt({t:s,game:n,saving:e,showTitle:I,onShowTitleChange:c,coverRemoved:u,coverPreview:g,coverUrlWithTimestamp:i,uploadingCover:L,coverInputRef:k,handleCoverFileSelect:z,onGameUpdate:X,handleCoverRemoveSuccess:w,backgroundRemoved:C,backgroundPreview:N,backgroundUrlWithTimestamp:E,uploadingBackground:D,backgroundInputRef:f,handleBackgroundFileSelect:O,handleBackgroundRemoveSuccess:y}){return t.jsxs("div",{className:"edit-game-modal-media",children:[t.jsx("div",{className:"edit-game-modal-media-options",children:t.jsxs("label",{className:"edit-game-modal-media-checkbox-label",children:[t.jsx("input",{type:"checkbox",checked:I,onChange:F=>c(F.target.checked),"aria-label":s("gameDetail.showTitle","Show title on cover")}),t.jsx("span",{children:s("gameDetail.showTitle","Show title on cover")})]})}),t.jsxs("div",{className:"edit-game-modal-media-row",children:[t.jsxs("div",{className:"edit-game-modal-media-info",children:[t.jsx("div",{className:"edit-game-modal-label",children:s("gameDetail.cover","Cover")}),t.jsx("div",{className:"edit-game-modal-media-description",children:s("gameDetail.coverFormat","Recommended format: WebP, ratio 2:3 (e.g., 400x600px)")})]}),t.jsx("div",{className:"edit-game-modal-media-image-container",children:(()=>{const F=u?"":g||i,K=F&&F.trim()!=="";return t.jsxs(t.Fragment,{children:[t.jsx(We,{title:n.title,coverUrl:F,width:150,height:200,showTitle:!1,detail:!1,play:!1,showBorder:!0,aspectRatio:"3/4",onUpload:()=>!L&&!e&&k.current?.click(),uploading:L,showRemoveButton:!!K&&!u&&!0,removeMediaType:"cover",removeResourceId:n.id,removeResourceType:"games",onGameUpdate:X,onRemoveSuccess:w,removeDisabled:e||L},`cover-${u?"removed":g?"preview":i}`),t.jsx("input",{ref:k,id:"edit-game-cover-input",name:"cover",type:"file",accept:"image/*",style:{display:"none"},onChange:z,"aria-label":s("gameDetail.cover","Cover")})]})})()})]}),t.jsxs("div",{className:"edit-game-modal-media-row",children:[t.jsxs("div",{className:"edit-game-modal-media-info",children:[t.jsx("div",{className:"edit-game-modal-label",children:s("gameDetail.background","Background")}),t.jsx("div",{className:"edit-game-modal-media-description",children:s("gameDetail.backgroundFormat","Recommended format: WebP, ratio 16:9 (e.g., 1920x1080px)")})]}),t.jsx("div",{className:"edit-game-modal-media-image-container",children:(()=>{const F=C?"":N||E,K=F&&F.trim()!=="";return t.jsxs(t.Fragment,{children:[t.jsx(We,{title:n.title,coverUrl:F,width:300,height:169,showTitle:!1,detail:!1,play:!1,showBorder:!0,aspectRatio:"16/9",onUpload:()=>!D&&!e&&f.current?.click(),uploading:D,showRemoveButton:!!K&&!C&&!0,removeMediaType:"background",removeResourceId:n.id,removeResourceType:"games",onGameUpdate:X,onRemoveSuccess:y,removeDisabled:e||D},`background-${C?"removed":N?"preview":E}`),t.jsx("input",{ref:f,id:"edit-game-background-input",name:"background",type:"file",accept:"image/*",style:{display:"none"},onChange:O,"aria-label":s("gameDetail.background","Background")})]})})()})]})]})}function Qe(s){return!s||!Array.isArray(s)?[]:s.map(n=>typeof n=="object"&&n!=null&&"title"in n?n.title:String(n))}function Kt(s,n,e){const c=(s?.flatMap(u=>{const g=u[n];return Array.isArray(g)?g:[]})??[]).find(u=>typeof u=="object"&&u!=null&&"id"in u&&u.id===Number(e)||u===e||typeof u=="number"&&String(u)===String(e));return typeof c=="object"&&c!=null&&"title"in c?c.title:typeof c=="string"?c:String(e)}function Ct({isOpen:s,onClose:n,game:e,onGameUpdate:I}){const{t:c}=Oe(),{setLoading:u}=Xe(),{categories:g}=et(),{tagLabels:i,refreshTagLists:L}=tt(),[k,z]=a.useState(e.title),[X,w]=a.useState(e.summary||""),[C,N]=a.useState(e.year?.toString()||""),[E,D]=a.useState(e.month?.toString()||""),[f,O]=a.useState(e.day?.toString()||""),y=(h,j)=>(Array.isArray(h)?h:h!=null?[h]:[]).map(d=>typeof d=="number"?j.get(String(d))??String(d):typeof d=="object"&&d!=null&&"id"in d?j.get(String(d.id))??String(d.id):String(d)),F=(h,j)=>(Array.isArray(h)?h:h!=null?[h]:[]).map(d=>{const le=typeof d=="number"?d:typeof d=="object"&&d!=null&&"id"in d?Number(d.id):null;return le==null||Number.isNaN(le)?null:{id:le,name:j.get(String(le))??String(le)}}).filter(d=>d!=null),K=h=>(Array.isArray(h)?h:h!=null?[h]:[]).map(j=>{const d=typeof j=="number"?j:typeof j=="object"&&j!=null&&"id"in j?Number(j.id):null;return d==null?String(j):g.find(me=>String(me.id)===String(d))?.title??String(d)}),[p,U]=a.useState([]),[m,M]=a.useState([]),[R,Q]=a.useState([]),[H,q]=a.useState([]),[ae,v]=a.useState([]),[x,$]=a.useState([]),[W,ne]=a.useState([]),[V,te]=a.useState([]),[Z,P]=a.useState([]),[A,ie]=a.useState(!1),[ue,_]=a.useState(null),[de,J]=a.useState("INFO"),[Ce,Pe]=a.useState(!1),[ze,Ge]=a.useState(!1),Ke=a.useRef(null),Je=a.useRef(null),[$e,Ne]=a.useState(null),[Ve,Ae]=a.useState(null),[ve,Ie]=a.useState(null),[ye,Fe]=a.useState(null),[be,Le]=a.useState(!1),[we,je]=a.useState(!1),[Re,r]=a.useState(Date.now()),[o,l]=a.useState(!0),T=a.useMemo(()=>{if(!e?.cover)return"";const h=e.cover.split("?")[0].split("&")[0];if(h.startsWith("http"))return"";const j=oe(re,h),d=j.includes("?")?"&":"?";return`${j}${d}t=${Re}`},[e?.cover,Re]),G=a.useMemo(()=>{if(!e?.background)return"";const h=e.background.split("?")[0].split("&")[0];if(h.startsWith("http"))return"";const j=oe(re,h),d=j.includes("?")?"&":"?";return`${j}${d}t=${Re}`},[e?.background,Re]);a.useEffect(()=>{s&&(z(e.title),w(e.summary||""),N(e.year?.toString()||""),D(e.month?.toString()||""),O(e.day?.toString()||""),U(K(e.genre)),M(y(e.themes,i.themes)),Q(Array.isArray(e.keywords)?e.keywords:[]),q(y(e.platforms,i.platforms)),v(y(e.gameModes,i.gameModes)),$(y(e.playerPerspectives,i.playerPerspectives)),ne(y(e.gameEngines,i.gameEngines)),te(F(e.franchise,i.franchises)),P(F(e.series??e.collection,i.series)),_(null),J("INFO"),Ne(null),Ae(null),Ie(null),Fe(null),Le(!1),je(!1),l(e.showTitle!==!1),r(Date.now()))},[s,e,i,g]),a.useEffect(()=>{e&&(!e.cover&&!be&&!ve&&(Le(!0),Ne(null),r(Date.now())),!e.background&&!we&&!ye&&(je(!0),Ae(null),r(Date.now())))},[e?.cover,e?.background]),a.useEffect(()=>{if(!s)return;function h(j){j.key==="Escape"&&(j.stopPropagation(),n())}return document.addEventListener("keydown",h,!0),document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",h,!0),document.body.style.overflow=""}},[s,n]);const b=(h,j)=>{if(h.length!==j.length)return!1;const d=[...h].sort(),le=[...j].sort();return d.every((me,Be)=>me===le[Be])},fe=h=>Array.isArray(h)?h:[],ke=()=>{if(k!==e.title||X!==(e.summary||"")||C!==(e.year?.toString()||"")||E!==(e.month?.toString()||"")||f!==(e.day?.toString()||"")||o!==(e.showTitle!==!1))return!0;const h=K(e.genre);if(!b(p,h)||!b(m,y(e.themes,i.themes))||!b(R,fe(e.keywords))||!b(H,y(e.platforms,i.platforms))||!b(ae,y(e.gameModes,i.gameModes))||!b(x,y(e.playerPerspectives,i.playerPerspectives))||!b(W,y(e.gameEngines,i.gameEngines)))return!0;const j=F(e.franchise,i.franchises),d=F(e.series??e.collection,i.series);return!!(V.length!==j.length||V.some((le,me)=>j[me]?.id!==le.id||j[me]?.name!==le.name)||Z.length!==d.length||Z.some((le,me)=>d[me]?.id!==le.id||d[me]?.name!==le.name)||ve||ye||be||we)},Se=async()=>{ie(!0),_(null),u(!0);try{let h=null,j=null;if(be)try{const B=oe(re,`/games/${e.id}/delete-cover`),Y=await fetch(B,{method:"DELETE",headers:{"X-Auth-Token":ce()||""}});if(!Y.ok){const se=await Y.json().catch(()=>({error:"Failed to remove cover"}));throw new Error(se.error||"Failed to remove cover")}const S=await Y.json();S.game&&(h=S.game.cover||null)}catch(B){_(String(B.message||B)),ie(!1),u(!1);return}if(we)try{const B=oe(re,`/games/${e.id}/delete-background`),Y=await fetch(B,{method:"DELETE",headers:{"X-Auth-Token":ce()||""}});if(!Y.ok){const se=await Y.json().catch(()=>({error:"Failed to remove background"}));throw new Error(se.error||"Failed to remove background")}const S=await Y.json();S.game&&(j=S.game.background||null)}catch(B){_(String(B.message||B)),ie(!1),u(!1);return}if(ve){Pe(!0);try{const B=new FormData;B.append("file",ve);const Y=oe(re,`/games/${e.id}/upload-cover`),S=await fetch(Y,{method:"POST",headers:{"X-Auth-Token":ce()||""},body:B});if(!S.ok){const he=await S.json().catch(()=>({error:"Failed to upload cover"}));throw new Error(he.error||"Failed to upload cover")}const se=await S.json();se.game&&(h=se.game.cover||null,se.game.background&&(j=se.game.background))}catch(B){Pe(!1),u(!1),ie(!1),_(String(B.message||B));return}finally{Pe(!1)}}if(ye){Ge(!0);try{const B=new FormData;B.append("file",ye);const Y=oe(re,`/games/${e.id}/upload-background`),S=await fetch(Y,{method:"POST",headers:{"X-Auth-Token":ce()||""},body:B});if(!S.ok){const he=await S.json().catch(()=>({error:"Failed to upload background"}));throw new Error(he.error||"Failed to upload background")}const se=await S.json();se.game&&(j=se.game.background||null,se.game.cover&&!h&&(h=se.game.cover))}catch(B){Ge(!1),u(!1),ie(!1),_(String(B.message||B));return}finally{Ge(!1)}}const d={};k!==e.title&&(d.title=k),X!==(e.summary||"")&&(d.summary=X),C!==(e.year?.toString()||"")&&(d.year=C?parseInt(C,10):null),E!==(e.month?.toString()||"")&&(d.month=E?parseInt(E,10):null),f!==(e.day?.toString()||"")&&(d.day=f?parseInt(f,10):null);const le=K(e.genre);b(p,le)||(d.genre=p.length===1?p[0]:p),b(m,y(e.themes,i.themes))||(d.themes=m.length>0?m:[]),b(R,fe(e.keywords))||(d.keywords=R.length>0?R:[]),b(H,y(e.platforms,i.platforms))||(d.platforms=H.length>0?H:[]),b(ae,y(e.gameModes,i.gameModes))||(d.gameModes=ae.length>0?ae:[]),b(x,y(e.playerPerspectives,i.playerPerspectives))||(d.playerPerspectives=x.length>0?x:[]),b(W,y(e.gameEngines,i.gameEngines))||(d.gameEngines=W.length>0?W:[]);const me=F(e.franchise,i.franchises);(V.length!==me.length||V.some((B,Y)=>me[Y]?.id!==B.id))&&(d.franchise=V.length>0?V:null);const Be=F(e.series??e.collection,i.series);if((Z.length!==Be.length||Z.some((B,Y)=>Be[Y]?.id!==B.id))&&(d.collection=Z.length>0?Z:null),o!==(e.showTitle!==!1)&&(d.showTitle=o),Object.keys(d).length>0){const B=oe(re,`/games/${e.id}`),Y=await fetch(B,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":He},body:JSON.stringify(d)});if(!Y.ok){const Me=await Y.json();throw new Error(Me.error||"Failed to update game")}const S=await Y.json();await L();let se=h!==null?h:S.game.cover,he=j!==null?j:S.game.background;if(h&&se){const Me=se.includes("?")?"&":"?";se=`${se}${Me}t=${Date.now()}`}if(j&&he){const Me=he.includes("?")?"&":"?";he=`${he}${Me}t=${Date.now()}`}const Ee={id:S.game.id,title:S.game.title,summary:S.game.summary,cover:se,background:he,day:S.game.day,month:S.game.month,year:S.game.year,stars:S.game.stars,genre:S.game.genre,criticratings:S.game.criticratings||null,userratings:S.game.userratings||null,executables:S.game.executables||null,themes:S.game.themes??e.themes??null,platforms:S.game.platforms??e.platforms??null,gameModes:S.game.gameModes??e.gameModes??null,playerPerspectives:S.game.playerPerspectives??e.playerPerspectives??null,websites:S.game.websites??e.websites??null,ageRatings:S.game.ageRatings??e.ageRatings??null,developers:S.game.developers??e.developers??null,publishers:S.game.publishers??e.publishers??null,franchise:S.game.franchise??e.franchise??null,collection:S.game.collection??e.collection??null,series:S.game.series??S.game.collection??e.series??e.collection??null,screenshots:S.game.screenshots??e.screenshots??null,videos:S.game.videos??e.videos??null,gameEngines:S.game.gameEngines??e.gameEngines??null,keywords:S.game.keywords??e.keywords??null,alternativeNames:S.game.alternativeNames??e.alternativeNames??null,similarGames:S.game.similarGames??e.similarGames??null,showTitle:S.game.showTitle??e.showTitle};if(d.genre!==void 0){const Me=Qe(Array.isArray(e.genre)?e.genre:e.genre?[e.genre]:[]),rt=Qe(Array.isArray(Ee.genre)?Ee.genre:Ee.genre?[Ee.genre]:[]),nt=Me.filter(Ye=>!rt.includes(Ye));for(const Ye of nt)try{const _e=oe(re,`/categories/${encodeURIComponent(Ye)}`),Ue=await fetch(_e,{method:"DELETE",headers:{Accept:"application/json","X-Auth-Token":He}});Ue.ok||(Ue.status===409?await Ue.json().catch(()=>{}):await Ue.json().catch(()=>{}))}catch{}}I(Ee)}else if(ve||ye||be||we){let B=be?void 0:h??e.cover,Y=we?void 0:j??e.background;if(ve&&(!B||B==="")||ye&&(!Y||Y==="")){const se=oe(re,`/games/${e.id}`),he=await fetch(se,{method:"GET",headers:{Accept:"application/json","X-Auth-Token":He}});if(he.ok){const Ee=await he.json();(ve||be)&&B===void 0&&(B=Ee.game.cover||null),(ye||we)&&Y===void 0&&(Y=Ee.game.background||null)}}if((ve||be)&&B){const se=B.includes("?")?"&":"?";B=`${B}${se}t=${Date.now()}`}if((ye||we)&&Y){const se=Y.includes("?")?"&":"?";Y=`${Y}${se}t=${Date.now()}`}const S={...e,cover:B,background:Y};I(S)}Ne(null),Ae(null),Ie(null),Fe(null),Le(!1),je(!1),n()}catch(h){_(String(h.message||h))}finally{ie(!1),u(!1)}},ge=h=>{const j=h.target.files?.[0];if(j){if(!j.type.startsWith("image/")){_(c("gameDetail.invalidImageType","File must be an image")),h.target.value="";return}const d=new FileReader;d.onloadend=()=>{Ne(d.result)},d.readAsDataURL(j),Ie(j),Le(!1),_(null),h.target.value=""}},pe=h=>{const j=h.target.files?.[0];if(j){if(!j.type.startsWith("image/")){_(c("gameDetail.invalidImageType","File must be an image")),h.target.value="";return}const d=new FileReader;d.onloadend=()=>{Ae(d.result)},d.readAsDataURL(j),Fe(j),je(!1),_(null),h.target.value=""}},ee=()=>{Le(!0),Ne(null),Ie(null),r(Date.now())},xe=()=>{je(!0),Ae(null),Fe(null),r(Date.now())};return s?at.createPortal(t.jsx("div",{className:"edit-game-modal-overlay",onClick:n,children:t.jsxs("div",{className:"edit-game-modal-container",onClick:h=>h.stopPropagation(),children:[t.jsxs("div",{className:"edit-game-modal-header",children:[t.jsxs("h2",{children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"8px",verticalAlign:"middle"},children:[t.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),t.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]}),c("gameDetail.editGame","Edit Game")]}),t.jsx("button",{className:"edit-game-modal-close",onClick:n,"aria-label":"Close",children:"×"})]}),t.jsxs("div",{className:"edit-game-modal-content",children:[ue&&t.jsx("div",{className:"edit-game-modal-error",children:ue}),t.jsxs("div",{className:"edit-game-modal-tabs",children:[t.jsx("button",{className:`edit-game-modal-tab ${de==="INFO"?"active":""}`,onClick:()=>J("INFO"),disabled:A,children:c("gameDetail.info","INFO")}),t.jsx("button",{className:`edit-game-modal-tab ${de==="TAGS"?"active":""}`,onClick:()=>J("TAGS"),disabled:A,children:c("gameDetail.tags","TAGS")}),t.jsx("button",{className:`edit-game-modal-tab ${de==="MEDIA"?"active":""}`,onClick:()=>J("MEDIA"),disabled:A,children:c("gameDetail.media","MEDIA")})]}),de==="INFO"&&t.jsx(kt,{t:c,title:k,summary:X,year:C,month:E,day:f,saving:A,setTitle:z,setSummary:w,setYear:N,setMonth:D,setDay:O}),de==="TAGS"&&t.jsx(Et,{t:c,isOpen:s,gameId:e.id,selectedGenres:p,selectedThemes:m,selectedKeywords:R,selectedPlatforms:H,selectedGameModes:ae,selectedPlayerPerspectives:x,selectedGameEngines:W,selectedFranchise:V,selectedSeries:Z,saving:A,setSelectedGenres:U,setSelectedThemes:M,setSelectedKeywords:Q,setSelectedPlatforms:q,setSelectedGameModes:v,setSelectedPlayerPerspectives:$,setSelectedGameEngines:ne,setSelectedFranchise:te,setSelectedSeries:P}),de==="MEDIA"&&t.jsx(Dt,{t:c,game:e,saving:A,showTitle:o,onShowTitleChange:l,coverRemoved:be,coverPreview:$e,coverUrlWithTimestamp:T,uploadingCover:Ce,coverInputRef:Ke,handleCoverFileSelect:ge,onGameUpdate:I,handleCoverRemoveSuccess:ee,backgroundRemoved:we,backgroundPreview:Ve,backgroundUrlWithTimestamp:G,uploadingBackground:ze,backgroundInputRef:Je,handleBackgroundFileSelect:pe,handleBackgroundRemoveSuccess:xe})]}),t.jsxs("div",{className:"edit-game-modal-footer",children:[t.jsx("button",{className:"edit-game-modal-cancel",onClick:n,disabled:A,children:c("common.cancel","Cancel")}),t.jsx("button",{className:"edit-game-modal-save",onClick:Se,disabled:A||!ke(),children:A?c("common.saving","Saving..."):c("common.save","Save")})]})]})}),document.body):null}function Nt({rating:s,starSize:n=16,gap:e=4,color:I="#ffffff",noStroke:c=!1,readOnly:u=!0,onRatingChange:g}){const[i,L]=a.useState(null),k=(C,N)=>{if(!u&&g){const D=(N?C-.5:C)*2;g(D)}},z=(C,N)=>{if(!u){const E=N?C-.5:C;L(E)}},X=()=>{u||L(null)},w=i!==null?i:s;return t.jsx("div",{style:{display:"flex",alignItems:"center",gap:`${e}px`},onMouseLeave:X,children:[1,2,3,4,5].map(C=>{const N=w>=C,E=w>=C-.5&&w<C,D=`star-${C}-${w}`;return t.jsxs("div",{style:{position:"relative",width:`${n}px`,height:`${n}px`,cursor:u?"default":"pointer"},children:[t.jsx("svg",{width:n,height:n,viewBox:"0 0 24 24",fill:"none",stroke:"rgba(255, 255, 255, 0.3)",strokeWidth:"1.5",style:{position:"absolute",top:0,left:0},children:t.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"})}),!u&&t.jsx("div",{style:{position:"absolute",top:0,left:0,width:`${n/2}px`,height:`${n}px`,cursor:"pointer",zIndex:10},onClick:()=>k(C,!0),onMouseEnter:()=>z(C,!0)}),!u&&t.jsx("div",{style:{position:"absolute",top:0,right:0,width:`${n/2}px`,height:`${n}px`,cursor:"pointer",zIndex:10},onClick:()=>k(C,!1),onMouseEnter:()=>z(C,!1)}),N&&t.jsx("svg",{width:n,height:n,viewBox:"0 0 24 24",fill:I,stroke:c?"none":I,strokeWidth:c?"0":"1.5",style:{position:"absolute",top:0,left:0,pointerEvents:"none"},children:t.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"})}),E&&t.jsxs("svg",{width:n,height:n,viewBox:"0 0 24 24",fill:"none",stroke:c?"none":I,strokeWidth:c?"0":"1.5",style:{position:"absolute",top:0,left:0,pointerEvents:"none"},children:[t.jsx("defs",{children:t.jsxs("linearGradient",{id:D,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[t.jsx("stop",{offset:"50%",stopColor:I}),t.jsx("stop",{offset:"50%",stopColor:"transparent"})]})}),t.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z",fill:`url(#${D})`})]})]},C)})})}function At(s){try{const n=sessionStorage.getItem(s);if(!n)return null;const e=JSON.parse(n);return{scrollTop:e.scrollTop??0,scrollLeft:e.scrollLeft??0}}catch{return null}}function Lt(s,n,e){try{sessionStorage.setItem(s,JSON.stringify({scrollTop:n,scrollLeft:e}))}catch{}}const De=40,Mt=2;function $t({games:s,coverSize:n,containerRef:e,itemRefs:I,onGameClick:c,onPlay:u,onEditClick:g,onGameDelete:i,onGameUpdate:L,buildCoverUrl:k,allCollections:z=[],collectionId:X,onRemoveFromCollection:w,developerId:C,publisherId:N,onRemoveFromDeveloper:E,onRemoveFromPublisher:D}){const f=ot(),[O,y]=a.useState({width:0,height:0}),[F,K]=a.useState(!1),p=a.useRef(null),U=a.useRef(!1),m=a.useRef(null),M=`${f.pathname}:grid`;a.useEffect(()=>{e&&"current"in e&&e.current&&(e.current.__virtualizedGridRef=p)},[e]);const R=a.useMemo(()=>{if(O.width===0)return 1;const v=n+De;return Math.max(1,Math.floor((O.width+De)/v))},[O.width,n]),Q=a.useMemo(()=>Math.ceil(s.length/R),[s.length,R]),H=n,q=n*1.5+De;a.useEffect(()=>{const v=()=>{if(e.current){const $=e.current.getBoundingClientRect();y({width:$.width-40,height:$.height||window.innerHeight-200})}};v(),window.addEventListener("resize",v);const x=new ResizeObserver(v);return e.current&&x.observe(e.current),()=>{window.removeEventListener("resize",v),x.disconnect()}},[e]),a.useEffect(()=>{const v=At(M);if(!v||v.scrollTop===0&&v.scrollLeft===0){K(!0);return}if(O.height===0||Q===0||R===0)return;U.current=!0,K(!1);const x=(W=0)=>{const ne=p.current;if(!ne){W<50?setTimeout(()=>x(W+1),50):U.current=!1;return}let V=null;if(ne.element)V=ne.element;else if(e.current){const te=e.current.querySelector('[style*="overflow"]');te&&(te.scrollHeight>te.clientHeight||te.scrollWidth>te.clientWidth)&&(V=te)}if(!V){W<50?setTimeout(()=>x(W+1),50):(U.current=!1,K(!0));return}try{V.scrollTop=v.scrollTop,V.scrollLeft=v.scrollLeft,setTimeout(()=>{const te=V.scrollTop,Z=V.scrollLeft;(Math.abs(te-v.scrollTop)>10||Math.abs(Z-v.scrollLeft)>10)&&W<5&&(V.scrollTop=v.scrollTop,V.scrollLeft=v.scrollLeft),setTimeout(()=>{U.current=!1,K(!0)},50)},50)}catch{W<10?setTimeout(()=>x(W+1),100):U.current=!1}},$=setTimeout(()=>{x()},300);return()=>{clearTimeout($),U.current=!1}},[f.pathname,M,O.height,Q,R]),a.useEffect(()=>{let v=null,x=null;const $=(W=0)=>{const ne=p.current;if(!ne){W<20&&setTimeout(()=>$(W+1),100);return}let V=null;if(ne.element)V=ne.element;else if(e.current){const Z=e.current.querySelector('[style*="overflow"]');Z&&(Z.scrollHeight>Z.clientHeight||Z.scrollWidth>Z.clientWidth)&&(V=Z)}if(!V){W<20&&setTimeout(()=>$(W+1),100);return}const te=()=>{U.current||(v&&clearTimeout(v),v=setTimeout(()=>{const Z=V.scrollTop,P=V.scrollLeft;(!m.current||m.current.scrollTop!==Z||m.current.scrollLeft!==P)&&(Lt(M,Z,P),m.current={scrollTop:Z,scrollLeft:P})},150))};V.addEventListener("scroll",te,{passive:!0}),x=()=>{v&&clearTimeout(v),V.removeEventListener("scroll",te)}};return $(),()=>{x&&x()}},[p.current,M,q,H,Q,R]);const ae=({columnIndex:v,rowIndex:x,style:$})=>{const W=x*R+v;if(W>=s.length)return t.jsx("div",{style:$});const ne=s[W];return t.jsx("div",{style:{...$,paddingLeft:v===0?0:De/2,paddingRight:v===R-1?0:De/2,paddingTop:x===0?0:De/2,paddingBottom:x===Q-1?0:De/2},children:t.jsx(st,{game:ne,onGameClick:c,onPlay:u,onEditClick:g,onGameDelete:i,onGameUpdate:L,buildCoverUrl:k,coverSize:n,itemRefs:I,index:W,onDragStart:()=>{},onDragOver:()=>{},onDragEnd:()=>{},isDragging:!1,dragOverIndex:null,viewMode:"grid",allCollections:z,collectionId:X,onRemoveFromCollection:w,developerId:C,publisherId:N,onRemoveFromDeveloper:E,onRemoveFromPublisher:D})})};return O.width===0||O.height===0?t.jsx("div",{style:{width:"100%",height:"100%"}}):t.jsx("div",{style:{opacity:F?1:0,transition:F?"opacity 0.1s":"none"},children:t.jsx(dt,{gridRef:p,className:"virtualized-games-grid",columnCount:R,columnWidth:H+De,defaultHeight:O.height,defaultWidth:O.width,rowCount:Q,rowHeight:q,overscanCount:Mt,cellComponent:ae,cellProps:{},style:{height:O.height,width:O.width},onResize:v=>{y({width:v.width,height:v.height})}})})}const It=100;function st({game:s,onGameClick:n,onPlay:e,onEditClick:I,onGameDelete:c,onGameUpdate:u,buildCoverUrl:g,coverSize:i,itemRefs:L,draggable:k=!1,index:z,onDragStart:X,onDragOver:w,onDragEnd:C,isDragging:N,dragOverIndex:E,viewMode:D,allCollections:f=[],collectionId:O,onRemoveFromCollection:y,developerId:F,publisherId:K,onRemoveFromDeveloper:p,onRemoveFromPublisher:U}){const m=i*1.5,M=a.useRef(s.cover),R=M.current!==s.cover;R&&(M.current=s.cover);const Q=a.useMemo(()=>s.cover?g(re,s.cover,R):"",[s.cover,R,g]),H=x=>{k&&(x.dataTransfer.effectAllowed="move",x.dataTransfer.setData("text/html",z.toString()),X(z))},q=x=>{k&&(x.preventDefault(),x.dataTransfer.dropEffect="move",w(z))},ae=()=>{k&&C()},v=E===z&&N;return t.jsx("div",{ref:x=>{x&&L?.current&&L.current.set(s.id,x)},className:`group cursor-pointer games-list-item ${k?"games-list-item-draggable":""} ${v?"games-list-item-drag-over":""}`,style:{width:`${i}px`,minWidth:`${i}px`},draggable:k,onDragStart:H,onDragOver:q,onDragEnd:ae,onDragLeave:x=>{if(!k)return;const $=x.currentTarget.getBoundingClientRect(),W=x.clientX,ne=x.clientY;(W<$.left||W>$.right||ne<$.top||ne>$.bottom)&&E===z&&w(-1)},children:t.jsx(We,{title:s.title,coverUrl:Q,width:i,height:m,onPlay:e?()=>e(s):void 0,onClick:()=>n(s),onEdit:()=>I(s),gameId:s.id,gameTitle:s.title,game:s,onGameDelete:c?x=>{const $=s.id===x?s:null;$&&c($)}:void 0,onGameUpdate:u?x=>{x.id===s.id&&u(x)}:void 0,collectionId:O,onRemoveFromCollection:y?()=>y(s.id):void 0,developerId:F,publisherId:K,onRemoveFromDeveloper:p?()=>p(s.id):void 0,onRemoveFromPublisher:U?()=>U(s.id):void 0,showTitle:s.showTitle!==!1,subtitle:s.year,detail:!0,play:!!(s.executables&&s.executables.length>0),showBorder:D!=="detail",allCollections:f},`${s.id}-${s.cover}`)})}function Ft({games:s,onGameClick:n,onPlay:e,onGameUpdate:I,onGameDelete:c,buildCoverUrl:u,coverSize:g=150,itemRefs:i,draggable:L=!1,onDragEnd:k,style:z,viewMode:X,allCollections:w=[],collectionId:C,onRemoveFromCollection:N,developerId:E,publisherId:D,onRemoveFromDeveloper:f,onRemoveFromPublisher:O,scrollContainerRef:y,enableVirtualization:F=!0}){const{t:K}=Oe(),p=ut(),[U,m]=a.useState(null),[M,R]=a.useState(null),Q=$=>{m($)},H=$=>{U===null||U===$||R($)},q=()=>{U!==null&&M!==null&&U!==M&&k&&k(U,M),m(null),R(null)},ae=$=>{I&&I($),p.closeEditModal()},v=F&&s.length>It&&!L,x=a.useRef(null);return s.length===0?t.jsx("div",{className:"centered-content h-full min-h-[400px]",children:t.jsx("div",{className:"text-gray-400 text-center",children:K("table.noGames")})}):t.jsxs(t.Fragment,{children:[t.jsx("div",{ref:x,className:"games-list-container",style:{gridTemplateColumns:v?void 0:`repeat(auto-fill, ${g}px)`,height:v?"100%":void 0,...z},children:v?t.jsx($t,{games:s,coverSize:g,containerRef:y||x,itemRefs:i,onGameClick:n,onPlay:e,onEditClick:p.openEditModal,onGameDelete:c,onGameUpdate:I,buildCoverUrl:u,allCollections:w,collectionId:C,onRemoveFromCollection:N,developerId:E,publisherId:D,onRemoveFromDeveloper:f,onRemoveFromPublisher:O}):s.map(($,W)=>t.jsx(st,{game:$,onGameClick:n,onPlay:e,onEditClick:p.openEditModal,onGameDelete:c,onGameUpdate:I,buildCoverUrl:u,coverSize:g,itemRefs:i,draggable:L,index:W,onDragStart:Q,onDragOver:H,onDragEnd:q,isDragging:U!==null,dragOverIndex:M,viewMode:X,allCollections:w,collectionId:C,onRemoveFromCollection:N,developerId:E,publisherId:D,onRemoveFromDeveloper:f,onRemoveFromPublisher:O},$.id))}),p.selectedGame&&He&&t.jsx(Ct,{isOpen:p.isEditModalOpen,onClose:p.closeEditModal,game:p.selectedGame,onGameUpdate:ae})]})}function Rt({setGames:s,enabledEvents:n=["gameUpdated","gameDeleted","gameAdded"]}){const e=a.useRef(n);e.current=n,a.useEffect(()=>{const I=[];if(e.current.includes("gameUpdated")){const c=u=>{const i=u.detail?.game;i&&s(L=>L.map(k=>String(k.id)===String(i.id)?i:k))};window.addEventListener("gameUpdated",c),I.push({event:"gameUpdated",handler:c})}if(e.current.includes("gameDeleted")){const c=u=>{const i=u.detail?.gameId;i&&s(L=>L.filter(k=>String(k.id)!==String(i)))};window.addEventListener("gameDeleted",c),I.push({event:"gameDeleted",handler:c})}if(e.current.includes("gameAdded")){const c=u=>{const i=u.detail?.game;i&&s(L=>{const k={...i,id:String(i.id)},z=L.findIndex(X=>String(X.id)===String(k.id));if(z>=0){const X=[...L];return X[z]=k,X}else return[...L,k]})};window.addEventListener("gameAdded",c),I.push({event:"gameAdded",handler:c})}return()=>{I.forEach(({event:c,handler:u})=>{window.removeEventListener(c,u)})}},[s])}function Pt(s){return(s.games||[]).map(e=>({id:e.id,title:e.title,summary:e.summary,cover:e.cover,background:e.background,day:e.day,month:e.month,year:e.year,stars:e.stars,executables:e.executables||null,themes:e.themes||null,platforms:e.platforms||null,gameModes:e.gameModes||null,playerPerspectives:e.playerPerspectives||null,websites:e.websites||null,ageRatings:e.ageRatings||null,developers:e.developers||null,publishers:e.publishers||null,franchise:e.franchise||null,collection:e.collection||null,series:e.series??e.collection??null,screenshots:e.screenshots||null,videos:e.videos||null,gameEngines:e.gameEngines||null,keywords:e.keywords||null,alternativeNames:e.alternativeNames||null,similarGames:e.similarGames||null}))}function Jt({onGameClick:s,onGamesLoaded:n,onPlay:e,allCollections:I=[]}){const{t:c}=Oe(),u=it(),{setLoading:g,isLoading:i}=Xe(),{collections:L}=mt(),{developers:k,updateDeveloper:z}=ht(),{publishers:X,updatePublisher:w}=ft(),C=lt(),N=C.collectionId,E=C.developerId,D=C.publisherId,f=N?"collections":E?"developers":"publishers",O=N??E??D??null,[y,F]=a.useState(null),[K,p]=a.useState([]),[U,m]=a.useState(!1),[M]=a.useState("grid"),[R,Q]=a.useState(()=>{const r=localStorage.getItem("coverSize");return r?parseInt(r,10):150}),[H,q]=a.useState(null),[ae,v]=a.useState(!1),[x,$]=a.useState(!1),[W,ne]=a.useState(!1),[V,te]=a.useState(null),Z=a.useRef(null),P=a.useRef(new Map),A=a.useRef(!1),ie=a.useRef(void 0);gt(Z);const ue=r=>{Q(r),localStorage.setItem("coverSize",r.toString())};a.useEffect(()=>{if(!(f!=="collections"||!N)&&N!==ie.current){ie.current=N,A.current=!1;const r=L.find(o=>String(o.id)===String(N));r?F({id:String(r.id),title:r.title,summary:r.summary,cover:r.cover,background:r.background,showTitle:r.showTitle!==!1}):_(N),A.current||de(N)}},[N,f,L]),a.useEffect(()=>{if(f==="collections"&&N&&!y){const r=L.find(o=>String(o.id)===String(N));r&&F({id:String(r.id),title:r.title,summary:r.summary,cover:r.cover,background:r.background,showTitle:r.showTitle!==!1})}},[L,N,f,y]),a.useEffect(()=>{if(!(f!=="developers"||!E)&&E!==ie.current){ie.current=E,A.current=!1;const r=k.find(o=>String(o.id)===String(E));r?F({id:String(r.id),title:r.title,summary:r.summary,cover:r.cover,background:r.background,showTitle:r.showTitle!==!1}):J(E),A.current||Ce(E)}},[E,f,k]),a.useEffect(()=>{if(f==="developers"&&E&&!y){const r=k.find(o=>String(o.id)===String(E));r&&F({id:String(r.id),title:r.title,summary:r.summary,cover:r.cover,background:r.background,showTitle:r.showTitle!==!1})}},[k,E,f,y]),a.useEffect(()=>{if(!(f!=="publishers"||!D)&&D!==ie.current){ie.current=D,A.current=!1;const r=X.find(o=>String(o.id)===String(D));r?F({id:String(r.id),title:r.title,summary:r.summary,cover:r.cover,background:r.background,showTitle:r.showTitle!==!1}):Pe(D),A.current||ze(D)}},[D,f,X]),a.useEffect(()=>{if(f==="publishers"&&D&&!y){const r=X.find(o=>String(o.id)===String(D));r&&F({id:String(r.id),title:r.title,summary:r.summary,cover:r.cover,background:r.background,showTitle:r.showTitle!==!1})}},[X,D,f,y]),Rt({setGames:p,enabledEvents:["gameUpdated","gameDeleted"]}),a.useLayoutEffect(()=>{!i&&y?requestAnimationFrame(()=>requestAnimationFrame(()=>m(!0))):i&&m(!1)},[i,y,K.length]);async function _(r){try{const o=oe(re,`/collections/${r}`),l=await fetch(o,{headers:{Accept:"application/json","X-Auth-Token":ce()}});if(l.ok){const G=await l.json();F({id:String(G.id),title:G.title,summary:G.summary,cover:G.cover,background:G.background,showTitle:G.showTitle!==!1});return}const T=L.find(G=>String(G.id)===String(r));T&&F({id:String(T.id),title:T.title,summary:T.summary,cover:T.cover,background:T.background,showTitle:T.showTitle!==!1})}catch(o){console.error("Error fetching collection info:",o?.message)}}async function de(r){if(!A.current){A.current=!0,g(!0);try{const o=oe(re,`/collections/${r}/games`),l=await fetch(o,{headers:{Accept:"application/json","X-Auth-Token":ce()}});if(!l.ok)throw new Error(`HTTP ${l.status}`);const T=await l.json(),G=Pt(T),b=[...G].sort((ge,pe)=>{const ee=ge.year??0,xe=pe.year??0;return ee!==0&&xe!==0?ee-xe:ee!==0&&xe===0?-1:ee===0&&xe!==0?1:0}),fe=G.map(ge=>ge.id),ke=b.map(ge=>ge.id),Se=fe.length===ke.length&&fe.every((ge,pe)=>ge===ke[pe]);q(Se?null:fe),p(G),n(G)}catch(o){console.error("Error fetching collection games:",o?.message)}finally{g(!1),A.current=!1}}}async function J(r){try{const o=oe(re,`/developers/${r}`),l=await fetch(o,{headers:{Accept:"application/json","X-Auth-Token":ce()||""}});if(!l.ok)return;const T=await l.json();F({id:String(T.id),title:T.title,summary:T.summary,cover:T.cover,background:T.background,showTitle:T.showTitle!==!1})}catch(o){console.error("Error fetching developer:",o)}}async function Ce(r){A.current=!0,g(!0);try{const o=oe(re,`/developers/${r}/games`),l=await fetch(o,{headers:{Accept:"application/json","X-Auth-Token":ce()||""}});if(!l.ok)throw new Error(`HTTP ${l.status}`);const G=((await l.json()).games||[]).map(b=>({id:String(b.id),title:b.title,summary:b.summary,cover:b.cover,day:b.day,month:b.month,year:b.year,stars:b.stars,developers:b.developers,publishers:b.publishers,executables:b.executables}));p(G),n(G)}catch(o){console.error("Error fetching developer games:",o)}finally{g(!1),A.current=!1}}async function Pe(r){try{const o=oe(re,`/publishers/${r}`),l=await fetch(o,{headers:{Accept:"application/json","X-Auth-Token":ce()||""}});if(!l.ok)return;const T=await l.json();F({id:String(T.id),title:T.title,summary:T.summary,cover:T.cover,background:T.background,showTitle:T.showTitle!==!1})}catch(o){console.error("Error fetching publisher:",o)}}async function ze(r){A.current=!0,g(!0);try{const o=oe(re,`/publishers/${r}/games`),l=await fetch(o,{headers:{Accept:"application/json","X-Auth-Token":ce()||""}});if(!l.ok)throw new Error(`HTTP ${l.status}`);const G=((await l.json()).games||[]).map(b=>({id:String(b.id),title:b.title,summary:b.summary,cover:b.cover,day:b.day,month:b.month,year:b.year,stars:b.stars,developers:b.developers,publishers:b.publishers,executables:b.executables}));p(G),n(G)}catch(o){console.error("Error fetching publisher games:",o)}finally{g(!1),A.current=!1}}const Ge=async()=>{if(!O||!y)return;const r=ce();if(!r)return;const o=f;ne(!0),te(null),g(!0);try{const l=oe(re,`/${o}/${O}`);if(!(await fetch(l,{method:"DELETE",headers:{"X-Auth-Token":r}})).ok)throw new Error("Delete failed");const G=f==="collections"?"collectionDeleted":f==="developers"?"developerDeleted":"publisherDeleted",b=f==="collections"?"collectionId":f==="developers"?"developerId":"publisherId";window.dispatchEvent(new CustomEvent(G,{detail:{[b]:O}})),$(!1),u(-1)}catch(l){te(String(l.message))}finally{ne(!1),g(!1)}},Ke=async r=>{if(!E)return;const o=ce();if(o)try{const l=oe(re,`/games/${r}`),T=await fetch(l,{headers:{Accept:"application/json","X-Auth-Token":o}});if(!T.ok)throw new Error("Failed to fetch game");const G=await T.json(),ke=((G.game||G).developers||[]).map(ee=>typeof ee=="object"?{id:ee.id,name:ee.name}:{id:ee,name:String(ee)}).filter(ee=>Number(ee.id)!==Number(E)),Se=await fetch(l,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":o},body:JSON.stringify({developers:ke})});if(!Se.ok)throw new Error("Failed to remove from developer");const pe=(await Se.json()).game;pe&&window.dispatchEvent(new CustomEvent("gameUpdated",{detail:{game:pe}})),window.dispatchEvent(new CustomEvent("developerUpdated",{detail:{developerId:E}})),p(ee=>ee.filter(xe=>String(xe.id)!==String(r)))}catch(l){console.error("Error removing game from developer:",l)}},Je=async r=>{if(!D)return;const o=ce();if(o)try{const l=oe(re,`/games/${r}`),T=await fetch(l,{headers:{Accept:"application/json","X-Auth-Token":o}});if(!T.ok)throw new Error("Failed to fetch game");const G=await T.json(),ke=((G.game||G).publishers||[]).map(ee=>typeof ee=="object"?{id:ee.id,name:ee.name}:{id:ee,name:String(ee)}).filter(ee=>Number(ee.id)!==Number(D)),Se=await fetch(l,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":o},body:JSON.stringify({publishers:ke})});if(!Se.ok)throw new Error("Failed to remove from publisher");const pe=(await Se.json()).game;pe&&window.dispatchEvent(new CustomEvent("gameUpdated",{detail:{game:pe}})),window.dispatchEvent(new CustomEvent("publisherUpdated",{detail:{publisherId:D}})),p(ee=>ee.filter(xe=>String(xe.id)!==String(r)))}catch(l){console.error("Error removing game from publisher:",l)}},$e=a.useMemo(()=>{if(f==="collections"&&H&&H.length===K.length){const o=new Map(K.map(l=>[l.id,l]));return H.map(l=>o.get(l)).filter(Boolean)}const r=[...K];return r.sort((o,l)=>{const T=o.year??0,G=l.year??0;return T!==0&&G!==0?T-G:T!==0&&G===0?-1:T===0&&G!==0?1:pt(o.title||"",l.title||"")}),r},[K,H,f]),Ne=r=>{p(o=>o.map(l=>String(l.id)===String(r.id)?r:l)),window.dispatchEvent(new CustomEvent("gameUpdated",{detail:{game:r}})),N&&de(N)},Ve=r=>{p(o=>o.filter(l=>String(l.id)!==String(r.id)))},Ae=r=>{p(o=>o.filter(l=>String(l.id)!==String(r)))},ve=async(r,o)=>{if(r===o||f!=="collections")return;const l=[...$e],[T]=l.splice(r,1);l.splice(o,0,T);const G=l.map(b=>b.id);if(q(G),p(l),N)try{const b=oe(re,`/collections/${N}/games/order`),fe=await fetch(b,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":ce()},body:JSON.stringify({gameIds:G})});if(!fe.ok)throw new Error(`HTTP ${fe.status}`)}catch{q(null),de(N)}},Ie=a.useMemo(()=>{const r=K.map(T=>T.year).filter(T=>T!=null);if(r.length===0)return null;const o=Math.min(...r),l=Math.max(...r);return o===l?o.toString():`${o} - ${l}`},[K]),ye=a.useMemo(()=>{const r=K.map(l=>l.stars).filter(l=>l!=null);return r.length===0?null:r.reduce((l,T)=>l+T,0)/r.length/10*5},[K]),Fe=f==="collections"?"Collection not found":f==="developers"?c("tags.noItemsFound",{type:c("igdbInfo.developers","Developers")}):c("tags.noItemsFound",{type:c("igdbInfo.publishers","Publishers")});if(!O)return t.jsx("div",{className:"bg-[#1a1a1a] text-white flex items-center justify-center",style:{width:"100%",height:"100%"},children:t.jsx("div",{className:"text-center",children:t.jsx("div",{className:"text-gray-400",children:Fe})})});const be=y?.cover?qe(re,y.cover,!0):"",Le=240,we=360,je=vt(re,y?.background),Re=!!(je&&je.trim()!=="");return t.jsx(jt,{backgroundUrl:je,hasBackground:Re,elementId:O,children:t.jsx(Gt,{item:y,itemCoverUrl:be,coverWidth:Le,coverHeight:we,yearRange:Ie,averageRating:ye,onPlay:e,sortedGames:$e,onGameClick:s,onGameUpdate:Ne,onGameDelete:Ve,buildCoverUrl:(r,o,l)=>qe(r,o,l??!1),coverSize:R,handleCoverSizeChange:ue,viewMode:M,itemRefs:P,handleDragEnd:ve,scrollContainerRef:Z,isReady:U,isEditModalOpen:ae,onEditModalOpen:()=>v(!0),onEditModalClose:()=>v(!1),onItemUpdate:r=>{F(r),f==="developers"&&z({...r,gameCount:$e.length}),f==="publishers"&&w({...r,gameCount:$e.length})},t:c,allCollections:I,resourceType:f,collectionId:f==="collections"?N:void 0,onRemoveFromCollection:f==="collections"?Ae:void 0,developerId:f==="developers"?E??void 0:void 0,publisherId:f==="publishers"?D??void 0:void 0,onRemoveFromDeveloper:f==="developers"?Ke:void 0,onRemoveFromPublisher:f==="publishers"?Je:void 0,showDeleteModal:x,isDeleting:W,deleteError:V,onDeleteClick:()=>$(!0),onConfirmDelete:Ge,onCloseDeleteModal:()=>!W&&$(!1)})})}function Gt({item:s,itemCoverUrl:n,coverWidth:e,coverHeight:I,yearRange:c,averageRating:u,onPlay:g,sortedGames:i,onGameClick:L,onGameUpdate:k,onGameDelete:z,buildCoverUrl:X,coverSize:w,handleCoverSizeChange:C,viewMode:N,itemRefs:E,handleDragEnd:D,scrollContainerRef:f,isReady:O,isEditModalOpen:y,onEditModalOpen:F,onEditModalClose:K,onItemUpdate:p,t:U,allCollections:m=[],resourceType:M,collectionId:R,onRemoveFromCollection:Q,developerId:H,publisherId:q,onRemoveFromDeveloper:ae,onRemoveFromPublisher:v,showDeleteModal:x=!1,isDeleting:$=!1,deleteError:W=null,onDeleteClick:ne,onConfirmDelete:V,onCloseDeleteModal:te}){const{hasBackground:Z,isBackgroundVisible:P}=St(),{isLoading:A}=Xe(),ue=(()=>{let J=1;return c&&J++,u!==null&&J++,(g&&i.length>0||s)&&J++,Math.max(2,Math.min(6,7-J))})(),_=M==="collections",de=M==="developers"||M==="publishers";return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:Z&&P?"game-detail-libraries-bar-transparent":"",style:{position:"relative",zIndex:1e3,pointerEvents:"auto"},children:t.jsx(Tt,{libraries:[],activeLibrary:_?{key:"collection",type:"collection"}:null,onSelectLibrary:()=>{},loading:!1,error:null,coverSize:w,onCoverSizeChange:C,viewMode:N,onViewModeChange:()=>{}})}),t.jsx("div",{style:{position:"relative",zIndex:2,height:"100vh",display:"flex",flexDirection:"column"},children:t.jsx("div",{className:"home-page-main-container",style:{backgroundColor:"transparent",position:"relative",flex:1,overflow:"hidden",display:"flex",flexDirection:"column",minHeight:0},children:t.jsx("main",{className:"flex-1 home-page-content",style:{minHeight:0},children:t.jsx("div",{className:"home-page-layout",style:{minHeight:0},children:t.jsx("div",{className:"home-page-content-wrapper",style:{opacity:O?1:0,transition:"opacity 0.2s ease-in-out",minHeight:0},children:t.jsxs("div",{ref:f,className:"home-page-scroll-container",style:{paddingLeft:"64px",paddingRight:"64px",paddingTop:"5px",paddingBottom:"32px"},children:[s&&t.jsxs("div",{className:"pt-8",style:{display:"flex",flexDirection:"row",gap:"48px",alignItems:"flex-start",width:"100%",boxSizing:"border-box",marginBottom:"32px"},children:[t.jsx("div",{style:{flexShrink:0},children:t.jsx(We,{title:s.title,coverUrl:n,width:e,height:I,onPlay:g&&i.some(J=>J.executables?.length)?()=>{const J=i.find(Ce=>Ce.executables?.length);J&&g(J)}:void 0,showTitle:!1,detail:!1,play:i.some(J=>J.executables&&J.executables.length>0),showBorder:!0})}),t.jsx("div",{style:{flex:1,display:"flex",flexDirection:"column",justifyContent:"flex-start",gap:"16px",minHeight:`${I}px`,minWidth:0,visibility:"visible"},children:t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"8px",visibility:"visible"},children:[t.jsx("h1",{className:"text-white",style:{fontFamily:"var(--font-heading-1-font-family)",fontSize:"var(--font-heading-1-font-size)",lineHeight:"var(--font-heading-1-line-height)"},children:s.title}),c&&t.jsx("div",{className:"text-white",style:{opacity:.8,fontFamily:"var(--font-body-2-font-family)",fontSize:"var(--font-body-2-font-size)",lineHeight:"var(--font-body-2-line-height)"},children:c}),u!==null&&t.jsx(Nt,{rating:u}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",marginTop:"16px"},children:[g&&i.some(J=>J.executables?.length)&&t.jsxs("button",{onClick:()=>{const J=i.find(Ce=>Ce.executables?.length);J&&g(J)},style:{backgroundColor:"#E5A00D",color:"#000000",border:"none",borderRadius:"4px",padding:"6px 12px 6px 8px",fontSize:"1.25rem",fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:"6px"},onMouseEnter:J=>J.currentTarget.style.backgroundColor="#F5B041",onMouseLeave:J=>J.currentTarget.style.backgroundColor="#E5A00D",children:[t.jsx("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"currentColor",children:t.jsx("path",{d:"M8 5v14l11-7z"})}),U("common.play")]}),t.jsx(yt,{text:U("common.edit"),delay:200,children:t.jsx("button",{onClick:F,className:"library-item-detail-edit-button",children:t.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),t.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]})})}),s&&(_||de)&&t.jsx(bt,{collectionId:_?s.id:void 0,collectionTitle:s.title,developerId:M==="developers"?s.id:void 0,publisherId:M==="publishers"?s.id:void 0,onCollectionDelete:J=>{s.id===J&&window.history.back()},onCollectionUpdate:p,onDelete:de?ne:void 0,horizontal:!0,className:"library-item-detail-dropdown-menu",toolTipDelay:200})]}),s&&t.jsx(wt,{isOpen:y,onClose:K,resourceType:M,item:s,onItemUpdate:p}),x&&s&&t.jsx("div",{className:"dropdown-menu-confirm-overlay",onClick:()=>te?.(),children:t.jsxs("div",{className:"dropdown-menu-confirm-container",onClick:J=>J.stopPropagation(),children:[t.jsxs("div",{className:"dropdown-menu-confirm-header",children:[t.jsx("h2",{children:U("common.deleteTitle","Delete")}),t.jsx("button",{className:"dropdown-menu-confirm-close",onClick:te,"aria-label":"Close",children:"×"})]}),t.jsxs("div",{className:"dropdown-menu-confirm-content",children:[t.jsx("p",{children:U("common.confirmDelete",{title:s.title})}),W&&t.jsx("div",{className:"dropdown-menu-confirm-error",children:W})]}),t.jsxs("div",{className:"dropdown-menu-confirm-footer",children:[t.jsx("button",{className:"dropdown-menu-confirm-cancel",onClick:te,disabled:$,children:U("common.cancel","Cancel")}),t.jsx("button",{className:"dropdown-menu-confirm-delete",onClick:V,disabled:$,children:$?U("common.deleting","Deleting..."):U("common.delete","Delete")})]})]})}),s?.summary&&t.jsx(xt,{summary:s.summary,maxLines:ue})]})})]}),!A&&t.jsxs("div",{style:{width:"100%"},children:[t.jsx("div",{style:{paddingLeft:"0",marginBottom:"32px",marginTop:"8px"},children:t.jsxs("h2",{className:"text-white",style:{fontFamily:"var(--font-heading-2-font-family)",fontSize:"var(--font-heading-2-font-size)",fontWeight:600},children:[i.length," ",U("common.games")]})}),t.jsx("style",{children:`
                        .library-item-detail-games-list .games-list-container {
                          justify-content: flex-start !important;
                        }
                      `}),t.jsx("div",{className:"library-item-detail-games-list",children:t.jsx(Ft,{games:i,onGameClick:L,onPlay:g,onGameUpdate:k,onGameDelete:z,buildCoverUrl:X,coverSize:w,itemRefs:E,draggable:_,onDragEnd:_?D:void 0,allCollections:_?m:void 0,collectionId:R,onRemoveFromCollection:Q,developerId:H,publisherId:q,onRemoveFromDeveloper:ae,onRemoveFromPublisher:v})})]})]})})})})})})]})}export{Ct as E,Ft as G,Jt as L,Nt as S,Kt as g,Rt as u};
