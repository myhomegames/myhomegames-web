import{r,j as f,u as P}from"./react-vendor-jNdKP8wU.js";import{b as E,C as N,u as R,c as U,f as M,d as O}from"./page-CategoriesPage.tsx-C2Tb3mNy.js";import{A as _,g as T,u as A}from"./page-AddGamePage.tsx-SkGFkz5J.js";import{E as F}from"./page-CollectionDetail.tsx-CcKojBp5.js";import{u as b}from"./i18n-vendor-mPXi0JFR.js";import{c as G,A as D}from"./page-CategoryPage.tsx-DiC0qfaQ.js";function H(e,k=!0){const[u,a]=r.useState(null),[d,p]=r.useState(!1);return r.useEffect(()=>{if(!k||!e){a(null),p(!1);return}p(!0),(async()=>{try{const m=E(_,`/collections/${e}/games`),w=await fetch(m,{headers:{Accept:"application/json","X-Auth-Token":T()}});if(w.ok){const y=((await w.json()).games||[]).some(i=>!!i.command);a(y)}else a(!1)}catch{a(!1)}finally{p(!1)}})()},[e,k]),{hasPlayableGame:u,isLoading:d}}const $=r.createContext(void 0),j="";function Z({children:e}){const[k,u]=r.useState(null),[a,d]=r.useState(null),[p,g]=r.useState(!0),m=async()=>{g(!0);try{const i=new URLSearchParams(window.location.search),t=i.get("twitch_token"),c=i.get("user_id");if(t&&c&&(localStorage.setItem("twitch_token",t),localStorage.setItem("twitch_user_id",c),window.history.replaceState({},document.title,window.location.pathname),await w(t)))return;const l=localStorage.getItem("twitch_token");if(l)if(!localStorage.getItem("twitch_client_id"))localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id");else{if(await w(l))return;localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id")}u(null),d(null)}catch(i){console.error("Auth check error:",i),u(null),d(null)}finally{g(!1)}},w=async i=>{const t=localStorage.getItem("twitch_client_id"),c=j;try{const l={"X-Auth-Token":i};t&&!c&&(l["X-Twitch-Client-Id"]=t);const o=await fetch(`${_}/auth/me`,{headers:l});if(o.ok){const s=await o.json();return u(s),d(i),A(),!0}else{const s=await o.text().catch(()=>"");if(console.error(`Failed to validate token: ${o.status} ${s}`),!c)return localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),u(null),d(null),!1}}catch(l){return console.error("Failed to fetch user info:",l),localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),u(null),d(null),!1}},C=async(i=!1)=>{const t=localStorage.getItem("twitch_client_id"),c=localStorage.getItem("twitch_client_secret");if(!(!t||!c))try{const l=String(t).trim(),o=String(c).trim(),n={clientId:l,clientSecret:o,forceVerify:!!i},h=await fetch(`${_}/auth/twitch`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(h.ok){const v=await h.json();window.location.href=v.authUrl}else{const v=await h.text().catch(()=>"Unknown error");let I;try{I=JSON.parse(v)}catch{I={error:v}}alert(`Errore durante il login: ${I.error||h.statusText}`)}}catch(l){console.error("Login error:",l),l instanceof Error?alert(`Errore durante il login: ${l.message}`):alert("Errore durante il login: Si Ã¨ verificato un errore sconosciuto")}},S=()=>{localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),localStorage.removeItem("twitch_client_id"),localStorage.removeItem("twitch_client_secret"),u(null),d(null),A(),a&&fetch(`${_}/auth/logout`,{method:"POST",headers:{"X-Auth-Token":a}}).catch(console.error)};r.useEffect(()=>{m()},[]);const y={user:k,token:a,isLoading:p,login:C,logout:S,checkAuth:m};return f.jsx($.Provider,{value:y,children:e})}function X(){const e=r.useContext($);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e}function B({collection:e,onCollectionClick:k,onPlay:u,onEditClick:a,onCollectionDelete:d,onCollectionUpdate:p,buildCoverUrl:g,coverSize:m,itemRefs:w}){const{t:C}=b(),S=m*1.5,{hasPlayableGame:y}=H(e.id,!0),i=async()=>{if(u)try{const t=E(_,`/collections/${e.id}/games`),c=await fetch(t,{headers:{Accept:"application/json","X-Auth-Token":T()}});if(c.ok){const s=((await c.json()).games||[]).find(n=>!!n.command);if(s){const n={id:s.id,title:s.title,summary:s.summary||"",cover:s.cover,day:s.day||null,month:s.month||null,year:s.year||null,stars:s.stars||null,genre:s.genre||null,command:s.command||null};u(n)}}}catch(t){console.error("Error fetching collection games for play:",t)}};return f.jsx("div",{ref:t=>{t&&w?.current&&w.current.set(e.id,t)},className:"group cursor-pointer collections-list-item",style:{width:`${m}px`,minWidth:`${m}px`},children:f.jsx(N,{title:e.title,coverUrl:g(_,e.cover,!0),width:m,height:S,onPlay:u?i:void 0,onClick:()=>k(e),onEdit:()=>a(e),collectionId:e.id,collectionTitle:e.title,onCollectionDelete:d?t=>{e.id===t&&d(e)}:void 0,onCollectionUpdate:p?t=>{const c={id:t.id,title:t.title,summary:t.summary,cover:t.cover,gameCount:e.gameCount};c.id===e.id&&p(c)}:void 0,showTitle:!0,subtitle:e.gameCount!==void 0?`${e.gameCount} ${C("common.elements")}`:void 0,detail:!0,play:y===!0,showBorder:!0},`${e.id}-${e.cover}`)},e.id)}function V({collections:e,onCollectionClick:k,onPlay:u,onCollectionUpdate:a,onCollectionDelete:d,buildCoverUrl:p,coverSize:g=150,itemRefs:m}){const{t:w}=b(),[C,S]=r.useState(!1),[y,i]=r.useState(null);if(e.length===0)return f.jsx("div",{className:"text-gray-400 text-center",children:w("table.noGames")});const t=o=>{const s={id:o.id,title:o.title,summary:o.summary,cover:o.cover,background:o.background};i(s),S(!0)},c=()=>{S(!1),i(null)},l=o=>{if(a){const s={id:o.id,title:o.title,summary:o.summary,cover:o.cover,background:o.background};a(s)}c()};return f.jsxs(f.Fragment,{children:[f.jsx("div",{className:"collections-list-container",style:{gridTemplateColumns:`repeat(auto-fill, ${g}px)`},children:e.map(o=>f.jsx(B,{collection:o,onCollectionClick:k,onPlay:u,onEditClick:t,onCollectionDelete:d,onCollectionUpdate:a,buildCoverUrl:p,coverSize:g,itemRefs:m},o.id))}),y&&f.jsx(F,{isOpen:C,onClose:c,collection:y,onCollectionUpdate:l})]})}function z({onPlay:e,coverSize:k}){const{setLoading:u,isLoading:a}=R(),{isLoading:d}=X(),p=P(),[g,m]=r.useState([]),[w,C]=r.useState(!1),[S]=r.useState(!0),y=r.useRef(null),i=r.useRef(new Map);U(y),r.useEffect(()=>{d||t()},[d]),r.useEffect(()=>{const n=()=>{t()};return window.addEventListener("metadataReloaded",n),()=>{window.removeEventListener("metadataReloaded",n)}},[]),r.useLayoutEffect(()=>{!a&&g.length>0?requestAnimationFrame(()=>{requestAnimationFrame(()=>{C(!0)})}):a&&C(!1)},[a,g.length]);async function t(){u(!0);try{const n=E(_,"/collections"),h=await fetch(n,{headers:M({Accept:"application/json"})});if(!h.ok)throw new Error(`HTTP ${h.status}`);const L=((await h.json()).collections||[]).map(x=>({id:x.id,title:x.title,summary:x.summary,cover:x.cover,background:x.background,gameCount:x.gameCount}));m(L)}catch(n){const h=String(n.message||n);console.error("Error fetching collections:",h)}finally{u(!1)}}function c(n){p(`/collections/${n.id}`)}const l=n=>{m(h=>h.map(v=>String(v.id)===String(n.id)?n:v)),window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collection:n}}))},o=n=>{m(h=>h.filter(v=>v.id!==n.id))},s=r.useMemo(()=>{const n=[...g];return n.sort((h,v)=>{const I=G(h.title||"",v.title||"");return S?I:-I}),n},[g,S]);return f.jsx("main",{className:"flex-1 home-page-content",children:f.jsxs("div",{className:"home-page-layout",children:[f.jsx("div",{className:"home-page-content-wrapper",style:{opacity:w?1:0,transition:"opacity 0.2s ease-in-out"},children:f.jsx("div",{ref:y,className:"home-page-scroll-container",children:!a&&f.jsx(V,{collections:s,onCollectionClick:c,onPlay:e,onCollectionUpdate:l,onCollectionDelete:o,buildCoverUrl:O,coverSize:k,itemRefs:i})})}),w&&f.jsx(D,{games:s,scrollContainerRef:y,itemRefs:i,ascending:S})]})})}export{Z as A,z as C,H as a,X as u};
