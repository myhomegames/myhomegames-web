import{r as s,j as n,b as Y,c as $e,u as Ue}from"./react-vendor-jNdKP8wU.js";import{g as O,a as Fe,A,u as we}from"./page-AddGamePage.tsx-SkGFkz5J.js";import{u as B}from"./i18n-vendor-mPXi0JFR.js";function U(t,r,a={}){const w=new URL(r,t);return Object.entries(a).forEach(([d,y])=>w.searchParams.set(d,String(y))),w.toString()}function te(t={}){const r=O(),a={...t};if(r){a["X-Auth-Token"]=r;const w=Fe();w&&(a["X-Twitch-Client-Id"]=w)}return a}function st(t,r,a){if(!r)return"";if(r.startsWith("http://")||r.startsWith("https://"))return r;if(r.includes("?t=")||r.includes("&t=")){const y=r.split("?")[0],i=r.includes("?")?r.substring(r.indexOf("?")):"",x=new URL(y,t);return i&&new URLSearchParams(i).forEach((p,C)=>{x.searchParams.set(C,p)}),x.toString()}const d=new URL(r,t);return a&&d.searchParams.set("t",Date.now().toString()),d.toString()}function Oe(t,r,a,w){let d;if(a&&a.trim()!==""){if(a.startsWith("http://")||a.startsWith("https://"))return a;d=a}else d=`/categories/${r}/cover.webp`;if(d.includes("?t=")||d.includes("&t=")){const x=d.split("?")[0],e=d.includes("?")?d.substring(d.indexOf("?")):"",p=new URL(x,t);return e&&new URLSearchParams(e).forEach((m,u)=>{p.searchParams.set(u,m)}),p.toString()}return new URL(d,t).toString()}function rt(t,r,a){if(!r)return"";if(r.startsWith("http://")||r.startsWith("https://"))return r;if(r.includes("?t=")||r.includes("&t=")){const y=r.split("?")[0],i=r.includes("?")?r.substring(r.indexOf("?")):"",x=new URL(y,t);return i&&new URLSearchParams(i).forEach((p,C)=>{x.searchParams.set(C,p)}),x.toString()}const d=new URL(r,t);return a&&d.searchParams.set("t",Date.now().toString()),d.toString()}function at(){const[t,r]=s.useState(!1),[a,w]=s.useState(null);return{isEditModalOpen:t,selectedGame:a,openEditModal:i=>{w(i),r(!0)},closeEditModal:()=>{r(!1),w(null)}}}const ye=s.createContext(void 0);function it({children:t}){const[r,a]=s.useState(!1),w=s.useCallback(y=>{a(y)},[]),d=s.useMemo(()=>({isLoading:r,setLoading:w}),[r,w]);return n.jsx(ye.Provider,{value:d,children:t})}function H(){const t=s.useContext(ye);if(t===void 0)throw new Error("useLoading must be used within a LoadingProvider");return t}function We({gameId:t,collectionId:r,onGameDelete:a,onCollectionDelete:w,onModalClose:d}){const{t:y}=B(),{setLoading:i}=H(),[x,e]=s.useState(!1),[p,C]=s.useState(null),[m,u]=s.useState(!1);return{isDeleting:x,deleteError:p,showConfirmModal:m,handleDeleteClick:()=>{u(!0)},handleConfirmDelete:async()=>{const h=O();if(h){e(!0),C(null),i(!0);try{let l,L=[];if(t){try{const c=U(A,"/collections"),o=await fetch(c,{headers:{Accept:"application/json","X-Auth-Token":h}});if(o.ok){const j=(await o.json()).collections||[];for(const R of j){const g=U(A,`/collections/${R.id}/games`),E=await fetch(g,{headers:{Accept:"application/json","X-Auth-Token":h}});E.ok&&((await E.json()).games||[]).map(P=>String(P.id)).includes(String(t))&&L.push(String(R.id))}}}catch(c){console.error("Error finding collections for game before deletion:",c)}l=U(A,`/games/${t}`)}else if(r)l=U(A,`/collections/${r}`);else return;(await fetch(l,{method:"DELETE",headers:{"X-Auth-Token":h}})).ok?(t&&a?a(t):r&&w&&w(r),t?(window.dispatchEvent(new CustomEvent("gameDeleted",{detail:{gameId:t}})),L.forEach(c=>{window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collectionId:c}}))})):r&&window.dispatchEvent(new CustomEvent("collectionDeleted",{detail:{collectionId:r}})),u(!1),d&&d()):C(y("common.deleteError"))}catch(l){console.error("Error deleting item:",l),C(y("common.deleteError"))}finally{e(!1),i(!1)}}},handleCancelDelete:()=>{u(!1),C(null),d&&d()}}}function qe({gameId:t,collectionId:r,onGameUpdate:a,onCollectionUpdate:w,onReload:d,onModalClose:y}){const{t:i}=B(),{setLoading:x}=H(),[e,p]=s.useState(!1),[C,m]=s.useState(null),[u,S]=s.useState(!1),v=async()=>{const L=O();if(L){p(!0),m(null),x(!0);try{let k;t?k=U(A,`/games/${t}/reload`):r?k=U(A,`/collections/${r}/reload`):k=U(A,"/reload-games");const c=await fetch(k,{method:"POST",headers:{"X-Auth-Token":L}});if(c.ok){const o=await c.json();if(t)if(a&&o.game){const f={id:o.game.id,title:o.game.title,summary:o.game.summary||"",cover:o.game.cover,background:o.game.background,day:o.game.day||null,month:o.game.month||null,year:o.game.year||null,stars:o.game.stars||null,genre:o.game.genre||null,executables:o.game.executables||null,criticratings:o.game.criticratings||null,userratings:o.game.userratings||null,themes:o.game.themes||null,platforms:o.game.platforms||null,gameModes:o.game.gameModes||null,playerPerspectives:o.game.playerPerspectives||null,websites:o.game.websites||null,ageRatings:o.game.ageRatings||null,developers:o.game.developers||null,publishers:o.game.publishers||null,franchise:o.game.franchise||null,collection:o.game.collection||null,screenshots:o.game.screenshots||null,videos:o.game.videos||null,gameEngines:o.game.gameEngines||null,keywords:o.game.keywords||null,alternativeNames:o.game.alternativeNames||null,similarGames:o.game.similarGames||null};a(f),p(!1),x(!1);return}else{p(!1),x(!1);return}else if(r)if(w&&o.collection){const f={id:o.collection.id,title:o.collection.title,summary:o.collection.summary||"",cover:o.collection.cover,background:o.collection.background};w(f),p(!1),x(!1);return}else{p(!1),x(!1);return}else if(d)await d(),p(!1),x(!1);else{const f=window.location.pathname;window.location.href=f}}else console.error("Failed to reload metadata"),m(i("common.reloadError","Failed to reload metadata")),p(!1),x(!1)}catch(k){console.error("Error reloading metadata:",k),m(i("common.reloadError","Failed to reload metadata")),p(!1),x(!1)}}};return{isReloading:e,reloadError:C,showReloadConfirmModal:u,handleReloadClick:()=>{S(!0)},handleConfirmReload:async()=>{d?d():await v(),S(!1)},handleCancelReload:()=>{S(!1),m(null),y&&y()}}}function Ie({gameId:t,onGameUpdate:r}){const{setLoading:a}=H(),[w,d]=s.useState(!1);return{isUnlinking:w,handleUnlinkExecutable:async()=>{d(!0),a(!0);try{const i=U(A,`/games/${t}`),x=await fetch(i,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":O()},body:JSON.stringify({executables:null})});if(x.ok){const e=await x.json(),p={id:e.game.id,title:e.game.title,summary:e.game.summary||"",cover:e.game.cover,background:e.game.background,day:e.game.day??null,month:e.game.month??null,year:e.game.year??null,stars:e.game.stars??null,genre:e.game.genre??null,criticratings:e.game.criticratings??null,userratings:e.game.userratings??null,themes:e.game.themes??null,platforms:e.game.platforms??null,gameModes:e.game.gameModes??null,playerPerspectives:e.game.playerPerspectives??null,websites:e.game.websites??null,ageRatings:e.game.ageRatings??null,developers:e.game.developers??null,publishers:e.game.publishers??null,franchise:e.game.franchise??null,collection:e.game.collection??null,screenshots:e.game.screenshots??null,videos:e.game.videos??null,gameEngines:e.game.gameEngines??null,keywords:e.game.keywords??null,alternativeNames:e.game.alternativeNames??null,similarGames:e.game.similarGames??null};"executables"in p&&delete p.executables,r(p)}else console.error("Failed to unlink executable")}catch(i){console.error("Error unlinking executable:",i)}finally{d(!1),a(!1)}}}}function lt({game:t,onGameUpdate:r}){const{t:a}=B(),{setLoading:w}=H(),[d,y]=s.useState(!1),[i,x]=s.useState(!1),e=s.useRef(null);return{isUploading:d,isUnlinking:i,fileInputRef:e,handleFileSelect:async u=>{const S=u.name.toLowerCase();if(!S.endsWith(".sh")&&!S.endsWith(".bat")){alert(a("gameDetail.invalidFileType","Only .sh and .bat files are allowed"));return}y(!0),w(!0);try{const v=new FormData;v.append("file",u);const b=U(A,`/games/${t.id}/upload-executable`),h=await fetch(b,{method:"POST",headers:{"X-Auth-Token":O()||""},body:v});if(!h.ok){const L=await h.json().catch(()=>({error:"Failed to upload file"}));throw new Error(L.error||"Failed to upload file")}const l=await h.json();if(l.game){const L={...t,id:l.game.id,title:l.game.title,summary:l.game.summary||"",cover:l.game.cover,background:l.game.background,day:l.game.day??t.day??null,month:l.game.month??t.month??null,year:l.game.year??t.year??null,stars:l.game.stars??t.stars??null,genre:l.game.genre??t.genre??null,criticratings:l.game.criticratings??t.criticratings??null,userratings:l.game.userratings??t.userratings??null,executables:l.game.executables??t.executables??null,themes:l.game.themes??t.themes??null,platforms:l.game.platforms??t.platforms??null,gameModes:l.game.gameModes??t.gameModes??null,playerPerspectives:l.game.playerPerspectives??t.playerPerspectives??null,websites:l.game.websites??t.websites??null,ageRatings:l.game.ageRatings??t.ageRatings??null,developers:l.game.developers??t.developers??null,publishers:l.game.publishers??t.publishers??null,franchise:l.game.franchise??t.franchise??null,collection:l.game.collection??t.collection??null,screenshots:l.game.screenshots??t.screenshots??null,videos:l.game.videos??t.videos??null,gameEngines:l.game.gameEngines??t.gameEngines??null,keywords:l.game.keywords??t.keywords??null,alternativeNames:l.game.alternativeNames??t.alternativeNames??null,similarGames:l.game.similarGames??t.similarGames??null};r(L)}}catch(v){console.error("Error uploading file:",v),alert(v.message||a("common.error","Error"))}finally{y(!1),w(!1)}},handleBrowseClick:()=>{e.current?.click()},handleUnlinkExecutable:async()=>{x(!0),w(!0);try{const u=U(A,`/games/${t.id}`),S=await fetch(u,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":O()},body:JSON.stringify({executables:null})});if(S.ok){const v=await S.json(),b={...t,id:v.game.id,title:v.game.title,summary:v.game.summary||"",cover:v.game.cover,background:v.game.background,day:v.game.day??t.day??null,month:v.game.month??t.month??null,year:v.game.year??t.year??null,stars:v.game.stars??t.stars??null,genre:v.game.genre??t.genre??null,criticratings:v.game.criticratings??t.criticratings??null,userratings:v.game.userratings??t.userratings??null,themes:v.game.themes??t.themes??null,platforms:v.game.platforms??t.platforms??null,gameModes:v.game.gameModes??t.gameModes??null,playerPerspectives:v.game.playerPerspectives??t.playerPerspectives??null,websites:v.game.websites??t.websites??null,ageRatings:v.game.ageRatings??t.ageRatings??null,developers:v.game.developers??t.developers??null,publishers:v.game.publishers??t.publishers??null,franchise:v.game.franchise??t.franchise??null,collection:v.game.collection??t.collection??null,screenshots:v.game.screenshots??t.screenshots??null,videos:v.game.videos??t.videos??null,gameEngines:v.game.gameEngines??t.gameEngines??null,keywords:v.game.keywords??t.keywords??null,alternativeNames:v.game.alternativeNames??t.alternativeNames??null,similarGames:v.game.similarGames??t.similarGames??null};"executables"in b&&delete b.executables,r(b)}else console.error("Failed to unlink executable")}catch(u){console.error("Error unlinking executable:",u)}finally{x(!1),w(!1)}}}}function ct({onGameAdded:t,onError:r}={}){const{setLoading:a}=H(),[w,d]=s.useState(!1),[y,i]=s.useState(null);return{isAdding:w,addError:y,addGame:async e=>{const p=O();if(!p){const C="Authentication required";return i(C),r&&r(C),null}d(!0),i(null),a(!0);try{const C=U(A,"/games/add-from-igdb"),m=await fetch(C,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Auth-Token":p},body:JSON.stringify({igdbId:e.id,name:e.name,summary:e.summary,cover:e.cover,background:e.background,releaseDate:e.releaseDateFull?.timestamp||e.releaseDate,genres:e.genres,criticRating:e.criticRating,userRating:e.userRating,themes:e.themes,platforms:e.platforms,gameModes:e.gameModes,playerPerspectives:e.playerPerspectives,websites:e.websites,ageRatings:e.ageRatings,developers:e.developers,publishers:e.publishers,franchise:e.franchise,collection:e.collection,screenshots:e.screenshots,videos:e.videos,gameEngines:e.gameEngines,keywords:e.keywords,alternativeNames:e.alternativeNames,similarGames:e.similarGames})});if(!m.ok){const h=(await m.json().catch(()=>({}))).error||`HTTP ${m.status}`;return i(h),r&&r(h),null}const u=await m.json(),S=u.gameId||u.game?.id,v={id:String(S),title:u.game?.title||e.name,summary:u.game?.summary||e.summary||"",cover:u.game?.cover||e.cover||"",background:u.game?.background||e.background||void 0,day:u.game?.day||e.releaseDateFull?.day||null,month:u.game?.month||e.releaseDateFull?.month||null,year:u.game?.year||e.releaseDateFull?.year||e.releaseDate||null,stars:u.game?.stars||null,genre:u.game?.genre||e.genres||null,criticratings:u.game?.criticratings||(e.criticRating?e.criticRating/10:null),userratings:u.game?.userratings||(e.userRating?e.userRating/10:null),executables:u.game?.executables||null,themes:u.game?.themes||e.themes||null,platforms:u.game?.platforms||e.platforms||null,gameModes:u.game?.gameModes||e.gameModes||null,playerPerspectives:u.game?.playerPerspectives||e.playerPerspectives||null,websites:u.game?.websites||e.websites||null,ageRatings:u.game?.ageRatings||e.ageRatings||null,developers:u.game?.developers||e.developers||null,publishers:u.game?.publishers||e.publishers||null,franchise:u.game?.franchise||e.franchise||null,collection:u.game?.collection||e.collection||null,screenshots:u.game?.screenshots||e.screenshots||null,videos:u.game?.videos||e.videos||null,gameEngines:u.game?.gameEngines||e.gameEngines||null,keywords:u.game?.keywords||e.keywords||null,alternativeNames:u.game?.alternativeNames||e.alternativeNames||null,similarGames:u.game?.similarGames||e.similarGames||null};return window.dispatchEvent(new CustomEvent("gameAdded",{detail:{game:v}})),t&&t(v),v}catch(C){const m=C.message||"Failed to add game";return console.error("Error adding game:",C),i(m),r&&r(m),null}finally{d(!1),a(!1)}}}}const xe=s.createContext(void 0),me="";function dt({children:t}){const[r,a]=s.useState(null),[w,d]=s.useState(null),[y,i]=s.useState(!0),x=async()=>{i(!0);try{const u=new URLSearchParams(window.location.search),S=u.get("twitch_token"),v=u.get("user_id");if(S&&v&&(localStorage.setItem("twitch_token",S),localStorage.setItem("twitch_user_id",v),window.history.replaceState({},document.title,window.location.pathname),await e(S)))return;const b=localStorage.getItem("twitch_token");if(b)if(!localStorage.getItem("twitch_client_id"))localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id");else{if(await e(b))return;localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id")}a(null),d(null)}catch(u){console.error("Auth check error:",u),a(null),d(null)}finally{i(!1)}},e=async u=>{const S=localStorage.getItem("twitch_client_id"),v=me;try{const b={"X-Auth-Token":u};S&&!v&&(b["X-Twitch-Client-Id"]=S);const h=await fetch(`${A}/auth/me`,{headers:b});if(h.ok){const l=await h.json();return a(l),d(u),we(),!0}else{const l=await h.text().catch(()=>"");if(console.error(`Failed to validate token: ${h.status} ${l}`),!v)return localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),a(null),d(null),!1}}catch(b){return console.error("Failed to fetch user info:",b),localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),a(null),d(null),!1}},p=async(u=!1)=>{const S=localStorage.getItem("twitch_client_id"),v=localStorage.getItem("twitch_client_secret");if(!(!S||!v))try{const b=String(S).trim(),h=String(v).trim(),L={clientId:b,clientSecret:h,forceVerify:!!u},k=await fetch(`${A}/auth/twitch`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(L)});if(k.ok){const c=await k.json();window.location.href=c.authUrl}else{const c=await k.text().catch(()=>"Unknown error");let o;try{o=JSON.parse(c)}catch{o={error:c}}alert(`Errore durante il login: ${o.error||k.statusText}`)}}catch(b){console.error("Login error:",b),b instanceof Error?alert(`Errore durante il login: ${b.message}`):alert("Errore durante il login: Si è verificato un errore sconosciuto")}},C=()=>{localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),localStorage.removeItem("twitch_client_id"),localStorage.removeItem("twitch_client_secret"),a(null),d(null),we(),w&&fetch(`${A}/auth/logout`,{method:"POST",headers:{"X-Auth-Token":w}}).catch(console.error)};s.useEffect(()=>{x()},[]);const m={user:r,token:w,isLoading:y,login:p,logout:C,checkAuth:x};return n.jsx(xe.Provider,{value:m,children:t})}function fe(){const t=s.useContext(xe);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t}const Ee=s.createContext(void 0);function ut({children:t}){const[r,a]=s.useState([]),[w,d]=s.useState(!1),[y,i]=s.useState(null),[x,e]=s.useState(new Map),{isLoading:p,token:C}=fe(),m=s.useCallback(async()=>{if(!(p||!(O()||C))){d(!0),i(null);try{const o=U(A,"/collections"),f=await fetch(o,{headers:te({Accept:"application/json"})});if(!f.ok)throw new Error(`HTTP ${f.status}`);const g=((await f.json()).collections||[]).map(E=>({id:String(E.id),title:E.title,summary:E.summary,cover:E.cover,background:E.background,gameCount:E.gameCount}));a(g)}catch(o){const f=String(o.message||o);console.error("Error fetching collections:",f),i(f)}finally{d(!1)}}},[p,C]);s.useEffect(()=>{p||m()},[p,m]),s.useEffect(()=>{const c=j=>{const R=j,g=R.detail?.collection,E=R.detail?.collectionId;g?a(T=>T.map(N=>String(N.id)===String(g.id)?g:N)):E&&(m(),(async()=>{try{const N=U(A,`/collections/${E}/games`),P=await fetch(N,{headers:te({Accept:"application/json"})});if(P.ok){const I=((await P.json()).games||[]).map(F=>String(F.id));e(F=>{const X=new Map(F);return X.set(String(E),I),X})}}catch(N){console.error(`Error reloading games for collection ${E}:`,N.message),e(P=>{const q=new Map(P);return q.delete(String(E)),q})}})())},o=j=>{const g=j.detail?.collectionId;g&&(a(E=>E.filter(T=>String(T.id)!==String(g))),e(E=>{const T=new Map(E);return T.delete(String(g)),T}))},f=()=>{m()};return window.addEventListener("collectionUpdated",c),window.addEventListener("collectionDeleted",o),window.addEventListener("metadataReloaded",f),()=>{window.removeEventListener("collectionUpdated",c),window.removeEventListener("collectionDeleted",o),window.removeEventListener("metadataReloaded",f)}},[m]);const u=s.useCallback(async()=>{await m()},[m]),S=s.useCallback(c=>{a(o=>{if(o.some(j=>String(j.id)===String(c.id)))return o;const f=[...o,c];return f.sort((j,R)=>(j.title||"").localeCompare(R.title||"")),f})},[]),v=s.useCallback(c=>{a(o=>o.map(f=>String(f.id)===String(c.id)?c:f))},[]),b=s.useCallback(c=>{a(o=>o.filter(f=>String(f.id)!==String(c))),e(o=>{const f=new Map(o);return f.delete(String(c)),f})},[]),h=s.useCallback((c,o)=>{e(f=>{const j=new Map(f),R=String(c),g=j.get(R)||[];return g.includes(o)||j.set(R,[...g,o]),j})},[]),l=s.useCallback((c,o)=>{e(f=>{const j=new Map(f),R=String(c),g=j.get(R)||[];return j.set(R,g.filter(E=>E!==o)),j})},[]),L=s.useCallback(async c=>{const o=x.get(String(c));if(o)return o;try{const f=U(A,`/collections/${c}/games`),j=await fetch(f,{headers:te({Accept:"application/json"})});if(j.ok){const g=((await j.json()).games||[]).map(E=>String(E.id));return e(E=>{const T=new Map(E);return T.set(String(c),g),T}),g}}catch(f){console.error(`Error fetching games for collection ${c}:`,f.message)}return[]},[x]),k=s.useMemo(()=>({collections:r,isLoading:w,error:y,refreshCollections:u,addCollection:S,updateCollection:v,removeCollection:b,getCollectionGameIds:L,collectionGameIds:x,addGameToCollectionCache:h,removeGameFromCollectionCache:l}),[r,w,y,u,S,v,b,L,x,h,l]);return n.jsx(Ee.Provider,{value:k,children:t})}function ce(){const t=s.useContext(Ee);if(t===void 0)throw new Error("useCollections must be used within a CollectionsProvider");return t}function ke({onSuccess:t,onError:r}={}){const{t:a}=B(),{setLoading:w}=H(),{addGameToCollectionCache:d}=ce(),[y,i]=s.useState(!1);return{isAdding:y,addGameToCollection:async(e,p)=>{const C=O();if(!C){r?.(a("common.unauthorized","Unauthorized"));return}i(!0),w(!0);try{const m=U(A,`/collections/${p}/games`),u=await fetch(m,{headers:{Accept:"application/json","X-Auth-Token":C}});if(!u.ok)throw new Error(`Failed to fetch collection games: ${u.status}`);const v=((await u.json()).games||[]).map(k=>String(k.id));if(v.includes(String(e))){r?.(a("collections.gameAlreadyInCollection","Game is already in this collection"));return}const b=[...v,String(e)],h=U(A,`/collections/${p}/games/order`),l=await fetch(h,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":C},body:JSON.stringify({gameIds:b})});if(!l.ok){const k=await l.json().catch(()=>({}));throw new Error(k.error||`Failed to add game to collection: ${l.status}`)}d(p,String(e)),window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collectionId:p}}));const L=JSON.parse(localStorage.getItem("recentCollections")||"[]");if(!L.includes(p)){L.unshift(p);const k=L.slice(0,10);localStorage.setItem("recentCollections",JSON.stringify(k))}t?.()}catch(m){const u=String(m.message||m);console.error("Error adding game to collection:",u),r?.(u)}finally{i(!1),w(!1)}}}}function Be({onSuccess:t,onError:r}={}){const{t:a}=B(),{setLoading:w}=H(),{removeGameFromCollectionCache:d}=ce(),[y,i]=s.useState(!1);return{isRemoving:y,removeGameFromCollection:async(e,p)=>{const C=O();if(!C){r?.(a("common.unauthorized","Unauthorized"));return}i(!0),w(!0);try{const m=U(A,`/collections/${p}/games`),u=await fetch(m,{headers:{Accept:"application/json","X-Auth-Token":C}});if(!u.ok)throw new Error(`Failed to fetch collection games: ${u.status}`);const b=((await u.json()).games||[]).map(L=>String(L.id)).filter(L=>L!==String(e)),h=U(A,`/collections/${p}/games/order`),l=await fetch(h,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":C},body:JSON.stringify({gameIds:b})});if(!l.ok){const L=await l.json().catch(()=>({}));throw new Error(L.error||`Failed to remove game from collection: ${l.status}`)}d(p,String(e)),window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collectionId:p}})),t?.()}catch(m){const u=String(m.message||m);console.error("Error removing game from collection:",u),r?.(u)}finally{i(!1),w(!1)}}}}function _e({onSuccess:t,onError:r}={}){const{t:a}=B(),{setLoading:w}=H(),[d,y]=s.useState(!1);return{isCreating:d,createCollection:async(x,e)=>{const p=O();if(!p)return r?.(a("common.unauthorized","Unauthorized")),null;if(!x||x.trim()==="")return r?.(a("collections.titleRequired","Collection title is required")),null;y(!0),w(!0);try{const C=U(A,"/collections"),m=await fetch(C,{method:"POST",headers:{"Content-Type":"application/json","X-Auth-Token":p},body:JSON.stringify({title:x.trim(),summary:e?.trim()||""})});if(!m.ok){const v=await m.json().catch(()=>({}));throw new Error(v.error||`Failed to create collection: ${m.status}`)}const u=await m.json(),S={id:u.collection.id,title:u.collection.title,summary:u.collection.summary,cover:u.collection.cover,gameCount:0};return window.dispatchEvent(new CustomEvent("collectionAdded",{detail:{collection:S}})),t?.(S),S}catch(C){const m=String(C.message||C);return console.error("Error creating collection:",m),r?.(m),null}finally{y(!1),w(!1)}}}}function be({text:t,delay:r=1e3,children:a}){const[w,d]=s.useState(!1),[y,i]=s.useState({}),x=s.useRef(null),e=s.useRef(null);s.useEffect(()=>()=>{e.current&&clearTimeout(e.current)},[]),s.useEffect(()=>{if(!w)return;const m=()=>{e.current&&(clearTimeout(e.current),e.current=null),d(!1)};return document.addEventListener("click",m,!0),()=>{document.removeEventListener("click",m,!0)}},[w]);const p=()=>{e.current&&clearTimeout(e.current),e.current=window.setTimeout(()=>{if(x.current){const m=x.current.getBoundingClientRect();i({position:"fixed",top:`${m.bottom+8}px`,left:`${m.left}px`,zIndex:99999}),d(!0)}},r)},C=()=>{e.current&&(clearTimeout(e.current),e.current=null),d(!1)};return n.jsxs(n.Fragment,{children:[n.jsx("div",{ref:x,className:"tooltip-wrapper",onMouseEnter:p,onMouseLeave:C,children:a}),w&&Y.createPortal(n.jsx("span",{className:"tooltip tooltip-portal",style:y,children:t}),document.body)]})}function He({onEdit:t,onDelete:r,onReload:a,onAddToCollection:w,onRemoveFromCollection:d,onManageInstallation:y,gameId:i,gameTitle:x,gameExecutables:e,onGameDelete:p,onGameUpdate:C,collectionId:m,collectionTitle:u,onCollectionDelete:S,onCollectionUpdate:v,className:b="",horizontal:h=!1,onModalOpen:l,onModalClose:L,toolTipDelay:k=0}){const{t:c}=B(),[o,f]=s.useState(!1),j=s.useRef(null),R=s.useRef(null),g=We({gameId:i,collectionId:m,onGameDelete:p,onCollectionDelete:S,onModalClose:L}),E=qe({gameId:i,collectionId:m,onGameUpdate:C,onCollectionUpdate:v,onReload:a,onModalClose:L}),T=i&&C?Ie({gameId:i,onGameUpdate:C}):{isUnlinking:!1,handleUnlinkExecutable:async()=>{}},N=Be({onSuccess:()=>{d&&d()},onError:M=>{console.error("Error removing game from collection:",M)}}),P=b.includes("games-list-dropdown-menu"),[q,I]=s.useState(!1);s.useEffect(()=>{if(o&&j.current){const M=j.current.closest(".search-dropdown-scroll");I(!!M)}else I(!1)},[o]),s.useEffect(()=>{!o&&i?(window.dispatchEvent(new CustomEvent("closeAddToCollectionDropdown",{detail:{gameId:i}})),window.dispatchEvent(new CustomEvent("closeAdditionalExecutablesDropdown",{detail:{gameId:i}})),window.dispatchEvent(new CustomEvent("dropdownMenuClosed",{detail:{gameId:i}}))):!o&&m&&window.dispatchEvent(new CustomEvent("dropdownMenuClosed",{detail:{collectionId:m}}))},[o,i,m]),s.useEffect(()=>{if(!o)return;function M(se){const V=se.target;j.current&&j.current.contains(V)||R.current&&R.current.contains(V)||V.closest(".dropdown-menu-popup")||V.closest(".add-to-collection-dropdown-menu")||V.closest(".additional-executables-dropdown-menu")||f(!1)}const D=setTimeout(()=>{document.addEventListener("mousedown",M,!0)},100);return()=>{clearTimeout(D),document.removeEventListener("mousedown",M,!0)}},[o]),s.useEffect(()=>(g.showConfirmModal||E.showReloadConfirmModal?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[g.showConfirmModal,E.showReloadConfirmModal]),s.useEffect(()=>{if(!g.showConfirmModal&&!E.showReloadConfirmModal)return;function M(D){D.key==="Escape"&&(g.showConfirmModal&&g.handleCancelDelete(),E.showReloadConfirmModal&&E.handleCancelReload())}return document.addEventListener("keydown",M),()=>{document.removeEventListener("keydown",M)}},[g.showConfirmModal,E.showReloadConfirmModal,g,E]);const F=M=>{M.stopPropagation();const D=!o;f(D),i?D?window.dispatchEvent(new CustomEvent("dropdownMenuOpened",{detail:{gameId:i}})):window.dispatchEvent(new CustomEvent("dropdownMenuClosed",{detail:{gameId:i}})):m&&(D?window.dispatchEvent(new CustomEvent("dropdownMenuOpened",{detail:{collectionId:m}})):window.dispatchEvent(new CustomEvent("dropdownMenuClosed",{detail:{collectionId:m}})))},X=M=>{M.stopPropagation(),f(!1),l&&l(),t&&t()},z=M=>{const D=M.currentTarget;window.dispatchEvent(new CustomEvent("openAddToCollectionDropdown",{detail:{gameId:i,menuItem:D}}))},_=M=>{const D=M.relatedTarget;D&&!D.closest(".add-to-collection-dropdown-menu")&&window.dispatchEvent(new CustomEvent("closeAddToCollectionDropdown",{detail:{gameId:i}}))},W=()=>{window.dispatchEvent(new CustomEvent("closeAddToCollectionDropdown",{detail:{gameId:i}})),window.dispatchEvent(new CustomEvent("closeAdditionalExecutablesDropdown",{detail:{gameId:i}}))},ne=()=>{window.dispatchEvent(new CustomEvent("openAdditionalExecutablesDropdown",{detail:{gameId:i}}))},J=M=>{const D=M.relatedTarget;D&&!D.closest(".additional-executables-dropdown-menu")&&window.dispatchEvent(new CustomEvent("closeAdditionalExecutablesDropdown",{detail:{gameId:i}}))},Q=M=>{const D=M.relatedTarget;D&&!D.closest(".dropdown-menu-popup")&&!D.closest(".add-to-collection-dropdown-menu")&&window.dispatchEvent(new CustomEvent("closeAddToCollectionDropdown",{detail:{gameId:i}}))},G=M=>{M.stopPropagation(),f(!1),i&&x||m&&u?(l&&l(),g.handleDeleteClick()):r&&r()},de=M=>{if(M.stopPropagation(),M.preventDefault(),f(!1),i||m){a?a():E.handleConfirmReload();return}setTimeout(()=>{l&&l(),E.handleReloadClick()},0)},oe=async M=>{M.stopPropagation(),f(!1),await T.handleUnlinkExecutable()},Z=n.jsx("button",{onClick:F,className:"dropdown-menu-button","aria-label":"Menu",children:h?n.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("circle",{cx:"5",cy:"12",r:"1"}),n.jsx("circle",{cx:"12",cy:"12",r:"1"}),n.jsx("circle",{cx:"19",cy:"12",r:"1"})]}):n.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("circle",{cx:"12",cy:"5",r:"1"}),n.jsx("circle",{cx:"12",cy:"12",r:"1"}),n.jsx("circle",{cx:"12",cy:"19",r:"1"})]})});return n.jsxs("div",{className:`dropdown-menu-wrapper ${b}`,ref:j,children:[k>0?n.jsx(be,{text:c("common.more","More"),delay:k,children:Z}):Z,o&&(()=>{const M=n.jsxs("div",{ref:R,className:`dropdown-menu-popup ${q?"dropdown-menu-popup-in-search":""}`,onMouseLeave:Q,style:(()=>{if(j.current){if(P){const D=j.current.getBoundingClientRect();return{position:"fixed",bottom:`${window.innerHeight-D.top+4}px`,right:`${window.innerWidth-D.right}px`,top:"auto"}}if(q){const D=j.current.getBoundingClientRect();return{position:"fixed",top:`${D.bottom+4}px`,right:`${window.innerWidth-D.right}px`,zIndex:10007}}}})(),children:[i&&e&&e.length>1&&n.jsxs("div",{className:"dropdown-menu-item dropdown-menu-item-with-submenu additional-executables-menu-item",onMouseEnter:ne,onMouseLeave:J,children:[n.jsx("span",{children:c("gameDetail.additionalExecutables","Additional executables")}),n.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:n.jsx("polyline",{points:"9 18 15 12 9 6"})})]}),w&&n.jsx(n.Fragment,{children:n.jsxs("div",{className:"dropdown-menu-item dropdown-menu-item-with-submenu",onMouseEnter:z,onMouseLeave:_,children:[n.jsx("span",{children:c("collections.addTo","Add to")}),n.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:n.jsx("polyline",{points:"9 18 15 12 9 6"})})]})}),i&&y&&n.jsx("button",{onClick:D=>{D.stopPropagation(),f(!1),y&&y()},className:"dropdown-menu-item",children:n.jsx("span",{children:c("manageInstallation.title","Manage Installation")})}),(i&&e&&e.length>1||w||i&&y)&&!(d&&i&&m)&&(t||a||i&&C||!i&&!m&&!t&&!r||i&&e&&e.length>0&&C||r||O()&&(i||m))&&n.jsx("div",{className:"dropdown-menu-divider",onMouseEnter:W}),d&&i&&m&&n.jsx("button",{onClick:async D=>{D.stopPropagation(),f(!1),await N.removeGameFromCollection(i,m)},className:"dropdown-menu-item dropdown-menu-item-danger",disabled:N.isRemoving,children:n.jsx("span",{children:N.isRemoving?c("common.removing","Removing..."):c("collections.removeFromCollection","Remove from collection")})}),d&&i&&m&&(t||a||i&&C||!i&&!m&&!t&&!r||i&&e&&e.length>0&&C||r||O()&&(i||m))&&n.jsx("div",{className:"dropdown-menu-divider"}),t&&n.jsx("button",{onClick:X,className:"dropdown-menu-item",children:n.jsx("span",{children:c("common.edit","Edit")})}),(a||i&&C||!i&&!m&&!t&&!r)&&n.jsx("button",{onClick:de,className:"dropdown-menu-item",disabled:E.isReloading,children:n.jsx("span",{children:i?c("common.reloadSingleMetadata","Reload metadata"):c("common.reloadMetadata","Reload all metadata")})}),i&&e&&e.length>0&&C&&n.jsx("button",{onClick:oe,className:"dropdown-menu-item",disabled:T.isUnlinking,children:n.jsx("span",{children:e.length>1?c("gameDetail.unlinkAllExecutables","Unlink All Executables"):c("gameDetail.unlinkExecutable","Unlink Executable")})}),(r||O()&&(i||m))&&n.jsx("button",{onClick:G,className:"dropdown-menu-item dropdown-menu-item-danger",children:n.jsx("span",{children:c("common.delete","Delete")})})]});return q||P?Y.createPortal(M,document.body):M})(),E.showReloadConfirmModal&&Y.createPortal(n.jsx("div",{className:"dropdown-menu-confirm-overlay",onClick:E.handleCancelReload,children:n.jsxs("div",{className:"dropdown-menu-confirm-container",onClick:M=>M.stopPropagation(),children:[n.jsxs("div",{className:"dropdown-menu-confirm-header",children:[n.jsxs("h2",{children:[n.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"8px",verticalAlign:"middle"},children:[n.jsx("path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"}),n.jsx("path",{d:"M21 3v5h-5"}),n.jsx("path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"}),n.jsx("path",{d:"M3 21v-5h5"})]}),c("common.reloadMetadata","Reload all metadata")]}),n.jsx("button",{className:"dropdown-menu-confirm-close",onClick:E.handleCancelReload,"aria-label":"Close",children:"×"})]}),n.jsxs("div",{className:"dropdown-menu-confirm-content",children:[n.jsx("p",{children:c("common.confirmReload","Are you sure you want to reload all metadata? This will refresh all games, collections, and categories.")}),E.reloadError&&n.jsx("div",{className:"dropdown-menu-confirm-error",children:E.reloadError})]}),n.jsxs("div",{className:"dropdown-menu-confirm-footer",children:[n.jsx("button",{className:"dropdown-menu-confirm-cancel",onClick:E.handleCancelReload,disabled:E.isReloading,children:c("common.cancel","Cancel")}),n.jsx("button",{className:"dropdown-menu-confirm-reload",onClick:E.handleConfirmReload,disabled:E.isReloading,children:E.isReloading?c("common.reloading","Reloading..."):c("common.reloadMetadata","Reload all metadata")})]})]})}),document.body),g.showConfirmModal&&Y.createPortal(n.jsx("div",{className:"dropdown-menu-confirm-overlay",onClick:g.handleCancelDelete,children:n.jsxs("div",{className:"dropdown-menu-confirm-container",onClick:M=>M.stopPropagation(),children:[n.jsxs("div",{className:"dropdown-menu-confirm-header",children:[n.jsxs("h2",{children:[n.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"8px",verticalAlign:"middle"},children:[n.jsx("path",{d:"M3 6h18"}),n.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"}),n.jsx("path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]}),c("common.deleteTitle","Delete")]}),n.jsx("button",{className:"dropdown-menu-confirm-close",onClick:g.handleCancelDelete,"aria-label":"Close",children:"×"})]}),n.jsxs("div",{className:"dropdown-menu-confirm-content",children:[n.jsx("p",{children:c("common.confirmDelete",{title:x||u||""})}),g.deleteError&&n.jsx("div",{className:"dropdown-menu-confirm-error",children:g.deleteError})]}),n.jsxs("div",{className:"dropdown-menu-confirm-footer",children:[n.jsx("button",{className:"dropdown-menu-confirm-cancel",onClick:g.handleCancelDelete,disabled:g.isDeleting,children:c("common.cancel","Cancel")}),n.jsx("button",{className:"dropdown-menu-confirm-delete",onClick:g.handleConfirmDelete,disabled:g.isDeleting,children:g.isDeleting?c("common.deleting","Deleting..."):c("common.delete","Delete")})]})]})}),document.body)]})}function Xe({isOpen:t,onClose:r,game:a,allCollections:w,onCollectionAdded:d}){const{t:y}=B(),[i,x]=s.useState(""),[e,p]=s.useState(a.title),C=s.useRef(null),{collectionGameIds:m}=ce(),u=s.useMemo(()=>w.filter(k=>{const c=m.get(String(k.id));return!c||!c.includes(String(a.id))}),[w,m,a.id]),[S,v]=s.useState(u),b=ke({onSuccess:()=>{d?.(),r()}}),h=_e({onSuccess:async k=>{k&&await b.addGameToCollection(a.id,k.id)}});s.useEffect(()=>(t?(p(a.title),x(""),document.body.style.overflow="hidden",setTimeout(()=>{C.current&&(C.current.focus(),C.current.select())},0)):document.body.style.overflow="",()=>{document.body.style.overflow=""}),[t,a.title]),s.useEffect(()=>{if(!i.trim())v(u);else{const k=i.toLowerCase();v(u.filter(c=>c.title.toLowerCase().includes(k)))}},[i,u]);const l=async k=>{await b.addGameToCollection(a.id,k)},L=async()=>{e.trim()&&await h.createCollection(e.trim())};return t?Y.createPortal(n.jsx("div",{className:"add-to-collection-modal-overlay",onClick:r,children:n.jsxs("div",{className:"add-to-collection-modal",onClick:k=>k.stopPropagation(),children:[n.jsxs("div",{className:"add-to-collection-modal-header",children:[n.jsx("h2",{children:y("collections.addToCollection","Add to Collection")}),n.jsx("button",{className:"add-to-collection-modal-close",onClick:r,children:"×"})]}),n.jsx("div",{className:"add-to-collection-modal-search",children:n.jsx("input",{type:"text",placeholder:y("collections.searchCollections","Search collections..."),value:i,onChange:k=>x(k.target.value),autoFocus:!0})}),n.jsx("div",{className:"add-to-collection-modal-collections",children:S.length>0?S.map(k=>n.jsxs("div",{className:"add-to-collection-modal-collection-item",onClick:()=>l(k.id),children:[n.jsx("div",{className:"add-to-collection-modal-collection-title",children:k.title}),k.gameCount!==void 0&&n.jsxs("div",{className:"add-to-collection-modal-collection-count",children:[k.gameCount," ",y("collections.games","games")]})]},k.id)):n.jsx("div",{className:"add-to-collection-modal-empty",children:y("collections.noCollectionsFound","No collections found")})}),n.jsxs("div",{className:"add-to-collection-modal-create",children:[n.jsx("input",{ref:C,type:"text",placeholder:y("collections.newCollectionTitle","New collection title"),value:e,onChange:k=>p(k.target.value),onFocus:k=>{k.target.value&&k.target.select()},onKeyDown:k=>{k.key==="Enter"&&L()}}),n.jsx("button",{onClick:L,disabled:!e.trim()||h.isCreating,className:"add-to-collection-modal-create-button",children:h.isCreating?y("common.creating","Creating..."):y("common.create","Create")})]})]})}),document.body):null}function ze({game:t,allCollections:r,onCollectionAdded:a}){const{t:w}=B(),[d,y]=s.useState(!1),[i,x]=s.useState(!1),[e,p]=s.useState([]),[C,m]=s.useState(!1),[u,S]=s.useState(!1),v=s.useRef(null),b=s.useRef(null),{collectionGameIds:h}=ce(),l=ke({onSuccess:()=>{a?.(),y(!1)}});s.useEffect(()=>{const f=R=>{const g=R;if(g.detail?.gameId===t.id&&!i){if(g.detail.menuItem)b.current=g.detail.menuItem;else{const E=document.querySelectorAll(".dropdown-menu-item-with-submenu");for(const T of E){const N=T.closest(".dropdown-menu-popup");if(N){const P=window.getComputedStyle(N);if(P.display!=="none"&&P.visibility!=="hidden"){b.current=T;break}}}}y(!0)}},j=R=>{const g=R;(!g.detail?.gameId||g.detail.gameId===t.id)&&!i&&y(!1)};return window.addEventListener("openAddToCollectionDropdown",f),window.addEventListener("closeAddToCollectionDropdown",j),()=>{window.removeEventListener("openAddToCollectionDropdown",f),window.removeEventListener("closeAddToCollectionDropdown",j)}},[t.id,i]);const L=s.useMemo(()=>r.filter(f=>{const j=h.get(String(f.id));return!j||!j.includes(String(t.id))}),[r,h,t.id]);s.useEffect(()=>{const j=JSON.parse(localStorage.getItem("recentCollections")||"[]").map(R=>L.find(g=>g.id===R)).filter(R=>R!==void 0).slice(0,5);p(j)},[L]),s.useEffect(()=>{S(d)},[d]),s.useEffect(()=>{if(!d||!v.current){m(!1);return}m(!1);const f=()=>{let E=b.current;if(!E||!document.contains(E)){const ne=document.querySelectorAll(".dropdown-menu-item-with-submenu");for(const J of ne){const Q=J.closest(".dropdown-menu-popup");if(Q){const G=window.getComputedStyle(Q);if(G.display!=="none"&&G.visibility!=="hidden"){E=J,b.current=E;break}}}}if(E||(E=document.querySelector(".dropdown-menu-item-with-submenu")),!E)return;let T=u?document.querySelector(".add-to-collection-dropdown-menu"):v.current?.querySelector(".add-to-collection-dropdown-menu");if(!T){u&&requestAnimationFrame(f);return}const N=E.getBoundingClientRect(),P=0,q=window.innerWidth,I=window.innerHeight,F=8,X=T.offsetWidth||200,z=T.offsetHeight||100;let _=N.right+P;_+X+F>q&&(_=N.left-X-P),_<F&&(_=F);let W=N.top;W+z+F>I&&(W=N.bottom-z,W+z+F>I&&(W=I-z-F)),W<F&&(W=F),u&&(T.style.position="fixed",T.style.right="auto",T.style.bottom="auto"),T.style.top=`${W}px`,T.style.left=`${_}px`,m(!0)};requestAnimationFrame(u?()=>{requestAnimationFrame(()=>{setTimeout(()=>{f()},50)})}:()=>{requestAnimationFrame(f)});const j=()=>{f()},R=()=>{f()};window.addEventListener("resize",j),window.addEventListener("scroll",R,!0);function g(E){const T=E.target;v.current&&!v.current.contains(T)&&!T.closest(".dropdown-menu-item-with-submenu")&&!T.closest(".dropdown-menu-popup")&&y(!1)}return v.current&&v.current.addEventListener("mouseleave",g),()=>{window.removeEventListener("resize",j),window.removeEventListener("scroll",R,!0),v.current&&v.current.removeEventListener("mouseleave",g)}},[d,u]);const k=async(f,j)=>{f.stopPropagation(),f.preventDefault(),y(!1),await l.addGameToCollection(t.id,j)},c=f=>{f.stopPropagation(),f.preventDefault(),y(!1),setTimeout(()=>{x(!0)},50)},o=d?n.jsxs("div",{className:"add-to-collection-dropdown-menu",style:{opacity:C?1:0,pointerEvents:C?"auto":"none"},onMouseEnter:()=>y(!0),onMouseLeave:f=>{const j=f.relatedTarget;(!j||!j.closest(".add-to-collection-dropdown-menu")&&!j.closest(".dropdown-menu-item-with-submenu")&&!j.closest(".dropdown-menu-popup"))&&setTimeout(()=>{const R=document.querySelector(".dropdown-menu-item-with-submenu"),g=document.querySelector(".add-to-collection-dropdown-menu");if(R&&g){const E=R.getBoundingClientRect(),T=g.getBoundingClientRect(),N=f.clientX,P=f.clientY,q=N>=E.left&&N<=E.right&&P>=E.top&&P<=E.bottom,I=N>=T.left&&N<=T.right&&P>=T.top&&P<=T.bottom;!q&&!I&&y(!1)}else y(!1)},200)},onClick:f=>{f.stopPropagation()},children:[n.jsx("div",{className:"add-to-collection-dropdown-item",onClick:c,children:w("collections.addToCollection","Add to Collection...")}),e.length>0&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"add-to-collection-dropdown-divider"}),n.jsx("div",{className:"add-to-collection-dropdown-section-title",children:w("collections.recent","RECENT")}),e.map(f=>n.jsx("div",{className:"add-to-collection-dropdown-item",onClick:j=>k(j,f.id),children:f.title},f.id))]})]}):null;return n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"add-to-collection-dropdown",ref:v,children:u&&o?Y.createPortal(o,document.body):o}),n.jsx(Xe,{isOpen:i,onClose:()=>x(!1),game:t,allCollections:r,onCollectionAdded:a})]})}function Ge({gameId:t,gameExecutables:r,onPlayExecutable:a}){const[w,d]=s.useState(!1),[y,i]=s.useState(!1),[x,e]=s.useState(!1),[p,C]=s.useState(!1),m=s.useRef(null),u=s.useRef(null),S=r.slice(1);s.useEffect(()=>{if(m.current){const h=m.current.closest(".search-dropdown-item")!==null;e(h)}},[]),s.useEffect(()=>{C(w)},[w]),s.useEffect(()=>{const h=L=>{L.detail?.gameId===t&&d(!0)},l=L=>{const k=L;(!k.detail?.gameId||k.detail.gameId===t)&&d(!1)};return window.addEventListener("openAdditionalExecutablesDropdown",h),window.addEventListener("closeAdditionalExecutablesDropdown",l),()=>{window.removeEventListener("openAdditionalExecutablesDropdown",h),window.removeEventListener("closeAdditionalExecutablesDropdown",l)}},[t]),s.useEffect(()=>{if(!w||!m.current){i(!1);return}i(!1);const h=()=>{const k=document.querySelector(".dropdown-menu-item-with-submenu.additional-executables-menu-item");if(!k){requestAnimationFrame(h);return}let c=p?document.querySelector(".additional-executables-dropdown-menu"):u.current;if(!c&&m.current&&!p&&(c=m.current.querySelector(".additional-executables-dropdown-menu")),!c){requestAnimationFrame(h);return}const o=k.getBoundingClientRect(),f=0,j=window.innerWidth,R=window.innerHeight,g=8,E=c.offsetWidth||200,T=c.offsetHeight||100;let N=o.right+f;N+E+g>j&&(N=o.left-E-f),N<g&&(N=g);let P=o.top;P+T+g>R&&(P=o.bottom-T,P+T+g>R&&(P=R-T-g)),P<g&&(P=g),c.style.position="fixed",c.style.top=`${P}px`,c.style.left=`${N}px`,c.style.right="auto",c.style.bottom="auto",i(!0)};requestAnimationFrame(()=>{requestAnimationFrame(h)});const l=()=>{h()},L=()=>{h()};return window.addEventListener("resize",l),window.addEventListener("scroll",L,!0),()=>{window.removeEventListener("resize",l),window.removeEventListener("scroll",L,!0)}},[w]);const v=(h,l)=>{h.stopPropagation(),h.preventDefault(),a&&a(l),setTimeout(()=>{d(!1)},50)};if(S.length===0)return null;const b=w?n.jsx("div",{ref:u,className:`additional-executables-dropdown-menu ${x?"additional-executables-dropdown-menu-in-popup":""}`,style:{visibility:y?"visible":"hidden",pointerEvents:y?"auto":"none"},onMouseLeave:h=>{setTimeout(()=>{const l=document.querySelector(".dropdown-menu-item-with-submenu.additional-executables-menu-item");if(l){const L=l.getBoundingClientRect();let k=u.current;!k&&m.current&&(k=m.current.querySelector(".additional-executables-dropdown-menu"));const c=k?.getBoundingClientRect();if(c){const o=h.clientX,f=h.clientY,j=o>=L.left&&o<=L.right&&f>=L.top&&f<=L.bottom,R=o>=c.left&&o<=c.right&&f>=c.top&&f<=c.bottom;!j&&!R&&d(!1)}else d(!1)}},200)},onClick:h=>{h.stopPropagation()},onMouseDown:h=>{h.stopPropagation()},children:S.map(h=>n.jsx("button",{type:"button",className:"additional-executables-dropdown-item",onClick:l=>v(l,h),onMouseDown:l=>{l.stopPropagation()},children:h},h))}):null;return n.jsx("div",{className:"additional-executables-dropdown",ref:m,children:p&&typeof document<"u"?Y.createPortal(b,document.body):b})}function Se({title:t,coverUrl:r,width:a,height:w,onPlay:d,onClick:y,onEdit:i,onDelete:x,gameId:e,gameTitle:p,game:C,onGameDelete:m,onGameUpdate:u,collectionId:S,collectionTitle:v,onCollectionDelete:b,onCollectionUpdate:h,onRemoveFromCollection:l,showTitle:L=!1,subtitle:k,detail:c=!0,play:o=!0,showBorder:f=!0,aspectRatio:j="3/4",overlayContent:R,titlePosition:g="bottom",editButtonPosition:E="bottom-left",onUpload:T,uploading:N=!1,allCollections:P=[],showRemoveButton:q=!1,removeMediaType:I,removeResourceId:F,removeResourceType:X,onRemoveSuccess:z,removeDisabled:_=!1}){const{t:W}=B(),[ne,J]=s.useState(!1),[Q,G]=s.useState(!1),[de,oe]=s.useState(!1),Z=s.useRef(null),M=!r||ne;s.useEffect(()=>{J(!1)},[r]),s.useEffect(()=>{if(!e&&!S)return;const $=ae=>{const K=ae;(e&&K.detail?.gameId===e||S&&!e&&K.detail?.collectionId===S)&&G(!0)},re=ae=>{const K=ae;(e&&K.detail?.gameId===e||S&&!e&&K.detail?.collectionId===S)&&G(!1)};return window.addEventListener("dropdownMenuOpened",$),window.addEventListener("dropdownMenuClosed",re),()=>{window.removeEventListener("dropdownMenuOpened",$),window.removeEventListener("dropdownMenuClosed",re)}},[e,S]),s.useEffect(()=>{const $=()=>{if(!Z.current)return;const K=Z.current.querySelectorAll(".games-list-play-button, .games-list-upload-button, .games-list-edit-button");if(K.length===0){oe(!1);return}const Pe=document.querySelectorAll(".dropdown-menu-popup, .add-to-collection-dropdown-menu");let pe=!1;K.forEach(Ae=>{const ie=Ae.getBoundingClientRect();Pe.forEach(ge=>{const ue=window.getComputedStyle(ge);if(ue.display==="none"||ue.opacity==="0"||ue.visibility==="hidden")return;const le=ge.getBoundingClientRect();!(le.right<ie.left||le.left>ie.right||le.bottom<ie.top||le.top>ie.bottom)&&(pe=!0)})}),oe(pe)};$();const re=setInterval($,100);return window.addEventListener("scroll",$,!0),window.addEventListener("resize",$),()=>{clearInterval(re),window.removeEventListener("scroll",$,!0),window.removeEventListener("resize",$)}},[Q]);let D=Math.max(10,Math.min(16,Math.floor(a/8)));j==="16/9"&&g==="overlay"&&(D=Math.max(14,Math.min(24,Math.floor(a/5))));const se=Math.max(4,Math.floor(a/20)),V=Math.max(2,Math.floor(w/(D*1.5))),Le=$=>{o&&!c&&d?($.stopPropagation(),d()):c&&y&&($.stopPropagation(),y())},Te=$=>{$.stopPropagation(),d&&d()},Ne=$=>{$.stopPropagation(),i&&i()},he=$=>{$.stopPropagation(),T&&!N&&T()},Me=o&&d&&!T,ee=T!==void 0,De=c||o||ee;return n.jsxs(n.Fragment,{children:[n.jsxs("div",{ref:Z,className:`games-list-cover relative bg-[#2a2a2a] rounded overflow-hidden transition-all ${f?"cover-hover-effect":""} ${o?"games-list-cover-play":""} ${c?"games-list-cover-detail":""} ${ee?"games-list-cover-upload":""} ${Q?"cover-dropdown-open":""} ${de?"cover-popup-overlay":""}`,style:{width:`${a}px`,aspectRatio:j,cursor:De&&!ee||ee?"pointer":"default"},onClick:ee?he:Le,children:[M?n.jsx("div",{className:"cover-placeholder",style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#2a2a2a",border:"1px solid rgba(255, 255, 255, 0.2)",boxSizing:"border-box"},children:n.jsx("div",{className:"cover-placeholder-text",style:{padding:`${se}px`,fontSize:`${D}px`,textAlign:"center",color:"rgba(255, 255, 255, 0.85)",fontWeight:600,lineHeight:1.3,wordBreak:"break-word",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:V,WebkitBoxOrient:"vertical",width:"100%",maxHeight:"100%"},children:t})}):n.jsx("img",{src:r,alt:t,className:"object-cover w-full h-full",loading:r.startsWith("data:")?void 0:"lazy",onError:()=>{J(!0)},onLoad:()=>{J(!1)}},r||"cover-image"),Me&&n.jsx("button",{onClick:Te,className:`games-list-play-button ${c?"games-list-play-button-detail":"games-list-play-button-play-only"}`,"aria-label":W("common.play"),children:n.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:n.jsx("path",{d:"M8 5v14l11-7z",fill:"currentColor"})})}),ee&&n.jsx("button",{onClick:he,className:`games-list-upload-button ${c?"games-list-upload-button-detail":"games-list-upload-button-upload-only"}`,"aria-label":W("gameDetail.uploadCover","Upload Cover"),disabled:N,children:N?n.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:"spinning",style:{animation:"spin 1s linear infinite"},children:n.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"2",fill:"none",strokeDasharray:"31.416",strokeDashoffset:"31.416",strokeLinecap:"round"})}):n.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:n.jsx("path",{d:"M12 5v14M5 12h14",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}),i&&n.jsx("button",{onClick:Ne,className:`games-list-edit-button ${E==="bottom-right"?"games-list-edit-button-bottom-right":""}`,"aria-label":W("common.edit","Edit"),children:n.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[n.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),n.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]})}),i&&e&&C&&n.jsx("div",{className:"games-list-dropdown-wrapper games-list-dropdown-wrapper-bottom-right",children:n.jsx(ze,{game:C,allCollections:P})}),i&&(e||S)&&n.jsxs("div",{className:"games-list-dropdown-wrapper games-list-dropdown-wrapper-bottom-right",children:[e&&C&&C.executables&&C.executables.length>1&&d&&n.jsx(Ge,{gameId:e,gameExecutables:C.executables,onPlayExecutable:$=>{d&&d(C,$)}}),n.jsx(He,{onDelete:x,gameId:e,gameTitle:p,gameExecutables:C?.executables,onAddToCollection:e&&C?()=>{}:void 0,onRemoveFromCollection:l,onGameDelete:m,onGameUpdate:u,collectionId:S,collectionTitle:v,onCollectionDelete:b,onCollectionUpdate:h,className:"games-list-dropdown-menu"})]}),q&&I&&F&&X&&n.jsx("button",{className:"cover-remove-media-button",onClick:$=>{$.stopPropagation(),z&&z()},disabled:_||N,title:I==="cover"?W("gameDetail.removeCover","Remove cover"):W("gameDetail.removeBackground","Remove background")}),R&&n.jsx("div",{className:"cover-overlay-content",children:R}),g==="overlay"&&L&&!M&&n.jsx("div",{className:"cover-overlay-content",style:{display:"flex",alignItems:"center",justifyContent:"center",padding:`${se}px`},children:n.jsx("div",{style:{textAlign:"center",color:"rgba(255, 255, 255, 0.95)",fontWeight:600,fontSize:`${D}px`,lineHeight:1.3,wordBreak:"break-word",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:V,WebkitBoxOrient:"vertical",textShadow:"2px 2px 4px rgba(0, 0, 0, 0.8)"},children:t})})]}),(L||k!=null)&&g==="bottom"&&n.jsxs("div",{className:"games-list-title-wrapper",children:[L&&n.jsx(be,{text:t,position:"bottom",children:n.jsx("div",{className:`truncate games-list-title ${c?"games-list-title-clickable":""}`,onClick:c&&y?$=>{$.stopPropagation(),y()}:void 0,children:t})}),k!=null&&n.jsx("div",{className:"games-list-year",children:k})]})]})}const je=s.createContext(void 0);function mt({children:t}){const[r,a]=s.useState([]),[w,d]=s.useState(!1),[y,i]=s.useState(null),{isLoading:x,token:e}=fe(),p=s.useCallback(async()=>{if(!(x||!(O()||e))){d(!0),i(null);try{const h=U(A,"/categories"),l=await fetch(h,{headers:te({Accept:"application/json"})});if(!l.ok)throw new Error(`HTTP ${l.status}`);const c=((await l.json()).categories||[]).map(o=>({id:o.id,title:o.title,cover:o.cover}));a(c)}catch(h){const l=String(h.message||h);console.error("Error fetching categories:",l),i(l)}finally{d(!1)}}},[x,e]);s.useEffect(()=>{x||p()},[x,p]),s.useEffect(()=>{const b=l=>{const k=l.detail?.category;k&&a(c=>c.map(o=>String(o.id)===String(k.id)?k:o))},h=()=>{p()};return window.addEventListener("categoryUpdated",b),window.addEventListener("metadataReloaded",h),()=>{window.removeEventListener("categoryUpdated",b),window.removeEventListener("metadataReloaded",h)}},[p]);const C=s.useCallback(async()=>{await p()},[p]),m=s.useCallback(b=>{a(h=>{if(h.some(L=>String(L.id)===String(b.id)))return h;const l=[...h,b];return l.sort((L,k)=>L.title.localeCompare(k.title)),l})},[]),u=s.useCallback(b=>{a(h=>h.map(l=>String(l.id)===String(b.id)?b:l))},[]),S=s.useCallback(b=>{a(h=>h.filter(l=>String(l.id)!==String(b)))},[]),v=s.useMemo(()=>({categories:r,isLoading:w,error:y,refreshCategories:C,addCategory:m,updateCategory:u,removeCategory:S}),[r,w,y,C,m,u,S]);return n.jsx(je.Provider,{value:v,children:t})}function Je(){const t=s.useContext(je);if(t===void 0)throw new Error("useCategories must be used within a CategoriesProvider");return t}const Re=s.createContext(void 0);function ft({children:t}){const[r,a]=s.useState([]),[w,d]=s.useState(!1),[y,i]=s.useState(null),{isLoading:x,token:e}=fe(),p=s.useCallback(async()=>{if(!(x||!(O()||e))){d(!0),i(null);try{const h=U(A,"/libraries/library/games",{sort:"title"}),l=await fetch(h,{headers:te({Accept:"application/json"})});if(!l.ok)throw new Error(`HTTP ${l.status}`);const c=((await l.json()).games||[]).map(o=>({id:String(o.id),title:o.title,summary:o.summary,cover:o.cover,background:o.background,day:o.day,month:o.month,year:o.year,stars:o.stars,genre:o.genre,criticratings:o.criticratings,userratings:o.userratings,executables:o.executables||null,themes:o.themes||null,platforms:o.platforms||null,gameModes:o.gameModes||null,playerPerspectives:o.playerPerspectives||null,websites:o.websites||null,ageRatings:o.ageRatings||null,developers:o.developers||null,publishers:o.publishers||null,franchise:o.franchise||null,collection:o.collection||null,screenshots:o.screenshots||null,videos:o.videos||null,gameEngines:o.gameEngines||null,keywords:o.keywords||null,alternativeNames:o.alternativeNames||null,similarGames:o.similarGames||null}));a(c)}catch(h){const l=String(h.message||h);console.error("Error fetching library games:",l),i(l)}finally{d(!1)}}},[x,e]);s.useEffect(()=>{x||p()},[x,p]),s.useEffect(()=>{const b=k=>{const o=k.detail?.game;o&&a(f=>f.map(j=>String(j.id)===String(o.id)?o:j))},h=k=>{const o=k.detail?.gameId;o&&a(f=>f.filter(j=>String(j.id)!==String(o)))},l=k=>{const o=k.detail?.game;o&&a(f=>f.some(j=>String(j.id)===String(o.id))?f.map(j=>String(j.id)===String(o.id)?o:j):[...f,o].sort((j,R)=>(j.title||"").localeCompare(R.title||"")))},L=()=>{p()};return window.addEventListener("gameUpdated",b),window.addEventListener("gameDeleted",h),window.addEventListener("gameAdded",l),window.addEventListener("metadataReloaded",L),()=>{window.removeEventListener("gameUpdated",b),window.removeEventListener("gameDeleted",h),window.removeEventListener("gameAdded",l),window.removeEventListener("metadataReloaded",L)}},[p]);const C=s.useCallback(async()=>{await p()},[p]),m=s.useCallback(b=>{a(h=>h.some(l=>String(l.id)===String(b.id))?h.map(l=>String(l.id)===String(b.id)?b:l):[...h,b].sort((l,L)=>(l.title||"").localeCompare(L.title||"")))},[]),u=s.useCallback(b=>{a(h=>h.map(l=>String(l.id)===String(b.id)?b:l))},[]),S=s.useCallback(b=>{a(h=>h.filter(l=>String(l.id)!==String(b)))},[]),v=s.useMemo(()=>({games:r,isLoading:w,error:y,refreshGames:C,addGame:m,updateGame:u,removeGame:S}),[r,w,y,C,m,u,S]);return n.jsx(Re.Provider,{value:v,children:t})}function Ve(){const t=s.useContext(Re);if(t===void 0)throw new Error("useLibraryGames must be used within a LibraryGamesProvider");return t}function ve(t){try{const r=sessionStorage.getItem(t);return r?parseInt(r,10):0}catch{return 0}}function Ce(t,r){try{sessionStorage.setItem(t,r.toString())}catch{}}function Ke(t,r){const a=$e(),w=s.useRef(!1),d=r?`${a.pathname}:${r}`:a.pathname;s.useLayoutEffect(()=>{if(!t.current){const p=setTimeout(()=>{const C=t.current;if(C){const m=ve(d);m>0&&(C.scrollTop=m)}},200);return()=>clearTimeout(p)}w.current=!0;const i=ve(d);if(i<=0){w.current=!1;return}const x=(p=0)=>{const C=t.current;if(!C){p<30?setTimeout(()=>x(p+1),50):w.current=!1;return}const u=r==="table"?C.querySelector("tbody tr"):!0;if(!(C.scrollHeight>C.clientHeight)||!u){p<100?p<20?requestAnimationFrame(()=>x(p+1)):setTimeout(()=>x(p+1),50):w.current=!1;return}C.scrollTop=i,p<10?setTimeout(()=>{const v=C.scrollTop;Math.abs(v-i)>10?(C.scrollTop=i,x(p+1)):w.current=!1},100):w.current=!1},e=setTimeout(()=>{x()},150);return()=>{clearTimeout(e),w.current=!1}},[a.pathname,d,t,r]),s.useEffect(()=>{const y=t.current;if(!y)return;const i=()=>{if(w.current)return;const x=y.scrollTop;x>0&&Ce(d,x)};return y.addEventListener("scroll",i,{passive:!0}),()=>{y.removeEventListener("scroll",i);const x=y.scrollTop;x>0&&!w.current&&Ce(d,x)}},[a.pathname,d,t,r])}function Ye({category:t,coverSize:r,itemRefs:a,onCategoryEdit:w}){const{t:d}=B(),y=Ue(),i=r*(9/16),x=()=>{y(`/category/${t.id}`)},e=()=>{w&&w(t)};return n.jsx("div",{ref:p=>{p&&a?.current&&a.current.set(t.id,p)},className:"group cursor-pointer categories-list-item",style:{width:`${r}px`,minWidth:`${r}px`},onClick:x,children:n.jsx(Se,{title:d(`genre.${t.title}`,t.title),coverUrl:Oe(A,t.id,t.cover),width:r,height:i,onClick:x,onEdit:w?e:void 0,showTitle:!0,titlePosition:"overlay",detail:!0,play:!1,showBorder:!0,aspectRatio:"16/9"})},t.id)}function Qe({categories:t,coverSize:r=150,itemRefs:a,onCategoryEdit:w}){const{t:d}=B();return t.length===0?n.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",minHeight:"400px"},children:n.jsx("div",{className:"text-gray-400 text-center",children:d("categories.noCategoriesFound")})}):n.jsx("div",{className:"categories-list-container",style:{gridTemplateColumns:`repeat(auto-fill, ${r}px)`},children:t.map(y=>n.jsx(Ye,{category:y,coverSize:r,itemRefs:a,onCategoryEdit:w},y.id))})}function Ze({isOpen:t,onClose:r,category:a,onCategoryUpdate:w}){const{t:d}=B(),{setLoading:y}=H(),[i,x]=s.useState(!1),[e,p]=s.useState(null),C=s.useRef(null),[m,u]=s.useState(null),[S,v]=s.useState(null),[b,h]=s.useState(!1),[l,L]=s.useState(Date.now()),k=s.useMemo(()=>{if(!a?.cover)return"";const R=a.cover.split("?")[0].split("&")[0];if(R.startsWith("/categories/")&&R.endsWith("/cover.webp"))return"";const g=U(A,R),E=g.includes("?")?"&":"?";return`${g}${E}t=${l}`},[a?.cover,l]);s.useEffect(()=>{t&&a?(p(null),u(null),v(null),h(!1),L(Date.now())):t||(u(null),v(null))},[t,a]),s.useEffect(()=>{t&&a&&(!a.cover||a.cover.trim()==="")&&!b&&!S&&(h(!0),u(null),L(Date.now()))},[t,a?.cover]),s.useEffect(()=>{if(!t)return;function R(g){g.key==="Escape"&&(g.stopPropagation(),r())}return document.addEventListener("keydown",R,!0),document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",R,!0),document.body.style.overflow=""}},[t,r]);const c=()=>S!==null||b,o=R=>{const g=R.target.files?.[0];if(g){if(!g.type.startsWith("image/")){p(d("gameDetail.invalidImageType","File must be an image")),R.target.value="";return}const E=new FileReader;E.onloadend=()=>{u(E.result)},E.readAsDataURL(g),v(g),h(!1),p(null),R.target.value=""}},f=()=>{h(!0),u(null),v(null),L(Date.now())},j=async()=>{if(!c()){r();return}y(!0),p(null);try{let R=null;if(b&&!S)try{const g=U(A,`/categories/${encodeURIComponent(a.title)}/delete-cover`),E=await fetch(g,{method:"DELETE",headers:{"X-Auth-Token":O()||""}});if(!E.ok){const N=await E.json().catch(()=>({error:"Failed to remove cover"}));throw new Error(N.error||"Failed to remove cover")}const T=await E.json();T.category&&(R=T.category.cover||null)}catch(g){p(String(g.message||g)),y(!1);return}if(S){x(!0);try{const g=new FormData;g.append("file",S);const E=U(A,`/categories/${encodeURIComponent(a.title)}/upload-cover`),T=await fetch(E,{method:"POST",headers:te(),body:g});if(!T.ok){const P=await T.json().catch(()=>({error:"Failed to upload cover"}));throw new Error(P.error||"Failed to upload cover")}const N=await T.json();N.category&&N.category.cover&&(R=N.category.cover)}catch(g){x(!1),y(!1),p(String(g.message||g));return}finally{x(!1)}}if(S||b){let g;if(b)g=void 0;else if(R!==null){if(g=R,g){const T=g.includes("?")?"&":"?";g=`${g}${T}t=${Date.now()}`}}else if(a.cover){const T=a.cover.includes("?")?"&":"?";g=`${a.cover}${T}t=${Date.now()}`}const E={id:a.id,title:a.title,cover:g};window.dispatchEvent(new CustomEvent("categoryUpdated",{detail:{category:E}})),w(E)}r()}catch(R){p(String(R.message||R))}finally{y(!1)}};return t?Y.createPortal(n.jsx("div",{className:"edit-collection-modal-overlay",onClick:r,children:n.jsxs("div",{className:"edit-collection-modal-container",onClick:R=>R.stopPropagation(),children:[n.jsxs("div",{className:"edit-collection-modal-header",children:[n.jsx("h2",{children:d("category.editCategory","Edit Category")}),n.jsx("button",{className:"edit-collection-modal-close",onClick:r,children:n.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:n.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),e&&n.jsx("div",{className:"edit-collection-modal-error",children:e}),n.jsxs("div",{className:"edit-collection-modal-content",children:[n.jsx("div",{className:"edit-collection-modal-tabs",children:n.jsx("button",{className:"edit-collection-modal-tab active",onClick:()=>{},children:d("gameDetail.media","MEDIA")})}),n.jsx("div",{className:"edit-collection-modal-tab-content",children:n.jsx("div",{className:"edit-collection-modal-media",children:n.jsxs("div",{className:"edit-collection-modal-media-row",children:[n.jsxs("div",{className:"edit-collection-modal-media-info",children:[n.jsx("div",{className:"edit-collection-modal-label",children:d("gameDetail.cover","Cover")}),n.jsx("div",{className:"edit-collection-modal-media-description",children:d("category.coverFormat","Recommended ratio: 16:9 (e.g., 1280x720px)")})]}),n.jsx("div",{className:"edit-collection-modal-media-image-container",children:(()=>{const R=b?"":m||k,E=(m||S||a.cover&&a.cover.startsWith("/category-covers/"))&&R&&R.trim()!=="";return n.jsxs(n.Fragment,{children:[n.jsx(Se,{title:a.title,coverUrl:R,width:300,height:169,showTitle:!1,detail:!1,play:!1,showBorder:!0,aspectRatio:"16/9",onUpload:()=>!i&&C.current?.click(),uploading:i,showRemoveButton:!!E&&!b,removeMediaType:"cover",removeResourceId:a.title,removeResourceType:"categories",onRemoveSuccess:f,removeDisabled:i},`cover-${b?"removed":m?"preview":k}`),n.jsx("input",{ref:C,id:"edit-category-cover-input",name:"cover",type:"file",accept:"image/*",style:{display:"none"},onChange:o})]})})()})]})})})]}),n.jsxs("div",{className:"edit-collection-modal-footer",children:[n.jsx("button",{className:"edit-collection-modal-cancel",onClick:r,disabled:i,children:d("common.cancel","Cancel")}),n.jsx("button",{className:"edit-collection-modal-save",onClick:j,disabled:!c()||i,children:i?d("common.uploading","Uploading..."):d("common.save","Save")})]})]})}),document.body):null}function ht({coverSize:t}){const{isLoading:r,setLoading:a}=H(),{categories:w,isLoading:d,refreshCategories:y,updateCategory:i}=Je(),{games:x,isLoading:e}=Ve(),[p,C]=s.useState([]),[m,u]=s.useState(!1),[S,v]=s.useState(null),b=s.useRef(null),h=s.useRef(new Map);s.useEffect(()=>{a(d||e||!m)},[d,e,m,a]),Ke(b),s.useEffect(()=>{const c=()=>{y()};return window.addEventListener("metadataReloaded",c),()=>{window.removeEventListener("metadataReloaded",c)}},[y]);const l=c=>{i(c),S&&String(S.id)===String(c.id)&&v(c)},L=c=>{v(c)},k=()=>{v(null)};return s.useEffect(()=>{if(x.length===0||w.length===0){C([]);return}const c=new Set;x.forEach(f=>{f.genre&&(Array.isArray(f.genre)?f.genre.forEach(j=>c.add(j)):typeof f.genre=="string"&&c.add(f.genre))});const o=w.filter(f=>c.has(f.title)).map(f=>({id:String(f.id),title:f.title,cover:f.cover}));C(o)},[x,w]),s.useEffect(()=>{if(S){const c=w.find(o=>String(o.id)===String(S.id));if(c){const o=c.cover||void 0,f=S.cover||void 0;o!==f&&v({id:String(c.id),title:c.title,cover:c.cover})}}},[w]),s.useLayoutEffect(()=>{!d&&!e?requestAnimationFrame(()=>{requestAnimationFrame(()=>{u(!0)})}):(d||e)&&u(!1)},[d,e,p.length]),n.jsxs("main",{className:"flex-1 home-page-content",children:[n.jsx("div",{className:"home-page-layout",children:n.jsx("div",{className:"home-page-content-wrapper",style:{opacity:m?1:0,transition:"opacity 0.2s ease-in-out"},children:n.jsx("div",{ref:b,className:"home-page-scroll-container",children:!r&&n.jsx(Qe,{categories:p,coverSize:t*2,itemRefs:h,onCategoryEdit:L})})})}),S&&n.jsx(Ze,{isOpen:!!S,onClose:k,category:S,onCategoryUpdate:l})]})}export{ze as A,Se as C,He as D,it as L,be as T,Je as a,U as b,ce as c,Ve as d,Ke as e,at as f,Ge as g,st as h,rt as i,ht as j,ct as k,fe as l,te as m,lt as n,dt as o,mt as p,ut as q,ft as r,H as u};
