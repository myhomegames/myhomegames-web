import{j as e,u as Y,r as a,b as Z}from"./react-vendor-jNdKP8wU.js";import{C as X,e as _,b as B,a as J,f as z,g as O,h as ee}from"./page-CollectionDetail.tsx-DYxPNzRb.js";import{u as te}from"./page-CollectionsPage.tsx-CqznnysS.js";import{u as Q}from"./i18n-vendor-mPXi0JFR.js";import{A as D,g as oe}from"./page-AddGamePage.tsx-CGFUTWrs.js";function se({item:n,coverSize:l,itemRefs:s,onItemEdit:u,getDisplayName:S,getCoverUrl:y,getRoute:m}){const d=Y(),T=l*(9/16),L=S?S(n):n.title,N=y?y(n):"",R=()=>{const v=m?m(n):`/category/${n.id}`;d(v)},h=()=>{u&&u(n)};return e.jsx("div",{ref:v=>{v&&s?.current&&s.current.set(n.id,v)},className:"group cursor-pointer tag-list-item",style:{width:`${l}px`,minWidth:`${l}px`},onClick:R,children:e.jsx(X,{title:L,coverUrl:N,width:l,height:T,onClick:R,onEdit:u?h:void 0,showTitle:!0,titlePosition:"overlay",detail:!0,play:!1,showBorder:!0,aspectRatio:"16/9"})},n.id)}function re({items:n,coverSize:l=150,itemRefs:s,onItemEdit:u,getDisplayName:S,getCoverUrl:y,getRoute:m,emptyMessage:d}){const{t:T}=Q();return n.length===0?e.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",minHeight:"400px"},children:e.jsx("div",{className:"text-gray-400 text-center",children:d||T("categories.noCategoriesFound")})}):e.jsx("div",{className:"tag-list-container",style:{gridTemplateColumns:`repeat(auto-fill, ${l}px)`},children:n.map(L=>e.jsx(se,{item:L,coverSize:l,itemRefs:s,onItemEdit:u,getDisplayName:S,getCoverUrl:y,getRoute:m},L.id))})}function ae({isOpen:n,onClose:l,item:s,onItemUpdate:u,title:S,coverDescription:y,routeBase:m,responseKey:d,localCoverPrefix:T,removeResourceType:L,updateEventName:N,updateEventPayloadKey:R}){const{t:h}=Q(),{setLoading:v}=_(),[j,$]=a.useState(!1),[k,C]=a.useState(null),M=a.useRef(null),W=a.useId(),[I,b]=a.useState(null),[w,U]=a.useState(null),[x,F]=a.useState(!1),[H,P]=a.useState(Date.now()),K=a.useMemo(()=>m.startsWith("/")?m:`/${m}`,[m]),r=a.useMemo(()=>o=>o.startsWith(T),[T]),f=a.useMemo(()=>{if(!s?.cover)return"";const o=s.cover.split("?")[0].split("&")[0];if(!r(o))return"";const t=B(D,o),c=t.includes("?")?"&":"?";return`${t}${c}t=${H}`},[s?.cover,H,r]);a.useEffect(()=>{n&&s?(C(null),b(null),U(null),F(!1),P(Date.now())):n||(b(null),U(null))},[n,s]),a.useEffect(()=>{n&&s&&(!s.cover||s.cover.trim()==="")&&!x&&!w&&(F(!0),b(null),P(Date.now()))},[n,s?.cover,w,x]),a.useEffect(()=>{if(!n)return;function o(t){t.key==="Escape"&&(t.stopPropagation(),l())}return document.addEventListener("keydown",o,!0),document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",o,!0),document.body.style.overflow=""}},[n,l]);const p=()=>w!==null||x,i=o=>{const t=o.target.files?.[0];if(t){if(!t.type.startsWith("image/")){C(h("gameDetail.invalidImageType","File must be an image")),o.target.value="";return}const c=new FileReader;c.onloadend=()=>{b(c.result)},c.readAsDataURL(t),U(t),F(!1),C(null),o.target.value=""}},g=()=>{F(!0),b(null),U(null),P(Date.now())},A=async()=>{if(!p()){l();return}v(!0),C(null);try{let o=null;if(x&&!w)try{const t=B(D,`${K}/${encodeURIComponent(s.title)}/delete-cover`),c=await fetch(t,{method:"DELETE",headers:{"X-Auth-Token":oe()||""}});if(!c.ok){const q=await c.json().catch(()=>({error:"Failed to remove cover"}));throw new Error(q.error||"Failed to remove cover")}const G=(await c.json())?.[d];G&&(o=G.cover||null)}catch(t){C(String(t.message||t)),v(!1);return}if(w){$(!0);try{const t=new FormData;t.append("file",w);const c=B(D,`${K}/${encodeURIComponent(s.title)}/upload-cover`),E=await fetch(c,{method:"POST",headers:J(),body:t});if(!E.ok){const V=await E.json().catch(()=>({error:"Failed to upload cover"}));throw new Error(V.error||"Failed to upload cover")}const q=(await E.json())?.[d];q?.cover&&(o=q.cover)}catch(t){$(!1),v(!1),C(String(t.message||t));return}finally{$(!1)}}if(w||x){let t;if(x)t=void 0;else if(o!==null){if(t=o,t){const E=t.includes("?")?"&":"?";t=`${t}${E}t=${Date.now()}`}}else if(s.cover){const E=s.cover.includes("?")?"&":"?";t=`${s.cover}${E}t=${Date.now()}`}const c={id:s.id,title:s.title,cover:t};if(N){const E=R||"item";window.dispatchEvent(new CustomEvent(N,{detail:{[E]:c}}))}u(c)}l()}catch(o){C(String(o.message||o))}finally{v(!1)}};return n?Z.createPortal(e.jsx("div",{className:"edit-collection-modal-overlay",onClick:l,children:e.jsxs("div",{className:"edit-collection-modal-container",onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{className:"edit-collection-modal-header",children:[e.jsx("h2",{children:S}),e.jsx("button",{className:"edit-collection-modal-close",onClick:l,children:e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),k&&e.jsx("div",{className:"edit-collection-modal-error",children:k}),e.jsxs("div",{className:"edit-collection-modal-content",children:[e.jsx("div",{className:"edit-collection-modal-tabs",children:e.jsx("button",{className:"edit-collection-modal-tab active",onClick:()=>{},children:h("gameDetail.media","MEDIA")})}),e.jsx("div",{className:"edit-collection-modal-tab-content",children:e.jsx("div",{className:"edit-collection-modal-media",children:e.jsxs("div",{className:"edit-collection-modal-media-row",children:[e.jsxs("div",{className:"edit-collection-modal-media-info",children:[e.jsx("div",{className:"edit-collection-modal-label",children:h("gameDetail.cover","Cover")}),e.jsx("div",{className:"edit-collection-modal-media-description",children:y||h("category.coverFormat","Recommended ratio: 16:9 (e.g., 1280x720px)")})]}),e.jsx("div",{className:"edit-collection-modal-media-image-container",children:(()=>{const o=x?"":I||f,c=(I||w||s.cover&&r(s.cover))&&o&&o.trim()!=="";return e.jsxs(e.Fragment,{children:[e.jsx(X,{title:s.title,coverUrl:o,width:300,height:169,showTitle:!1,detail:!1,play:!1,showBorder:!0,aspectRatio:"16/9",onUpload:()=>!j&&M.current?.click(),uploading:j,showRemoveButton:!!c&&!x,removeMediaType:"cover",removeResourceId:s.title,removeResourceType:L,onRemoveSuccess:g,removeDisabled:j},`cover-${x?"removed":I?"preview":f}`),e.jsx("input",{ref:M,id:W,name:"cover",type:"file",accept:"image/*",style:{display:"none"},onChange:i,"aria-label":y})]})})()})]})})})]}),e.jsxs("div",{className:"edit-collection-modal-footer",children:[e.jsx("button",{className:"edit-collection-modal-cancel",onClick:l,disabled:j,children:h("common.cancel","Cancel")}),e.jsx("button",{className:"edit-collection-modal-save",onClick:A,disabled:!p()||j,children:j?h("common.uploading","Uploading..."):h("common.save","Save")})]})]})}),document.body):null}function ue({coverSize:n,routeBase:l,valueExtractor:s,getDisplayName:u,emptyMessage:S,listEndpoint:y,listResponseKey:m,editConfig:d}){const{isLoading:T,setLoading:L}=_(),{games:N,isLoading:R}=te(),[h,v]=a.useState([]),[j,$]=a.useState(null),[k,C]=a.useState(!1),[M,W]=a.useState(!1),[I,b]=a.useState(null),w=a.useRef(null),U=a.useRef(new Map);a.useEffect(()=>{L(R||k||!M)},[R,k,M,L]),z(w),a.useEffect(()=>{if(!m){$(null);return}let r=!0;const f=y||l;return(async()=>{C(!0);try{const i=B(D,f),g=await fetch(i,{headers:J({Accept:"application/json"})});if(!g.ok)throw new Error(`HTTP ${g.status}`);const t=((await g.json())?.[m]||[]).map(c=>({id:String(c.id),title:c.title,cover:c.cover}));r&&$(t)}catch(i){console.error("Error fetching tag list:",String(i.message||i)),r&&$([])}finally{r&&C(!1)}})(),()=>{r=!1}},[y,m,l]),a.useEffect(()=>{if(N.length===0){v([]);return}const r=new Map;N.forEach(i=>{const g=s(i);g&&g.forEach(A=>{const o=String(A).trim();if(!o)return;const t=o.toLowerCase();r.has(t)||r.set(t,o)})});const f=new Map;j&&j.forEach(i=>{f.set(i.title.toLowerCase(),i)});const p=Array.from(r.values()).map(i=>f.get(i.toLowerCase())||{id:i,title:i});p.sort((i,g)=>{const A=u?u(i.title):i.title,o=u?u(g.title):g.title;return O(A,o)}),v(p)},[N,s,u,j]);const x=a.useMemo(()=>r=>`${l}/${encodeURIComponent(r.title)}`,[l]),F=a.useMemo(()=>r=>ee(D,r.cover),[]),H=r=>{v(f=>f.map(p=>p.title.toLowerCase()===r.title.toLowerCase()?r:p)),$(f=>f&&f.map(p=>p.title.toLowerCase()===r.title.toLowerCase()?r:p)),I&&I.title.toLowerCase()===r.title.toLowerCase()&&b(r)},P=r=>{b(r)},K=()=>{b(null)};return a.useLayoutEffect(()=>{!R&&!k?requestAnimationFrame(()=>{requestAnimationFrame(()=>{W(!0)})}):W(!1)},[R,k,h.length]),e.jsxs("main",{className:"flex-1 home-page-content",children:[e.jsx("div",{className:"home-page-layout",children:e.jsx("div",{className:"home-page-content-wrapper",style:{opacity:M?1:0,transition:"opacity 0.2s ease-in-out"},children:e.jsx("div",{ref:w,className:"home-page-scroll-container",children:!T&&e.jsx(re,{items:h,coverSize:n*2,itemRefs:U,onItemEdit:d?P:void 0,getDisplayName:r=>u?u(r.title):r.title,getRoute:x,getCoverUrl:F,emptyMessage:S})})})}),d&&I&&e.jsx(ae,{isOpen:!!I,onClose:K,item:I,onItemUpdate:H,title:d.title,coverDescription:d.coverDescription,routeBase:d.routeBase||l,responseKey:d.responseKey,localCoverPrefix:d.localCoverPrefix,removeResourceType:d.removeResourceType,updateEventName:d.updateEventName,updateEventPayloadKey:d.updateEventPayloadKey})]})}export{ue as T};
