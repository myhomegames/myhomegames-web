import{j as e,u as ne,r as l,b as ie}from"./react-vendor-jNdKP8wU.js";import{l as se,u as re,h as V,i as ce,b as de,c as ue,d as he,A as fe,e as ve}from"./page-CollectionsPage.tsx-DjVo-48O.js";import{u as le}from"./i18n-vendor-mPXi0JFR.js";import{A as G,g as O}from"./page-AddGamePage.tsx-CGFUTWrs.js";function me({item:a,coverSize:i,itemRefs:o,onItemEdit:h,getDisplayName:F,getCoverUrl:$,getRoute:w}){const d=ne(),f=i*(9/16),U=F?F(a):a.title,b=$?$(a):"",P=()=>{const x=w?w(a):`/category/${a.id}`;d(x)},E=()=>{h&&h(a)};return e.jsx("div",{ref:x=>{x&&o?.current&&o.current.set(a.id,x)},className:"group cursor-pointer tag-list-item",style:{width:`${i}px`,minWidth:`${i}px`},onClick:P,children:e.jsx(se,{title:U,coverUrl:b,width:i,height:f,onClick:P,onEdit:h?E:void 0,showTitle:a.showTitle!==!1,titlePosition:"overlay",detail:!0,play:!1,showBorder:!0,aspectRatio:"16/9"})},a.id)}function pe({items:a,coverSize:i=150,itemRefs:o,onItemEdit:h,getDisplayName:F,getCoverUrl:$,getRoute:w,emptyMessage:d}){const{t:f}=le();return a.length===0?e.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",minHeight:"400px"},children:e.jsx("div",{className:"text-gray-400 text-center",children:d||f("categories.noCategoriesFound")})}):e.jsx("div",{className:"tag-list-container",style:{gridTemplateColumns:`repeat(auto-fill, ${i}px)`},children:a.map(U=>e.jsx(me,{item:U,coverSize:i,itemRefs:o,onItemEdit:h,getDisplayName:F,getCoverUrl:$,getRoute:w},U.id))})}function ge({isOpen:a,onClose:i,item:o,onItemUpdate:h,title:F,coverDescription:$,routeBase:w,responseKey:d,localCoverPrefix:f,removeResourceType:U,getRouteSegment:b,listResponseKey:P,updateEventName:E,updateEventPayloadKey:x,coverSize:_=300,getDisplayName:B}){const{t:j}=le(),{setLoading:L}=re(),[D,A]=l.useState(!1),[Y,v]=l.useState(null),[W,k]=l.useState(!1),Z=l.useRef(null),[M,H]=l.useState(null),[X,J]=l.useState(null),[C,Q]=l.useState(!1),[r,u]=l.useState(Date.now()),[n,s]=l.useState(o.showTitle!==!1),T=w.startsWith("/")?w:`/${w}`,R=b?b(o):encodeURIComponent(o.title),y=l.useMemo(()=>{if(!o?.cover||o.cover.trim()==="")return"";const t=o.cover.split("?")[0].split("&")[0];if(t.startsWith("http"))return"";const m=w.replace(/^\//,"");if(!b&&t.includes(`/${m}/`)&&t.endsWith("/cover.webp"))return"";const p=V(G,t),g=p.includes("?")?"&":"?";return`${p}${g}t=${r}`},[o?.cover,r,w,b]);l.useEffect(()=>{a&&o?(s(o.showTitle!==!1),v(null),H(null),J(null),Q(!1),u(Date.now())):a||(H(null),J(null))},[a,o]),l.useEffect(()=>{o&&!o.cover&&!C&&!X&&(Q(!0),H(null),u(Date.now()))},[o?.cover]),l.useEffect(()=>{if(!a)return;function t(m){m.key==="Escape"&&(m.stopPropagation(),i())}return document.addEventListener("keydown",t,!0),document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",t,!0),document.body.style.overflow=""}},[a,i]);const z=()=>n!==(o.showTitle!==!1)||X!==null||C,ee=t=>{const m=t.target.files?.[0];if(m){if(!m.type.startsWith("image/")){v(j("gameDetail.invalidImageType","File must be an image")),t.target.value="";return}const c=new FileReader;c.onloadend=()=>{H(c.result)},c.readAsDataURL(m),J(m),Q(!1),v(null),t.target.value=""}},te=()=>{Q(!0),H(null),J(null),u(Date.now())},K=async()=>{A(!0),v(null),L(!0);try{let t=null;if(C&&o.cover)try{const c=V(G,`${T}/${R}/delete-cover`),p=await fetch(c,{method:"DELETE",headers:{"X-Auth-Token":O()||""}});if(!p.ok){const S=await p.json().catch(()=>({error:"Failed to remove cover"}));throw new Error(S.error||"Failed to remove cover")}const g=await p.json();g[d]&&(t=g[d].cover||null)}catch(c){v(String(c.message||c)),A(!1),L(!1);return}if(X){k(!0);try{const c=new FormData;c.append("file",X);const p=V(G,`${T}/${R}/upload-cover`),g=await fetch(p,{method:"POST",headers:{"X-Auth-Token":O()||""},body:c});if(!g.ok){const q=await g.json().catch(()=>({error:"Failed to upload cover"}));throw new Error(q.error||"Failed to upload cover")}const S=await g.json();S[d]&&S[d].cover&&(t=S[d].cover)}catch(c){k(!1),L(!1),A(!1),v(String(c.message||c));return}finally{k(!1)}}const m={};if(n!==(o.showTitle!==!1)&&(m.showTitle=n),Object.keys(m).length>0){const c=V(G,`${T}/${R}`),p=await fetch(c,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":O()||""},body:JSON.stringify(m)});if(!p.ok){const I=await p.json();throw new Error(I.error||"Failed to update tag")}const g=await p.json();let S=t!==null?t:g[d]?.cover||o.cover;if(t&&S){const I=S.includes("?")?"&":"?";S=`${S}${I}t=${Date.now()}`}const q={id:g[d]?.id||o.id,title:g[d]?.title||o.title,cover:S,showTitle:g[d]?.showTitle??n};E&&x&&window.dispatchEvent(new CustomEvent(E,{detail:{[x]:q}})),h(q)}else if(X||C){const c=V(G,T),p=await fetch(c,{method:"GET",headers:{Accept:"application/json","X-Auth-Token":O()||""}});if(p.ok){const g=await p.json(),S=P??(d.endsWith("y")?`${d.slice(0,-1)}ies`:`${d}s`),q=g[S]||[],I=b?q.find(N=>String(N.id)===String(o.id)):q.find(N=>N.title.toLowerCase()===o.title.toLowerCase());if(I){let N=t!==null?t:I.cover;if((t!==null||C)&&N){const ae=N.includes("?")?"&":"?";N=`${N}${ae}t=${Date.now()}`}const oe={id:I.id,title:I.title,cover:N,showTitle:I.showTitle??o.showTitle};E&&x&&window.dispatchEvent(new CustomEvent(E,{detail:{[x]:oe}})),h(oe)}}}else{i();return}i()}catch(t){v(String(t.message||t))}finally{A(!1),L(!1)}};return a?ie.createPortal(e.jsx("div",{className:"edit-collection-modal-overlay",onClick:i,children:e.jsxs("div",{className:"edit-collection-modal-container",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"edit-collection-modal-header",children:[e.jsxs("h2",{children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"8px",verticalAlign:"middle"},children:[e.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),e.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]}),F]}),e.jsx("button",{className:"edit-collection-modal-close",onClick:i,"aria-label":"Close",children:"Ã—"})]}),e.jsxs("div",{className:"edit-collection-modal-content",children:[Y&&e.jsx("div",{className:"edit-collection-modal-error",children:Y}),e.jsxs("div",{className:"edit-collection-modal-media",children:[e.jsx("div",{className:"edit-collection-modal-media-options",children:e.jsxs("label",{className:"edit-collection-modal-media-checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:n,onChange:t=>s(t.target.checked),"aria-label":j("gameDetail.showTitle","Show title on cover")}),e.jsx("span",{children:j("gameDetail.showTitle","Show title on cover")})]})}),e.jsxs("div",{className:"edit-collection-modal-media-row",children:[e.jsxs("div",{className:"edit-collection-modal-media-info",children:[e.jsx("div",{className:"edit-collection-modal-label",children:j("gameDetail.cover","Cover")}),e.jsx("div",{className:"edit-collection-modal-media-description",children:$||j("gameDetail.coverFormat","Recommended format: WebP, ratio 2:3 (e.g., 400x600px)")})]}),e.jsx("div",{className:"edit-collection-modal-media-image-container",children:(()=>{const t=C?"":M||y,m=t&&t.trim()!=="";return e.jsxs(e.Fragment,{children:[e.jsx(se,{title:B?B(o.title):o.title,coverUrl:t,width:Math.min(_,320),height:Math.min(_,320)*(9/16),showTitle:n,titlePosition:"overlay",detail:!1,play:!1,showBorder:!0,aspectRatio:"16/9",onUpload:()=>!W&&!D&&Z.current?.click(),uploading:W,showRemoveButton:!!m&&!C,removeMediaType:"cover",removeResourceId:b?b(o):o.title,removeResourceType:U,onRemoveSuccess:te,removeDisabled:D||W},`cover-${C?"removed":M?"preview":y}`),e.jsx("input",{ref:Z,id:"edit-tag-cover-input",name:"cover",type:"file",accept:"image/*",style:{display:"none"},onChange:ee,"aria-label":j("gameDetail.cover","Cover")})]})})()})]})]})]}),e.jsxs("div",{className:"edit-collection-modal-footer",children:[e.jsx("button",{className:"edit-collection-modal-cancel",onClick:i,disabled:D,children:j("common.cancel","Cancel")}),e.jsx("button",{className:"edit-collection-modal-save",onClick:K,disabled:D||!z(),children:D?j("common.saving","Saving..."):j("common.save","Save")})]})]})}),document.body):null}function ye({coverSize:a,routeBase:i,valueExtractor:o,getDisplayName:h,emptyMessage:F,listEndpoint:$,listResponseKey:w,showAlphabetNavigator:d=!1,editConfig:f}){const{isLoading:U,setLoading:b}=re(),{games:P,isLoading:E}=ce(),[x,_]=l.useState([]),[B,j]=l.useState(null),[L,D]=l.useState(!1),[A,Y]=l.useState(!1),[v,W]=l.useState(null),k=l.useRef(null),Z=l.useRef(new Map),M=l.useRef(null);l.useEffect(()=>{b(E||L||!A)},[E,L,A,b]),de(k),l.useEffect(()=>{if(!w){j(null);return}let r=!0;const u=$||i;let n=null,s=null;const T=async(R=0)=>{n=new AbortController,s=setTimeout(()=>n.abort(),9e4),D(!0);try{const y=V(G,u),z=await fetch(y,{headers:ve({Accept:"application/json"}),signal:n.signal});if(s&&clearTimeout(s),s=null,!z.ok)throw new Error(`HTTP ${z.status}`);const K=((await z.json())?.[w]||[]).map(t=>({id:String(t.id),title:t.title,cover:t.cover,showTitle:t.showTitle}));r&&j(K)}catch(y){if(s&&clearTimeout(s),s=null,r&&R<1){setTimeout(()=>T(R+1),2e3);return}y?.name==="AbortError"?console.debug("Tag list request timed out, using empty list."):console.error("Error fetching tag list:",String(y.message||y)),r&&j([])}finally{r&&D(!1)}};return T(),()=>{r=!1,n&&n.abort(),s!=null&&clearTimeout(s)}},[$,w,i]),l.useEffect(()=>{if(P.length===0){_([]);return}const r=new Set;P.forEach(s=>{const T=o(s);T&&T.forEach(R=>{const y=String(R).trim();y&&r.add(y)})});const u=new Map;B&&B.forEach(s=>{u.set(String(s.id),s)});const n=Array.from(r).map(s=>u.get(s)||{id:s,title:s});n.sort((s,T)=>{const R=h?h(s.title):s.title,y=h?h(T.title):T.title;return ue(R,y)}),M.current===null&&_(n)},[P,o,h,B]);const H=l.useMemo(()=>r=>`${i}/${encodeURIComponent(r.id)}`,[i]),X=l.useMemo(()=>r=>he(G,r.cover),[]),J=r=>{const u=n=>String(n.id)===String(r.id);_(n=>n.map(s=>u(s)?r:s)),j(n=>n&&n.map(s=>u(s)?r:s)),v&&u(v)&&W(r)},C=r=>{const u=k.current;u&&(M.current=u.scrollTop),W(r)},Q=()=>{W(null)};return l.useLayoutEffect(()=>{!E&&!L?requestAnimationFrame(()=>{requestAnimationFrame(()=>{Y(!0)})}):Y(!1)},[E,L,x.length]),l.useLayoutEffect(()=>{if(!v&&M.current!==null&&k.current){const r=k.current,u=M.current;if(M.current=null,r.scrollHeight>0){r.scrollTop=u;try{sessionStorage.setItem(window.location.pathname,u.toString())}catch{}}}},[v]),e.jsxs("main",{className:"flex-1 home-page-content",children:[e.jsxs("div",{className:"home-page-layout",children:[e.jsx("div",{className:"home-page-content-wrapper",style:{opacity:A?1:0,transition:"opacity 0.2s ease-in-out"},children:e.jsx("div",{ref:k,className:"home-page-scroll-container",children:!U&&e.jsx(pe,{items:x,coverSize:a*2,itemRefs:Z,onItemEdit:f?C:void 0,getDisplayName:r=>h?h(r.title):r.title,getRoute:H,getCoverUrl:X,emptyMessage:F})})}),d&&A&&x.length>0&&e.jsx(fe,{games:x,scrollContainerRef:k,itemRefs:Z,ascending:!0,viewMode:"grid",coverSize:a*2})]}),f&&v&&e.jsx(ge,{isOpen:!!v,onClose:Q,item:v,onItemUpdate:J,title:f.title,coverDescription:f.coverDescription,routeBase:f.routeBase||i,responseKey:f.responseKey,localCoverPrefix:f.localCoverPrefix,removeResourceType:f.removeResourceType,getRouteSegment:f.getRouteSegment,listResponseKey:f.listResponseKey,updateEventName:f.updateEventName,updateEventPayloadKey:f.updateEventPayloadKey,coverSize:a*2,getDisplayName:h})]})}export{ye as T};
