import{r,j as f,u as P}from"./react-vendor-jNdKP8wU.js";import{b as A,C as N,u as R,c as U,d as M}from"./page-CategoriesPage.tsx-UEkNxXUO.js";import{A as j,g as T,u as _}from"./page-AddGamePage.tsx-lJZ2PP1m.js";import{E as O}from"./page-CollectionDetail.tsx-aYxxjzsd.js";import{u as $}from"./i18n-vendor-mPXi0JFR.js";import{c as F,A as G}from"./page-CategoryPage.tsx-CkrIduET.js";function D(e,S=!0){const[u,a]=r.useState(null),[d,y]=r.useState(!1);return r.useEffect(()=>{if(!S||!e){a(null),y(!1);return}y(!0),(async()=>{try{const m=A(j,`/collections/${e}/games`),p=await fetch(m,{headers:{Accept:"application/json","X-Auth-Token":T()}});if(p.ok){const v=((await p.json()).games||[]).some(i=>!!i.command);a(v)}else a(!1)}catch{a(!1)}finally{y(!1)}})()},[e,S]),{hasPlayableGame:u,isLoading:d}}const b=r.createContext(void 0),I="";function Z({children:e}){const[S,u]=r.useState(null),[a,d]=r.useState(null),[y,w]=r.useState(!0),m=async()=>{w(!0);try{const i=new URLSearchParams(window.location.search),t=i.get("twitch_token"),c=i.get("user_id");if(t&&c&&(localStorage.setItem("twitch_token",t),localStorage.setItem("twitch_user_id",c),window.history.replaceState({},document.title,window.location.pathname),await p(t)))return;const l=localStorage.getItem("twitch_token");if(l){if(await p(l))return;localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id")}u(null),d(null)}catch(i){console.error("Auth check error:",i),u(null),d(null)}finally{w(!1)}},p=async i=>{const t=localStorage.getItem("twitch_client_id"),c=I;try{const l={"X-Auth-Token":i};t&&!c&&(l["X-Twitch-Client-Id"]=t);const o=await fetch(`${j}/auth/me`,{headers:l});if(o.ok){const n=await o.json();return u(n),d(i),_(),!0}else{const n=await o.text().catch(()=>"");if(console.error(`Failed to validate token: ${o.status} ${n}`),!c)return localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),u(null),d(null),!1}}catch(l){return console.error("Failed to fetch user info:",l),localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),u(null),d(null),!1}},C=async(i=!1)=>{const t=localStorage.getItem("twitch_client_id"),c=localStorage.getItem("twitch_client_secret");if(!(!t||!c))try{const l=String(t).trim(),o=String(c).trim(),s={clientId:l,clientSecret:o,forceVerify:!!i},g=await fetch(`${j}/auth/twitch`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(g.ok){const h=await g.json();window.location.href=h.authUrl}else{const h=await g.text().catch(()=>"Unknown error");let x;try{x=JSON.parse(h)}catch{x={error:h}}alert(`Errore durante il login: ${x.error||g.statusText}`)}}catch(l){console.error("Login error:",l),l instanceof Error?alert(`Errore durante il login: ${l.message}`):alert("Errore durante il login: Si Ã¨ verificato un errore sconosciuto")}},k=()=>{localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),u(null),d(null),_(),a&&fetch(`${j}/auth/logout`,{method:"POST",headers:{"X-Auth-Token":a}}).catch(console.error)};r.useEffect(()=>{m()},[]);const v={user:S,token:a,isLoading:y,login:C,logout:k,checkAuth:m};return f.jsx(b.Provider,{value:v,children:e})}function X(){const e=r.useContext(b);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e}function B({collection:e,onCollectionClick:S,onPlay:u,onEditClick:a,onCollectionDelete:d,onCollectionUpdate:y,buildCoverUrl:w,coverSize:m,itemRefs:p}){const{t:C}=$(),k=m*1.5,{hasPlayableGame:v}=D(e.id,!0),i=async()=>{if(u)try{const t=A(j,`/collections/${e.id}/games`),c=await fetch(t,{headers:{Accept:"application/json","X-Auth-Token":T()}});if(c.ok){const n=((await c.json()).games||[]).find(s=>!!s.command);if(n){const s={id:n.id,title:n.title,summary:n.summary||"",cover:n.cover,day:n.day||null,month:n.month||null,year:n.year||null,stars:n.stars||null,genre:n.genre||null,command:n.command||null};u(s)}}}catch(t){console.error("Error fetching collection games for play:",t)}};return f.jsx("div",{ref:t=>{t&&p?.current&&p.current.set(e.id,t)},className:"group cursor-pointer collections-list-item",style:{width:`${m}px`,minWidth:`${m}px`},children:f.jsx(N,{title:e.title,coverUrl:w(j,e.cover,!0),width:m,height:k,onPlay:u?i:void 0,onClick:()=>S(e),onEdit:()=>a(e),collectionId:e.id,collectionTitle:e.title,onCollectionDelete:d?t=>{e.id===t&&d(e)}:void 0,onCollectionUpdate:y?t=>{const c={id:t.id,title:t.title,summary:t.summary,cover:t.cover,gameCount:e.gameCount};c.id===e.id&&y(c)}:void 0,showTitle:!0,subtitle:e.gameCount!==void 0?`${e.gameCount} ${C("common.elements")}`:void 0,detail:!0,play:v===!0,showBorder:!0},`${e.id}-${e.cover}`)},e.id)}function H({collections:e,onCollectionClick:S,onPlay:u,onCollectionUpdate:a,onCollectionDelete:d,buildCoverUrl:y,coverSize:w=150,itemRefs:m}){const{t:p}=$(),[C,k]=r.useState(!1),[v,i]=r.useState(null);if(e.length===0)return f.jsx("div",{className:"text-gray-400 text-center",children:p("table.noGames")});const t=o=>{const n={id:o.id,title:o.title,summary:o.summary,cover:o.cover,background:o.background};i(n),k(!0)},c=()=>{k(!1),i(null)},l=o=>{if(a){const n={id:o.id,title:o.title,summary:o.summary,cover:o.cover,background:o.background};a(n)}c()};return f.jsxs(f.Fragment,{children:[f.jsx("div",{className:"collections-list-container",style:{gridTemplateColumns:`repeat(auto-fill, ${w}px)`},children:e.map(o=>f.jsx(B,{collection:o,onCollectionClick:S,onPlay:u,onEditClick:t,onCollectionDelete:d,onCollectionUpdate:a,buildCoverUrl:y,coverSize:w,itemRefs:m},o.id))}),v&&f.jsx(O,{isOpen:C,onClose:c,collection:v,onCollectionUpdate:l})]})}function z({onPlay:e,coverSize:S}){const{setLoading:u,isLoading:a}=R(),{isLoading:d}=X(),y=P(),[w,m]=r.useState([]),[p,C]=r.useState(!1),[k]=r.useState(!0),v=r.useRef(null),i=r.useRef(new Map);U(v),r.useEffect(()=>{d||t()},[d]),r.useEffect(()=>{const s=()=>{t()};return window.addEventListener("metadataReloaded",s),()=>{window.removeEventListener("metadataReloaded",s)}},[]),r.useLayoutEffect(()=>{!a&&w.length>0?requestAnimationFrame(()=>{requestAnimationFrame(()=>{C(!0)})}):a&&C(!1)},[a,w.length]);async function t(){u(!0);try{const s=T(),g=A(j,"/collections"),h=await fetch(g,{headers:{Accept:"application/json","X-Auth-Token":s}});if(!h.ok)throw new Error(`HTTP ${h.status}`);const L=((await h.json()).collections||[]).map(E=>({id:E.id,title:E.title,summary:E.summary,cover:E.cover,background:E.background,gameCount:E.gameCount}));m(L)}catch(s){const g=String(s.message||s);console.error("Error fetching collections:",g)}finally{u(!1)}}function c(s){y(`/collections/${s.id}`)}const l=s=>{m(g=>g.map(h=>String(h.id)===String(s.id)?s:h)),window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collection:s}}))},o=s=>{m(g=>g.filter(h=>h.id!==s.id))},n=r.useMemo(()=>{const s=[...w];return s.sort((g,h)=>{const x=F(g.title||"",h.title||"");return k?x:-x}),s},[w,k]);return f.jsx("main",{className:"flex-1 home-page-content",children:f.jsxs("div",{className:"home-page-layout",children:[f.jsx("div",{className:"home-page-content-wrapper",style:{opacity:p?1:0,transition:"opacity 0.2s ease-in-out"},children:f.jsx("div",{ref:v,className:"home-page-scroll-container",children:!a&&f.jsx(H,{collections:n,onCollectionClick:c,onPlay:e,onCollectionUpdate:l,onCollectionDelete:o,buildCoverUrl:M,coverSize:S,itemRefs:i})})}),p&&f.jsx(G,{games:n,scrollContainerRef:v,itemRefs:i,ascending:k})]})})}export{Z as A,z as C,D as a,X as u};
