import{r as a,j as l}from"./react-vendor-mZEhzm5d.js";import{u as Ee,c as Ie,b as x,d as le}from"./page-CategoriesPage.tsx-Pj1wP9IV.js";import{u as Ge,c as je,e as Ce,g as we,G as Fe,h as ke,i as xe,A as Te}from"./page-CategoryPage.tsx-BGJknrhL.js";import{u as Be}from"./page-CollectionsPage.tsx-BexaroTA.js";import{A as T,g as B}from"./page-AddGamePage.tsx-BrD1K-KO.js";function Ye({onGameClick:L,onGamesLoaded:oe,onPlay:D,coverSize:ie,viewMode:c,allCollections:v=[]}){const{setLoading:q,isLoading:h}=Ee(),{isLoading:O}=Be(),[o,j]=a.useState([]),[_,z]=a.useState(!1),[f,K]=a.useState(()=>localStorage.getItem("libraryFilterField")||"all"),[S,ce]=a.useState(()=>{const e=localStorage.getItem("librarySelectedYear");return e?parseInt(e,10):null}),[y,ge]=a.useState(()=>{const e=localStorage.getItem("librarySelectedDecade");return e?parseInt(e,10):null}),[p,ue]=a.useState(()=>{const e=localStorage.getItem("librarySelectedAgeRating");return e!==null?e:null}),[b,de]=a.useState(()=>localStorage.getItem("librarySelectedCollection")||null),[i,Q]=a.useState(()=>localStorage.getItem("librarySelectedGenre")||null),[N,me]=a.useState([]),[W,fe]=a.useState([]),[he,Se]=a.useState([]),[Z,ye]=a.useState(new Map),[u,ee]=a.useState(()=>localStorage.getItem("librarySortField")||"title"),[d,U]=a.useState(()=>{const e=localStorage.getItem("librarySortAscending");return e?e==="true":!0}),$=a.useRef(null),te=a.useRef(null),C=a.useRef(new Map),[w,pe]=a.useState(()=>{const e=localStorage.getItem("tableColumnVisibility");if(e)try{return JSON.parse(e)}catch{return{title:!0,releaseDate:!0,year:!1,stars:!1,criticRating:!1,ageRating:!1}}return{title:!0,releaseDate:!0,criticRating:!1,ageRating:!1}});a.useEffect(()=>{localStorage.setItem("tableColumnVisibility",JSON.stringify(w))},[w]);const be=e=>{u===e?U(!d):(ee(e),U(!0))},Ae=e=>{pe(t=>({...t,[e]:!t[e]}))};Ie($,c==="table"?void 0:c),a.useEffect(()=>{O||(ae(),se(),re())},[O]),a.useEffect(()=>{const e=()=>{ae(),se(),re()};return window.addEventListener("metadataReloaded",e),()=>{window.removeEventListener("metadataReloaded",e)}},[]),Ge({setGames:j,enabledEvents:["gameUpdated"]}),a.useLayoutEffect(()=>{!h&&o.length>0?requestAnimationFrame(()=>{requestAnimationFrame(()=>{z(!0)})}):h&&z(!1)},[h,o.length]),a.useEffect(()=>{localStorage.setItem("libraryFilterField",f)},[f]),a.useEffect(()=>{S!==null?localStorage.setItem("librarySelectedYear",S.toString()):localStorage.removeItem("librarySelectedYear")},[S]),a.useEffect(()=>{i!==null?localStorage.setItem("librarySelectedGenre",i):localStorage.removeItem("librarySelectedGenre")},[i]),a.useEffect(()=>{y!==null?localStorage.setItem("librarySelectedDecade",y.toString()):localStorage.removeItem("librarySelectedDecade")},[y]),a.useEffect(()=>{b!==null?localStorage.setItem("librarySelectedCollection",b):localStorage.removeItem("librarySelectedCollection")},[b]),a.useEffect(()=>{p!==null?localStorage.setItem("librarySelectedAgeRating",p):localStorage.removeItem("librarySelectedAgeRating")},[p]),a.useEffect(()=>{localStorage.setItem("librarySortField",u)},[u]),a.useEffect(()=>{localStorage.setItem("librarySortAscending",d.toString())},[d]),a.useEffect(()=>{if(o.length===0||N.length===0)return;const e=new Set;o.forEach(s=>{s.genre&&(Array.isArray(s.genre)?s.genre.forEach(n=>{typeof n=="string"?e.add(n):e.add(String(n))}):typeof s.genre=="string"&&e.add(s.genre))});const t=N.filter(s=>e.has(s.title));fe(t),i!==null&&f==="genre"&&(t.some(n=>n.title===i)||(Q(null),K("all")))},[o,N,i,f]);async function se(){try{const e=x(T,"/categories"),t=await fetch(e,{headers:{Accept:"application/json","X-Auth-Token":B()}});if(!t.ok)throw new Error(`HTTP ${t.status}`);const g=((await t.json()).categories||[]).map(m=>({id:m,title:m}));me(g)}catch(e){const t=String(e.message||e);console.error("Error fetching categories:",t)}}async function re(){try{const e=x(T,"/collections"),t=await fetch(e,{headers:{Accept:"application/json","X-Auth-Token":B()}});if(!t.ok)throw new Error(`HTTP ${t.status}`);const g=((await t.json()).collections||[]).map(r=>({id:r.id,title:r.title}));Se(g);const m=new Map;for(const r of g)try{const F=x(T,`/collections/${r.id}/games`),I=await fetch(F,{headers:{Accept:"application/json","X-Auth-Token":B()}});if(I.ok){const J=((await I.json()).games||[]).map(ne=>ne.id);m.set(r.id,J)}}catch(F){console.error(`Error fetching games for collection ${r.id}:`,F.message)}ye(m)}catch(e){const t=String(e.message||e);console.error("Error fetching collections:",t)}}async function ae(){q(!0);try{const e=x(T,"/libraries/library/games",{sort:"title"}),t=B(),s=await fetch(e,{headers:{Accept:"application/json","X-Auth-Token":t}});if(!s.ok)throw new Error(`HTTP ${s.status}`);const m=((await s.json()).games||[]).map(r=>({id:r.id,title:r.title,summary:r.summary,cover:r.cover,background:r.background,day:r.day,month:r.month,year:r.year,stars:r.stars,genre:r.genre,criticratings:r.criticratings,userratings:r.userratings,command:r.command||null,themes:r.themes||null,platforms:r.platforms||null,gameModes:r.gameModes||null,playerPerspectives:r.playerPerspectives||null,websites:r.websites||null,ageRatings:r.ageRatings||null,developers:r.developers||null,publishers:r.publishers||null,franchise:r.franchise||null,collection:r.collection||null,screenshots:r.screenshots||null,videos:r.videos||null,gameEngines:r.gameEngines||null,keywords:r.keywords||null,alternativeNames:r.alternativeNames||null,similarGames:r.similarGames||null}));j(m),oe(m)}catch(e){const t=String(e.message||e);console.error("Error fetching library games:",t)}finally{q(!1)}}const E=a.useMemo(()=>{let e=[...o];return f!=="all"&&(e=e.filter(t=>{switch(f){case"genre":return i!==null?Array.isArray(t.genre)?t.genre.some(s=>(typeof s=="string"?s:String(s))===i):typeof t.genre=="string"?t.genre===i:!1:!0;case"year":return S!==null?t.year===S:t.year!==null&&t.year!==void 0;case"decade":return y!==null&&t.year!==null&&t.year!==void 0?Math.floor(t.year/10)*10===y:!1;case"collection":if(b!==null){const s=Z.get(b);return s?s.includes(t.id):!1}return!1;case"ageRating":if(p!==null){const[s,n]=p.split("-").map(Number);return t.ageRatings&&t.ageRatings.length>0?t.ageRatings.some(g=>g.category===s&&g.rating===n):!1}return!1;default:return!0}})),e.sort((t,s)=>{let n=0;switch(u){case"title":n=je(t.title||"",s.title||"");break;case"year":const g=t.year??0;n=(s.year??0)-g;break;case"stars":const r=t.stars??0;n=(s.stars??0)-r;break;case"releaseDate":const I=t.year??0,H=s.year??0;if(I!==H)n=H-I;else{const k=t.month??0,M=s.month??0;if(k!==M)n=M-k;else{const A=t.day??0;n=(s.day??0)-A}}break;case"criticRating":const J=t.criticratings??0;n=(s.criticratings??0)-J;break;case"userRating":const Re=t.userratings??0;n=(s.userratings??0)-Re;break;case"ageRating":const V=t.ageRatings&&t.ageRatings.length>0?t.ageRatings:[],X=s.ageRatings&&s.ageRatings.length>0?s.ageRatings:[];if(V.length===0&&X.length===0)n=0;else if(V.length===0)n=1;else if(X.length===0)n=-1;else{const k=V.reduce((A,R)=>{const G=R.category*1e3+R.rating;return G>A?G:A},0);n=X.reduce((A,R)=>{const G=R.category*1e3+R.rating;return G>A?G:A},0)-k}break;default:return 0}return u==="title"?d?n:-n:d?-n:n}),e},[o,f,S,y,i,b,p,u,d,W,Z]),Y=e=>{j(t=>t.map(s=>String(s.id)===String(e.id)?e:s)),window.dispatchEvent(new CustomEvent("gameUpdated",{detail:{game:e}}))},P=e=>{j(t=>t.filter(s=>s.id!==e.id))};return l.jsx("main",{className:"flex-1 home-page-content",children:l.jsxs("div",{className:"home-page-layout",children:[l.jsxs("div",{className:`home-page-content-wrapper ${!h&&o.length>0?"has-toolbar":""}`,style:{opacity:_?1:0,transition:"opacity 0.2s ease-in-out"},children:[!h&&o.length>0&&l.jsx(Ce,{gamesCount:E.length,games:o,onFilterChange:K,onYearFilterChange:ce,onGenreFilterChange:Q,onDecadeFilterChange:ge,onSortChange:ee,onSortDirectionChange:U,currentFilter:f,selectedYear:S,selectedGenre:i,selectedDecade:y,selectedCollection:b,onCollectionFilterChange:de,selectedAgeRating:p,onAgeRatingFilterChange:ue,currentSort:u,sortAscending:d,viewMode:c,availableGenres:W,availableCollections:he}),c==="table"&&!h&&o.length>0&&l.jsx(we,{columnVisibility:w,onToggleColumn:Ae,sortField:u,sortAscending:d,onSort:be}),l.jsx("div",{ref:$,className:`home-page-scroll-container ${c==="table"?"table-view":""}`,children:!h&&l.jsxs(l.Fragment,{children:[c==="grid"&&l.jsx(Fe,{games:E,onGameClick:L,onPlay:D,onGameUpdate:Y,onGameDelete:P,buildCoverUrl:le,coverSize:ie,itemRefs:C,viewMode:c,allCollections:v}),c==="detail"&&l.jsx(ke,{games:E,onGameClick:L,onPlay:D,onGameUpdate:Y,onGameDelete:P,buildCoverUrl:le,itemRefs:C,allCollections:v}),c==="table"&&l.jsx(xe,{games:E,onGameClick:L,onPlay:D,onGameUpdate:Y,onGameDelete:P,itemRefs:C,scrollContainerRef:te,allCollections:v,columnVisibility:w})]})})]}),u==="title"&&_&&l.jsx(Te,{games:E,scrollContainerRef:c==="table"?te:$,itemRefs:C,ascending:d})]})})}export{Ye as L};
