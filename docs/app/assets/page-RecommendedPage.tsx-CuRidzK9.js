import{j as c,r as o,c as G}from"./react-vendor-jNdKP8wU.js";import{h as I,u as z,e as B,b as F,m as X}from"./page-CategoriesPage.tsx-PfePlHQa.js";import{G as H}from"./page-CategoryPage.tsx-Ct3nuy93.js";import{u as q}from"./i18n-vendor-mPXi0JFR.js";import{A as D}from"./page-AddGamePage.tsx-SkGFkz5J.js";function Q({canScrollLeft:e,canScrollRight:n,onScrollToFirst:s,onScrollToLast:f}){return c.jsxs("div",{className:"recommended-section-nav",children:[c.jsx("button",{className:`recommended-section-nav-button ${e?"":"recommended-section-nav-button-hidden"}`,onClick:e?s:void 0,"aria-label":"Go to first",disabled:!e,children:c.jsx("svg",{width:"20",height:"20",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:2,children:c.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15.75 19.5L8.25 12l7.5-7.5"})})}),c.jsx("button",{className:`recommended-section-nav-button ${n?"":"recommended-section-nav-button-hidden"}`,onClick:n?f:void 0,"aria-label":"Go to last",disabled:!n,children:c.jsx("svg",{width:"20",height:"20",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:2,children:c.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M8.25 4.5l7.5 7.5-7.5 7.5"})})})]})}const k=new Map,$=[];let A=!1;const Y=500,_={it:"it",fr:"fr",es:"es",de:"de",pt:"pt",ja:"ja",zh:"zh",en:"en"};function K(e,n){const{t:s,i18n:f}=q(),[d,a]=o.useState(e),m=o.useRef(!1);return o.useEffect(()=>{const p=s(n,{defaultValue:"$$$$MISSING$$$$"});if(p!=="$$$$MISSING$$$$"&&p!==n&&p!==e){a(p);return}if(f.language==="en"){a(P(e));return}const h=`${e}-${f.language}`;if(k.has(h)){a(k.get(h));return}if(m.current)return;m.current=!0,(async()=>new Promise((g,w)=>{$.push({text:e,targetLang:f.language,cacheKey:h,resolve:g,reject:w}),V()}))().then(g=>{a(g),m.current=!1}).catch(g=>{console.error(`Error translating "${e}":`,g),a(e),m.current=!1})},[e,n,s,f.language]),d}function P(e){if(!e||typeof e!="string")return e;let n=e.replace(/-/g," ");return n=n.toLowerCase().split(" ").map(s=>s.length===0?s:s.charAt(0).toUpperCase()+s.slice(1)).join(" "),n}async function O(e,n){try{const s=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${n}&dt=t&q=${encodeURIComponent(e)}`,f=await fetch(s,{method:"GET",headers:{Accept:"application/json","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}});if(!f.ok)return null;const d=await f.json();if(Array.isArray(d)&&d[0]&&Array.isArray(d[0])){const a=d[0].map(m=>m&&m[0]).filter(Boolean);if(a.length>0)return a.join("")}return null}catch{return null}}async function V(){if(!(A||$.length===0)){for(A=!0;$.length>0;){const e=$.shift();if(!e)break;try{$.length>0&&await new Promise(d=>setTimeout(d,Y));const n=_[e.targetLang]||e.targetLang;if(!n||n==="en"){e.resolve(e.text);return}let s=3,f=null;for(;s>0;)try{const d=await O(e.text,n);if(d){const a=P(d);k.set(e.cacheKey,a),e.resolve(a);break}else{e.resolve(e.text);break}}catch(d){if(f=d,s--,s>0){const a=Math.pow(2,3-s)*1e3;await new Promise(m=>setTimeout(m,a))}}s===0&&f&&e.resolve(e.text)}catch(n){console.error("[useAutoTranslate] Error processing translation queue:",n),e.resolve(e.text)}}A=!1}}function J(e){try{const n=sessionStorage.getItem(e);return n?parseInt(n,10):0}catch{return 0}}function N(e,n){try{sessionStorage.setItem(e,n.toString())}catch{}}function Z({sectionId:e,games:n,onGameClick:s,onPlay:f,onGameUpdate:d,coverSize:a,allCollections:m=[]}){const p=G(),h=o.useRef(null),S=`${p.pathname}:${e}`,[g,w]=o.useState(!1),[R,b]=o.useState(!1),[j,L]=o.useState(!0),r=`recommended.${e}`,v=K(e,r),y=()=>{const t=h.current;if(!t)return;const l=t.scrollLeft,i=t.scrollWidth-t.clientWidth;w(l>0),b(l<i-1)},x=()=>{h.current?.scrollTo({left:0,behavior:"smooth"})},T=()=>{const t=h.current;if(t){const l=t.scrollWidth-t.clientWidth;t.scrollTo({left:l,behavior:"smooth"})}};return o.useEffect(()=>{const t=h.current;if(!t)return;L(!0);const l=J(S);if(l<=0){L(!1);return}const i=(E=0)=>{if(!t){L(!1);return}if(t.scrollWidth<=t.clientWidth){E<20?requestAnimationFrame(()=>i(E+1)):L(!1);return}t.scrollLeft=l,y(),L(!1)},u=setTimeout(()=>{i()},100);return()=>{clearTimeout(u),L(!1)}},[p.pathname,e,S,n.length]),o.useEffect(()=>{const t=h.current;if(!t)return;const l=()=>{j||N(S,t.scrollLeft),y()},i=u=>{const E=t.getBoundingClientRect();if(!(u.clientX>=E.left&&u.clientX<=E.right&&u.clientY>=E.top&&u.clientY<=E.bottom)||!(t.scrollWidth>t.clientWidth))return;if(Math.abs(u.deltaX)>Math.abs(u.deltaY)||Math.abs(u.deltaX)>0){u.preventDefault(),u.stopPropagation();const C=t.scrollLeft,W=t.scrollWidth-t.clientWidth,M=C>0&&u.deltaX<0,U=C<W&&u.deltaX>0;(M||U)&&(t.scrollLeft+=u.deltaX)}};return t.addEventListener("scroll",l,{passive:!0}),t.addEventListener("wheel",i,{passive:!1,capture:!0}),()=>{t.removeEventListener("scroll",l),t.removeEventListener("wheel",i);const u=t.scrollLeft;u>0&&!j&&N(S,u)}},[e,S,j]),o.useEffect(()=>{y();const t=setTimeout(y,200);return()=>clearTimeout(t)},[n.length]),n.length===0?null:c.jsxs("div",{className:"recommended-section",children:[c.jsxs("div",{className:"recommended-section-header",children:[c.jsx("h2",{className:"recommended-section-title",children:v}),c.jsx(Q,{canScrollLeft:g,canScrollRight:R,onScrollToFirst:x,onScrollToLast:T})]}),c.jsx("div",{ref:h,className:`recommended-section-scroll ${j?"restoring":""}`,children:c.jsx(H,{games:n,onGameClick:s,onPlay:f,onGameUpdate:d,buildCoverUrl:I,coverSize:a,allCollections:m})})]})}function le({onGameClick:e,onGamesLoaded:n,onPlay:s,coverSize:f,allCollections:d=[]}){const{setLoading:a}=z(),[m,p]=o.useState([]),[h,S]=o.useState(!1),[g,w]=o.useState(!1),R=o.useRef(null),b=o.useRef(!1);B(R);const j=r=>{p(v=>v.map(y=>({...y,games:y.games.map(x=>String(x.id)===String(r.id)?r:x)}))),window.dispatchEvent(new CustomEvent("gameUpdated",{detail:{game:r}}))};o.useEffect(()=>{const r=v=>{const x=v.detail?.game;x&&p(T=>T.map(t=>({...t,games:t.games.map(l=>String(l.id)===String(x.id)?x:l)})))};return window.addEventListener("gameUpdated",r),()=>{window.removeEventListener("gameUpdated",r)}},[]),o.useEffect(()=>{L()},[]),o.useEffect(()=>{const r=()=>{L()};return window.addEventListener("metadataReloaded",r),()=>{window.removeEventListener("metadataReloaded",r)}},[]),o.useLayoutEffect(()=>{g?g&&S(!1):requestAnimationFrame(()=>{requestAnimationFrame(()=>{S(!0)})})},[g,m.length]),o.useEffect(()=>{a(g||!h)},[g,h,a]);async function L(){if(!b.current){b.current=!0,w(!0),a(!0);try{const r=F(D,"/recommended"),v=await fetch(r,{headers:X({Accept:"application/json"})});if(!v.ok)throw new Error(`HTTP ${v.status}`);const T=((await v.json()).sections||[]).map(l=>({id:l.id,games:(l.games||[]).map(i=>({id:i.id,title:i.title,summary:i.summary,cover:i.cover,background:i.background,day:i.day,month:i.month,year:i.year,stars:i.stars,genre:i.genre,executables:i.executables||null}))}));p(T);const t=T.flatMap(l=>l.games);n(t)}catch(r){const v=String(r.message||r);console.error("Error fetching recommended sections:",v)}finally{w(!1),b.current=!1}}}return c.jsx("main",{className:"flex-1 home-page-content",children:c.jsx("div",{className:"home-page-layout",children:c.jsx("div",{className:"home-page-content-wrapper",style:{opacity:h?1:0,transition:"opacity 0.2s ease-in-out"},children:c.jsx("div",{ref:R,className:"home-page-scroll-container",style:{paddingTop:"16px",paddingBottom:"32px"},children:!g&&m.map(r=>c.jsx(Z,{sectionId:r.id,games:r.games,onGameClick:e,onPlay:s,onGameUpdate:j,coverSize:f,allCollections:d},r.id))})})})})}export{le as R};
