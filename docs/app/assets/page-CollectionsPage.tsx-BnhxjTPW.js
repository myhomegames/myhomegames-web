import{r as o,c as _,j as c,u as q}from"./react-vendor-jNdKP8wU.js";import{c as P,d as F,C as U,b as B,u as D,e as V,h as J}from"./page-CategoriesPage.tsx-PfePlHQa.js";import{A as I,g as K}from"./page-AddGamePage.tsx-SkGFkz5J.js";import{E as X}from"./page-CollectionDetail.tsx-DfNjLps5.js";import{E as Z,c as z,A as Q}from"./page-CategoryPage.tsx-Ct3nuy93.js";import{u as O}from"./i18n-vendor-mPXi0JFR.js";function Y(e,a=!0){const{collectionGameIds:t,isLoading:h,getCollectionGameIds:f}=P(),{games:E,isLoading:x}=F(),[L,m]=o.useState(!1);return o.useEffect(()=>{!a||!e||h||x||t.get(String(e))||(m(!0),f(e).then(()=>{m(!1)}).catch(()=>{m(!1)}))},[e,a,h,x]),o.useMemo(()=>{if(!a||!e)return{hasPlayableGame:null,isLoading:!1};if(h||x||L)return{hasPlayableGame:null,isLoading:!0};const g=t.get(String(e));return!g||g.length===0?{hasPlayableGame:!1,isLoading:!1}:{hasPlayableGame:g.some(w=>{const n=E.find(u=>String(u.id)===String(w));return n&&n.executables&&n.executables.length>0}),isLoading:!1}},[e,a,t,E,h,x,L])}function ee(e){try{const a=sessionStorage.getItem(e);if(!a)return null;const t=JSON.parse(a);return{scrollTop:t.scrollTop||0,scrollLeft:t.scrollLeft||0}}catch{return null}}function te(e,a,t){try{sessionStorage.setItem(e,JSON.stringify({scrollTop:a,scrollLeft:t}))}catch{}}const M=40,se=2;function re({collections:e,coverSize:a,containerRef:t,itemRefs:h,onCollectionClick:f,onPlay:E,onEditClick:x,onCollectionDelete:L,onCollectionUpdate:m,buildCoverUrl:G}){const g=_(),[l,w]=o.useState({width:0,height:0}),[n,u]=o.useState(!1),S=o.useRef(null),C=o.useRef(!1),r=o.useRef(null),p=`${g.pathname}:collections`,i=o.useMemo(()=>{if(l.width===0)return 1;const s=a+M;return Math.max(1,Math.floor((l.width+M)/s))},[l.width,a]),T=o.useMemo(()=>Math.ceil(e.length/i),[e.length,i]),N=a,k=a*1.5+M;o.useEffect(()=>{const s=()=>{if(t.current){const A=t.current.getBoundingClientRect();w({width:A.width-40,height:A.height||window.innerHeight-200})}};s(),window.addEventListener("resize",s);const y=new ResizeObserver(s);return t.current&&y.observe(t.current),()=>{window.removeEventListener("resize",s),y.disconnect()}},[t]),o.useEffect(()=>{const s=ee(p);if(!s||s.scrollTop===0&&s.scrollLeft===0){u(!0);return}if(l.height===0||T===0||i===0)return;C.current=!0,u(!1);const y=(v=0)=>{const R=S.current;if(!R){v<50?setTimeout(()=>y(v+1),50):C.current=!1;return}let d=null;if(R.element)d=R.element;else if(t.current){const b=t.current.querySelector('[style*="overflow"]');b&&(b.scrollHeight>b.clientHeight||b.scrollWidth>b.clientWidth)&&(d=b)}if(!d){v<50?setTimeout(()=>y(v+1),50):(C.current=!1,u(!0));return}try{d.scrollTop=s.scrollTop,d.scrollLeft=s.scrollLeft,setTimeout(()=>{const b=d.scrollTop,j=d.scrollLeft;(Math.abs(b-s.scrollTop)>10||Math.abs(j-s.scrollLeft)>10)&&v<5&&(d.scrollTop=s.scrollTop,d.scrollLeft=s.scrollLeft),setTimeout(()=>{C.current=!1,u(!0)},50)},50)}catch{v<10?setTimeout(()=>y(v+1),100):(C.current=!1,u(!0))}},A=setTimeout(()=>{y()},300);return()=>{clearTimeout(A),C.current=!1}},[g.pathname,p,l.height,T,i]),o.useEffect(()=>{let s=null,y=null;const A=(v=0)=>{const R=S.current;if(!R){v<20&&setTimeout(()=>A(v+1),100);return}let d=null;if(R.element)d=R.element;else if(t.current){const j=t.current.querySelector('[style*="overflow"]');j&&(j.scrollHeight>j.clientHeight||j.scrollWidth>j.clientWidth)&&(d=j)}if(!d){v<20&&setTimeout(()=>A(v+1),100);return}const b=()=>{C.current||(s&&clearTimeout(s),s=setTimeout(()=>{const j=d.scrollTop,H=d.scrollLeft;(!r.current||r.current.scrollTop!==j||r.current.scrollLeft!==H)&&(te(p,j,H),r.current={scrollTop:j,scrollLeft:H})},150))};d.addEventListener("scroll",b,{passive:!0}),y=()=>{s&&clearTimeout(s),d.removeEventListener("scroll",b)}};return A(),()=>{y&&y()}},[S.current,p,k,N,T,i]),o.useEffect(()=>{t&&"current"in t&&t.current&&(t.current.__virtualizedGridRef=S)},[t]);const $=({columnIndex:s,rowIndex:y,style:A})=>{const v=y*i+s;if(v>=e.length)return c.jsx("div",{style:A});const R=e[v];return c.jsx("div",{style:{...A,paddingLeft:s===0?0:M/2,paddingRight:s===i-1?0:M/2,paddingTop:y===0?0:M/2,paddingBottom:y===T-1?0:M/2},children:c.jsx(W,{collection:R,onCollectionClick:f,onPlay:E,onEditClick:x,onCollectionDelete:L,onCollectionUpdate:m,buildCoverUrl:G,coverSize:a,itemRefs:h})})};return l.width===0||l.height===0?c.jsx("div",{style:{width:"100%",height:"100%"}}):c.jsx("div",{style:{opacity:n?1:0,transition:n?"opacity 0.1s":"none"},children:c.jsx(Z,{gridRef:S,className:"virtualized-collections-grid",columnCount:i,columnWidth:N+M,defaultHeight:l.height,defaultWidth:l.width,rowCount:T,rowHeight:k,overscanCount:se,cellComponent:$,cellProps:{},style:{height:l.height,width:l.width},onResize:s=>{w({width:s.width,height:s.height})}})})}const ie=100;function W({collection:e,onCollectionClick:a,onPlay:t,onEditClick:h,onCollectionDelete:f,onCollectionUpdate:E,buildCoverUrl:x,coverSize:L,itemRefs:m}){const{t:G}=O(),g=L*1.5,{hasPlayableGame:l}=Y(e.id,!0),w=async()=>{if(t)try{const n=B(I,`/collections/${e.id}/games`),u=await fetch(n,{headers:{Accept:"application/json","X-Auth-Token":K()}});if(u.ok){const r=((await u.json()).games||[]).find(p=>p.executables&&p.executables.length>0);if(r){const p={id:r.id,title:r.title,summary:r.summary||"",cover:r.cover,day:r.day||null,month:r.month||null,year:r.year||null,stars:r.stars||null,genre:r.genre||null,executables:r.executables||null};t(p)}}}catch(n){console.error("Error fetching collection games for play:",n)}};return c.jsx("div",{ref:n=>{n&&m?.current&&m.current.set(String(e.id),n)},className:"group cursor-pointer collections-list-item",style:{width:`${L}px`,minWidth:`${L}px`},children:c.jsx(U,{title:e.title,coverUrl:x(I,e.cover,!0),width:L,height:g,onPlay:t?w:void 0,onClick:()=>a(e),onEdit:()=>h(e),collectionId:e.id,collectionTitle:e.title,onCollectionDelete:f?n=>{e.id===n&&f(e)}:void 0,onCollectionUpdate:E?n=>{const u={id:n.id,title:n.title,summary:n.summary,cover:n.cover,gameCount:e.gameCount};u.id===e.id&&E(u)}:void 0,showTitle:!0,subtitle:e.gameCount!==void 0?`${e.gameCount} ${G("common.elements")}`:void 0,detail:!0,play:l===!0,showBorder:!0},`${e.id}-${e.cover}`)})}function ne({collections:e,onCollectionClick:a,onPlay:t,onCollectionUpdate:h,onCollectionDelete:f,buildCoverUrl:E,coverSize:x=150,itemRefs:L,scrollContainerRef:m}){const{t:G}=O(),[g,l]=o.useState(!1),[w,n]=o.useState(null);if(e.length===0)return c.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",minHeight:"400px"},children:c.jsx("div",{className:"text-gray-400 text-center",children:G("collections.noCollectionsFound")})});const u=i=>{const T={id:i.id,title:i.title,summary:i.summary,cover:i.cover,background:i.background};n(T),l(!0)},S=()=>{l(!1),n(null)},C=i=>{if(h){const T={id:i.id,title:i.title,summary:i.summary,cover:i.cover,background:i.background};h(T)}S()},r=e.length>ie,p=o.useRef(null);return c.jsxs(c.Fragment,{children:[c.jsx("div",{ref:p,className:"collections-list-container",style:{gridTemplateColumns:r?void 0:`repeat(auto-fill, ${x}px)`,height:r?"100%":void 0},children:r?c.jsx(re,{collections:e,coverSize:x,containerRef:m||p,itemRefs:L,onCollectionClick:a,onPlay:t,onEditClick:u,onCollectionDelete:f,onCollectionUpdate:h,buildCoverUrl:E}):e.map(i=>c.jsx(W,{collection:i,onCollectionClick:a,onPlay:t,onEditClick:u,onCollectionDelete:f,onCollectionUpdate:h,buildCoverUrl:E,coverSize:x,itemRefs:L},String(i.id)))}),w&&c.jsx(X,{isOpen:g,onClose:S,collection:w,onCollectionUpdate:C})]})}function he({onPlay:e,coverSize:a}){const{setLoading:t}=D(),{collections:h,isLoading:f,updateCollection:E,removeCollection:x}=P(),L=q(),[m,G]=o.useState(!1),[g]=o.useState(!0),l=o.useRef(null),w=o.useRef(new Map);o.useEffect(()=>{t(f||!m)},[f,m,t]),V(l);function n(r){L(`/collections/${r.id}`)}const u=r=>{E(r)},S=r=>{x(r.id)},C=o.useMemo(()=>{const p=[...h.filter((i,T,N)=>T===N.findIndex(k=>String(k.id)===String(i.id)))];return p.sort((i,T)=>{const N=z(i.title||"",T.title||"");return g?N:-N}),p},[h,g]);return o.useLayoutEffect(()=>{f?f&&G(!1):requestAnimationFrame(()=>{requestAnimationFrame(()=>{G(!0)})})},[f,C.length]),c.jsx("main",{className:"flex-1 home-page-content",children:c.jsxs("div",{className:"home-page-layout",children:[c.jsx("div",{className:"home-page-content-wrapper",style:{opacity:m?1:0,transition:"opacity 0.2s ease-in-out"},children:c.jsx("div",{ref:l,className:"home-page-scroll-container",children:!f&&c.jsx(ne,{collections:C,onCollectionClick:n,onPlay:e,onCollectionUpdate:u,onCollectionDelete:S,buildCoverUrl:J,coverSize:a,itemRefs:w,scrollContainerRef:l})})}),m&&c.jsx(Q,{games:C,scrollContainerRef:l,itemRefs:w,ascending:g,virtualizedGridRef:l.current?l.current.__virtualizedGridRef:void 0,viewMode:"grid",coverSize:a})]})})}export{he as C,Y as u};
