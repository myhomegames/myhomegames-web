import{r as i,j as g,u as N}from"./react-vendor-mZEhzm5d.js";import{b as _,C as P,u as U,c as R,d as D}from"./page-CategoriesPage.tsx-Pj1wP9IV.js";import{A as x,g as T,u as A}from"./page-AddGamePage.tsx-BrD1K-KO.js";import{E as M}from"./page-CollectionDetail.tsx-D3Y5eMtX.js";import{u as $}from"./i18n-vendor-BQWJFj1H.js";import{c as O,A as F}from"./page-CategoryPage.tsx-BGJknrhL.js";function G(e,k=!0){const[l,c]=i.useState(null),[d,y]=i.useState(!1);return i.useEffect(()=>{if(!k||!e){c(null),y(!1);return}y(!0),(async()=>{try{const m=_(x,`/collections/${e}/games`),h=await fetch(m,{headers:{Accept:"application/json","X-Auth-Token":T()}});if(h.ok){const v=((await h.json()).games||[]).some(n=>!!n.command);c(v)}else c(!1)}catch{c(!1)}finally{y(!1)}})()},[e,k]),{hasPlayableGame:l,isLoading:d}}const b=i.createContext(void 0),E="changeme";function Z({children:e}){const[k,l]=i.useState(null),[c,d]=i.useState(null),[y,p]=i.useState(!0),m=async()=>{p(!0);try{const n=new URLSearchParams(window.location.search),t=n.get("twitch_token"),a=n.get("user_id");if(t&&a&&(localStorage.setItem("twitch_token",t),localStorage.setItem("twitch_user_id",a),window.history.replaceState({},document.title,window.location.pathname),await h(t)))return;const u=localStorage.getItem("twitch_token");if(u){if(await h(u))return;localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id")}if(E&&E!==""){localStorage.clear(),await h(E);return}l(null),d(null)}catch(n){console.error("Auth check error:",n),await h(E)}finally{p(!1)}},h=async n=>{const t=localStorage.getItem("twitch_client_id"),a=n===E;try{const u={"X-Auth-Token":n};t&&!a&&(u["X-Twitch-Client-Id"]=t);const s=await fetch(`${x}/auth/me`,{headers:u});if(s.ok){const r=await s.json();return l(r),d(n),A(),!0}else{const r=await s.text().catch(()=>"");return console.error(`Failed to validate token: ${s.status} ${r}`),a?(d(n),l({userId:"dev",userName:"Development User",userImage:null,isDev:!0}),A(),!0):(localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),l(null),d(null),!1)}}catch(u){return console.error("Failed to fetch user info:",u),a?(d(n),l({userId:"dev",userName:"Development User",userImage:null,isDev:!0}),A(),!0):(localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),l(null),d(null),!1)}},C=async(n=!1)=>{const t=localStorage.getItem("twitch_client_id"),a=localStorage.getItem("twitch_client_secret");if(!(!t||!a))try{const u=String(t).trim(),s=String(a).trim(),o={clientId:u,clientSecret:s,forceVerify:!!n},w=await fetch(`${x}/auth/twitch`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(w.ok){const f=await w.json();window.location.href=f.authUrl}else{const f=await w.text().catch(()=>"Unknown error");let I;try{I=JSON.parse(f)}catch{I={error:f}}alert(`Errore durante il login: ${I.error||w.statusText}`)}}catch(u){console.error("Login error:",u),u instanceof Error?alert(`Errore durante il login: ${u.message}`):alert("Errore durante il login: Si Ã¨ verificato un errore sconosciuto")}},S=()=>{localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),l(null),d(null),A(),c&&fetch(`${x}/auth/logout`,{method:"POST",headers:{"X-Auth-Token":c}}).catch(console.error)};i.useEffect(()=>{m()},[]);const v={user:k,token:c,isLoading:y,login:C,logout:S,checkAuth:m};return g.jsx(b.Provider,{value:v,children:e})}function X(){const e=i.useContext(b);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e}function B({collection:e,onCollectionClick:k,onPlay:l,onEditClick:c,onCollectionDelete:d,onCollectionUpdate:y,buildCoverUrl:p,coverSize:m,itemRefs:h}){const{t:C}=$(),S=m*1.5,{hasPlayableGame:v}=G(e.id,!0),n=async()=>{if(l)try{const t=_(x,`/collections/${e.id}/games`),a=await fetch(t,{headers:{Accept:"application/json","X-Auth-Token":T()}});if(a.ok){const r=((await a.json()).games||[]).find(o=>!!o.command);if(r){const o={id:r.id,title:r.title,summary:r.summary||"",cover:r.cover,day:r.day||null,month:r.month||null,year:r.year||null,stars:r.stars||null,genre:r.genre||null,command:r.command||null};l(o)}}}catch(t){console.error("Error fetching collection games for play:",t)}};return g.jsx("div",{ref:t=>{t&&h?.current&&h.current.set(e.id,t)},className:"group cursor-pointer collections-list-item",style:{width:`${m}px`,minWidth:`${m}px`},children:g.jsx(P,{title:e.title,coverUrl:p(x,e.cover,!0),width:m,height:S,onPlay:l?n:void 0,onClick:()=>k(e),onEdit:()=>c(e),collectionId:e.id,collectionTitle:e.title,onCollectionDelete:d?t=>{e.id===t&&d(e)}:void 0,onCollectionUpdate:y?t=>{const a={id:t.id,title:t.title,summary:t.summary,cover:t.cover,gameCount:e.gameCount};a.id===e.id&&y(a)}:void 0,showTitle:!0,subtitle:e.gameCount!==void 0?`${e.gameCount} ${C("common.elements")}`:void 0,detail:!0,play:v===!0,showBorder:!0},`${e.id}-${e.cover}`)},e.id)}function H({collections:e,onCollectionClick:k,onPlay:l,onCollectionUpdate:c,onCollectionDelete:d,buildCoverUrl:y,coverSize:p=150,itemRefs:m}){const{t:h}=$(),[C,S]=i.useState(!1),[v,n]=i.useState(null);if(e.length===0)return g.jsx("div",{className:"text-gray-400 text-center",children:h("table.noGames")});const t=s=>{const r={id:s.id,title:s.title,summary:s.summary,cover:s.cover,background:s.background};n(r),S(!0)},a=()=>{S(!1),n(null)},u=s=>{if(c){const r={id:s.id,title:s.title,summary:s.summary,cover:s.cover,background:s.background};c(r)}a()};return g.jsxs(g.Fragment,{children:[g.jsx("div",{className:"collections-list-container",style:{gridTemplateColumns:`repeat(auto-fill, ${p}px)`},children:e.map(s=>g.jsx(B,{collection:s,onCollectionClick:k,onPlay:l,onEditClick:t,onCollectionDelete:d,onCollectionUpdate:c,buildCoverUrl:y,coverSize:p,itemRefs:m},s.id))}),v&&g.jsx(M,{isOpen:C,onClose:a,collection:v,onCollectionUpdate:u})]})}function z({onPlay:e,coverSize:k}){const{setLoading:l,isLoading:c}=U(),{isLoading:d}=X(),y=N(),[p,m]=i.useState([]),[h,C]=i.useState(!1),[S]=i.useState(!0),v=i.useRef(null),n=i.useRef(new Map);R(v),i.useEffect(()=>{d||t()},[d]),i.useEffect(()=>{const o=()=>{t()};return window.addEventListener("metadataReloaded",o),()=>{window.removeEventListener("metadataReloaded",o)}},[]),i.useLayoutEffect(()=>{!c&&p.length>0?requestAnimationFrame(()=>{requestAnimationFrame(()=>{C(!0)})}):c&&C(!1)},[c,p.length]);async function t(){l(!0);try{const o=T(),w=_(x,"/collections"),f=await fetch(w,{headers:{Accept:"application/json","X-Auth-Token":o}});if(!f.ok)throw new Error(`HTTP ${f.status}`);const L=((await f.json()).collections||[]).map(j=>({id:j.id,title:j.title,summary:j.summary,cover:j.cover,background:j.background,gameCount:j.gameCount}));m(L)}catch(o){const w=String(o.message||o);console.error("Error fetching collections:",w)}finally{l(!1)}}function a(o){y(`/collections/${o.id}`)}const u=o=>{m(w=>w.map(f=>String(f.id)===String(o.id)?o:f)),window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collection:o}}))},s=o=>{m(w=>w.filter(f=>f.id!==o.id))},r=i.useMemo(()=>{const o=[...p];return o.sort((w,f)=>{const I=O(w.title||"",f.title||"");return S?I:-I}),o},[p,S]);return g.jsx("main",{className:"flex-1 home-page-content",children:g.jsxs("div",{className:"home-page-layout",children:[g.jsx("div",{className:"home-page-content-wrapper",style:{opacity:h?1:0,transition:"opacity 0.2s ease-in-out"},children:g.jsx("div",{ref:v,className:"home-page-scroll-container",children:!c&&g.jsx(H,{collections:r,onCollectionClick:a,onPlay:e,onCollectionUpdate:u,onCollectionDelete:s,buildCoverUrl:D,coverSize:k,itemRefs:n})})}),h&&g.jsx(F,{games:r,scrollContainerRef:v,itemRefs:n,ascending:S})]})})}export{Z as A,z as C,G as a,X as u};
