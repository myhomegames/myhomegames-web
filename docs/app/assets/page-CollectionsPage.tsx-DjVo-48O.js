import{r,j as i,b as fe,c as He,u as rt}from"./react-vendor-jNdKP8wU.js";import{A as z,g as W,a as it,u as Oe,b as ze}from"./page-AddGamePage.tsx-CGFUTWrs.js";import{u as oe}from"./i18n-vendor-mPXi0JFR.js";let Ge=null;function lt(e){Ge=e}function at(e){return typeof e=="string"?e:e instanceof Request?e.url:String(e)}function ct(e){const n=z.replace(/\/$/,"");return e===n||e.startsWith(n+"/")}function dt(e){try{const n=new URL(e).pathname.replace(/\/$/,"");return n==="/settings"||n.endsWith("/settings")}catch{return!1}}const ut=window.fetch;window.fetch=async function(e,n){const s=await ut.call(this,e,n);if(s.status===401){const o=at(e);ct(o)&&!dt(o)&&Ge?.()}return s};function U(e,n,s={}){const o=new URL(n,e);return Object.entries(s).forEach(([h,m])=>o.searchParams.set(h,String(m))),o.toString()}function ye(e={}){const n=W(),s={...e};if(n){s["X-Auth-Token"]=n;const o=it();o&&(s["X-Twitch-Client-Id"]=o)}return s}function mt(e,n,s){if(!n)return"";if(n.startsWith("http://")||n.startsWith("https://"))return n;if(n.includes("?t=")||n.includes("&t=")){const m=n.split("?")[0],l=n.includes("?")?n.substring(n.indexOf("?")):"",y=new URL(m,e);return l&&new URLSearchParams(l).forEach((p,g)=>{y.searchParams.set(g,p)}),y.toString()}const h=new URL(n,e);return s&&h.searchParams.set("t",Date.now().toString()),h.toString()}function nn(e,n,s){if(!n)return"";if(n.startsWith("http://")||n.startsWith("https://"))return n;if(n.includes("?t=")||n.includes("&t=")){const m=n.split("?")[0],l=n.includes("?")?n.substring(n.indexOf("?")):"",y=new URL(m,e);return l&&new URLSearchParams(l).forEach((p,g)=>{y.searchParams.set(g,p)}),y.toString()}const h=new URL(n,e);return s&&h.searchParams.set("t",Date.now().toString()),h.toString()}function on(){const[e,n]=r.useState(!1),[s,o]=r.useState(null);return{isEditModalOpen:e,selectedGame:s,openEditModal:l=>{o(l),n(!0)},closeEditModal:()=>{n(!1),o(null)}}}const _e=r.createContext(void 0);function sn({children:e}){const[n,s]=r.useState(!1),o=r.useCallback(m=>{s(m)},[]),h=r.useMemo(()=>({isLoading:n,setLoading:o}),[n,o]);return i.jsx(_e.Provider,{value:h,children:e})}function ae(){const e=r.useContext(_e);if(e===void 0)throw new Error("useLoading must be used within a LoadingProvider");return e}function ft({gameId:e,collectionId:n,developerId:s,publisherId:o,onGameDelete:h,onCollectionDelete:m,onDeveloperDelete:l,onPublisherDelete:y,onModalClose:t}){const{t:p}=oe(),{setLoading:g}=ae(),[c,d]=r.useState(!1),[x,u]=r.useState(null),[b,w]=r.useState(!1);return{isDeleting:c,deleteError:x,showConfirmModal:b,handleDeleteClick:()=>{w(!0)},handleConfirmDelete:async()=>{const C=W();if(C){d(!0),u(null),g(!0);try{let a,v=[];if(e){try{const R=U(z,"/collections"),j=await fetch(R,{headers:{Accept:"application/json","X-Auth-Token":C}});if(j.ok){const k=(await j.json()).collections||[];for(const A of k){const P=U(z,`/collections/${A.id}/games`),N=await fetch(P,{headers:{Accept:"application/json","X-Auth-Token":C}});N.ok&&((await N.json()).games||[]).map(q=>String(q.id)).includes(String(e))&&v.push(String(A.id))}}}catch(R){console.error("Error finding collections for game before deletion:",R)}a=U(z,`/games/${e}`)}else if(s)a=U(z,`/developers/${s}`);else if(o)a=U(z,`/publishers/${o}`);else if(n)a=U(z,`/collections/${n}`);else return;(await fetch(a,{method:"DELETE",headers:{"X-Auth-Token":C}})).ok?(e&&h?h(e):s&&l?l(s):o&&y?y(o):n&&m&&m(n),e?(window.dispatchEvent(new CustomEvent("gameDeleted",{detail:{gameId:e}})),v.forEach(R=>{window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collectionId:R}}))})):s?window.dispatchEvent(new CustomEvent("developerDeleted",{detail:{developerId:s}})):o?window.dispatchEvent(new CustomEvent("publisherDeleted",{detail:{publisherId:o}})):n&&window.dispatchEvent(new CustomEvent("collectionDeleted",{detail:{collectionId:n}})),w(!1),t&&t()):u(p("common.deleteError"))}catch(a){console.error("Error deleting item:",a),u(p("common.deleteError"))}finally{d(!1),g(!1)}}},handleCancelDelete:()=>{w(!1),u(null),t&&t()}}}function ht({gameId:e,collectionId:n,onGameUpdate:s,onCollectionUpdate:o,onReload:h,onModalClose:m}){const{t:l}=oe(),{setLoading:y}=ae(),[t,p]=r.useState(!1),[g,c]=r.useState(null),[d,x]=r.useState(!1),u=async()=>{const E=W();if(E){p(!0),c(null),y(!0);try{let S;e?S=U(z,`/games/${e}/reload`):n?S=U(z,`/collections/${n}/reload`):S=U(z,"/reload-games");const C=await fetch(S,{method:"POST",headers:{"X-Auth-Token":E}});if(C.ok){const a=await C.json();if(e)if(s&&a.game){const v={id:a.game.id,title:a.game.title,summary:a.game.summary||"",cover:a.game.cover,background:a.game.background,day:a.game.day||null,month:a.game.month||null,year:a.game.year||null,stars:a.game.stars||null,genre:a.game.genre||null,executables:a.game.executables||null,criticratings:a.game.criticratings||null,userratings:a.game.userratings||null,themes:a.game.themes||null,platforms:a.game.platforms||null,gameModes:a.game.gameModes||null,playerPerspectives:a.game.playerPerspectives||null,websites:a.game.websites||null,ageRatings:a.game.ageRatings||null,developers:a.game.developers||null,publishers:a.game.publishers||null,franchise:a.game.franchise||null,collection:a.game.collection||null,screenshots:a.game.screenshots||null,videos:a.game.videos||null,gameEngines:a.game.gameEngines||null,keywords:a.game.keywords||null,alternativeNames:a.game.alternativeNames||null,similarGames:a.game.similarGames||null};s(v),p(!1),y(!1);return}else{p(!1),y(!1);return}else if(n)if(o&&a.collection){const v={id:a.collection.id,title:a.collection.title,summary:a.collection.summary||"",cover:a.collection.cover,background:a.collection.background};o(v),p(!1),y(!1);return}else{p(!1),y(!1);return}else if(h)await h(),p(!1),y(!1);else{const v=window.location.pathname;window.location.href=v}}else console.error("Failed to reload metadata"),c(l("common.reloadError","Failed to reload metadata")),p(!1),y(!1)}catch(S){console.error("Error reloading metadata:",S),c(l("common.reloadError","Failed to reload metadata")),p(!1),y(!1)}}};return{isReloading:t,reloadError:g,showReloadConfirmModal:d,handleReloadClick:()=>{x(!0)},handleConfirmReload:async()=>{h?h():await u(),x(!1)},handleCancelReload:()=>{x(!1),c(null),m&&m()}}}function gt({gameId:e,onGameUpdate:n}){const{setLoading:s}=ae(),[o,h]=r.useState(!1);return{isUnlinking:o,handleUnlinkExecutable:async()=>{h(!0),s(!0);try{const l=U(z,`/games/${e}`),y=await fetch(l,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":W()},body:JSON.stringify({executables:null})});if(y.ok){const t=await y.json(),p={id:t.game.id,title:t.game.title,summary:t.game.summary||"",cover:t.game.cover,background:t.game.background,day:t.game.day??null,month:t.game.month??null,year:t.game.year??null,stars:t.game.stars??null,genre:t.game.genre??null,criticratings:t.game.criticratings??null,userratings:t.game.userratings??null,themes:t.game.themes??null,platforms:t.game.platforms??null,gameModes:t.game.gameModes??null,playerPerspectives:t.game.playerPerspectives??null,websites:t.game.websites??null,ageRatings:t.game.ageRatings??null,developers:t.game.developers??null,publishers:t.game.publishers??null,franchise:t.game.franchise??null,collection:t.game.collection??null,screenshots:t.game.screenshots??null,videos:t.game.videos??null,gameEngines:t.game.gameEngines??null,keywords:t.game.keywords??null,alternativeNames:t.game.alternativeNames??null,similarGames:t.game.similarGames??null};"executables"in p&&delete p.executables,n(p)}else console.error("Failed to unlink executable")}catch(l){console.error("Error unlinking executable:",l)}finally{h(!1),s(!1)}}}}function rn({game:e,onGameUpdate:n}){const{t:s}=oe(),{setLoading:o}=ae(),[h,m]=r.useState(!1),[l,y]=r.useState(!1),t=r.useRef(null);return{isUploading:h,isUnlinking:l,fileInputRef:t,handleFileSelect:async d=>{const x=d.name.toLowerCase();if(!x.endsWith(".sh")&&!x.endsWith(".bat")){alert(s("gameDetail.invalidFileType","Only .sh and .bat files are allowed"));return}m(!0),o(!0);try{const u=new FormData;u.append("file",d);const b=U(z,`/games/${e.id}/upload-executable`),w=await fetch(b,{method:"POST",headers:{"X-Auth-Token":W()||""},body:u});if(!w.ok){const E=await w.json().catch(()=>({error:"Failed to upload file"}));throw new Error(E.error||"Failed to upload file")}const f=await w.json();if(f.game){const E={...e,id:f.game.id,title:f.game.title,summary:f.game.summary||"",cover:f.game.cover,background:f.game.background,day:f.game.day??e.day??null,month:f.game.month??e.month??null,year:f.game.year??e.year??null,stars:f.game.stars??e.stars??null,genre:f.game.genre??e.genre??null,criticratings:f.game.criticratings??e.criticratings??null,userratings:f.game.userratings??e.userratings??null,executables:f.game.executables??e.executables??null,themes:f.game.themes??e.themes??null,platforms:f.game.platforms??e.platforms??null,gameModes:f.game.gameModes??e.gameModes??null,playerPerspectives:f.game.playerPerspectives??e.playerPerspectives??null,websites:f.game.websites??e.websites??null,ageRatings:f.game.ageRatings??e.ageRatings??null,developers:f.game.developers??e.developers??null,publishers:f.game.publishers??e.publishers??null,franchise:f.game.franchise??e.franchise??null,collection:f.game.collection??e.collection??null,screenshots:f.game.screenshots??e.screenshots??null,videos:f.game.videos??e.videos??null,gameEngines:f.game.gameEngines??e.gameEngines??null,keywords:f.game.keywords??e.keywords??null,alternativeNames:f.game.alternativeNames??e.alternativeNames??null,similarGames:f.game.similarGames??e.similarGames??null};n(E)}}catch(u){console.error("Error uploading file:",u),alert(u.message||s("common.error","Error"))}finally{m(!1),o(!1)}},handleBrowseClick:()=>{t.current?.click()},handleUnlinkExecutable:async()=>{y(!0),o(!0);try{const d=U(z,`/games/${e.id}`),x=await fetch(d,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":W()},body:JSON.stringify({executables:null})});if(x.ok){const u=await x.json(),b={...e,id:u.game.id,title:u.game.title,summary:u.game.summary||"",cover:u.game.cover,background:u.game.background,day:u.game.day??e.day??null,month:u.game.month??e.month??null,year:u.game.year??e.year??null,stars:u.game.stars??e.stars??null,genre:u.game.genre??e.genre??null,criticratings:u.game.criticratings??e.criticratings??null,userratings:u.game.userratings??e.userratings??null,themes:u.game.themes??e.themes??null,platforms:u.game.platforms??e.platforms??null,gameModes:u.game.gameModes??e.gameModes??null,playerPerspectives:u.game.playerPerspectives??e.playerPerspectives??null,websites:u.game.websites??e.websites??null,ageRatings:u.game.ageRatings??e.ageRatings??null,developers:u.game.developers??e.developers??null,publishers:u.game.publishers??e.publishers??null,franchise:u.game.franchise??e.franchise??null,collection:u.game.collection??e.collection??null,screenshots:u.game.screenshots??e.screenshots??null,videos:u.game.videos??e.videos??null,gameEngines:u.game.gameEngines??e.gameEngines??null,keywords:u.game.keywords??e.keywords??null,alternativeNames:u.game.alternativeNames??e.alternativeNames??null,similarGames:u.game.similarGames??e.similarGames??null};"executables"in b&&delete b.executables,n(b)}else console.error("Failed to unlink executable")}catch(d){console.error("Error unlinking executable:",d)}finally{y(!1),o(!1)}}}}function ln({onGameAdded:e,onError:n}={}){const{setLoading:s}=ae(),[o,h]=r.useState(!1),[m,l]=r.useState(null);return{isAdding:o,addError:m,addGame:async t=>{const p=W();if(!p){const g="Authentication required";return l(g),n&&n(g),null}h(!0),l(null),s(!0);try{const g=U(z,"/games/add-from-igdb"),c=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Auth-Token":p},body:JSON.stringify({igdbId:t.id,name:t.name,summary:t.summary,cover:t.cover,background:t.background,releaseDate:t.releaseDateFull?.timestamp||t.releaseDate,genres:t.genres,criticRating:t.criticRating,userRating:t.userRating,themes:t.themes,platforms:t.platforms,gameModes:t.gameModes,playerPerspectives:t.playerPerspectives,websites:t.websites,ageRatings:t.ageRatings,developers:t.developers,publishers:t.publishers,franchise:t.franchise,collection:t.series??t.collection,screenshots:t.screenshots,videos:t.videos,gameEngines:t.gameEngines,keywords:t.keywords,alternativeNames:t.alternativeNames,similarGames:t.similarGames})});if(!c.ok){const w=(await c.json().catch(()=>({}))).error||`HTTP ${c.status}`;return l(w),n&&n(w),null}const d=await c.json(),x=d.gameId||d.game?.id,u={id:String(x),title:d.game?.title||t.name,summary:d.game?.summary||t.summary||"",cover:d.game?.cover||t.cover||"",background:d.game?.background||t.background||void 0,day:d.game?.day||t.releaseDateFull?.day||null,month:d.game?.month||t.releaseDateFull?.month||null,year:d.game?.year||t.releaseDateFull?.year||t.releaseDate||null,stars:d.game?.stars||null,genre:d.game?.genre||t.genres||null,criticratings:d.game?.criticratings||(t.criticRating?t.criticRating/10:null),userratings:d.game?.userratings||(t.userRating?t.userRating/10:null),executables:d.game?.executables||null,themes:d.game?.themes||t.themes||null,platforms:d.game?.platforms||t.platforms||null,gameModes:d.game?.gameModes||t.gameModes||null,playerPerspectives:d.game?.playerPerspectives||t.playerPerspectives||null,websites:d.game?.websites||t.websites||null,ageRatings:d.game?.ageRatings||t.ageRatings||null,developers:d.game?.developers||t.developers||null,publishers:d.game?.publishers||t.publishers||null,franchise:d.game?.franchise??t.franchise??null,collection:d.game?.collection??t.series??t.collection??null,series:d.game?.series??d.game?.collection??t.series??t.collection??null,screenshots:d.game?.screenshots||t.screenshots||null,videos:d.game?.videos||t.videos||null,gameEngines:d.game?.gameEngines||t.gameEngines||null,keywords:d.game?.keywords||t.keywords||null,alternativeNames:d.game?.alternativeNames||t.alternativeNames||null,similarGames:d.game?.similarGames||t.similarGames||null};return window.dispatchEvent(new CustomEvent("gameAdded",{detail:{game:u}})),e&&e(u),u}catch(g){const c=g.message||"Failed to add game";return console.error("Error adding game:",g),l(c),n&&n(c),null}finally{h(!1),s(!1)}}}}const qe=r.createContext(void 0),Ae="";function an({children:e}){const[n,s]=r.useState(null),[o,h]=r.useState(null),[m,l]=r.useState(!0),y=async()=>{l(!0);try{const x=new URLSearchParams(window.location.search),u=x.get("twitch_token"),b=x.get("user_id");if(u&&b&&(localStorage.setItem("twitch_token",u),localStorage.setItem("twitch_user_id",b),window.history.replaceState({},document.title,window.location.pathname),await t(u)))return;const w=localStorage.getItem("twitch_token");if(w)if(!localStorage.getItem("twitch_client_id"))localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id");else{if(await t(w))return;localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id")}s(null),h(null)}catch(x){console.error("Auth check error:",x),s(null),h(null)}finally{l(!1)}},t=async x=>{const u=localStorage.getItem("twitch_client_id"),b=Ae;let w;try{const f={"X-Auth-Token":x};u&&!b&&(f["X-Twitch-Client-Id"]=u);const E=new AbortController;w=setTimeout(()=>E.abort(),9e4);const S=await fetch(`${z}/auth/me`,{headers:f,signal:E.signal});if(clearTimeout(w),S.ok){const C=await S.json();return s(C),h(x),Oe(),!0}else{const C=await S.text().catch(()=>"");if(console.error(`Failed to validate token: ${S.status} ${C}`),!b)return localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),s(null),h(null),!1}}catch(f){return clearTimeout(w),console.error("Failed to fetch user info:",f),localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),s(null),h(null),!1}},p=async(x=!1)=>{const u=localStorage.getItem("twitch_client_id"),b=localStorage.getItem("twitch_client_secret");if(!(!u||!b))try{const w=String(u).trim(),f=String(b).trim(),S={clientId:w,clientSecret:f,forceVerify:!!x},C=await fetch(`${z}/auth/twitch`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(S)});if(C.ok){const a=await C.json();window.location.href=a.authUrl}else{const a=await C.text().catch(()=>"Unknown error");let v;try{v=JSON.parse(a)}catch{v={error:a}}alert(`Errore durante il login: ${v.error||C.statusText}`)}}catch(w){console.error("Login error:",w);const f=w instanceof Error?w.message:"Si è verificato un errore sconosciuto";if(f==="Failed to fetch"||f?.toLowerCase().includes("network")||f?.toLowerCase().includes("fetch")){const S=z.replace(/\/$/,"");window.location.href=S}else w instanceof Error?alert(`Errore durante il login: ${f}`):alert(`Errore durante il login: ${f}`)}},g=()=>{localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),localStorage.removeItem("twitch_client_id"),localStorage.removeItem("twitch_client_secret"),s(null),h(null),Oe(),o&&fetch(`${z}/auth/logout`,{method:"POST",headers:{"X-Auth-Token":o}}).catch(console.error)};r.useEffect(()=>{y()},[]);const c=r.useRef(g);c.current=g,r.useEffect(()=>{lt(()=>{c.current();const x=z.replace(/\/$/,"");window.location.href=x})},[]);const d={user:n,token:o,isLoading:m,login:p,logout:g,checkAuth:y};return i.jsx(qe.Provider,{value:d,children:e})}function Te(){const e=r.useContext(qe);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e}const Ke=r.createContext(void 0);function cn({children:e}){const[n,s]=r.useState([]),[o,h]=r.useState(!0),[m,l]=r.useState(null),[y,t]=r.useState(new Map),p=r.useRef(y),{isLoading:g,token:c}=Te(),d=r.useCallback(async()=>{if(g||!(W()||c))return;h(!0),l(null);const v=new AbortController,L=setTimeout(()=>v.abort(),9e4);try{const R=U(z,"/collections"),j=await fetch(R,{headers:ye({Accept:"application/json"}),signal:v.signal});if(clearTimeout(L),!j.ok)throw new Error(`HTTP ${j.status}`);const A=((await j.json()).collections||[]).map(P=>({id:String(P.id),title:P.title,summary:P.summary,cover:P.cover,background:P.background,gameCount:P.gameCount,showTitle:P.showTitle!==!1}));s(A)}catch(R){clearTimeout(L);const j=String(R.message||R);console.error("Error fetching collections:",j),l(j)}finally{h(!1)}},[g,c]);r.useEffect(()=>{if(g)return;if(!W()&&!c){h(!1);return}const a=setTimeout(d,400);return()=>clearTimeout(a)},[g,c,d]),r.useEffect(()=>{p.current=y},[y]),r.useEffect(()=>{const a=R=>{const j=R,T=j.detail?.collection,k=j.detail?.collectionId;T?s(A=>A.map(P=>String(P.id)===String(T.id)?T:P)):k&&(d(),(async()=>{try{const P=U(z,`/collections/${k}/games`),N=await fetch(P,{headers:ye({Accept:"application/json"})});if(N.ok){const D=((await N.json()).games||[]).map(q=>String(q.id));t(q=>{const H=new Map(q);return H.set(String(k),D),H})}}catch(P){console.error(`Error reloading games for collection ${k}:`,P.message),t(N=>{const M=new Map(N);return M.delete(String(k)),M})}})())},v=R=>{const T=R.detail?.collectionId;T&&(s(k=>k.filter(A=>String(A.id)!==String(T))),t(k=>{const A=new Map(k);return A.delete(String(T)),A}))},L=()=>{d()};return window.addEventListener("collectionUpdated",a),window.addEventListener("collectionDeleted",v),window.addEventListener("metadataReloaded",L),()=>{window.removeEventListener("collectionUpdated",a),window.removeEventListener("collectionDeleted",v),window.removeEventListener("metadataReloaded",L)}},[d]);const x=r.useCallback(async()=>{await d()},[d]),u=r.useCallback(a=>{s(v=>{if(v.some(R=>String(R.id)===String(a.id)))return v;const L=[...v,a];return L.sort((R,j)=>(R.title||"").localeCompare(j.title||"")),L})},[]),b=r.useCallback(a=>{s(v=>v.map(L=>String(L.id)===String(a.id)?a:L))},[]),w=r.useCallback(a=>{s(v=>v.filter(L=>String(L.id)!==String(a))),t(v=>{const L=new Map(v);return L.delete(String(a)),L})},[]),f=r.useCallback((a,v)=>{t(L=>{const R=new Map(L),j=String(a),T=R.get(j)||[];return T.includes(v)||R.set(j,[...T,v]),R})},[]),E=r.useCallback((a,v)=>{t(L=>{const R=new Map(L),j=String(a),T=R.get(j)||[];return R.set(j,T.filter(k=>k!==v)),R})},[]),S=r.useCallback(async a=>{const v=p.current.get(String(a));if(v)return v;try{const L=U(z,`/collections/${a}/games`),R=await fetch(L,{headers:ye({Accept:"application/json"})});if(R.ok){const T=((await R.json()).games||[]).map(k=>String(k.id));return t(k=>{const A=String(a),P=k.get(A)||[];if(P.length===T.length&&P.every((M,D)=>M===T[D]))return k;const N=new Map(k);return N.set(A,T),N}),T}}catch(L){console.error(`Error fetching games for collection ${a}:`,L.message)}return[]},[]),C=r.useMemo(()=>({collections:n,isLoading:o,error:m,refreshCollections:x,addCollection:u,updateCollection:b,removeCollection:w,getCollectionGameIds:S,collectionGameIds:y,addGameToCollectionCache:f,removeGameFromCollectionCache:E}),[n,o,m,x,u,b,w,S,y,f,E]);return i.jsx(Ke.Provider,{value:C,children:e})}function xe(){const e=r.useContext(Ke);if(e===void 0)throw new Error("useCollections must be used within a CollectionsProvider");return e}function Ve({onSuccess:e,onError:n}={}){const{t:s}=oe(),{setLoading:o}=ae(),{addGameToCollectionCache:h}=xe(),[m,l]=r.useState(!1);return{isAdding:m,addGameToCollection:async(t,p)=>{const g=W();if(!g){n?.(s("common.unauthorized","Unauthorized"));return}l(!0),o(!0);try{const c=U(z,`/collections/${p}/games`),d=await fetch(c,{headers:{Accept:"application/json","X-Auth-Token":g}});if(!d.ok)throw new Error(`Failed to fetch collection games: ${d.status}`);const u=((await d.json()).games||[]).map(S=>String(S.id));if(u.includes(String(t))){n?.(s("collections.gameAlreadyInCollection","Game is already in this collection"));return}const b=[...u,String(t)],w=U(z,`/collections/${p}/games/order`),f=await fetch(w,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":g},body:JSON.stringify({gameIds:b})});if(!f.ok){const S=await f.json().catch(()=>({}));throw new Error(S.error||`Failed to add game to collection: ${f.status}`)}h(p,String(t)),window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collectionId:p}}));const E=JSON.parse(localStorage.getItem("recentCollections")||"[]");if(!E.includes(p)){E.unshift(p);const S=E.slice(0,10);localStorage.setItem("recentCollections",JSON.stringify(S))}e?.()}catch(c){const d=String(c.message||c);console.error("Error adding game to collection:",d),n?.(d)}finally{l(!1),o(!1)}}}}function pt({onSuccess:e,onError:n}={}){const{t:s}=oe(),{setLoading:o}=ae(),[h,m]=r.useState(!1);return{isAdding:h,addGameToDeveloper:async(y,t,p)=>{const g=W();if(!g){n?.(s("common.unauthorized","Unauthorized"));return}m(!0),o(!0);try{const c=U(z,`/games/${y}`),d=await fetch(c,{headers:{Accept:"application/json","X-Auth-Token":g}});if(!d.ok)throw new Error(`Failed to fetch game: ${d.status}`);const x=await d.json(),b=(x.game||x).developers||[];if(new Set(b.map(v=>Number(typeof v=="object"?v?.id:v))).has(Number(t))){n?.(s("collections.gameAlreadyInCollection","Game is already in this collection"));return}const f=[...b.map(v=>typeof v=="object"?{id:v.id,name:v.name}:{id:v,name:String(v)}),{id:Number(t),name:p.trim()}],E=U(z,`/games/${y}`),S=await fetch(E,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":g},body:JSON.stringify({developers:f})});if(!S.ok){const v=await S.json().catch(()=>({}));throw new Error(v.error||`Failed to add game to developer: ${S.status}`)}const a=(await S.json()).game;window.dispatchEvent(new CustomEvent("gameUpdated",{detail:{game:a}})),window.dispatchEvent(new CustomEvent("developerUpdated",{detail:{developerId:t}})),e?.(a)}catch(c){const d=String(c.message||c);console.error("Error adding game to developer:",d),n?.(d)}finally{m(!1),o(!1)}}}}function wt({onSuccess:e,onError:n}={}){const{t:s}=oe(),{setLoading:o}=ae(),[h,m]=r.useState(!1);return{isAdding:h,addGameToPublisher:async(y,t,p)=>{const g=W();if(!g){n?.(s("common.unauthorized","Unauthorized"));return}m(!0),o(!0);try{const c=U(z,`/games/${y}`),d=await fetch(c,{headers:{Accept:"application/json","X-Auth-Token":g}});if(!d.ok)throw new Error(`Failed to fetch game: ${d.status}`);const x=await d.json(),b=(x.game||x).publishers||[];if(new Set(b.map(v=>Number(typeof v=="object"?v?.id:v))).has(Number(t))){n?.(s("collections.gameAlreadyInCollection","Game is already in this collection"));return}const f=[...b.map(v=>typeof v=="object"?{id:v.id,name:v.name}:{id:v,name:String(v)}),{id:Number(t),name:p.trim()}],E=U(z,`/games/${y}`),S=await fetch(E,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":g},body:JSON.stringify({publishers:f})});if(!S.ok){const v=await S.json().catch(()=>({}));throw new Error(v.error||`Failed to add game to publisher: ${S.status}`)}const a=(await S.json()).game;window.dispatchEvent(new CustomEvent("gameUpdated",{detail:{game:a}})),window.dispatchEvent(new CustomEvent("publisherUpdated",{detail:{publisherId:t}})),e?.(a)}catch(c){const d=String(c.message||c);console.error("Error adding game to publisher:",d),n?.(d)}finally{m(!1),o(!1)}}}}function vt({onSuccess:e,onError:n}={}){const{t:s}=oe(),{setLoading:o}=ae(),{removeGameFromCollectionCache:h}=xe(),[m,l]=r.useState(!1);return{isRemoving:m,removeGameFromCollection:async(t,p)=>{const g=W();if(!g){n?.(s("common.unauthorized","Unauthorized"));return}l(!0),o(!0);try{const c=U(z,`/collections/${p}/games`),d=await fetch(c,{headers:{Accept:"application/json","X-Auth-Token":g}});if(!d.ok)throw new Error(`Failed to fetch collection games: ${d.status}`);const b=((await d.json()).games||[]).map(E=>String(E.id)).filter(E=>E!==String(t)),w=U(z,`/collections/${p}/games/order`),f=await fetch(w,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":g},body:JSON.stringify({gameIds:b})});if(!f.ok){const E=await f.json().catch(()=>({}));throw new Error(E.error||`Failed to remove game from collection: ${f.status}`)}h(p,String(t)),window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collectionId:p}})),e?.()}catch(c){const d=String(c.message||c);console.error("Error removing game from collection:",d),n?.(d)}finally{l(!1),o(!1)}}}}function bt({onSuccess:e,onError:n}={}){const{t:s}=oe(),{setLoading:o}=ae(),[h,m]=r.useState(!1);return{isCreating:h,createCollection:async(y,t)=>{const p=W();if(!p)return n?.(s("common.unauthorized","Unauthorized")),null;if(!y||y.trim()==="")return n?.(s("collections.titleRequired","Collection title is required")),null;m(!0),o(!0);try{const g=U(z,"/collections"),c=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json","X-Auth-Token":p},body:JSON.stringify({title:y.trim(),summary:t?.trim()||""})});if(!c.ok){const u=await c.json().catch(()=>({}));throw new Error(u.error||`Failed to create collection: ${c.status}`)}const d=await c.json(),x={id:d.collection.id,title:d.collection.title,summary:d.collection.summary,cover:d.collection.cover,gameCount:0};return window.dispatchEvent(new CustomEvent("collectionAdded",{detail:{collection:x}})),e?.(x),x}catch(g){const c=String(g.message||g);return console.error("Error creating collection:",c),n?.(c),null}finally{m(!1),o(!1)}}}}function yt({onSuccess:e,onError:n}={}){const{t:s}=oe(),{setLoading:o}=ae(),[h,m]=r.useState(!1);return{isCreating:h,createDeveloper:async(y,t)=>{const p=W();if(!p)return n?.(s("common.unauthorized","Unauthorized")),null;if(!y||y.trim()==="")return n?.(s("collections.titleRequired","Title is required")),null;m(!0),o(!0);try{const g=U(z,"/developers"),c=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json","X-Auth-Token":p},body:JSON.stringify({title:y.trim(),summary:t?.trim()||""})}),d=await c.json().catch(()=>({}));if(!c.ok){if(c.status===409&&d.developer){const b={id:String(d.developer.id),title:d.developer.title,gameCount:void 0};return e?.(b),b}throw new Error(d.error||`Failed to create developer: ${c.status}`)}const x=d.developer,u={id:String(x.id),title:x.title,summary:x.summary,cover:x.cover??void 0,gameCount:x.gameCount??0};return window.dispatchEvent(new CustomEvent("developerAdded",{detail:{developer:u}})),e?.(u),u}catch(g){const c=g instanceof Error?g.message:String(g);return console.error("Error creating developer:",c),n?.(c),null}finally{m(!1),o(!1)}}}}function xt({onSuccess:e,onError:n}={}){const{t:s}=oe(),{setLoading:o}=ae(),[h,m]=r.useState(!1);return{isCreating:h,createPublisher:async(y,t)=>{const p=W();if(!p)return n?.(s("common.unauthorized","Unauthorized")),null;if(!y||y.trim()==="")return n?.(s("collections.titleRequired","Title is required")),null;m(!0),o(!0);try{const g=U(z,"/publishers"),c=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json","X-Auth-Token":p},body:JSON.stringify({title:y.trim(),summary:t?.trim()||""})}),d=await c.json().catch(()=>({}));if(!c.ok){if(c.status===409&&d.publisher){const b={id:String(d.publisher.id),title:d.publisher.title,gameCount:void 0};return e?.(b),b}throw new Error(d.error||`Failed to create publisher: ${c.status}`)}const x=d.publisher,u={id:String(x.id),title:x.title,summary:x.summary,cover:x.cover??void 0,gameCount:x.gameCount??0};return window.dispatchEvent(new CustomEvent("publisherAdded",{detail:{publisher:u}})),e?.(u),u}catch(g){const c=g instanceof Error?g.message:String(g);return console.error("Error creating publisher:",c),n?.(c),null}finally{m(!1),o(!1)}}}}function Xe({text:e,delay:n=1e3,children:s}){const[o,h]=r.useState(!1),[m,l]=r.useState({}),y=r.useRef(null),t=r.useRef(null);r.useEffect(()=>()=>{t.current&&clearTimeout(t.current)},[]),r.useEffect(()=>{if(!o)return;const c=()=>{t.current&&(clearTimeout(t.current),t.current=null),h(!1)};return document.addEventListener("click",c,!0),()=>{document.removeEventListener("click",c,!0)}},[o]);const p=()=>{t.current&&clearTimeout(t.current),t.current=window.setTimeout(()=>{if(y.current){const c=y.current.getBoundingClientRect();l({position:"fixed",top:`${c.bottom+8}px`,left:`${c.left}px`,zIndex:99999}),h(!0)}},n)},g=()=>{t.current&&(clearTimeout(t.current),t.current=null),h(!1)};return i.jsxs(i.Fragment,{children:[i.jsx("div",{ref:y,className:"tooltip-wrapper",onMouseEnter:p,onMouseLeave:g,children:s}),o&&fe.createPortal(i.jsx("span",{className:"tooltip tooltip-portal",style:m,children:e}),document.body)]})}function Ct({onEdit:e,onDelete:n,onReload:s,onAddToCollection:o,onRemoveFromCollection:h,onManageInstallation:m,gameId:l,gameTitle:y,gameExecutables:t,onGameDelete:p,onGameUpdate:g,collectionId:c,collectionTitle:d,onCollectionDelete:x,onCollectionUpdate:u,developerId:b,publisherId:w,onRemoveFromDeveloper:f,onRemoveFromPublisher:E,className:S="",horizontal:C=!1,onModalOpen:a,onModalClose:v,toolTipDelay:L=0}){const{t:R}=oe(),[j,T]=r.useState(!1),k=r.useRef(null),A=r.useRef(null),P=ft({gameId:l,collectionId:c,developerId:b,publisherId:w,onGameDelete:p,onCollectionDelete:x,onDeveloperDelete:O=>{x&&x(O)},onPublisherDelete:O=>{x&&x(O)},onModalClose:v}),N=ht({gameId:l,collectionId:c,onGameUpdate:g,onCollectionUpdate:u,onReload:s,onModalClose:v}),M=l&&g?gt({gameId:l,onGameUpdate:g}):{isUnlinking:!1,handleUnlinkExecutable:async()=>{}},D=vt({onSuccess:()=>{h&&h()},onError:O=>{console.error("Error removing game from collection:",O)}}),q=S.includes("games-list-dropdown-menu"),H=S.includes("games-table-dropdown-menu"),[K,_]=r.useState(!1);r.useEffect(()=>{if(j&&k.current){const O=!!k.current.closest(".search-dropdown-scroll"),F=k.current.classList.contains("search-result-dropdown-menu");_(O||F)}else _(!1)},[j]),r.useEffect(()=>{!j&&l?(window.dispatchEvent(new CustomEvent("closeAddToCollectionDropdown",{detail:{gameId:l}})),window.dispatchEvent(new CustomEvent("closeAdditionalExecutablesDropdown",{detail:{gameId:l}})),window.dispatchEvent(new CustomEvent("dropdownMenuClosed",{detail:{gameId:l}}))):!j&&c&&window.dispatchEvent(new CustomEvent("dropdownMenuClosed",{detail:{collectionId:c}}))},[j,l,c]),r.useEffect(()=>{if(!j)return;function O(I){const B=I.target;k.current&&k.current.contains(B)||A.current&&A.current.contains(B)||B.closest(".dropdown-menu-popup")||B.closest(".add-to-collection-dropdown-menu")||B.closest(".additional-executables-dropdown-menu")||T(!1)}const F=setTimeout(()=>{document.addEventListener("mousedown",O,!0)},100);return()=>{clearTimeout(F),document.removeEventListener("mousedown",O,!0)}},[j]),r.useEffect(()=>(P.showConfirmModal||N.showReloadConfirmModal?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[P.showConfirmModal,N.showReloadConfirmModal]),r.useEffect(()=>{if(!P.showConfirmModal&&!N.showReloadConfirmModal)return;function O(F){F.key==="Escape"&&(P.showConfirmModal&&P.handleCancelDelete(),N.showReloadConfirmModal&&N.handleCancelReload())}return document.addEventListener("keydown",O),()=>{document.removeEventListener("keydown",O)}},[P.showConfirmModal,N.showReloadConfirmModal,P,N]);const ce=O=>{O.stopPropagation();const F=!j;T(F),l?F?window.dispatchEvent(new CustomEvent("dropdownMenuOpened",{detail:{gameId:l}})):window.dispatchEvent(new CustomEvent("dropdownMenuClosed",{detail:{gameId:l}})):c&&(F?window.dispatchEvent(new CustomEvent("dropdownMenuOpened",{detail:{collectionId:c}})):window.dispatchEvent(new CustomEvent("dropdownMenuClosed",{detail:{collectionId:c}})))},ie=O=>{O.stopPropagation(),T(!1),a&&a(),e&&e()},X=O=>{const F=O.currentTarget;window.dispatchEvent(new CustomEvent("openAddToCollectionDropdown",{detail:{gameId:l,menuItem:F}}))},G=O=>{const F=O.relatedTarget;F&&!F.closest(".add-to-collection-dropdown-menu")&&window.dispatchEvent(new CustomEvent("closeAddToCollectionDropdown",{detail:{gameId:l}}))},re=()=>{window.dispatchEvent(new CustomEvent("closeAddToCollectionDropdown",{detail:{gameId:l}})),window.dispatchEvent(new CustomEvent("closeAdditionalExecutablesDropdown",{detail:{gameId:l}}))},te=()=>{window.dispatchEvent(new CustomEvent("openAdditionalExecutablesDropdown",{detail:{gameId:l}}))},ne=O=>{const F=O.relatedTarget;F&&!F.closest(".additional-executables-dropdown-menu")&&window.dispatchEvent(new CustomEvent("closeAdditionalExecutablesDropdown",{detail:{gameId:l}}))},le=O=>{const F=O.relatedTarget;F&&!F.closest(".dropdown-menu-popup")&&!F.closest(".add-to-collection-dropdown-menu")&&window.dispatchEvent(new CustomEvent("closeAddToCollectionDropdown",{detail:{gameId:l}}))},he=O=>{O.stopPropagation(),T(!1),l&&y||c&&d||b&&d||w&&d?(a&&a(),P.handleDeleteClick()):n&&n()},ge=O=>{if(O.stopPropagation(),O.preventDefault(),T(!1),l||c){s?s():N.handleConfirmReload();return}setTimeout(()=>{a&&a(),N.handleReloadClick()},0)},pe=async O=>{O.stopPropagation(),T(!1),await M.handleUnlinkExecutable()},we=i.jsx("button",{onClick:ce,className:"dropdown-menu-button","aria-label":"Menu",children:C?i.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("circle",{cx:"5",cy:"12",r:"1"}),i.jsx("circle",{cx:"12",cy:"12",r:"1"}),i.jsx("circle",{cx:"19",cy:"12",r:"1"})]}):i.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("circle",{cx:"12",cy:"5",r:"1"}),i.jsx("circle",{cx:"12",cy:"12",r:"1"}),i.jsx("circle",{cx:"12",cy:"19",r:"1"})]})});return i.jsxs("div",{className:`dropdown-menu-wrapper ${S}`,ref:k,children:[L>0?i.jsx(Xe,{text:R("common.more","More"),delay:L,children:we}):we,j&&(()=>{const O=i.jsxs("div",{ref:A,className:`dropdown-menu-popup ${K?"dropdown-menu-popup-in-search":""} ${H?"dropdown-menu-popup-in-games-table":""}`,onMouseLeave:le,style:(()=>{if(k.current){if(q){const F=k.current.getBoundingClientRect();return{position:"fixed",bottom:`${window.innerHeight-F.top+4}px`,right:`${window.innerWidth-F.right}px`,top:"auto"}}if(K){const F=k.current.getBoundingClientRect();return{position:"fixed",top:`${F.bottom+4}px`,right:`${window.innerWidth-F.right}px`,zIndex:10007}}if(H){const F=k.current.getBoundingClientRect();return{position:"fixed",top:`${F.bottom+4}px`,right:`${window.innerWidth-F.right}px`,left:"auto",zIndex:10002}}}})(),children:[l&&t&&t.length>1&&i.jsxs("div",{className:"dropdown-menu-item dropdown-menu-item-with-submenu additional-executables-menu-item",onMouseEnter:te,onMouseLeave:ne,children:[i.jsx("span",{children:R("gameDetail.additionalExecutables","Additional executables")}),i.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:i.jsx("polyline",{points:"9 18 15 12 9 6"})})]}),o&&i.jsx(i.Fragment,{children:i.jsxs("div",{className:"dropdown-menu-item dropdown-menu-item-with-submenu",onMouseEnter:X,onMouseLeave:G,children:[i.jsx("span",{children:R("collections.addTo","Add to")}),i.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:i.jsx("polyline",{points:"9 18 15 12 9 6"})})]})}),l&&m&&i.jsx("button",{onClick:F=>{F.stopPropagation(),T(!1),m&&m()},className:"dropdown-menu-item",children:i.jsx("span",{children:R("manageInstallation.title","Manage Installation")})}),(l&&t&&t.length>1||o||l&&m)&&!(h&&l&&c)&&(e||s||l&&g||!l&&!c&&!b&&!w&&!e&&!n||l&&t&&t.length>0&&g||n||W()&&(l||c||b||w))&&i.jsx("div",{className:"dropdown-menu-divider",onMouseEnter:re}),h&&l&&c&&i.jsx("button",{onClick:async F=>{F.stopPropagation(),T(!1),await D.removeGameFromCollection(l,c)},className:"dropdown-menu-item dropdown-menu-item-danger",disabled:D.isRemoving,children:i.jsx("span",{children:D.isRemoving?R("common.removing","Removing..."):R("collections.removeFromCollection","Remove from collection")})}),f&&l&&b&&i.jsx("button",{onClick:F=>{F.stopPropagation(),T(!1),f?.()},className:"dropdown-menu-item dropdown-menu-item-danger",children:i.jsx("span",{children:R("igdbInfo.removeFromDeveloper","Remove from developer")})}),E&&l&&w&&i.jsx("button",{onClick:F=>{F.stopPropagation(),T(!1),E?.()},className:"dropdown-menu-item dropdown-menu-item-danger",children:i.jsx("span",{children:R("igdbInfo.removeFromPublisher","Remove from publisher")})}),(h&&l&&c||f&&l&&b||E&&l&&w)&&(e||s||l&&g||!l&&!c&&!b&&!w&&!e&&!n||l&&t&&t.length>0&&g||n||W()&&(l||c||b||w))&&i.jsx("div",{className:"dropdown-menu-divider"}),e&&i.jsx("button",{onClick:ie,className:"dropdown-menu-item",children:i.jsx("span",{children:R("common.edit","Edit")})}),(s||l&&g||!l&&!c&&!b&&!w&&!e&&!n)&&i.jsx("button",{onClick:ge,className:"dropdown-menu-item",disabled:N.isReloading,children:i.jsx("span",{children:l?R("common.reloadSingleMetadata","Reload metadata"):R("common.reloadMetadata","Reload all metadata")})}),l&&t&&t.length>0&&g&&i.jsx("button",{onClick:pe,className:"dropdown-menu-item",disabled:M.isUnlinking,children:i.jsx("span",{children:t.length>1?R("gameDetail.unlinkAllExecutables","Unlink All Executables"):R("gameDetail.unlinkExecutable","Unlink Executable")})}),(n||W()&&(l||c||b||w))&&i.jsx("button",{onClick:he,className:"dropdown-menu-item dropdown-menu-item-danger",children:i.jsx("span",{children:R("common.delete","Delete")})})]});return K||q||H?fe.createPortal(O,document.body):O})(),N.showReloadConfirmModal&&fe.createPortal(i.jsx("div",{className:"dropdown-menu-confirm-overlay",onClick:N.handleCancelReload,children:i.jsxs("div",{className:"dropdown-menu-confirm-container",onClick:O=>O.stopPropagation(),children:[i.jsxs("div",{className:"dropdown-menu-confirm-header",children:[i.jsxs("h2",{children:[i.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"8px",verticalAlign:"middle"},children:[i.jsx("path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"}),i.jsx("path",{d:"M21 3v5h-5"}),i.jsx("path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"}),i.jsx("path",{d:"M3 21v-5h5"})]}),R("common.reloadMetadata","Reload all metadata")]}),i.jsx("button",{className:"dropdown-menu-confirm-close",onClick:N.handleCancelReload,"aria-label":"Close",children:"×"})]}),i.jsxs("div",{className:"dropdown-menu-confirm-content",children:[i.jsx("p",{children:R("common.confirmReload","Are you sure you want to reload all metadata? This will refresh all games, collections, and categories.")}),N.reloadError&&i.jsx("div",{className:"dropdown-menu-confirm-error",children:N.reloadError})]}),i.jsxs("div",{className:"dropdown-menu-confirm-footer",children:[i.jsx("button",{className:"dropdown-menu-confirm-cancel",onClick:N.handleCancelReload,disabled:N.isReloading,children:R("common.cancel","Cancel")}),i.jsx("button",{className:"dropdown-menu-confirm-reload",onClick:N.handleConfirmReload,disabled:N.isReloading,children:N.isReloading?R("common.reloading","Reloading..."):R("common.reloadMetadata","Reload all metadata")})]})]})}),document.body),P.showConfirmModal&&fe.createPortal(i.jsx("div",{className:"dropdown-menu-confirm-overlay",onClick:P.handleCancelDelete,children:i.jsxs("div",{className:"dropdown-menu-confirm-container",onClick:O=>O.stopPropagation(),children:[i.jsxs("div",{className:"dropdown-menu-confirm-header",children:[i.jsxs("h2",{children:[i.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"8px",verticalAlign:"middle"},children:[i.jsx("path",{d:"M3 6h18"}),i.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"}),i.jsx("path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]}),R("common.deleteTitle","Delete")]}),i.jsx("button",{className:"dropdown-menu-confirm-close",onClick:P.handleCancelDelete,"aria-label":"Close",children:"×"})]}),i.jsxs("div",{className:"dropdown-menu-confirm-content",children:[i.jsx("p",{children:R("common.confirmDelete",{title:y||d||""})}),P.deleteError&&i.jsx("div",{className:"dropdown-menu-confirm-error",children:P.deleteError})]}),i.jsxs("div",{className:"dropdown-menu-confirm-footer",children:[i.jsx("button",{className:"dropdown-menu-confirm-cancel",onClick:P.handleCancelDelete,disabled:P.isDeleting,children:R("common.cancel","Cancel")}),i.jsx("button",{className:"dropdown-menu-confirm-delete",onClick:P.handleConfirmDelete,disabled:P.isDeleting,children:P.isDeleting?R("common.deleting","Deleting..."):R("common.delete","Delete")})]})]})}),document.body)]})}const Je=r.createContext(void 0);function dn({children:e}){const[n,s]=r.useState([]),[o,h]=r.useState(!0),[m,l]=r.useState(null),{isLoading:y,token:t}=Te(),p=r.useCallback(async()=>{if(y||!(W()||t))return;h(!0),l(null);const u=new AbortController,b=setTimeout(()=>u.abort(),9e4);try{const w=U(z,"/developers"),f=await fetch(w,{headers:ye({Accept:"application/json"}),signal:u.signal});if(clearTimeout(b),!f.ok)throw new Error(`HTTP ${f.status}`);const S=((await f.json()).developers||[]).map(C=>({id:String(C.id),title:C.title,summary:C.summary,cover:C.cover,gameCount:C.gameCount,background:C.background,showTitle:C.showTitle!==!1}));s(S)}catch(w){clearTimeout(b),l(String(w.message||w))}finally{h(!1)}},[y,t]);r.useEffect(()=>{if(y)return;if(!W()&&!t){h(!1);return}const x=setTimeout(p,800);return()=>clearTimeout(x)},[y,t,p]),r.useEffect(()=>{const x=f=>{const E=f;E.detail?.developer?s(S=>S.map(C=>String(C.id)===String(E.detail.developer.id)?E.detail.developer:C)):p()},u=f=>{const S=f.detail?.developer;S&&s(C=>C.some(a=>String(a.id)===String(S.id))?C:[...C,S])},b=f=>{const S=f.detail?.developerId;S!=null&&s(C=>C.filter(a=>String(a.id)!==String(S)))},w=()=>p();return window.addEventListener("developerUpdated",x),window.addEventListener("developerAdded",u),window.addEventListener("developerDeleted",b),window.addEventListener("metadataReloaded",p),window.addEventListener("gameAdded",w),()=>{window.removeEventListener("developerUpdated",x),window.removeEventListener("developerAdded",u),window.removeEventListener("developerDeleted",b),window.removeEventListener("metadataReloaded",p),window.removeEventListener("gameAdded",w)}},[p]);const g=r.useCallback(()=>p(),[p]),c=r.useCallback(x=>{s(u=>u.map(b=>String(b.id)===String(x.id)?x:b))},[]),d=r.useMemo(()=>({developers:n,isLoading:o,error:m,refreshDevelopers:g,updateDeveloper:c}),[n,o,m,g,c]);return i.jsx(Je.Provider,{value:d,children:e})}function kt(){const e=r.useContext(Je);if(e===void 0)throw new Error("useDevelopers must be used within DevelopersProvider");return e}const Ye=r.createContext(void 0);function un({children:e}){const[n,s]=r.useState([]),[o,h]=r.useState(!0),[m,l]=r.useState(null),{isLoading:y,token:t}=Te(),p=r.useCallback(async()=>{if(y||!(W()||t))return;h(!0),l(null);const u=new AbortController,b=setTimeout(()=>u.abort(),9e4);try{const w=U(z,"/publishers"),f=await fetch(w,{headers:ye({Accept:"application/json"}),signal:u.signal});if(clearTimeout(b),!f.ok)throw new Error(`HTTP ${f.status}`);const S=((await f.json()).publishers||[]).map(C=>({id:String(C.id),title:C.title,summary:C.summary,cover:C.cover,gameCount:C.gameCount,background:C.background,showTitle:C.showTitle!==!1}));s(S)}catch(w){clearTimeout(b),l(String(w.message||w))}finally{h(!1)}},[y,t]);r.useEffect(()=>{if(y)return;if(!W()&&!t){h(!1);return}const x=setTimeout(p,1200);return()=>clearTimeout(x)},[y,t,p]),r.useEffect(()=>{const x=f=>{const E=f;E.detail?.publisher?s(S=>S.map(C=>String(C.id)===String(E.detail.publisher.id)?E.detail.publisher:C)):p()},u=f=>{const S=f.detail?.publisher;S&&s(C=>C.some(a=>String(a.id)===String(S.id))?C:[...C,S])},b=f=>{const S=f.detail?.publisherId;S!=null&&s(C=>C.filter(a=>String(a.id)!==String(S)))},w=()=>p();return window.addEventListener("publisherUpdated",x),window.addEventListener("publisherAdded",u),window.addEventListener("publisherDeleted",b),window.addEventListener("metadataReloaded",p),window.addEventListener("gameAdded",w),()=>{window.removeEventListener("publisherUpdated",x),window.removeEventListener("publisherAdded",u),window.removeEventListener("publisherDeleted",b),window.removeEventListener("metadataReloaded",p),window.removeEventListener("gameAdded",w)}},[p]);const g=r.useCallback(()=>p(),[p]),c=r.useCallback(x=>{s(u=>u.map(b=>String(b.id)===String(x.id)?x:b))},[]),d=r.useMemo(()=>({publishers:n,isLoading:o,error:m,refreshPublishers:g,updatePublisher:c}),[n,o,m,g,c]);return i.jsx(Ye.Provider,{value:d,children:e})}function St(){const e=r.useContext(Ye);if(e===void 0)throw new Error("usePublishers must be used within PublishersProvider");return e}const Et={collections:{titleKey:"collections.addToCollection",searchKey:"collections.searchCollections",emptyKey:"collections.noCollectionsFound",recentKey:"recentCollections",newTitlePlaceholderKey:"collections.newCollectionTitle"},developers:{titleKey:"igdbInfo.addToDeveloper",searchKey:"igdbInfo.searchDevelopers",emptyKey:"igdbInfo.noDevelopersFound",recentKey:"recentDevelopers",newTitlePlaceholderKey:"igdbInfo.newDeveloperName"},publishers:{titleKey:"igdbInfo.addToPublisher",searchKey:"igdbInfo.searchPublishers",emptyKey:"igdbInfo.noPublishersFound",recentKey:"recentPublishers",newTitlePlaceholderKey:"igdbInfo.newPublisherName"}};function jt({isOpen:e,onClose:n,game:s,resourceType:o,onAdded:h}){const{t:m}=oe(),[l,y]=r.useState(""),[t,p]=r.useState(o==="collections"?s.title:""),g=r.useRef(null),c=Et[o],{collections:d,collectionGameIds:x}=xe(),{developers:u}=kt(),{publishers:b}=St(),w=o==="collections"?d:o==="developers"?u:b,f=Ve({onSuccess:()=>{h?.(),n()}}),E=pt({onSuccess:()=>{h?.(),n()}}),S=wt({onSuccess:()=>{h?.(),n()}}),C=bt({onSuccess:async k=>{k&&await f.addGameToCollection(s.id,k.id)}}),a=yt(),v=xt(),L=r.useMemo(()=>{if(o==="collections")return w.filter(k=>{const A=x.get(String(k.id));return!A||!A.includes(String(s.id))});if(o==="developers"){const k=(s.developers||[]).map(A=>Number(typeof A=="object"?A?.id:A));return w.filter(A=>!k.includes(Number(A.id)))}if(o==="publishers"){const k=(s.publishers||[]).map(A=>Number(typeof A=="object"?A?.id:A));return w.filter(A=>!k.includes(Number(A.id)))}return[]},[w,x,s.id,s.developers,s.publishers,o]);r.useEffect(()=>(e?(p(o==="collections"?s.title:""),y(""),document.body.style.overflow="hidden",setTimeout(()=>{g.current?.focus(),o==="collections"&&g.current?.value&&g.current?.select()},0)):document.body.style.overflow="",()=>{document.body.style.overflow=""}),[e,s.title,o]);const R=r.useMemo(()=>{if(!l.trim())return L;const k=l.toLowerCase();return L.filter(A=>(A.title||"").toLowerCase().includes(k))},[l,L]),j=async k=>{o==="collections"?await f.addGameToCollection(s.id,k.id):o==="developers"?await E.addGameToDeveloper(s.id,String(k.id),k.title||""):o==="publishers"&&await S.addGameToPublisher(s.id,String(k.id),k.title||"")},T=async()=>{const k=t.trim();if(k){if(o==="collections")await C.createCollection(k);else if(o==="developers"){const A=await a.createDeveloper(k);A&&await E.addGameToDeveloper(s.id,A.id,A.title)}else if(o==="publishers"){const A=await v.createPublisher(k);A&&await S.addGameToPublisher(s.id,A.id,A.title)}}};return e?fe.createPortal(i.jsx("div",{className:"add-to-collection-modal-overlay",onClick:n,children:i.jsxs("div",{className:"add-to-collection-modal",onClick:k=>k.stopPropagation(),children:[i.jsxs("div",{className:"add-to-collection-modal-header",children:[i.jsx("h2",{children:m(c.titleKey)}),i.jsx("button",{className:"add-to-collection-modal-close",onClick:n,children:"×"})]}),i.jsx("div",{className:"add-to-collection-modal-search",children:i.jsx("input",{id:"add-to-collection-search",name:"search",type:"text",placeholder:m(c.searchKey),value:l,onChange:k=>y(k.target.value),autoFocus:!0,"aria-label":m(c.searchKey)})}),i.jsx("div",{className:"add-to-collection-modal-collections",children:R.length>0?R.map(k=>i.jsxs("div",{className:"add-to-collection-modal-collection-item",onClick:()=>j(k),children:[i.jsx("div",{className:"add-to-collection-modal-collection-title",children:k.title}),k.gameCount!==void 0&&i.jsxs("div",{className:"add-to-collection-modal-collection-count",children:[k.gameCount," ",m("collections.games","games")]})]},String(k.id))):i.jsx("div",{className:"add-to-collection-modal-empty",children:m(c.emptyKey)})}),i.jsxs("div",{className:"add-to-collection-modal-create",children:[i.jsx("input",{ref:g,id:"add-to-collection-create-title",name:"newItemTitle",type:"text",placeholder:m(c.newTitlePlaceholderKey),value:t,onChange:k=>p(k.target.value),onFocus:k=>{k.target.value&&k.target.select()},onKeyDown:k=>{k.key==="Enter"&&T()},"aria-label":m(c.newTitlePlaceholderKey)}),i.jsx("button",{onClick:T,disabled:!t.trim()||o==="collections"&&C.isCreating||o==="developers"&&(a.isCreating||E.isAdding)||o==="publishers"&&(v.isCreating||S.isAdding),className:"add-to-collection-modal-create-button",children:o==="collections"&&C.isCreating?m("common.creating","Creating..."):o==="developers"&&(a.isCreating||E.isAdding)||o==="publishers"&&(v.isCreating||S.isAdding)?a.isCreating||v.isCreating?m("common.creating","Creating..."):m("common.adding","Adding..."):m("common.create","Create")})]})]})}),document.body):null}function Tt({game:e,allCollections:n,onCollectionAdded:s}){const{t:o}=oe(),[h,m]=r.useState(!1),[l,y]=r.useState(null),[t,p]=r.useState(!1),[g,c]=r.useState(!1),d=r.useRef(null),x=r.useRef(null),{collectionGameIds:u}=xe(),b=l!==null,w=Ve({onSuccess:()=>{s?.(),m(!1)}});r.useEffect(()=>{const v=R=>{const j=R;if(j.detail?.gameId===e.id&&!b){if(j.detail.menuItem)x.current=j.detail.menuItem;else{const T=document.querySelectorAll(".dropdown-menu-item-with-submenu");for(const k of T){const A=k.closest(".dropdown-menu-popup");if(A){const P=window.getComputedStyle(A);if(P.display!=="none"&&P.visibility!=="hidden"){x.current=k;break}}}}m(!0)}},L=R=>{const j=R;(!j.detail?.gameId||j.detail.gameId===e.id)&&!b&&m(!1)};return window.addEventListener("openAddToCollectionDropdown",v),window.addEventListener("closeAddToCollectionDropdown",L),()=>{window.removeEventListener("openAddToCollectionDropdown",v),window.removeEventListener("closeAddToCollectionDropdown",L)}},[e.id,b]);const f=r.useMemo(()=>n.filter(v=>{const L=u.get(String(v.id));return!L||!L.includes(String(e.id))}),[n,u,e.id]),E=r.useMemo(()=>JSON.parse(localStorage.getItem("recentCollections")||"[]").map(L=>f.find(R=>R.id===L)).filter(L=>L!==void 0).slice(0,5),[f]);r.useEffect(()=>{c(h)},[h]),r.useEffect(()=>{if(!h||!d.current){p(!1);return}p(!1);const v=()=>{let T=x.current;if(!T||!document.contains(T)){const ce=document.querySelectorAll(".dropdown-menu-item-with-submenu");for(const ie of ce){const X=ie.closest(".dropdown-menu-popup");if(X){const G=window.getComputedStyle(X);if(G.display!=="none"&&G.visibility!=="hidden"){T=ie,x.current=T;break}}}}if(T||(T=document.querySelector(".dropdown-menu-item-with-submenu")),!T)return;let k=g?document.querySelector(".add-to-collection-dropdown-menu"):d.current?.querySelector(".add-to-collection-dropdown-menu");if(!k){g&&requestAnimationFrame(v);return}const A=T.getBoundingClientRect(),P=0,N=window.innerWidth,M=window.innerHeight,D=8,q=k.offsetWidth||200,H=k.offsetHeight||100;let K=A.right+P;K+q+D>N&&(K=A.left-q-P),K<D&&(K=D);let _=A.top;_+H+D>M&&(_=A.bottom-H,_+H+D>M&&(_=M-H-D)),_<D&&(_=D),g&&(k.style.position="fixed",k.style.right="auto",k.style.bottom="auto"),k.style.top=`${_}px`,k.style.left=`${K}px`,p(!0)};requestAnimationFrame(g?()=>{requestAnimationFrame(()=>{setTimeout(()=>{v()},50)})}:()=>{requestAnimationFrame(v)});const L=()=>{v()},R=()=>{v()};window.addEventListener("resize",L),window.addEventListener("scroll",R,!0);function j(T){const k=T.target;d.current&&!d.current.contains(k)&&!k.closest(".dropdown-menu-item-with-submenu")&&!k.closest(".dropdown-menu-popup")&&m(!1)}return d.current&&d.current.addEventListener("mouseleave",j),()=>{window.removeEventListener("resize",L),window.removeEventListener("scroll",R,!0),d.current&&d.current.removeEventListener("mouseleave",j)}},[h,g]);const S=async(v,L)=>{v.stopPropagation(),v.preventDefault(),m(!1),await w.addGameToCollection(e.id,L)},C=v=>L=>{L.stopPropagation(),L.preventDefault(),m(!1),setTimeout(()=>y(v),50)},a=h?i.jsxs("div",{className:"add-to-collection-dropdown-menu",style:{opacity:t?1:0,pointerEvents:t?"auto":"none"},onMouseEnter:()=>m(!0),onMouseLeave:v=>{const L=v.relatedTarget;(!L||!L.closest(".add-to-collection-dropdown-menu")&&!L.closest(".dropdown-menu-item-with-submenu")&&!L.closest(".dropdown-menu-popup"))&&setTimeout(()=>{const R=document.querySelector(".dropdown-menu-item-with-submenu"),j=document.querySelector(".add-to-collection-dropdown-menu");if(R&&j){const T=R.getBoundingClientRect(),k=j.getBoundingClientRect(),A=v.clientX,P=v.clientY,N=A>=T.left&&A<=T.right&&P>=T.top&&P<=T.bottom,M=A>=k.left&&A<=k.right&&P>=k.top&&P<=k.bottom;!N&&!M&&m(!1)}else m(!1)},200)},onClick:v=>{v.stopPropagation()},children:[i.jsx("div",{className:"add-to-collection-dropdown-item",onClick:C("collections"),children:o("collections.addToCollection","Add to Collection...")}),i.jsx("div",{className:"add-to-collection-dropdown-item",onClick:C("developers"),children:o("igdbInfo.addToDeveloper","Add to Developer...")}),i.jsx("div",{className:"add-to-collection-dropdown-item",onClick:C("publishers"),children:o("igdbInfo.addToPublisher","Add to Publisher...")}),E.length>0&&i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"add-to-collection-dropdown-divider"}),i.jsx("div",{className:"add-to-collection-dropdown-section-title",children:o("collections.recent","RECENT")}),E.map(v=>i.jsx("div",{className:"add-to-collection-dropdown-item",onClick:L=>S(L,v.id),children:v.title},v.id))]})]}):null;return i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"add-to-collection-dropdown",ref:d,children:g&&a?fe.createPortal(a,document.body):a}),l&&i.jsx(jt,{isOpen:!0,onClose:()=>y(null),game:e,resourceType:l,onAdded:s})]})}function Lt({gameId:e,gameExecutables:n,onPlayExecutable:s}){const[o,h]=r.useState(!1),[m,l]=r.useState(!1),[y,t]=r.useState(!1),[p,g]=r.useState(!1),c=r.useRef(null),d=r.useRef(null),x=n.slice(1);r.useEffect(()=>{if(c.current){const w=c.current.closest(".search-dropdown-item")!==null;t(w)}},[]),r.useEffect(()=>{g(o)},[o]),r.useEffect(()=>{const w=E=>{E.detail?.gameId===e&&h(!0)},f=E=>{const S=E;(!S.detail?.gameId||S.detail.gameId===e)&&h(!1)};return window.addEventListener("openAdditionalExecutablesDropdown",w),window.addEventListener("closeAdditionalExecutablesDropdown",f),()=>{window.removeEventListener("openAdditionalExecutablesDropdown",w),window.removeEventListener("closeAdditionalExecutablesDropdown",f)}},[e]),r.useEffect(()=>{if(!o||!c.current){l(!1);return}l(!1);const w=()=>{const S=document.querySelector(".dropdown-menu-item-with-submenu.additional-executables-menu-item");if(!S){requestAnimationFrame(w);return}let C=p?document.querySelector(".additional-executables-dropdown-menu"):d.current;if(!C&&c.current&&!p&&(C=c.current.querySelector(".additional-executables-dropdown-menu")),!C){requestAnimationFrame(w);return}const a=S.getBoundingClientRect(),v=0,L=window.innerWidth,R=window.innerHeight,j=8,T=C.offsetWidth||200,k=C.offsetHeight||100;let A=a.right+v;A+T+j>L&&(A=a.left-T-v),A<j&&(A=j);let P=a.top;P+k+j>R&&(P=a.bottom-k,P+k+j>R&&(P=R-k-j)),P<j&&(P=j),C.style.position="fixed",C.style.top=`${P}px`,C.style.left=`${A}px`,C.style.right="auto",C.style.bottom="auto",l(!0)};requestAnimationFrame(()=>{requestAnimationFrame(w)});const f=()=>{w()},E=()=>{w()};return window.addEventListener("resize",f),window.addEventListener("scroll",E,!0),()=>{window.removeEventListener("resize",f),window.removeEventListener("scroll",E,!0)}},[o]);const u=(w,f)=>{w.stopPropagation(),w.preventDefault(),s&&s(f),setTimeout(()=>{h(!1)},50)};if(x.length===0)return null;const b=o?i.jsx("div",{ref:d,className:`additional-executables-dropdown-menu ${y?"additional-executables-dropdown-menu-in-popup":""}`,style:{visibility:m?"visible":"hidden",pointerEvents:m?"auto":"none"},onMouseLeave:w=>{setTimeout(()=>{const f=document.querySelector(".dropdown-menu-item-with-submenu.additional-executables-menu-item");if(f){const E=f.getBoundingClientRect();let S=d.current;!S&&c.current&&(S=c.current.querySelector(".additional-executables-dropdown-menu"));const C=S?.getBoundingClientRect();if(C){const a=w.clientX,v=w.clientY,L=a>=E.left&&a<=E.right&&v>=E.top&&v<=E.bottom,R=a>=C.left&&a<=C.right&&v>=C.top&&v<=C.bottom;!L&&!R&&h(!1)}else h(!1)}},200)},onClick:w=>{w.stopPropagation()},onMouseDown:w=>{w.stopPropagation()},children:x.map(w=>i.jsx("button",{type:"button",className:"additional-executables-dropdown-item",onClick:f=>u(f,w),onMouseDown:f=>{f.stopPropagation()},children:w},w))}):null;return i.jsx("div",{className:"additional-executables-dropdown",ref:c,children:p&&typeof document<"u"?fe.createPortal(b,document.body):b})}function De({title:e,coverUrl:n,width:s,height:o,onPlay:h,onClick:m,onEdit:l,onDelete:y,gameId:t,gameTitle:p,game:g,onGameDelete:c,onGameUpdate:d,collectionId:x,collectionTitle:u,onCollectionDelete:b,onCollectionUpdate:w,onRemoveFromCollection:f,developerId:E,publisherId:S,onRemoveFromDeveloper:C,onRemoveFromPublisher:a,showTitle:v=!1,subtitle:L,detail:R=!0,play:j=!0,showBorder:T=!0,aspectRatio:k="3/4",overlayContent:A,titlePosition:P="bottom",editButtonPosition:N="bottom-left",onUpload:M,uploading:D=!1,allCollections:q=[],showRemoveButton:H=!1,removeMediaType:K,removeResourceId:_,removeResourceType:ce,onRemoveSuccess:ie,removeDisabled:X=!1}){const{t:G}=oe(),[re,te]=r.useState(!1),[ne,le]=r.useState(!1),[he,ge]=r.useState(!1),pe=r.useRef(null),we=!n||re;r.useEffect(()=>{te(!1)},[n]),r.useEffect(()=>{if(!t&&!x)return;const $=de=>{const ee=de;(t&&ee.detail?.gameId===t||x&&!t&&ee.detail?.collectionId===x)&&le(!0)},Q=de=>{const ee=de;(t&&ee.detail?.gameId===t||x&&!t&&ee.detail?.collectionId===x)&&le(!1)};return window.addEventListener("dropdownMenuOpened",$),window.addEventListener("dropdownMenuClosed",Q),()=>{window.removeEventListener("dropdownMenuOpened",$),window.removeEventListener("dropdownMenuClosed",Q)}},[t,x]),r.useEffect(()=>{if(!ne){ge(!1);return}const $=()=>{if(!pe.current)return;const ee=pe.current.querySelectorAll(".games-list-play-button, .games-list-upload-button, .games-list-edit-button");if(ee.length===0){ge(!1);return}const st=document.querySelectorAll(".dropdown-menu-popup, .add-to-collection-dropdown-menu");let Le=!1;ee.forEach(Se=>{const Ee=Se.getBoundingClientRect();st.forEach($e=>{const Re=window.getComputedStyle($e);if(Re.display==="none"||Re.opacity==="0"||Re.visibility==="hidden")return;const je=$e.getBoundingClientRect();!(je.right<Ee.left||je.left>Ee.right||je.bottom<Ee.top||je.top>Ee.bottom)&&(Le=!0)})}),ge(Se=>Se===Le?Se:Le)};$();const Q=setInterval($,100);return window.addEventListener("scroll",$,!0),window.addEventListener("resize",$),()=>{clearInterval(Q),window.removeEventListener("scroll",$,!0),window.removeEventListener("resize",$)}},[ne]);let O=Math.max(10,Math.min(16,Math.floor(s/8)));k==="16/9"&&P==="overlay"&&(O=Math.max(14,Math.min(24,Math.floor(s/5))));const F=Math.max(4,Math.floor(s/20)),I=Math.max(2,Math.floor(o/(O*1.5))),B=$=>{j&&!R&&h?($.stopPropagation(),h()):R&&m&&($.stopPropagation(),m())},J=$=>{$.stopPropagation(),h&&h()},ve=$=>{$.stopPropagation(),l&&l()},se=$=>{$.stopPropagation(),M&&!D&&M()},Y=j&&h&&!M,Z=M!==void 0,V=R||j||Z;return i.jsxs(i.Fragment,{children:[i.jsxs("div",{ref:pe,className:`games-list-cover relative bg-[#2a2a2a] rounded overflow-hidden transition-all ${T?"cover-hover-effect":""} ${j?"games-list-cover-play":""} ${R?"games-list-cover-detail":""} ${Z?"games-list-cover-upload":""} ${ne?"cover-dropdown-open":""} ${he?"cover-popup-overlay":""}`,style:{width:`${s}px`,aspectRatio:k,cursor:V&&!Z||Z?"pointer":"default"},onClick:Z?se:B,children:[we?i.jsx("div",{className:"cover-placeholder",style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#2a2a2a",border:"1px solid rgba(255, 255, 255, 0.2)",boxSizing:"border-box"},children:i.jsx("div",{className:"cover-placeholder-text",style:{padding:`${F}px`,fontSize:`${O}px`,textAlign:"center",color:"rgba(255, 255, 255, 0.85)",fontWeight:600,lineHeight:1.3,wordBreak:"break-word",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:I,WebkitBoxOrient:"vertical",width:"100%",maxHeight:"100%"},children:e})}):i.jsx("img",{src:n,alt:e,className:"object-cover w-full h-full",loading:n.startsWith("data:")?void 0:"lazy",onError:()=>{te(!0)},onLoad:()=>{te(!1)}},n||"cover-image"),Y&&i.jsx("button",{onClick:J,className:`games-list-play-button ${R?"games-list-play-button-detail":"games-list-play-button-play-only"}`,"aria-label":G("common.play"),children:i.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:i.jsx("path",{d:"M8 5v14l11-7z",fill:"currentColor"})})}),Z&&i.jsx("button",{onClick:se,className:`games-list-upload-button ${R?"games-list-upload-button-detail":"games-list-upload-button-upload-only"}`,"aria-label":G("gameDetail.uploadCover","Upload Cover"),disabled:D,children:D?i.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:"spinning",style:{animation:"spin 1s linear infinite"},children:i.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"2",fill:"none",strokeDasharray:"31.416",strokeDashoffset:"31.416",strokeLinecap:"round"})}):i.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:i.jsx("path",{d:"M12 5v14M5 12h14",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}),l&&i.jsx("button",{onClick:ve,className:`games-list-edit-button ${N==="bottom-right"?"games-list-edit-button-bottom-right":""}`,"aria-label":G("common.edit","Edit"),children:i.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[i.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),i.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]})}),l&&t&&g&&i.jsx("div",{className:"games-list-dropdown-wrapper games-list-dropdown-wrapper-bottom-right",children:i.jsx(Tt,{game:g,allCollections:q})}),l&&(t||x||E||S)&&i.jsxs("div",{className:"games-list-dropdown-wrapper games-list-dropdown-wrapper-bottom-right",children:[t&&g&&g.executables&&g.executables.length>1&&h&&i.jsx(Lt,{gameId:t,gameExecutables:g.executables,onPlayExecutable:$=>{h&&h(g,$)}}),i.jsx(Ct,{onDelete:y,gameId:t,gameTitle:p,gameExecutables:g?.executables,onAddToCollection:t&&g?()=>{}:void 0,onRemoveFromCollection:f,onGameDelete:c,onGameUpdate:d,collectionId:x,collectionTitle:u,onCollectionDelete:b,onCollectionUpdate:w,developerId:E,publisherId:S,onRemoveFromDeveloper:C,onRemoveFromPublisher:a,className:"games-list-dropdown-menu"})]}),H&&K&&_&&ce&&i.jsx("button",{className:"cover-remove-media-button",onClick:$=>{$.stopPropagation(),ie&&ie()},disabled:X||D,title:K==="cover"?G("gameDetail.removeCover","Remove cover"):G("gameDetail.removeBackground","Remove background")}),A&&i.jsx("div",{className:"cover-overlay-content",children:A}),P==="overlay"&&v&&!we&&i.jsx("div",{className:"cover-overlay-content",style:{display:"flex",alignItems:"center",justifyContent:"center",padding:`${F}px`},children:i.jsx("div",{style:{textAlign:"center",color:"rgba(255, 255, 255, 0.95)",fontWeight:600,fontSize:`${O}px`,lineHeight:1.3,wordBreak:"break-word",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:I,WebkitBoxOrient:"vertical",textShadow:"2px 2px 4px rgba(0, 0, 0, 0.8)"},children:e})})]}),(v&&P==="bottom"||L!=null)&&i.jsxs("div",{className:"games-list-title-wrapper",children:[v&&P==="bottom"&&i.jsx(Xe,{text:e,position:"bottom",children:i.jsx("div",{className:`truncate games-list-title ${R?"games-list-title-clickable":""}`,onClick:R&&m?$=>{$.stopPropagation(),m()}:void 0,children:e})}),L!=null&&i.jsx("div",{className:"games-list-year",children:L})]})]})}const Rt={collections:{routeBase:"collections",responseKey:"collection",coverPrefix:"collection-covers",backgroundPrefix:"collection-backgrounds",titleKey:"collectionDetail.editCollection"},developers:{routeBase:"developers",responseKey:"developer",coverPrefix:"developer-covers",backgroundPrefix:"developer-backgrounds",titleKey:"igdbInfo.editDeveloper"},publishers:{routeBase:"publishers",responseKey:"publisher",coverPrefix:"publisher-covers",backgroundPrefix:"publisher-backgrounds",titleKey:"igdbInfo.editPublisher"}};function At({isOpen:e,onClose:n,resourceType:s,item:o,onItemUpdate:h}){const{t:m}=oe(),{setLoading:l}=ae(),y=Rt[s],t=!0,p=!0,[g,c]=r.useState(o.title),[d,x]=r.useState(o.summary||""),[u,b]=r.useState(!1),[w,f]=r.useState(null),[E,S]=r.useState("INFO"),[C,a]=r.useState(!1),[v,L]=r.useState(!1),R=r.useRef(null),j=r.useRef(null),[T,k]=r.useState(null),[A,P]=r.useState(null),[N,M]=r.useState(null),[D,q]=r.useState(null),[H,K]=r.useState(!1),[_,ce]=r.useState(!1),[ie,X]=r.useState(Date.now()),[G,re]=r.useState(!1),te=r.useMemo(()=>{if(!o?.cover||o.cover.trim()==="")return"";const I=o.cover.split("?")[0].split("&")[0];if(I.startsWith("http"))return"";const B=U(z,I),J=B.includes("?")?"&":"?";return`${B}${J}t=${ie}`},[o?.cover,ie]),ne=r.useMemo(()=>{if(!o?.background||o.background.trim()==="")return"";const I=o.background.split("?")[0].split("&")[0];if(I.startsWith("http"))return"";const B=U(z,I),J=B.includes("?")?"&":"?";return`${B}${J}t=${ie}`},[o?.background,ie]);r.useEffect(()=>{e&&o?(c(o.title||""),x(o.summary||""),re(o.showTitle!==!1),f(null),S("INFO"),k(null),P(null),M(null),q(null),K(!1),ce(!1),X(Date.now())):e||(k(null),P(null),M(null),q(null))},[e,o]),r.useEffect(()=>{o&&(!o.cover&&!H&&!N&&(K(!0),k(null),X(Date.now())),!o.background&&!_&&!D&&(ce(!0),P(null),X(Date.now())))},[o?.cover,o?.background,t]),r.useEffect(()=>{if(!e)return;function I(B){B.key==="Escape"&&(B.stopPropagation(),n())}return document.addEventListener("keydown",I,!0),document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",I,!0),document.body.style.overflow=""}},[e,n]);const le=()=>g.trim()!==o.title.trim()||d.trim()!==(o.summary||"").trim()||G!==(o.showTitle!==!1)||N!==null||D!==null||H||_,he=I=>{const B=I.target.files?.[0];if(B?.type.startsWith("image/")){const J=new FileReader;J.onloadend=()=>k(J.result),J.readAsDataURL(B),M(B),K(!1),f(null)}else f(m("gameDetail.invalidImageType","File must be an image"));I.target.value=""},ge=I=>{const B=I.target.files?.[0];if(B?.type.startsWith("image/")){const J=new FileReader;J.onloadend=()=>P(J.result),J.readAsDataURL(B),q(B),ce(!1),f(null)}else f(m("gameDetail.invalidImageType","File must be an image"));I.target.value=""},pe=()=>{K(!0),k(null),M(null),X(Date.now())},we=()=>{ce(!0),P(null),q(null),X(Date.now())},O=async()=>{b(!0),f(null),l(!0);try{let I=null,B=null;const J=`/${y.routeBase}/${o.id}`;if(H){const se=U(z,`${J}/delete-cover`),Y=await fetch(se,{method:"DELETE",headers:{"X-Auth-Token":W()||""}});if(!Y.ok){const $=await Y.json().catch(()=>({error:"Failed to remove cover"}));throw new Error($.error||"Failed to remove cover")}const V=(await Y.json())[y.responseKey];V?.cover&&(I=V.cover)}if(t&&_){const se=U(z,`${J}/delete-background`),Y=await fetch(se,{method:"DELETE",headers:{"X-Auth-Token":W()||""}});if(!Y.ok){const $=await Y.json().catch(()=>({error:"Failed to remove background"}));throw new Error($.error||"Failed to remove background")}const V=(await Y.json())[y.responseKey];V?.background&&(B=V.background)}if(N){a(!0);try{const se=new FormData;se.append("file",N);const Y=U(z,`${J}/upload-cover`),Z=await fetch(Y,{method:"POST",headers:{"X-Auth-Token":W()||""},body:se});if(!Z.ok){const Q=await Z.json().catch(()=>({error:"Failed to upload cover"}));throw new Error(Q.error||"Failed to upload cover")}const $=(await Z.json())[y.responseKey];$?.cover&&(I=$.cover),t&&$?.background&&!B&&(B=$.background)}finally{a(!1)}}if(t&&D){L(!0);try{const se=new FormData;se.append("file",D);const Y=U(z,`${J}/upload-background`),Z=await fetch(Y,{method:"POST",headers:{"X-Auth-Token":W()||""},body:se});if(!Z.ok){const Q=await Z.json().catch(()=>({error:"Failed to upload background"}));throw new Error(Q.error||"Failed to upload background")}const $=(await Z.json())[y.responseKey];$?.background&&(B=$.background),$?.cover&&!I&&(I=$.cover)}finally{L(!1)}}const ve={};if(g.trim()!==o.title.trim()&&(ve.title=g.trim()),d.trim()!==(o.summary||"").trim()&&(ve.summary=d.trim()),p&&G!==(o.showTitle!==!1)&&(ve.showTitle=G),Object.keys(ve).length>0){const se=U(z,J),Y=await fetch(se,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":ze},body:JSON.stringify(ve)});if(!Y.ok){const ee=await Y.json();throw new Error(ee.error||"Failed to update")}const V=(await Y.json())[y.responseKey];let $=H?void 0:I??V?.cover??o.cover,Q=t?_?void 0:B??V?.background??o.background:void 0;if(I&&$){const ee=$.includes("?")?"&":"?";$=`${$}${ee}t=${Date.now()}`}if(t&&B&&Q){const ee=Q.includes("?")?"&":"?";Q=`${Q}${ee}t=${Date.now()}`}const de={id:V?.id??o.id,title:V?.title??o.title,summary:V?.summary??o.summary??"",cover:$,background:Q,showTitle:p?V?.showTitle??o.showTitle:void 0};F(de),h(de)}else if(N||t&&D||H||t&&_){const se=U(z,J),Y=await fetch(se,{method:"GET",headers:{Accept:"application/json","X-Auth-Token":ze}});if(Y.ok){const Z=await Y.json(),V=Z[y.responseKey]??Z;let $=H?void 0:I??V?.cover??o.cover,Q=t?_?void 0:B??V?.background??o.background:void 0;if((I!==null||H)&&$){const ee=$.includes("?")?"&":"?";$=`${$}${ee}t=${Date.now()}`}if(t&&(B!==null||_)&&Q){const ee=Q.includes("?")?"&":"?";Q=`${Q}${ee}t=${Date.now()}`}const de={id:V?.id??o.id,title:V?.title??o.title,summary:V?.summary??o.summary??"",cover:$,background:Q,showTitle:p?V?.showTitle??o.showTitle:void 0};F(de),h(de)}}else{n();return}n()}catch(I){f(String(I instanceof Error?I.message:I))}finally{b(!1),l(!1)}};function F(I){s==="collections"?window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collection:I}})):s==="developers"?window.dispatchEvent(new CustomEvent("developerUpdated",{detail:{developer:I}})):s==="publishers"&&window.dispatchEvent(new CustomEvent("publisherUpdated",{detail:{publisher:I}}))}return e?fe.createPortal(i.jsx("div",{className:"edit-collection-modal-overlay",onClick:n,children:i.jsxs("div",{className:"edit-collection-modal-container",onClick:I=>I.stopPropagation(),children:[i.jsxs("div",{className:"edit-collection-modal-header",children:[i.jsxs("h2",{children:[i.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"8px",verticalAlign:"middle"},children:[i.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),i.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]}),m(y.titleKey,s==="collections"?"Edit Collection":s==="developers"?"Edit Developer":"Edit Publisher")]}),i.jsx("button",{className:"edit-collection-modal-close",onClick:n,"aria-label":"Close",children:"×"})]}),i.jsxs("div",{className:"edit-collection-modal-content",children:[w&&i.jsx("div",{className:"edit-collection-modal-error",children:w}),i.jsxs("div",{className:"edit-collection-modal-tabs",children:[i.jsx("button",{className:`edit-collection-modal-tab ${E==="INFO"?"active":""}`,onClick:()=>S("INFO"),disabled:u,children:m("gameDetail.info","INFO")}),i.jsx("button",{className:`edit-collection-modal-tab ${E==="MEDIA"?"active":""}`,onClick:()=>S("MEDIA"),disabled:u,children:m("gameDetail.media","MEDIA")})]}),E==="INFO"&&i.jsxs("div",{className:"edit-collection-modal-info",children:[i.jsxs("div",{className:"edit-collection-modal-field",children:[i.jsx("label",{htmlFor:"edit-collection-like-title",children:s==="collections"?m("collectionDetail.title","Title"):m("igdbInfo.name","Name")}),i.jsx("input",{id:"edit-collection-like-title",type:"text",value:g,onChange:I=>c(I.target.value),disabled:u})]}),i.jsxs("div",{className:"edit-collection-modal-field",children:[i.jsx("label",{htmlFor:"edit-collection-like-summary",children:m("collectionDetail.summary","Summary")}),i.jsx("textarea",{id:"edit-collection-like-summary",value:d,onChange:I=>x(I.target.value),disabled:u,rows:15})]})]}),E==="MEDIA"&&i.jsxs("div",{className:"edit-collection-modal-media",children:[i.jsx("div",{className:"edit-collection-modal-media-options",children:i.jsxs("label",{className:"edit-collection-modal-media-checkbox-label",children:[i.jsx("input",{type:"checkbox",checked:G,onChange:I=>re(I.target.checked),"aria-label":m("gameDetail.showTitle","Show title on cover")}),i.jsx("span",{children:m("gameDetail.showTitle","Show title on cover")})]})}),i.jsxs("div",{className:"edit-collection-modal-media-row",children:[i.jsxs("div",{className:"edit-collection-modal-media-info",children:[i.jsx("div",{className:"edit-collection-modal-label",children:m("gameDetail.cover","Cover")}),i.jsx("div",{className:"edit-collection-modal-media-description",children:m("gameDetail.coverFormat","Recommended format: WebP, ratio 2:3 (e.g., 400x600px)")})]}),i.jsx("div",{className:"edit-collection-modal-media-image-container",children:(()=>{const I=H?"":T||te,B=!!I?.trim();return i.jsxs(i.Fragment,{children:[i.jsx(De,{title:o.title,coverUrl:I,width:150,height:200,showTitle:!1,detail:!1,play:!1,showBorder:!0,aspectRatio:"3/4",onUpload:()=>!C&&!u&&R.current?.click(),uploading:C,showRemoveButton:!!B&&!H,removeMediaType:"cover",removeResourceId:o.id,removeResourceType:s,onCollectionUpdate:h,onRemoveSuccess:pe,removeDisabled:u||C},`cover-${H?"removed":T?"preview":te}`),i.jsx("input",{ref:R,type:"file",accept:"image/*",style:{display:"none"},onChange:he,"aria-label":m("gameDetail.cover","Cover")})]})})()})]}),i.jsxs("div",{className:"edit-collection-modal-media-row",children:[i.jsxs("div",{className:"edit-collection-modal-media-info",children:[i.jsx("div",{className:"edit-collection-modal-label",children:m("gameDetail.background","Background")}),i.jsx("div",{className:"edit-collection-modal-media-description",children:m("gameDetail.backgroundFormat","Recommended format: WebP, ratio 16:9 (e.g., 1920x1080px)")})]}),i.jsx("div",{className:"edit-collection-modal-media-image-container",children:(()=>{const I=_?"":A||ne,B=!!I?.trim();return i.jsxs(i.Fragment,{children:[i.jsx(De,{title:o.title,coverUrl:I,width:300,height:169,showTitle:!1,detail:!1,play:!1,showBorder:!0,aspectRatio:"16/9",onUpload:()=>!v&&!u&&j.current?.click(),uploading:v,showRemoveButton:!!B&&!_,removeMediaType:"background",removeResourceId:o.id,removeResourceType:s,onCollectionUpdate:h,onRemoveSuccess:we,removeDisabled:u||v},`bg-${_?"removed":A?"preview":ne}`),i.jsx("input",{ref:j,type:"file",accept:"image/*",style:{display:"none"},onChange:ge,"aria-label":m("gameDetail.background","Background")})]})})()})]})]})]}),i.jsxs("div",{className:"edit-collection-modal-footer",children:[i.jsx("button",{className:"edit-collection-modal-cancel",onClick:n,disabled:u,children:m("common.cancel","Cancel")}),i.jsx("button",{className:"edit-collection-modal-save",onClick:O,disabled:u||!le(),children:u?m("common.saving","Saving..."):m("common.save","Save")})]})]})}),document.body):null}const Ze=r.createContext(void 0);function mn({children:e}){const[n,s]=r.useState([]),[o,h]=r.useState(!1),[m,l]=r.useState(null),{isLoading:y,token:t}=Te(),p=r.useCallback(async()=>{if(!(y||!(W()||t))){h(!0),l(null);try{const w=U(z,"/libraries/library/games",{sort:"title"}),f=await fetch(w,{headers:ye({Accept:"application/json"})});if(!f.ok)throw new Error(`HTTP ${f.status}`);const C=((await f.json()).games||[]).map(a=>({id:String(a.id),title:a.title,summary:a.summary,cover:a.cover,background:a.background,day:a.day,month:a.month,year:a.year,stars:a.stars,genre:a.genre,criticratings:a.criticratings,userratings:a.userratings,executables:a.executables||null,themes:a.themes||null,platforms:a.platforms||null,gameModes:a.gameModes||null,playerPerspectives:a.playerPerspectives||null,websites:a.websites||null,ageRatings:a.ageRatings||null,developers:a.developers||null,publishers:a.publishers||null,franchise:a.franchise||null,collection:a.collection||null,series:a.series??a.collection??null,screenshots:a.screenshots||null,videos:a.videos||null,gameEngines:a.gameEngines||null,keywords:a.keywords||null,alternativeNames:a.alternativeNames||null,similarGames:a.similarGames||null}));s(C)}catch(w){const f=String(w.message||w);console.error("Error fetching library games:",f),l(f)}finally{h(!1)}}},[y,t]);r.useEffect(()=>{y||p()},[y,p]),r.useEffect(()=>{const b=S=>{const a=S.detail?.game;a&&s(v=>v.map(L=>String(L.id)===String(a.id)?a:L))},w=S=>{const a=S.detail?.gameId;a&&s(v=>v.filter(L=>String(L.id)!==String(a)))},f=S=>{const a=S.detail?.game;a&&s(v=>v.some(L=>String(L.id)===String(a.id))?v.map(L=>String(L.id)===String(a.id)?a:L):[...v,a].sort((L,R)=>(L.title||"").localeCompare(R.title||"")))},E=()=>{p()};return window.addEventListener("gameUpdated",b),window.addEventListener("gameDeleted",w),window.addEventListener("gameAdded",f),window.addEventListener("metadataReloaded",E),()=>{window.removeEventListener("gameUpdated",b),window.removeEventListener("gameDeleted",w),window.removeEventListener("gameAdded",f),window.removeEventListener("metadataReloaded",E)}},[p]);const g=r.useCallback(async()=>{await p()},[p]),c=r.useCallback(b=>{s(w=>w.some(f=>String(f.id)===String(b.id))?w.map(f=>String(f.id)===String(b.id)?b:f):[...w,b].sort((f,E)=>(f.title||"").localeCompare(E.title||"")))},[]),d=r.useCallback(b=>{s(w=>w.map(f=>String(f.id)===String(b.id)?b:f))},[]),x=r.useCallback(b=>{s(w=>w.filter(f=>String(f.id)!==String(b)))},[]),u=r.useMemo(()=>({games:n,isLoading:o,error:m,refreshGames:g,addGame:c,updateGame:d,removeGame:x}),[n,o,m,g,c,d,x]);return i.jsx(Ze.Provider,{value:u,children:e})}function Pt(){const e=r.useContext(Ze);if(e===void 0)throw new Error("useLibraryGames must be used within a LibraryGamesProvider");return e}function Nt(e,n=!0){const{collectionGameIds:s,isLoading:o,getCollectionGameIds:h}=xe(),{games:m,isLoading:l}=Pt(),[y,t]=r.useState(!1);return r.useEffect(()=>{!n||!e||o||l||s.get(String(e))||(t(!0),h(e).then(()=>{t(!1)}).catch(()=>{t(!1)}))},[e,n,o,l]),r.useMemo(()=>{if(!n||!e)return{hasPlayableGame:null,isLoading:!1};if(o||l||y)return{hasPlayableGame:null,isLoading:!0};const g=s.get(String(e));return!g||g.length===0?{hasPlayableGame:!1,isLoading:!1}:{hasPlayableGame:g.some(d=>{const x=m.find(u=>String(u.id)===String(d));return x&&x.executables&&x.executables.length>0}),isLoading:!1}},[e,n,s,m,o,l,y])}function Dt(e){let n=e;for(;n;){if(n.dir)return n.dir==="rtl";n=n.parentElement}return!1}function Mt(e,n){const[s,o]=r.useState(n==="rtl");return r.useLayoutEffect(()=>{e&&(n||o(Dt(e)))},[n,e]),s}const ke=typeof window<"u"?r.useLayoutEffect:r.useEffect;function Fe(e){if(e!==void 0)switch(typeof e){case"number":return e;case"string":{if(e.endsWith("px"))return parseFloat(e);break}}}function It({box:e,defaultHeight:n,defaultWidth:s,disabled:o,element:h,mode:m,style:l}){const{styleHeight:y,styleWidth:t}=r.useMemo(()=>({styleHeight:Fe(l?.height),styleWidth:Fe(l?.width)}),[l?.height,l?.width]),[p,g]=r.useState({height:n,width:s}),c=o||m==="only-height"&&y!==void 0||m==="only-width"&&t!==void 0||y!==void 0&&t!==void 0;return ke(()=>{if(h===null||c)return;const d=new ResizeObserver(x=>{for(const u of x){const{contentRect:b,target:w}=u;h===w&&g(f=>f.height===b.height&&f.width===b.width?f:{height:b.height,width:b.width})}});return d.observe(h,{box:e}),()=>{d?.unobserve(h)}},[e,c,h,y,t]),r.useMemo(()=>({height:y??p.height,width:t??p.width}),[p,y,t])}function Qe(e){const n=r.useRef(()=>{throw new Error("Cannot call during render.")});return ke(()=>{n.current=e},[e]),r.useCallback(s=>n.current?.(s),[n])}let be=null;function $t(e=!1){if(be===null||e){const n=document.createElement("div"),s=n.style;s.width="50px",s.height="50px",s.overflow="scroll",s.direction="rtl";const o=document.createElement("div"),h=o.style;return h.width="100px",h.height="100px",n.appendChild(o),document.body.appendChild(n),n.scrollLeft>0?be="positive-descending":(n.scrollLeft=1,n.scrollLeft===0?be="negative":be="positive-ascending"),document.body.removeChild(n),be}return be}function Pe({containerElement:e,direction:n,isRtl:s,scrollOffset:o}){if(n==="horizontal"&&s)switch($t()){case"negative":return-o;case"positive-descending":{if(e){const{clientWidth:h,scrollLeft:m,scrollWidth:l}=e;return l-h-m}break}}return o}function ue(e,n="Assertion error"){if(!e)throw console.error(n),Error(n)}function Ce(e,n){if(e===n)return!0;if(!!e!=!!n||(ue(e!==void 0),ue(n!==void 0),Object.keys(e).length!==Object.keys(n).length))return!1;for(const s in e)if(!Object.is(n[s],e[s]))return!1;return!0}function et({cachedBounds:e,itemCount:n,itemSize:s}){if(n===0)return 0;if(typeof s=="number")return n*s;{const o=e.get(e.size===0?0:e.size-1);ue(o!==void 0,"Unexpected bounds cache miss");const h=(o.scrollOffset+o.size)/e.size;return n*h}}function Ot({align:e,cachedBounds:n,index:s,itemCount:o,itemSize:h,containerScrollOffset:m,containerSize:l}){if(s<0||s>=o)throw RangeError(`Invalid index specified: ${s}`,{cause:`Index ${s} is not within the range of 0 - ${o-1}`});const y=et({cachedBounds:n,itemCount:o,itemSize:h}),t=n.get(s),p=Math.max(0,Math.min(y-l,t.scrollOffset)),g=Math.max(0,t.scrollOffset-l+t.size);switch(e==="smart"&&(m>=g&&m<=p?e="auto":e="center"),e){case"start":return p;case"end":return g;case"center":return t.scrollOffset<=l/2?0:t.scrollOffset+t.size/2>=y-l/2?y-l:t.scrollOffset+t.size/2-l/2;case"auto":default:return m>=g&&m<=p?m:m<g?g:p}}function Ne({cachedBounds:e,containerScrollOffset:n,containerSize:s,itemCount:o,overscanCount:h}){const m=o-1;let l=0,y=-1,t=0,p=-1,g=0;for(;g<m;){const c=e.get(g);if(c.scrollOffset+c.size>n)break;g++}for(l=g,t=Math.max(0,l-h);g<m;){const c=e.get(g);if(c.scrollOffset+c.size>=n+s)break;g++}return y=Math.min(m,g),p=Math.min(o-1,y+h),l<0&&(l=0,y=-1,t=0,p=-1),{startIndexVisible:l,stopIndexVisible:y,startIndexOverscan:t,stopIndexOverscan:p}}function zt({itemCount:e,itemProps:n,itemSize:s}){const o=new Map;return{get(h){for(ue(h<e,`Invalid index ${h}`);o.size-1<h;){const l=o.size;let y;switch(typeof s){case"function":{y=s(l,n);break}case"number":{y=s;break}}if(l===0)o.set(l,{size:y,scrollOffset:0});else{const t=o.get(l-1);ue(t!==void 0,`Unexpected bounds cache miss for index ${h}`),o.set(l,{scrollOffset:t.scrollOffset+t.size,size:y})}}const m=o.get(h);return ue(m!==void 0,`Unexpected bounds cache miss for index ${h}`),m},set(h,m){o.set(h,m)},get size(){return o.size}}}function Ft({itemCount:e,itemProps:n,itemSize:s}){return r.useMemo(()=>zt({itemCount:e,itemProps:n,itemSize:s}),[e,n,s])}function Ut({containerSize:e,itemSize:n}){let s;switch(typeof n){case"string":{ue(n.endsWith("%"),`Invalid item size: "${n}"; string values must be percentages (e.g. "100%")`),ue(e!==void 0,"Container size must be defined if a percentage item size is specified"),s=e*parseInt(n)/100;break}default:{s=n;break}}return s}function Me({containerElement:e,containerStyle:n,defaultContainerSize:s=0,direction:o,isRtl:h=!1,itemCount:m,itemProps:l,itemSize:y,onResize:t,overscanCount:p}){const{height:g=s,width:c=s}=It({defaultHeight:o==="vertical"?s:void 0,defaultWidth:o==="horizontal"?s:void 0,element:e,mode:o==="vertical"?"only-height":"only-width",style:n}),d=r.useRef({height:0,width:0}),x=o==="vertical"?g:c,u=Ut({containerSize:x,itemSize:y});r.useLayoutEffect(()=>{if(typeof t=="function"){const T=d.current;(T.height!==g||T.width!==c)&&(t({height:g,width:c},{...T}),T.height=g,T.width=c)}},[g,t,c]);const b=Ft({itemCount:m,itemProps:l,itemSize:u}),w=r.useCallback(T=>b.get(T),[b]),[f,E]=r.useState(()=>Ne({cachedBounds:b,containerScrollOffset:0,containerSize:x,itemCount:m,overscanCount:p})),{startIndexVisible:S,startIndexOverscan:C,stopIndexVisible:a,stopIndexOverscan:v}={startIndexVisible:Math.min(m-1,f.startIndexVisible),startIndexOverscan:Math.min(m-1,f.startIndexOverscan),stopIndexVisible:Math.min(m-1,f.stopIndexVisible),stopIndexOverscan:Math.min(m-1,f.stopIndexOverscan)},L=r.useCallback(()=>et({cachedBounds:b,itemCount:m,itemSize:u}),[b,m,u]),R=r.useCallback(T=>{const k=Pe({containerElement:e,direction:o,isRtl:h,scrollOffset:T});return Ne({cachedBounds:b,containerScrollOffset:k,containerSize:x,itemCount:m,overscanCount:p})},[b,e,x,o,h,m,p]);ke(()=>{const T=(o==="vertical"?e?.scrollTop:e?.scrollLeft)??0;E(R(T))},[e,o,R]),ke(()=>{if(!e)return;const T=()=>{E(k=>{const{scrollLeft:A,scrollTop:P}=e,N=Pe({containerElement:e,direction:o,isRtl:h,scrollOffset:o==="vertical"?P:A}),M=Ne({cachedBounds:b,containerScrollOffset:N,containerSize:x,itemCount:m,overscanCount:p});return Ce(M,k)?k:M})};return e.addEventListener("scroll",T),()=>{e.removeEventListener("scroll",T)}},[b,e,x,o,m,p]);const j=Qe(({align:T="auto",containerScrollOffset:k,index:A})=>{let P=Ot({align:T,cachedBounds:b,containerScrollOffset:k,containerSize:x,index:A,itemCount:m,itemSize:u});if(e){if(P=Pe({containerElement:e,direction:o,isRtl:h,scrollOffset:P}),typeof e.scrollTo!="function"){const N=R(P);Ce(f,N)||E(N)}return P}});return{getCellBounds:w,getEstimatedSize:L,scrollToIndex:j,startIndexOverscan:C,startIndexVisible:S,stopIndexOverscan:v,stopIndexVisible:a}}function tt(e){return r.useMemo(()=>e,Object.values(e))}function nt(e,n){const{ariaAttributes:s,style:o,...h}=e,{ariaAttributes:m,style:l,...y}=n;return Ce(s,m)&&Ce(o,l)&&Ce(h,y)}function Bt({cellComponent:e,cellProps:n,children:s,className:o,columnCount:h,columnWidth:m,defaultHeight:l=0,defaultWidth:y=0,dir:t,gridRef:p,onCellsRendered:g,onResize:c,overscanCount:d=3,rowCount:x,rowHeight:u,style:b,tagName:w="div",...f}){const E=tt(n),S=r.useMemo(()=>r.memo(e,nt),[e]),[C,a]=r.useState(null),v=Mt(C,t),{getCellBounds:L,getEstimatedSize:R,startIndexOverscan:j,startIndexVisible:T,scrollToIndex:k,stopIndexOverscan:A,stopIndexVisible:P}=Me({containerElement:C,containerStyle:b,defaultContainerSize:y,direction:"horizontal",isRtl:v,itemCount:h,itemProps:E,itemSize:m,onResize:c,overscanCount:d}),{getCellBounds:N,getEstimatedSize:M,startIndexOverscan:D,startIndexVisible:q,scrollToIndex:H,stopIndexOverscan:K,stopIndexVisible:_}=Me({containerElement:C,containerStyle:b,defaultContainerSize:l,direction:"vertical",itemCount:x,itemProps:E,itemSize:u,onResize:c,overscanCount:d});r.useImperativeHandle(p,()=>({get element(){return C},scrollToCell({behavior:X="auto",columnAlign:G="auto",columnIndex:re,rowAlign:te="auto",rowIndex:ne}){const le=k({align:G,containerScrollOffset:C?.scrollLeft??0,index:re}),he=H({align:te,containerScrollOffset:C?.scrollTop??0,index:ne});typeof C?.scrollTo=="function"&&C.scrollTo({behavior:X,left:le,top:he})},scrollToColumn({align:X="auto",behavior:G="auto",index:re}){const te=k({align:X,containerScrollOffset:C?.scrollLeft??0,index:re});typeof C?.scrollTo=="function"&&C.scrollTo({behavior:G,left:te})},scrollToRow({align:X="auto",behavior:G="auto",index:re}){const te=H({align:X,containerScrollOffset:C?.scrollTop??0,index:re});typeof C?.scrollTo=="function"&&C.scrollTo({behavior:G,top:te})}}),[C,k,H]),r.useEffect(()=>{j>=0&&A>=0&&D>=0&&K>=0&&g&&g({columnStartIndex:T,columnStopIndex:P,rowStartIndex:q,rowStopIndex:_},{columnStartIndex:j,columnStopIndex:A,rowStartIndex:D,rowStopIndex:K})},[g,j,T,A,P,D,q,K,_]);const ce=r.useMemo(()=>{const X=[];if(h>0&&x>0)for(let G=D;G<=K;G++){const re=N(G),te=[];for(let ne=j;ne<=A;ne++){const le=L(ne);te.push(r.createElement(S,{...E,ariaAttributes:{"aria-colindex":ne+1,role:"gridcell"},columnIndex:ne,key:ne,rowIndex:G,style:{position:"absolute",left:v?void 0:0,right:v?0:void 0,transform:`translate(${v?-le.scrollOffset:le.scrollOffset}px, ${re.scrollOffset}px)`,height:re.size,width:le.size}}))}X.push(i.jsx("div",{role:"row","aria-rowindex":G+1,children:te},G))}return X},[S,E,h,j,A,L,N,v,x,D,K]),ie=i.jsx("div",{"aria-hidden":!0,style:{height:M(),width:R(),zIndex:-1}});return r.createElement(w,{"aria-colcount":h,"aria-rowcount":x,role:"grid",...f,className:o,dir:t,ref:a,style:{position:"relative",maxHeight:"100%",maxWidth:"100%",flexGrow:1,overflow:"auto",...b}},ce,s,ie)}function Wt(e){return e!=null&&typeof e=="object"&&"getAverageRowHeight"in e&&typeof e.getAverageRowHeight=="function"}const Ie="data-react-window-index";function fn({children:e,className:n,defaultHeight:s=0,listRef:o,onResize:h,onRowsRendered:m,overscanCount:l=3,rowComponent:y,rowCount:t,rowHeight:p,rowProps:g,tagName:c="div",style:d,...x}){const u=tt(g),b=r.useMemo(()=>r.memo(y,nt),[y]),[w,f]=r.useState(null),E=Wt(p),S=r.useMemo(()=>E?P=>p.getRowHeight(P)??p.getAverageRowHeight():p,[E,p]),{getCellBounds:C,getEstimatedSize:a,scrollToIndex:v,startIndexOverscan:L,startIndexVisible:R,stopIndexOverscan:j,stopIndexVisible:T}=Me({containerElement:w,containerStyle:d,defaultContainerSize:s,direction:"vertical",itemCount:t,itemProps:u,itemSize:S,onResize:h,overscanCount:l});r.useImperativeHandle(o,()=>({get element(){return w},scrollToRow({align:P="auto",behavior:N="auto",index:M}){const D=v({align:P,containerScrollOffset:w?.scrollTop??0,index:M});typeof w?.scrollTo=="function"&&w.scrollTo({behavior:N,top:D})}}),[w,v]),ke(()=>{if(!w)return;const P=Array.from(w.children).filter((N,M)=>{if(N.hasAttribute("aria-hidden"))return!1;const D=`${L+M}`;return N.setAttribute(Ie,D),!0});if(E)return p.observeRowElements(P)},[w,E,p,L,j]),r.useEffect(()=>{L>=0&&j>=0&&m&&m({startIndex:R,stopIndex:T},{startIndex:L,stopIndex:j})},[m,L,R,j,T]);const k=r.useMemo(()=>{const P=[];if(t>0)for(let N=L;N<=j;N++){const M=C(N);P.push(r.createElement(b,{...u,ariaAttributes:{"aria-posinset":N+1,"aria-setsize":t,role:"listitem"},key:N,index:N,style:{position:"absolute",left:0,transform:`translateY(${M.scrollOffset}px)`,height:E?void 0:M.size,width:"100%"}}))}return P},[b,C,E,t,u,L,j]),A=i.jsx("div",{"aria-hidden":!0,style:{height:a(),width:"100%",zIndex:-1}});return r.createElement(c,{role:"list",...x,className:n,ref:f,style:{position:"relative",maxHeight:"100%",flexGrow:1,overflowY:"auto",...d}},k,e,A)}function hn({defaultRowHeight:e,key:n}){const[s,o]=r.useState({key:n,map:new Map});s.key!==n&&o({key:n,map:new Map});const{map:h}=s,m=r.useCallback(()=>{let c=0;return h.forEach(d=>{c+=d}),c===0?e:c/h.size},[e,h]),l=r.useCallback(c=>{const d=h.get(c);return d!==void 0?d:(h.set(c,e),e)},[e,h]),y=r.useCallback((c,d)=>{o(x=>{if(x.map.get(c)===d)return x;const u=new Map(x.map);return u.set(c,d),{...x,map:u}})},[]),t=Qe(c=>{c.length!==0&&c.forEach(d=>{const{borderBoxSize:x,target:u}=d,b=u.getAttribute(Ie);ue(b!==null,`Invalid ${Ie} attribute value`);const w=parseInt(b),{blockSize:f}=x[0];f&&y(w,f)})}),[p]=r.useState(()=>new ResizeObserver(t));r.useEffect(()=>()=>{p.disconnect()},[p]);const g=r.useCallback(c=>(c.forEach(d=>p.observe(d)),()=>{c.forEach(d=>p.unobserve(d))}),[p]);return r.useMemo(()=>({getAverageRowHeight:m,getRowHeight:l,setRowHeight:y,observeRowElements:g}),[m,l,y,g])}function Ue(e){try{const n=sessionStorage.getItem(e);return n?parseInt(n,10):0}catch{return 0}}function Be(e,n){try{sessionStorage.setItem(e,n.toString())}catch{}}function Ht(e,n){const s=He(),o=r.useRef(!1),h=n?`${s.pathname}:${n}`:s.pathname;r.useLayoutEffect(()=>{if(!e.current){const p=setTimeout(()=>{const g=e.current;if(g){const c=Ue(h);c>0&&(g.scrollTop=c)}},200);return()=>clearTimeout(p)}o.current=!0;const l=Ue(h);if(l<=0){o.current=!1;return}const y=(p=0)=>{const g=e.current;if(!g){p<30?setTimeout(()=>y(p+1),50):o.current=!1;return}const d=n==="table"?g.querySelector("tbody tr"):!0;if(!(g.scrollHeight>g.clientHeight)||!d){p<100?p<20?requestAnimationFrame(()=>y(p+1)):setTimeout(()=>y(p+1),50):o.current=!1;return}g.scrollTop=l,p<10?setTimeout(()=>{const u=g.scrollTop;Math.abs(u-l)>10?(g.scrollTop=l,y(p+1)):o.current=!1},100):o.current=!1},t=setTimeout(()=>{y()},150);return()=>{clearTimeout(t),o.current=!1}},[s.pathname,h,e,n]),r.useEffect(()=>{const m=e.current;if(!m)return;const l=()=>{if(o.current)return;const y=m.scrollTop;y>0&&Be(h,y)};return m.addEventListener("scroll",l,{passive:!0}),()=>{m.removeEventListener("scroll",l);const y=m.scrollTop;y>0&&!o.current&&Be(h,y)}},[s.pathname,h,e,n])}function We(e){return e?e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g,"").trim():""}function Gt(e,n){const s=We(e||""),o=We(n||"");return s.localeCompare(o)}function _t({games:e,scrollContainerRef:n,itemRefs:s,ascending:o=!0,virtualizedGridRef:h,virtualizedListRef:m,viewMode:l,coverSize:y}){const[t,p]=r.useState(!1);r.useEffect(()=>{const u=()=>{const S=n.current;if(!S){p(!1);return}requestAnimationFrame(()=>{if(!S){p(!1);return}const C=S,a=C.__virtualizedGridRef?.current,v=C.__virtualizedListRef?.current;if(h?.current||m?.current||a||v){p(e.length>10);return}const R=S.scrollHeight>S.clientHeight;p(R)})};u();const b=setTimeout(u,100),w=setTimeout(u,300),f=setTimeout(u,500),E=setTimeout(u,1e3);if(window.addEventListener("resize",u),n.current){const S=new ResizeObserver(()=>{setTimeout(u,50)});S.observe(n.current);const C=new MutationObserver(()=>{setTimeout(u,50)});return C.observe(n.current,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),()=>{clearTimeout(b),clearTimeout(w),clearTimeout(f),clearTimeout(E),window.removeEventListener("resize",u),S.disconnect(),C.disconnect()}}return()=>{clearTimeout(b),clearTimeout(w),clearTimeout(f),clearTimeout(E),window.removeEventListener("resize",u)}},[e,n,h,m]);const g=o?["#",..."ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("")]:[..."ZYXWVUTSRQPONMLKJIHGFEDCBA".split(""),"#"],c=u=>{const b=u.trim().charAt(0).toUpperCase();if(/[A-Z]/.test(b))return b;if(/[0-9]/.test(b))return"#";{const w=u.match(/[A-Z]/i);return w?w[0].toUpperCase():"#"}},d=u=>e.some(b=>c(b.title)===u),x=u=>{const b=n.current;if(!b)return;const w=e.findIndex(T=>c(T.title)===u);if(w===-1)return;const f=e[w],E=b,S=E.__virtualizedGridRef?.current,C=E.__virtualizedListRef?.current,a=h?.current||S,v=m?.current||C;if(a&&l==="grid"){const T=a;if(T&&typeof T.scrollToCell=="function"){const k=b.clientWidth,A=(y||150)+40,P=Math.max(1,Math.floor((k+40)/A)),N=Math.floor(w/P),M=w%P;T.scrollToCell({rowIndex:N,columnIndex:M,align:"start",behavior:"smooth"});return}}if(v&&(l==="detail"||l==="table")){const T=v;if(T&&typeof T.scrollToRow=="function"){T.scrollToRow({index:w,align:"start",behavior:"smooth"});return}}if(s?.current){const T=s.current.get(f.id);if(T){const k=b.getBoundingClientRect(),A=T.getBoundingClientRect(),P=b.querySelector("thead"),N=P?P.offsetHeight:0,M=N>0?N+4:20,D=b.scrollTop+A.top-k.top-M;b.scrollTo({top:D,behavior:"smooth"});return}}const L=Math.floor(b.clientWidth/200),j=Math.floor(w/L)*200;b.scrollTo({top:j,behavior:"smooth"})};return!t||e.length===0?null:i.jsx("div",{className:"home-page-alphabet-container",children:i.jsx("div",{className:"alphabet-navigator",children:g.map(u=>{const b=d(u);return i.jsx("button",{onClick:()=>x(u),disabled:!b,className:"alphabet-button",children:u},u)})})})}function qt(e){try{const n=sessionStorage.getItem(e);if(!n)return null;const s=JSON.parse(n);return{scrollTop:s.scrollTop||0,scrollLeft:s.scrollLeft||0}}catch{return null}}function Kt(e,n,s){try{sessionStorage.setItem(e,JSON.stringify({scrollTop:n,scrollLeft:s}))}catch{}}const me=40,Vt=2;function Xt({collections:e,coverSize:n,containerRef:s,itemRefs:o,onCollectionClick:h,onPlay:m,onEditClick:l,onCollectionDelete:y,onCollectionUpdate:t,gamesPath:p="collections",buildCoverUrl:g}){const c=He(),[d,x]=r.useState({width:0,height:0}),[u,b]=r.useState(!1),w=r.useRef(null),f=r.useRef(!1),E=r.useRef(null),S=`${c.pathname}:collections`,C=r.useMemo(()=>{if(d.width===0)return 1;const j=n+me;return Math.max(1,Math.floor((d.width+me)/j))},[d.width,n]),a=r.useMemo(()=>Math.ceil(e.length/C),[e.length,C]),v=n,L=n*1.5+me;r.useEffect(()=>{const j=()=>{if(s.current){const k=s.current.getBoundingClientRect();x({width:k.width-40,height:k.height||window.innerHeight-200})}};j(),window.addEventListener("resize",j);const T=new ResizeObserver(j);return s.current&&T.observe(s.current),()=>{window.removeEventListener("resize",j),T.disconnect()}},[s]),r.useEffect(()=>{const j=qt(S);if(!j||j.scrollTop===0&&j.scrollLeft===0){b(!0);return}if(d.height===0||a===0||C===0)return;f.current=!0,b(!1);const T=(A=0)=>{const P=w.current;if(!P){A<50?setTimeout(()=>T(A+1),50):f.current=!1;return}let N=null;if(P.element)N=P.element;else if(s.current){const M=s.current.querySelector('[style*="overflow"]');M&&(M.scrollHeight>M.clientHeight||M.scrollWidth>M.clientWidth)&&(N=M)}if(!N){A<50?setTimeout(()=>T(A+1),50):(f.current=!1,b(!0));return}try{N.scrollTop=j.scrollTop,N.scrollLeft=j.scrollLeft,setTimeout(()=>{const M=N.scrollTop,D=N.scrollLeft;(Math.abs(M-j.scrollTop)>10||Math.abs(D-j.scrollLeft)>10)&&A<5&&(N.scrollTop=j.scrollTop,N.scrollLeft=j.scrollLeft),setTimeout(()=>{f.current=!1,b(!0)},50)},50)}catch{A<10?setTimeout(()=>T(A+1),100):(f.current=!1,b(!0))}},k=setTimeout(()=>{T()},300);return()=>{clearTimeout(k),f.current=!1}},[c.pathname,S,d.height,a,C]),r.useEffect(()=>{let j=null,T=null;const k=(A=0)=>{const P=w.current;if(!P){A<20&&setTimeout(()=>k(A+1),100);return}let N=null;if(P.element)N=P.element;else if(s.current){const D=s.current.querySelector('[style*="overflow"]');D&&(D.scrollHeight>D.clientHeight||D.scrollWidth>D.clientWidth)&&(N=D)}if(!N){A<20&&setTimeout(()=>k(A+1),100);return}const M=()=>{f.current||(j&&clearTimeout(j),j=setTimeout(()=>{const D=N.scrollTop,q=N.scrollLeft;(!E.current||E.current.scrollTop!==D||E.current.scrollLeft!==q)&&(Kt(S,D,q),E.current={scrollTop:D,scrollLeft:q})},150))};N.addEventListener("scroll",M,{passive:!0}),T=()=>{j&&clearTimeout(j),N.removeEventListener("scroll",M)}};return k(),()=>{T&&T()}},[w.current,S,L,v,a,C]),r.useEffect(()=>{s&&"current"in s&&s.current&&(s.current.__virtualizedGridRef=w)},[s]);const R=({columnIndex:j,rowIndex:T,style:k})=>{const A=T*C+j;if(A>=e.length)return i.jsx("div",{style:k});const P=e[A];return i.jsx("div",{style:{...k,paddingLeft:j===0?0:me/2,paddingRight:j===C-1?0:me/2,paddingTop:T===0?0:me/2,paddingBottom:T===a-1?0:me/2},children:i.jsx(ot,{collection:P,onCollectionClick:h,onPlay:m,onEditClick:l,onCollectionDelete:y,onCollectionUpdate:t,gamesPath:p,buildCoverUrl:g,coverSize:n,itemRefs:o})})};return d.width===0||d.height===0?i.jsx("div",{style:{width:"100%",height:"100%"}}):i.jsx("div",{style:{opacity:u?1:0,transition:u?"opacity 0.1s":"none"},children:i.jsx(Bt,{gridRef:w,className:"virtualized-collections-grid",columnCount:C,columnWidth:v+me,defaultHeight:d.height,defaultWidth:d.width,rowCount:a,rowHeight:L,overscanCount:Vt,cellComponent:R,cellProps:{},style:{height:d.height,width:d.width},onResize:j=>{x({width:j.width,height:j.height})}})})}const Jt=100;function ot({collection:e,onCollectionClick:n,onPlay:s,onEditClick:o,onCollectionDelete:h,onCollectionUpdate:m,gamesPath:l="collections",buildCoverUrl:y,coverSize:t,itemRefs:p}){const{t:g}=oe(),c=t*1.5,{hasPlayableGame:d}=Nt(e.id,l==="collections"),x=async()=>{if(s)try{const u=U(z,`/${l}/${e.id}/games`),b=await fetch(u,{headers:{Accept:"application/json","X-Auth-Token":W()}});if(b.ok){const E=((await b.json()).games||[]).find(S=>S.executables&&S.executables.length>0);if(E){const S={id:E.id,title:E.title,summary:E.summary||"",cover:E.cover,day:E.day||null,month:E.month||null,year:E.year||null,stars:E.stars||null,genre:E.genre||null,executables:E.executables||null};s(S)}}}catch(u){console.error("Error fetching collection games for play:",u)}};return i.jsx("div",{ref:u=>{u&&p?.current&&p.current.set(String(e.id),u)},className:"group cursor-pointer collections-list-item",style:{width:`${t}px`,minWidth:`${t}px`},children:i.jsx(De,{title:e.title,coverUrl:y(z,e.cover,!0),width:t,height:c,onPlay:s?x:void 0,onClick:()=>n(e),onEdit:o?()=>o(e):void 0,collectionId:l==="collections"?e.id:void 0,developerId:l==="developers"?e.id:void 0,publisherId:l==="publishers"?e.id:void 0,collectionTitle:e.title,onCollectionDelete:h?u=>{String(e.id)===String(u)&&h(e)}:void 0,onCollectionUpdate:m?u=>{const b={id:u.id,title:u.title,summary:u.summary,cover:u.cover,gameCount:e.gameCount};b.id===e.id&&m(b)}:void 0,showTitle:e.showTitle!==!1,subtitle:e.gameCount!==void 0?`${e.gameCount} ${g("common.elements")}`:void 0,detail:!0,play:l==="collections"?d===!0:!1,showBorder:!0},`${e.id}-${e.cover}`)})}function Yt({collections:e,onCollectionClick:n,onPlay:s,onCollectionUpdate:o,onCollectionDelete:h,isLoading:m=!1,showEdit:l=!0,gamesPath:y="collections",buildCoverUrl:t,coverSize:p=150,itemRefs:g,scrollContainerRef:c}){const{t:d}=oe(),[x,u]=r.useState(!1),[b,w]=r.useState(null),f=r.useRef(null);if(m&&e.length===0)return null;if(!m&&e.length===0){const v=y==="developers"?"igdbInfo.noDevelopersFound":y==="publishers"?"igdbInfo.noPublishersFound":"collections.noCollectionsFound";return i.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",minHeight:"400px"},children:i.jsx("div",{className:"text-gray-400 text-center",children:d(v)})})}const E=v=>{if(!l)return;const L={id:v.id,title:v.title,summary:v.summary,cover:v.cover,background:v.background,showTitle:v.showTitle!==!1};w(L),u(!0)},S=()=>{u(!1),w(null)},C=v=>{if(o){const L={id:v.id,title:v.title,summary:v.summary,cover:v.cover,background:v.background,showTitle:v.showTitle!==!1};o(L)}S()},a=e.length>Jt;return i.jsxs(i.Fragment,{children:[i.jsx("div",{ref:f,className:"collections-list-container",style:{gridTemplateColumns:a?void 0:`repeat(auto-fill, ${p}px)`,height:a?"100%":void 0},children:a?i.jsx(Xt,{collections:e,coverSize:p,containerRef:c||f,itemRefs:g,onCollectionClick:n,onPlay:s,onEditClick:l?E:void 0,onCollectionDelete:h,onCollectionUpdate:o,gamesPath:y,buildCoverUrl:t}):e.map(v=>i.jsx(ot,{collection:v,onCollectionClick:n,onPlay:s,onEditClick:l?E:void 0,onCollectionDelete:h,onCollectionUpdate:o,gamesPath:y,buildCoverUrl:t,coverSize:p,itemRefs:g},String(v.id)))}),b&&i.jsx(At,{isOpen:x,onClose:S,resourceType:y,item:b,onItemUpdate:C})]})}function gn({onPlay:e,coverSize:n}){const{setLoading:s}=ae(),{collections:o,isLoading:h,updateCollection:m,removeCollection:l}=xe(),y=rt(),[t,p]=r.useState(!1),[g]=r.useState(!0),c=r.useRef(null),d=r.useRef(new Map);r.useEffect(()=>{s(h||!t)},[h,t,s]),Ht(c);function x(f){y(`/collections/${f.id}`)}const u=f=>{m(f)},b=f=>{l(f.id)},w=r.useMemo(()=>{const E=[...o.filter((S,C,a)=>C===a.findIndex(v=>String(v.id)===String(S.id)))];return E.sort((S,C)=>{const a=Gt(S.title||"",C.title||"");return g?a:-a}),E},[o,g]);return r.useLayoutEffect(()=>{h?h&&p(!1):requestAnimationFrame(()=>{requestAnimationFrame(()=>{p(!0)})})},[h,w.length]),i.jsx("main",{className:"flex-1 home-page-content",children:i.jsxs("div",{className:"home-page-layout",children:[i.jsx("div",{className:"home-page-content-wrapper",style:{opacity:t?1:0,transition:"opacity 0.2s ease-in-out"},children:i.jsx("div",{ref:c,className:"home-page-scroll-container",children:i.jsx(Yt,{collections:w,onCollectionClick:x,onPlay:e,isLoading:h,onCollectionUpdate:u,onCollectionDelete:b,buildCoverUrl:mt,coverSize:n,itemRefs:d,scrollContainerRef:c})})}),t&&i.jsx(_t,{games:w,scrollContainerRef:c,itemRefs:d,ascending:g,virtualizedGridRef:c.current?c.current.__virtualizedGridRef:void 0,viewMode:"grid",coverSize:n})]})})}export{_t as A,mn as B,Yt as C,Ct as D,Bt as E,sn as L,un as P,Xe as T,kt as a,Ht as b,Gt as c,mt as d,ye as e,gn as f,Te as g,U as h,Pt as i,St as j,ln as k,De as l,on as m,xe as n,nn as o,At as p,fn as q,Tt as r,Lt as s,hn as t,ae as u,Nt as v,rn as w,an as x,cn as y,dn as z};
