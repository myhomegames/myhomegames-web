import{r as n,j as m,u as P}from"./react-vendor-LH__evd4.js";import{b as T,C as R,u as N,c as U,d as M}from"./page-CategoriesPage.tsx-D4YrERN0.js";import{A as x,g as b,u as E}from"./page-AddGamePage.tsx-D9wmbn1s.js";import{E as G}from"./page-CollectionDetail.tsx-BLxkLwz3.js";import{u as L}from"./i18n-vendor-CVN1UYbd.js";import{c as D,A as F}from"./page-CategoryPage.tsx-mOSdKYyA.js";function O(e,y=!0){const[r,a]=n.useState(null),[c,g]=n.useState(!1);return n.useEffect(()=>{if(!y||!e){a(null),g(!1);return}g(!0),(async()=>{try{const u=T(x,`/collections/${e}/games`),f=await fetch(u,{headers:{Accept:"application/json","X-Auth-Token":b()}});if(f.ok){const p=((await f.json()).games||[]).some(s=>!!s.command);a(p)}else a(!1)}catch{a(!1)}finally{g(!1)}})()},[e,y]),{hasPlayableGame:r,isLoading:c}}const _=n.createContext(void 0),I="changeme";function Z({children:e}){const[y,r]=n.useState(null),[a,c]=n.useState(null),[g,h]=n.useState(!0),u=async()=>{h(!0);try{const s=new URLSearchParams(window.location.search),t=s.get("twitch_token"),d=s.get("user_id");if(t&&d){localStorage.setItem("twitch_token",t),localStorage.setItem("twitch_user_id",d),window.history.replaceState({},document.title,window.location.pathname),await f(t),E();return}const j=localStorage.getItem("twitch_token");if(j){await f(j),E();return}if(I&&I!==""){c(I),r({userId:"dev",userName:"Development User",userImage:null,isDev:!0}),E();return}r(null),c(null)}catch(s){console.error("Auth check error:",s),r(null),c(null)}finally{h(!1)}},f=async s=>{try{const t=await fetch(`${x}/auth/me`,{headers:{"X-Auth-Token":s}});if(t.ok){const d=await t.json();r(d),c(s)}else localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),r(null),c(null)}catch(t){console.error("Failed to fetch user info:",t),r(null),c(null)}},k=async()=>{try{const s=await fetch(`${x}/auth/twitch`);if(s.ok){const t=await s.json();window.location.href=t.authUrl}else console.error("Failed to initiate login")}catch(s){console.error("Login error:",s)}},w=()=>{localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),r(null),c(null),E(),a&&fetch(`${x}/auth/logout`,{method:"POST",headers:{"X-Auth-Token":a}}).catch(console.error)};n.useEffect(()=>{u()},[]);const p={user:y,token:a,isLoading:g,login:k,logout:w,checkAuth:u};return m.jsx(_.Provider,{value:p,children:e})}function X(){const e=n.useContext(_);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e}function H({collection:e,onCollectionClick:y,onPlay:r,onEditClick:a,onCollectionDelete:c,onCollectionUpdate:g,buildCoverUrl:h,coverSize:u,itemRefs:f}){const{t:k}=L(),w=u*1.5,{hasPlayableGame:p}=O(e.id,!0),s=async()=>{if(r)try{const t=T(x,`/collections/${e.id}/games`),d=await fetch(t,{headers:{Accept:"application/json","X-Auth-Token":b()}});if(d.ok){const i=((await d.json()).games||[]).find(o=>!!o.command);if(i){const o={id:i.id,title:i.title,summary:i.summary||"",cover:i.cover,day:i.day||null,month:i.month||null,year:i.year||null,stars:i.stars||null,genre:i.genre||null,command:i.command||null};r(o)}}}catch(t){console.error("Error fetching collection games for play:",t)}};return m.jsx("div",{ref:t=>{t&&f?.current&&f.current.set(e.id,t)},className:"group cursor-pointer collections-list-item",style:{width:`${u}px`,minWidth:`${u}px`},children:m.jsx(R,{title:e.title,coverUrl:h(x,e.cover,!0),width:u,height:w,onPlay:r?s:void 0,onClick:()=>y(e),onEdit:()=>a(e),collectionId:e.id,collectionTitle:e.title,onCollectionDelete:c?t=>{e.id===t&&c(e)}:void 0,onCollectionUpdate:g?t=>{const d={id:t.id,title:t.title,summary:t.summary,cover:t.cover,gameCount:e.gameCount};d.id===e.id&&g(d)}:void 0,showTitle:!0,subtitle:e.gameCount!==void 0?`${e.gameCount} ${k("common.elements")}`:void 0,detail:!0,play:p===!0,showBorder:!0},`${e.id}-${e.cover}`)},e.id)}function q({collections:e,onCollectionClick:y,onPlay:r,onCollectionUpdate:a,onCollectionDelete:c,buildCoverUrl:g,coverSize:h=150,itemRefs:u}){const{t:f}=L(),[k,w]=n.useState(!1),[p,s]=n.useState(null);if(e.length===0)return m.jsx("div",{className:"text-gray-400 text-center",children:f("table.noGames")});const t=l=>{const i={id:l.id,title:l.title,summary:l.summary,cover:l.cover,background:l.background};s(i),w(!0)},d=()=>{w(!1),s(null)},j=l=>{if(a){const i={id:l.id,title:l.title,summary:l.summary,cover:l.cover,background:l.background};a(i)}d()};return m.jsxs(m.Fragment,{children:[m.jsx("div",{className:"collections-list-container",style:{gridTemplateColumns:`repeat(auto-fill, ${h}px)`},children:e.map(l=>m.jsx(H,{collection:l,onCollectionClick:y,onPlay:r,onEditClick:t,onCollectionDelete:c,onCollectionUpdate:a,buildCoverUrl:g,coverSize:h,itemRefs:u},l.id))}),p&&m.jsx(G,{isOpen:k,onClose:d,collection:p,onCollectionUpdate:j})]})}function z({onPlay:e,coverSize:y}){const{setLoading:r,isLoading:a}=N(),{isLoading:c}=X(),g=P(),[h,u]=n.useState([]),[f,k]=n.useState(!1),[w]=n.useState(!0),p=n.useRef(null),s=n.useRef(new Map);U(p),n.useEffect(()=>{c||t()},[c]),n.useEffect(()=>{const o=()=>{t()};return window.addEventListener("metadataReloaded",o),()=>{window.removeEventListener("metadataReloaded",o)}},[]),n.useLayoutEffect(()=>{!a&&h.length>0?requestAnimationFrame(()=>{requestAnimationFrame(()=>{k(!0)})}):a&&k(!1)},[a,h.length]);async function t(){r(!0);try{const o=b(),C=T(x,"/collections"),v=await fetch(C,{headers:{Accept:"application/json","X-Auth-Token":o}});if(!v.ok)throw new Error(`HTTP ${v.status}`);const $=((await v.json()).collections||[]).map(A=>({id:A.id,title:A.title,summary:A.summary,cover:A.cover,background:A.background,gameCount:A.gameCount}));u($)}catch(o){const C=String(o.message||o);console.error("Error fetching collections:",C)}finally{r(!1)}}function d(o){g(`/collections/${o.id}`)}const j=o=>{u(C=>C.map(v=>String(v.id)===String(o.id)?o:v)),window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collection:o}}))},l=o=>{u(C=>C.filter(v=>v.id!==o.id))},i=n.useMemo(()=>{const o=[...h];return o.sort((C,v)=>{const S=D(C.title||"",v.title||"");return w?S:-S}),o},[h,w]);return m.jsx("main",{className:"flex-1 home-page-content",children:m.jsxs("div",{className:"home-page-layout",children:[m.jsx("div",{className:"home-page-content-wrapper",style:{opacity:f?1:0,transition:"opacity 0.2s ease-in-out"},children:m.jsx("div",{ref:p,className:"home-page-scroll-container",children:!a&&m.jsx(q,{collections:i,onCollectionClick:d,onPlay:e,onCollectionUpdate:j,onCollectionDelete:l,buildCoverUrl:M,coverSize:y,itemRefs:s})})}),f&&m.jsx(F,{games:i,scrollContainerRef:p,itemRefs:s,ascending:w})]})})}export{Z as A,z as C,O as a,X as u};
