import{j as g,r as u,c as _,L as Q}from"./react-vendor-jNdKP8wU.js";import{d as Y,u as O,b as V,h as J,e as Z}from"./page-CollectionsPage.tsx-DjVo-48O.js";import{u as F}from"./i18n-vendor-mPXi0JFR.js";import{G as ee}from"./page-LibraryItemDetailPage.tsx-C5nrov_b.js";import{A as te}from"./page-AddGamePage.tsx-CGFUTWrs.js";function B({canScrollLeft:e,canScrollRight:r,onScrollToFirst:a,onScrollToLast:l}){return g.jsxs("div",{className:"scrollable-section-nav",children:[g.jsx("button",{className:`scrollable-section-nav-button ${e?"":"scrollable-section-nav-button-hidden"}`,onClick:a,"aria-label":"Scroll to beginning",children:g.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:g.jsx("path",{d:"M15 18l-6-6 6-6",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}),g.jsx("button",{className:`scrollable-section-nav-button ${r?"":"scrollable-section-nav-button-hidden"}`,onClick:l,"aria-label":"Scroll to end",children:g.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:g.jsx("path",{d:"M9 6l6 6-6 6",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]})}const C=new Map,P=[];let W=!1;const ne=500,X={it:"it",fr:"fr",es:"es",de:"de",pt:"pt",ja:"ja",zh:"zh",en:"en"};function re(e,r,a={}){const{t:l,i18n:c}=F(),[i,h]=u.useState(e),d=u.useRef(!1);return u.useEffect(()=>{if(a.disabled){h(e);return}const m=l(r,{defaultValue:"$$$$MISSING$$$$"});if(m!=="$$$$MISSING$$$$"&&m!==r&&m!==e){h(m);return}if(c.language==="en"){h(v(e));return}const w=`${e}-${c.language}`;if(C.has(w)){h(C.get(w));return}if(d.current)return;d.current=!0,(async()=>new Promise((n,s)=>{P.push({text:e,targetLang:c.language,cacheKey:w,resolve:n,reject:s}),oe()}))().then(n=>{h(n),d.current=!1}).catch(n=>{console.error(`Error translating "${e}":`,n),h(e),d.current=!1})},[e,r,l,c.language,a.disabled]),i}function se(e,r={}){const{t:a,i18n:l}=F(),[c,i]=u.useState(()=>{const d={};return e.forEach(m=>{d[m.id]=v(m.text)}),d}),h=u.useRef("");return u.useEffect(()=>{if(r.disabled||e.length===0){const n={};e.forEach(s=>{n[s.id]=v(s.text)}),i(n);return}const d={},m=[];for(const n of e){const s=a(n.translationKey,{defaultValue:"$$$$MISSING$$$$"});if(s!=="$$$$MISSING$$$$"&&s!==n.translationKey&&s!==n.text){d[n.id]=s;continue}if(l.language==="en"){d[n.id]=v(n.text);continue}const p=`${n.text}-${l.language}`;if(C.has(p)){d[n.id]=C.get(p);continue}m.push(n)}if(m.length===0){i(d);return}const w=X[l.language]||l.language;if(!w||w==="en"){m.forEach(n=>{d[n.id]=v(n.text)}),i(d);return}const y=`${l.language}:${e.map(n=>n.id).sort().join(",")}`;if(h.current===y){i(d);return}h.current=y,i(d),ae(m.map(n=>n.text),w).then(n=>{const s={};m.forEach((p,A)=>{const k=n[A],T=v(k||p.text),N=`${p.text}-${l.language}`;C.set(N,T),s[p.id]=T}),i(p=>({...p,...s}))}).catch(()=>{const n={};m.forEach(s=>{n[s.id]=v(s.text)}),i(s=>({...s,...n}))})},[e,a,l.language,r.disabled]),c}function v(e){if(!e||typeof e!="string")return e;const r=e.replace(/-/g," ").trim();if(!r)return r;const a=r.toLowerCase();return a.charAt(0).toUpperCase()+a.slice(1)}const K=`
`;async function I(e,r){try{const a=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${r}&dt=t&q=${encodeURIComponent(e)}`,l=await fetch(a,{method:"GET",headers:{Accept:"application/json","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}});if(!l.ok)return null;const c=await l.json();if(Array.isArray(c)&&c[0]&&Array.isArray(c[0])){const i=c[0].map(h=>h&&h[0]).filter(Boolean);if(i.length>0)return i.join("")}return null}catch{return null}}async function ae(e,r){if(e.length===0)return[];if(e.length===1)return[await I(e[0],r)];try{const a=e.join(K),l=await I(a,r);if(!l)return e.map(()=>null);const c=l.split(K).map(i=>i.trim());return c.length!==e.length?e.map(()=>null):c}catch{return e.map(()=>null)}}async function oe(){if(!(W||P.length===0)){for(W=!0;P.length>0;){const e=P.shift();if(!e)break;try{P.length>0&&await new Promise(c=>setTimeout(c,ne));const r=X[e.targetLang]||e.targetLang;if(!r||r==="en"){e.resolve(e.text);return}let a=3,l=null;for(;a>0;)try{const c=await I(e.text,r);if(c){const i=v(c);C.set(e.cacheKey,i),e.resolve(i);break}else{e.resolve(e.text);break}}catch(c){if(l=c,a--,a>0){const i=Math.pow(2,3-a)*1e3;await new Promise(h=>setTimeout(h,i))}}a===0&&l&&e.resolve(e.text)}catch(r){console.error("[useAutoTranslate] Error processing translation queue:",r),e.resolve(e.text)}}W=!1}}function le(e){try{const r=sessionStorage.getItem(e);return r?parseInt(r,10):0}catch{return 0}}function z(e,r){try{sessionStorage.setItem(e,r.toString())}catch{}}function ce({sectionId:e,games:r,onGameClick:a,onPlay:l,onGameUpdate:c,coverSize:i,allCollections:h=[],titleOverride:d,titleHref:m,disableAutoTranslate:w=!1,showTitle:y=!0}){const n=_(),s=u.useRef(null),p=`${n.pathname}:${e}`,[A,k]=u.useState(!1),[T,N]=u.useState(!1),[o,b]=u.useState(!0),x=`recommended.${e}`,$=re(e,x,{disabled:w}),M=d||(w?e:$),E=()=>{const t=s.current;if(!t)return;const f=t.scrollLeft,j=t.scrollWidth-t.clientWidth;k(f>0),N(f<j-1)},L=()=>{s.current?.scrollTo({left:0,behavior:"smooth"})},G=()=>{const t=s.current;if(t){const f=t.scrollWidth-t.clientWidth;t.scrollTo({left:f,behavior:"smooth"})}};return u.useEffect(()=>{const t=s.current;if(!t)return;b(!0);const f=le(p);if(f<=0){b(!1);return}const j=(R=0)=>{if(!t){b(!1);return}if(t.scrollWidth<=t.clientWidth){R<20?requestAnimationFrame(()=>j(R+1)):b(!1);return}t.scrollLeft=f,E(),b(!1)},S=setTimeout(()=>{j()},100);return()=>{clearTimeout(S),b(!1)}},[n.pathname,e,p,r.length]),u.useEffect(()=>{const t=s.current;if(!t)return;const f=()=>{o||z(p,t.scrollLeft),E()},j=S=>{const R=t.getBoundingClientRect();if(!(S.clientX>=R.left&&S.clientX<=R.right&&S.clientY>=R.top&&S.clientY<=R.bottom)||!(t.scrollWidth>t.clientWidth))return;if(Math.abs(S.deltaX)>Math.abs(S.deltaY)||Math.abs(S.deltaX)>0){S.preventDefault(),S.stopPropagation();const U=t.scrollLeft,q=t.scrollWidth-t.clientWidth,H=U>0&&S.deltaX<0,D=U<q&&S.deltaX>0;(H||D)&&(t.scrollLeft+=S.deltaX)}};return t.addEventListener("scroll",f,{passive:!0}),t.addEventListener("wheel",j,{passive:!1,capture:!0}),()=>{t.removeEventListener("scroll",f),t.removeEventListener("wheel",j);const S=t.scrollLeft;S>0&&!o&&z(p,S)}},[e,p,o]),u.useEffect(()=>{E();const t=setTimeout(E,200);return()=>clearTimeout(t)},[r.length]),r.length===0?null:g.jsxs("div",{className:"scrollable-section",children:[y&&g.jsxs("div",{className:"scrollable-section-header",children:[g.jsx("h2",{className:"scrollable-section-title",children:m?g.jsx(Q,{to:m,className:"scrollable-section-title-link",children:M}):M}),g.jsx(B,{canScrollLeft:A,canScrollRight:T,onScrollToFirst:L,onScrollToLast:G})]}),!y&&g.jsx(B,{canScrollLeft:A,canScrollRight:T,onScrollToFirst:L,onScrollToLast:G}),g.jsx("div",{ref:s,className:`scrollable-section-scroll ${o?"restoring":""}`,children:g.jsx(ee,{games:r,onGameClick:a,onPlay:l,onGameUpdate:c,buildCoverUrl:Y,coverSize:i,allCollections:h,enableVirtualization:!1})})]})}function Se({onGameClick:e,onGamesLoaded:r,onPlay:a,coverSize:l,allCollections:c=[]}){const{setLoading:i}=O(),[h,d]=u.useState([]),[m,w]=u.useState(!1),[y,n]=u.useState(!1),s=u.useRef(null),p=u.useRef(!1);V(s);const A=o=>{d(b=>b.map(x=>({...x,games:x.games.map($=>String($.id)===String(o.id)?o:$)}))),window.dispatchEvent(new CustomEvent("gameUpdated",{detail:{game:o}}))};u.useEffect(()=>{const o=b=>{const $=b.detail?.game;$&&d(M=>M.map(E=>({...E,games:E.games.map(L=>String(L.id)===String($.id)?$:L)})))};return window.addEventListener("gameUpdated",o),()=>{window.removeEventListener("gameUpdated",o)}},[]),u.useEffect(()=>{N()},[]),u.useEffect(()=>{const o=()=>{N()};return window.addEventListener("metadataReloaded",o),()=>{window.removeEventListener("metadataReloaded",o)}},[]),u.useLayoutEffect(()=>{y?y&&w(!1):requestAnimationFrame(()=>{requestAnimationFrame(()=>{w(!0)})})},[y,h.length]),u.useEffect(()=>{i(y||!m)},[y,m,i]);const k=u.useMemo(()=>h.map(o=>({id:o.id,text:o.id,translationKey:`recommended.${o.id}`})),[h]),T=se(k);async function N(){if(p.current)return;p.current=!0,n(!0),i(!0);const o=new AbortController,b=setTimeout(()=>o.abort(),9e4);try{const x=J(te,"/recommended"),$=await fetch(x,{headers:Z({Accept:"application/json"}),signal:o.signal});if(clearTimeout(b),!$.ok)throw new Error(`HTTP ${$.status}`);const L=((await $.json()).sections||[]).map(t=>({id:t.id,games:(t.games||[]).map(f=>({id:f.id,title:f.title,summary:f.summary,cover:f.cover,background:f.background,day:f.day,month:f.month,year:f.year,stars:f.stars,genre:f.genre,executables:f.executables||null}))}));d(L);const G=L.flatMap(t=>t.games);r(G)}catch(x){clearTimeout(b);const $=x?.name==="AbortError"?"Request timed out":String(x.message||x);console.error("Error fetching recommended sections:",$)}finally{clearTimeout(b),n(!1),p.current=!1}}return g.jsx("main",{className:"flex-1 home-page-content",children:g.jsx("div",{className:"home-page-layout",children:g.jsx("div",{className:"home-page-content-wrapper",style:{opacity:m?1:0,transition:"opacity 0.2s ease-in-out"},children:g.jsx("div",{ref:s,className:"home-page-scroll-container",style:{paddingTop:"16px",paddingBottom:"32px"},children:!y&&h.map(o=>g.jsx(ce,{sectionId:o.id,titleOverride:T[o.id],disableAutoTranslate:!0,games:o.games,onGameClick:e,onPlay:a,onGameUpdate:A,coverSize:l,allCollections:c},o.id))})})})})}export{Se as R,ce as S};
