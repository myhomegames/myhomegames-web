import{r,j as t,b as Ce,c as st,d as jt}from"./react-vendor-jNdKP8wU.js";import{g as se,a as St,A as H,u as Ye,b as Ae}from"./page-AddGamePage.tsx-CGFUTWrs.js";import{u as ge}from"./i18n-vendor-mPXi0JFR.js";/* empty css                                  */function _(e,o,n={}){const d=new URL(o,e);return Object.entries(n).forEach(([i,l])=>d.searchParams.set(i,String(l))),d.toString()}function Be(e={}){const o=se(),n={...e};if(o){n["X-Auth-Token"]=o;const d=St();d&&(n["X-Twitch-Client-Id"]=d)}return n}function Qe(e,o,n){if(!o)return"";if(o.startsWith("http://")||o.startsWith("https://"))return o;if(o.includes("?t=")||o.includes("&t=")){const l=o.split("?")[0],a=o.includes("?")?o.substring(o.indexOf("?")):"",f=new URL(l,e);return a&&new URLSearchParams(a).forEach((m,u)=>{f.searchParams.set(u,m)}),f.toString()}const i=new URL(o,e);return n&&i.searchParams.set("t",Date.now().toString()),i.toString()}function Et(e,o,n){if(!o)return"";if(o.startsWith("http://")||o.startsWith("https://"))return o;if(o.includes("?t=")||o.includes("&t=")){const l=o.split("?")[0],a=o.includes("?")?o.substring(o.indexOf("?")):"",f=new URL(l,e);return a&&new URLSearchParams(a).forEach((m,u)=>{f.searchParams.set(u,m)}),f.toString()}const i=new URL(o,e);return n&&i.searchParams.set("t",Date.now().toString()),i.toString()}function Tt(){const[e,o]=r.useState(!1),[n,d]=r.useState(null);return{isEditModalOpen:e,selectedGame:n,openEditModal:a=>{d(a),o(!0)},closeEditModal:()=>{o(!1),d(null)}}}const rt=r.createContext(void 0);function Cn({children:e}){const[o,n]=r.useState(!1),d=r.useCallback(l=>{n(l)},[]),i=r.useMemo(()=>({isLoading:o,setLoading:d}),[o,d]);return t.jsx(rt.Provider,{value:i,children:e})}function ve(){const e=r.useContext(rt);if(e===void 0)throw new Error("useLoading must be used within a LoadingProvider");return e}function Nt({gameId:e,collectionId:o,onGameDelete:n,onCollectionDelete:d,onModalClose:i}){const{t:l}=ge(),{setLoading:a}=ve(),[f,s]=r.useState(!1),[m,u]=r.useState(null),[g,c]=r.useState(!1);return{isDeleting:f,deleteError:m,showConfirmModal:g,handleDeleteClick:()=>{c(!0)},handleConfirmDelete:async()=>{const x=se();if(x){s(!0),u(null),a(!0);try{let p,y=[];if(e){try{const C=_(H,"/collections"),h=await fetch(C,{headers:{Accept:"application/json","X-Auth-Token":x}});if(h.ok){const M=(await h.json()).collections||[];for(const N of M){const E=_(H,`/collections/${N.id}/games`),k=await fetch(E,{headers:{Accept:"application/json","X-Auth-Token":x}});k.ok&&((await k.json()).games||[]).map(A=>String(A.id)).includes(String(e))&&y.push(String(N.id))}}}catch(C){console.error("Error finding collections for game before deletion:",C)}p=_(H,`/games/${e}`)}else if(o)p=_(H,`/collections/${o}`);else return;(await fetch(p,{method:"DELETE",headers:{"X-Auth-Token":x}})).ok?(e&&n?n(e):o&&d&&d(o),e?(window.dispatchEvent(new CustomEvent("gameDeleted",{detail:{gameId:e}})),y.forEach(C=>{window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collectionId:C}}))})):o&&window.dispatchEvent(new CustomEvent("collectionDeleted",{detail:{collectionId:o}})),c(!1),i&&i()):u(l("common.deleteError"))}catch(p){console.error("Error deleting item:",p),u(l("common.deleteError"))}finally{s(!1),a(!1)}}},handleCancelDelete:()=>{c(!1),u(null),i&&i()}}}function Dt({gameId:e,collectionId:o,onGameUpdate:n,onCollectionUpdate:d,onReload:i,onModalClose:l}){const{t:a}=ge(),{setLoading:f}=ve(),[s,m]=r.useState(!1),[u,g]=r.useState(null),[c,b]=r.useState(!1),w=async()=>{const y=se();if(y){m(!0),g(null),f(!0);try{let R;e?R=_(H,`/games/${e}/reload`):o?R=_(H,`/collections/${o}/reload`):R=_(H,"/reload-games");const C=await fetch(R,{method:"POST",headers:{"X-Auth-Token":y}});if(C.ok){const h=await C.json();if(e)if(n&&h.game){const v={id:h.game.id,title:h.game.title,summary:h.game.summary||"",cover:h.game.cover,background:h.game.background,day:h.game.day||null,month:h.game.month||null,year:h.game.year||null,stars:h.game.stars||null,genre:h.game.genre||null,executables:h.game.executables||null,criticratings:h.game.criticratings||null,userratings:h.game.userratings||null,themes:h.game.themes||null,platforms:h.game.platforms||null,gameModes:h.game.gameModes||null,playerPerspectives:h.game.playerPerspectives||null,websites:h.game.websites||null,ageRatings:h.game.ageRatings||null,developers:h.game.developers||null,publishers:h.game.publishers||null,franchise:h.game.franchise||null,collection:h.game.collection||null,screenshots:h.game.screenshots||null,videos:h.game.videos||null,gameEngines:h.game.gameEngines||null,keywords:h.game.keywords||null,alternativeNames:h.game.alternativeNames||null,similarGames:h.game.similarGames||null};n(v),m(!1),f(!1);return}else{m(!1),f(!1);return}else if(o)if(d&&h.collection){const v={id:h.collection.id,title:h.collection.title,summary:h.collection.summary||"",cover:h.collection.cover,background:h.collection.background};d(v),m(!1),f(!1);return}else{m(!1),f(!1);return}else if(i)await i(),m(!1),f(!1);else{const v=window.location.pathname;window.location.href=v}}else console.error("Failed to reload metadata"),g(a("common.reloadError","Failed to reload metadata")),m(!1),f(!1)}catch(R){console.error("Error reloading metadata:",R),g(a("common.reloadError","Failed to reload metadata")),m(!1),f(!1)}}};return{isReloading:s,reloadError:u,showReloadConfirmModal:c,handleReloadClick:()=>{b(!0)},handleConfirmReload:async()=>{i?i():await w(),b(!1)},handleCancelReload:()=>{b(!1),g(null),l&&l()}}}function Rt({gameId:e,onGameUpdate:o}){const{setLoading:n}=ve(),[d,i]=r.useState(!1);return{isUnlinking:d,handleUnlinkExecutable:async()=>{i(!0),n(!0);try{const a=_(H,`/games/${e}`),f=await fetch(a,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":se()},body:JSON.stringify({executables:null})});if(f.ok){const s=await f.json(),m={id:s.game.id,title:s.game.title,summary:s.game.summary||"",cover:s.game.cover,background:s.game.background,day:s.game.day??null,month:s.game.month??null,year:s.game.year??null,stars:s.game.stars??null,genre:s.game.genre??null,criticratings:s.game.criticratings??null,userratings:s.game.userratings??null,themes:s.game.themes??null,platforms:s.game.platforms??null,gameModes:s.game.gameModes??null,playerPerspectives:s.game.playerPerspectives??null,websites:s.game.websites??null,ageRatings:s.game.ageRatings??null,developers:s.game.developers??null,publishers:s.game.publishers??null,franchise:s.game.franchise??null,collection:s.game.collection??null,screenshots:s.game.screenshots??null,videos:s.game.videos??null,gameEngines:s.game.gameEngines??null,keywords:s.game.keywords??null,alternativeNames:s.game.alternativeNames??null,similarGames:s.game.similarGames??null};"executables"in m&&delete m.executables,o(m)}else console.error("Failed to unlink executable")}catch(a){console.error("Error unlinking executable:",a)}finally{i(!1),n(!1)}}}}function jn({game:e,onGameUpdate:o}){const{t:n}=ge(),{setLoading:d}=ve(),[i,l]=r.useState(!1),[a,f]=r.useState(!1),s=r.useRef(null);return{isUploading:i,isUnlinking:a,fileInputRef:s,handleFileSelect:async c=>{const b=c.name.toLowerCase();if(!b.endsWith(".sh")&&!b.endsWith(".bat")){alert(n("gameDetail.invalidFileType","Only .sh and .bat files are allowed"));return}l(!0),d(!0);try{const w=new FormData;w.append("file",c);const D=_(H,`/games/${e.id}/upload-executable`),x=await fetch(D,{method:"POST",headers:{"X-Auth-Token":se()||""},body:w});if(!x.ok){const y=await x.json().catch(()=>({error:"Failed to upload file"}));throw new Error(y.error||"Failed to upload file")}const p=await x.json();if(p.game){const y={...e,id:p.game.id,title:p.game.title,summary:p.game.summary||"",cover:p.game.cover,background:p.game.background,day:p.game.day??e.day??null,month:p.game.month??e.month??null,year:p.game.year??e.year??null,stars:p.game.stars??e.stars??null,genre:p.game.genre??e.genre??null,criticratings:p.game.criticratings??e.criticratings??null,userratings:p.game.userratings??e.userratings??null,executables:p.game.executables??e.executables??null,themes:p.game.themes??e.themes??null,platforms:p.game.platforms??e.platforms??null,gameModes:p.game.gameModes??e.gameModes??null,playerPerspectives:p.game.playerPerspectives??e.playerPerspectives??null,websites:p.game.websites??e.websites??null,ageRatings:p.game.ageRatings??e.ageRatings??null,developers:p.game.developers??e.developers??null,publishers:p.game.publishers??e.publishers??null,franchise:p.game.franchise??e.franchise??null,collection:p.game.collection??e.collection??null,screenshots:p.game.screenshots??e.screenshots??null,videos:p.game.videos??e.videos??null,gameEngines:p.game.gameEngines??e.gameEngines??null,keywords:p.game.keywords??e.keywords??null,alternativeNames:p.game.alternativeNames??e.alternativeNames??null,similarGames:p.game.similarGames??e.similarGames??null};o(y)}}catch(w){console.error("Error uploading file:",w),alert(w.message||n("common.error","Error"))}finally{l(!1),d(!1)}},handleBrowseClick:()=>{s.current?.click()},handleUnlinkExecutable:async()=>{f(!0),d(!0);try{const c=_(H,`/games/${e.id}`),b=await fetch(c,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":se()},body:JSON.stringify({executables:null})});if(b.ok){const w=await b.json(),D={...e,id:w.game.id,title:w.game.title,summary:w.game.summary||"",cover:w.game.cover,background:w.game.background,day:w.game.day??e.day??null,month:w.game.month??e.month??null,year:w.game.year??e.year??null,stars:w.game.stars??e.stars??null,genre:w.game.genre??e.genre??null,criticratings:w.game.criticratings??e.criticratings??null,userratings:w.game.userratings??e.userratings??null,themes:w.game.themes??e.themes??null,platforms:w.game.platforms??e.platforms??null,gameModes:w.game.gameModes??e.gameModes??null,playerPerspectives:w.game.playerPerspectives??e.playerPerspectives??null,websites:w.game.websites??e.websites??null,ageRatings:w.game.ageRatings??e.ageRatings??null,developers:w.game.developers??e.developers??null,publishers:w.game.publishers??e.publishers??null,franchise:w.game.franchise??e.franchise??null,collection:w.game.collection??e.collection??null,screenshots:w.game.screenshots??e.screenshots??null,videos:w.game.videos??e.videos??null,gameEngines:w.game.gameEngines??e.gameEngines??null,keywords:w.game.keywords??e.keywords??null,alternativeNames:w.game.alternativeNames??e.alternativeNames??null,similarGames:w.game.similarGames??e.similarGames??null};"executables"in D&&delete D.executables,o(D)}else console.error("Failed to unlink executable")}catch(c){console.error("Error unlinking executable:",c)}finally{f(!1),d(!1)}}}}function Sn({onGameAdded:e,onError:o}={}){const{setLoading:n}=ve(),[d,i]=r.useState(!1),[l,a]=r.useState(null);return{isAdding:d,addError:l,addGame:async s=>{const m=se();if(!m){const u="Authentication required";return a(u),o&&o(u),null}i(!0),a(null),n(!0);try{const u=_(H,"/games/add-from-igdb"),g=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Auth-Token":m},body:JSON.stringify({igdbId:s.id,name:s.name,summary:s.summary,cover:s.cover,background:s.background,releaseDate:s.releaseDateFull?.timestamp||s.releaseDate,genres:s.genres,criticRating:s.criticRating,userRating:s.userRating,themes:s.themes,platforms:s.platforms,gameModes:s.gameModes,playerPerspectives:s.playerPerspectives,websites:s.websites,ageRatings:s.ageRatings,developers:s.developers,publishers:s.publishers,franchise:s.franchise,collection:s.collection,screenshots:s.screenshots,videos:s.videos,gameEngines:s.gameEngines,keywords:s.keywords,alternativeNames:s.alternativeNames,similarGames:s.similarGames})});if(!g.ok){const x=(await g.json().catch(()=>({}))).error||`HTTP ${g.status}`;return a(x),o&&o(x),null}const c=await g.json(),b=c.gameId||c.game?.id,w={id:String(b),title:c.game?.title||s.name,summary:c.game?.summary||s.summary||"",cover:c.game?.cover||s.cover||"",background:c.game?.background||s.background||void 0,day:c.game?.day||s.releaseDateFull?.day||null,month:c.game?.month||s.releaseDateFull?.month||null,year:c.game?.year||s.releaseDateFull?.year||s.releaseDate||null,stars:c.game?.stars||null,genre:c.game?.genre||s.genres||null,criticratings:c.game?.criticratings||(s.criticRating?s.criticRating/10:null),userratings:c.game?.userratings||(s.userRating?s.userRating/10:null),executables:c.game?.executables||null,themes:c.game?.themes||s.themes||null,platforms:c.game?.platforms||s.platforms||null,gameModes:c.game?.gameModes||s.gameModes||null,playerPerspectives:c.game?.playerPerspectives||s.playerPerspectives||null,websites:c.game?.websites||s.websites||null,ageRatings:c.game?.ageRatings||s.ageRatings||null,developers:c.game?.developers||s.developers||null,publishers:c.game?.publishers||s.publishers||null,franchise:c.game?.franchise||s.franchise||null,collection:c.game?.collection||s.collection||null,screenshots:c.game?.screenshots||s.screenshots||null,videos:c.game?.videos||s.videos||null,gameEngines:c.game?.gameEngines||s.gameEngines||null,keywords:c.game?.keywords||s.keywords||null,alternativeNames:c.game?.alternativeNames||s.alternativeNames||null,similarGames:c.game?.similarGames||s.similarGames||null};return window.dispatchEvent(new CustomEvent("gameAdded",{detail:{game:w}})),e&&e(w),w}catch(u){const g=u.message||"Failed to add game";return console.error("Error adding game:",u),a(g),o&&o(g),null}finally{i(!1),n(!1)}}}}const it=r.createContext(void 0),He="";function En({children:e}){const[o,n]=r.useState(null),[d,i]=r.useState(null),[l,a]=r.useState(!0),f=async()=>{a(!0);try{const c=new URLSearchParams(window.location.search),b=c.get("twitch_token"),w=c.get("user_id");if(b&&w&&(localStorage.setItem("twitch_token",b),localStorage.setItem("twitch_user_id",w),window.history.replaceState({},document.title,window.location.pathname),await s(b)))return;const D=localStorage.getItem("twitch_token");if(D)if(!localStorage.getItem("twitch_client_id"))localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id");else{if(await s(D))return;localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id")}n(null),i(null)}catch(c){console.error("Auth check error:",c),n(null),i(null)}finally{a(!1)}},s=async c=>{const b=localStorage.getItem("twitch_client_id"),w=He;try{const D={"X-Auth-Token":c};b&&!w&&(D["X-Twitch-Client-Id"]=b);const x=await fetch(`${H}/auth/me`,{headers:D});if(x.ok){const p=await x.json();return n(p),i(c),Ye(),!0}else{const p=await x.text().catch(()=>"");if(console.error(`Failed to validate token: ${x.status} ${p}`),!w)return localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),n(null),i(null),!1}}catch(D){return console.error("Failed to fetch user info:",D),localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),n(null),i(null),!1}},m=async(c=!1)=>{const b=localStorage.getItem("twitch_client_id"),w=localStorage.getItem("twitch_client_secret");if(!(!b||!w))try{const D=String(b).trim(),x=String(w).trim(),y={clientId:D,clientSecret:x,forceVerify:!!c},R=await fetch(`${H}/auth/twitch`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)});if(R.ok){const C=await R.json();window.location.href=C.authUrl}else{const C=await R.text().catch(()=>"Unknown error");let h;try{h=JSON.parse(C)}catch{h={error:C}}alert(`Errore durante il login: ${h.error||R.statusText}`)}}catch(D){console.error("Login error:",D),D instanceof Error?alert(`Errore durante il login: ${D.message}`):alert("Errore durante il login: Si è verificato un errore sconosciuto")}},u=()=>{localStorage.removeItem("twitch_token"),localStorage.removeItem("twitch_user_id"),localStorage.removeItem("twitch_client_id"),localStorage.removeItem("twitch_client_secret"),n(null),i(null),Ye(),d&&fetch(`${H}/auth/logout`,{method:"POST",headers:{"X-Auth-Token":d}}).catch(console.error)};r.useEffect(()=>{f()},[]);const g={user:o,token:d,isLoading:l,login:m,logout:u,checkAuth:f};return t.jsx(it.Provider,{value:g,children:e})}function at(){const e=r.useContext(it);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e}const lt=r.createContext(void 0);function Tn({children:e}){const[o,n]=r.useState([]),[d,i]=r.useState(!1),[l,a]=r.useState(null),[f,s]=r.useState(new Map),m=r.useRef(f),{isLoading:u,token:g}=at(),c=r.useCallback(async()=>{if(!(u||!(se()||g))){i(!0),a(null);try{const v=_(H,"/collections"),M=await fetch(v,{headers:Be({Accept:"application/json"})});if(!M.ok)throw new Error(`HTTP ${M.status}`);const k=((await M.json()).collections||[]).map(S=>({id:String(S.id),title:S.title,summary:S.summary,cover:S.cover,background:S.background,gameCount:S.gameCount}));n(k)}catch(v){const M=String(v.message||v);console.error("Error fetching collections:",M),a(M)}finally{i(!1)}}},[u,g]);r.useEffect(()=>{u||c()},[u,c]),r.useEffect(()=>{m.current=f},[f]),r.useEffect(()=>{const h=N=>{const E=N,k=E.detail?.collection,S=E.detail?.collectionId;k?n(j=>j.map(A=>String(A.id)===String(k.id)?k:A)):S&&(c(),(async()=>{try{const A=_(H,`/collections/${S}/games`),$=await fetch(A,{headers:Be({Accept:"application/json"})});if($.ok){const P=((await $.json()).games||[]).map(V=>String(V.id));s(V=>{const B=new Map(V);return B.set(String(S),P),B})}}catch(A){console.error(`Error reloading games for collection ${S}:`,A.message),s($=>{const F=new Map($);return F.delete(String(S)),F})}})())},v=N=>{const k=N.detail?.collectionId;k&&(n(S=>S.filter(j=>String(j.id)!==String(k))),s(S=>{const j=new Map(S);return j.delete(String(k)),j}))},M=()=>{c()};return window.addEventListener("collectionUpdated",h),window.addEventListener("collectionDeleted",v),window.addEventListener("metadataReloaded",M),()=>{window.removeEventListener("collectionUpdated",h),window.removeEventListener("collectionDeleted",v),window.removeEventListener("metadataReloaded",M)}},[c]);const b=r.useCallback(async()=>{await c()},[c]),w=r.useCallback(h=>{n(v=>{if(v.some(N=>String(N.id)===String(h.id)))return v;const M=[...v,h];return M.sort((N,E)=>(N.title||"").localeCompare(E.title||"")),M})},[]),D=r.useCallback(h=>{n(v=>v.map(M=>String(M.id)===String(h.id)?h:M))},[]),x=r.useCallback(h=>{n(v=>v.filter(M=>String(M.id)!==String(h))),s(v=>{const M=new Map(v);return M.delete(String(h)),M})},[]),p=r.useCallback((h,v)=>{s(M=>{const N=new Map(M),E=String(h),k=N.get(E)||[];return k.includes(v)||N.set(E,[...k,v]),N})},[]),y=r.useCallback((h,v)=>{s(M=>{const N=new Map(M),E=String(h),k=N.get(E)||[];return N.set(E,k.filter(S=>S!==v)),N})},[]),R=r.useCallback(async h=>{const v=m.current.get(String(h));if(v)return v;try{const M=_(H,`/collections/${h}/games`),N=await fetch(M,{headers:Be({Accept:"application/json"})});if(N.ok){const k=((await N.json()).games||[]).map(S=>String(S.id));return s(S=>{const j=String(h),A=S.get(j)||[];if(A.length===k.length&&A.every((F,P)=>F===k[P]))return S;const $=new Map(S);return $.set(j,k),$}),k}}catch(M){console.error(`Error fetching games for collection ${h}:`,M.message)}return[]},[]),C=r.useMemo(()=>({collections:o,isLoading:d,error:l,refreshCollections:b,addCollection:w,updateCollection:D,removeCollection:x,getCollectionGameIds:R,collectionGameIds:f,addGameToCollectionCache:p,removeGameFromCollectionCache:y}),[o,d,l,b,w,D,x,R,f,p,y]);return t.jsx(lt.Provider,{value:C,children:e})}function Oe(){const e=r.useContext(lt);if(e===void 0)throw new Error("useCollections must be used within a CollectionsProvider");return e}function ct({onSuccess:e,onError:o}={}){const{t:n}=ge(),{setLoading:d}=ve(),{addGameToCollectionCache:i}=Oe(),[l,a]=r.useState(!1);return{isAdding:l,addGameToCollection:async(s,m)=>{const u=se();if(!u){o?.(n("common.unauthorized","Unauthorized"));return}a(!0),d(!0);try{const g=_(H,`/collections/${m}/games`),c=await fetch(g,{headers:{Accept:"application/json","X-Auth-Token":u}});if(!c.ok)throw new Error(`Failed to fetch collection games: ${c.status}`);const w=((await c.json()).games||[]).map(R=>String(R.id));if(w.includes(String(s))){o?.(n("collections.gameAlreadyInCollection","Game is already in this collection"));return}const D=[...w,String(s)],x=_(H,`/collections/${m}/games/order`),p=await fetch(x,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":u},body:JSON.stringify({gameIds:D})});if(!p.ok){const R=await p.json().catch(()=>({}));throw new Error(R.error||`Failed to add game to collection: ${p.status}`)}i(m,String(s)),window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collectionId:m}}));const y=JSON.parse(localStorage.getItem("recentCollections")||"[]");if(!y.includes(m)){y.unshift(m);const R=y.slice(0,10);localStorage.setItem("recentCollections",JSON.stringify(R))}e?.()}catch(g){const c=String(g.message||g);console.error("Error adding game to collection:",c),o?.(c)}finally{a(!1),d(!1)}}}}function Mt({onSuccess:e,onError:o}={}){const{t:n}=ge(),{setLoading:d}=ve(),{removeGameFromCollectionCache:i}=Oe(),[l,a]=r.useState(!1);return{isRemoving:l,removeGameFromCollection:async(s,m)=>{const u=se();if(!u){o?.(n("common.unauthorized","Unauthorized"));return}a(!0),d(!0);try{const g=_(H,`/collections/${m}/games`),c=await fetch(g,{headers:{Accept:"application/json","X-Auth-Token":u}});if(!c.ok)throw new Error(`Failed to fetch collection games: ${c.status}`);const D=((await c.json()).games||[]).map(y=>String(y.id)).filter(y=>y!==String(s)),x=_(H,`/collections/${m}/games/order`),p=await fetch(x,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":u},body:JSON.stringify({gameIds:D})});if(!p.ok){const y=await p.json().catch(()=>({}));throw new Error(y.error||`Failed to remove game from collection: ${p.status}`)}i(m,String(s)),window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collectionId:m}})),e?.()}catch(g){const c=String(g.message||g);console.error("Error removing game from collection:",c),o?.(c)}finally{a(!1),d(!1)}}}}function At({onSuccess:e,onError:o}={}){const{t:n}=ge(),{setLoading:d}=ve(),[i,l]=r.useState(!1);return{isCreating:i,createCollection:async(f,s)=>{const m=se();if(!m)return o?.(n("common.unauthorized","Unauthorized")),null;if(!f||f.trim()==="")return o?.(n("collections.titleRequired","Collection title is required")),null;l(!0),d(!0);try{const u=_(H,"/collections"),g=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json","X-Auth-Token":m},body:JSON.stringify({title:f.trim(),summary:s?.trim()||""})});if(!g.ok){const w=await g.json().catch(()=>({}));throw new Error(w.error||`Failed to create collection: ${g.status}`)}const c=await g.json(),b={id:c.collection.id,title:c.collection.title,summary:c.collection.summary,cover:c.collection.cover,gameCount:0};return window.dispatchEvent(new CustomEvent("collectionAdded",{detail:{collection:b}})),e?.(b),b}catch(u){const g=String(u.message||u);return console.error("Error creating collection:",g),o?.(g),null}finally{l(!1),d(!1)}}}}function Xe({text:e,delay:o=1e3,children:n}){const[d,i]=r.useState(!1),[l,a]=r.useState({}),f=r.useRef(null),s=r.useRef(null);r.useEffect(()=>()=>{s.current&&clearTimeout(s.current)},[]),r.useEffect(()=>{if(!d)return;const g=()=>{s.current&&(clearTimeout(s.current),s.current=null),i(!1)};return document.addEventListener("click",g,!0),()=>{document.removeEventListener("click",g,!0)}},[d]);const m=()=>{s.current&&clearTimeout(s.current),s.current=window.setTimeout(()=>{if(f.current){const g=f.current.getBoundingClientRect();a({position:"fixed",top:`${g.bottom+8}px`,left:`${g.left}px`,zIndex:99999}),i(!0)}},o)},u=()=>{s.current&&(clearTimeout(s.current),s.current=null),i(!1)};return t.jsxs(t.Fragment,{children:[t.jsx("div",{ref:f,className:"tooltip-wrapper",onMouseEnter:m,onMouseLeave:u,children:n}),d&&Ce.createPortal(t.jsx("span",{className:"tooltip tooltip-portal",style:l,children:e}),document.body)]})}function qe({onEdit:e,onDelete:o,onReload:n,onAddToCollection:d,onRemoveFromCollection:i,onManageInstallation:l,gameId:a,gameTitle:f,gameExecutables:s,onGameDelete:m,onGameUpdate:u,collectionId:g,collectionTitle:c,onCollectionDelete:b,onCollectionUpdate:w,className:D="",horizontal:x=!1,onModalOpen:p,onModalClose:y,toolTipDelay:R=0}){const{t:C}=ge(),[h,v]=r.useState(!1),M=r.useRef(null),N=r.useRef(null),E=Nt({gameId:a,collectionId:g,onGameDelete:m,onCollectionDelete:b,onModalClose:y}),k=Dt({gameId:a,collectionId:g,onGameUpdate:u,onCollectionUpdate:w,onReload:n,onModalClose:y}),S=a&&u?Rt({gameId:a,onGameUpdate:u}):{isUnlinking:!1,handleUnlinkExecutable:async()=>{}},j=Mt({onSuccess:()=>{i&&i()},onError:T=>{console.error("Error removing game from collection:",T)}}),A=D.includes("games-list-dropdown-menu"),[$,F]=r.useState(!1);r.useEffect(()=>{if(h&&M.current){const T=M.current.closest(".search-dropdown-scroll");F(!!T)}else F(!1)},[h]),r.useEffect(()=>{!h&&a?(window.dispatchEvent(new CustomEvent("closeAddToCollectionDropdown",{detail:{gameId:a}})),window.dispatchEvent(new CustomEvent("closeAdditionalExecutablesDropdown",{detail:{gameId:a}})),window.dispatchEvent(new CustomEvent("dropdownMenuClosed",{detail:{gameId:a}}))):!h&&g&&window.dispatchEvent(new CustomEvent("dropdownMenuClosed",{detail:{collectionId:g}}))},[h,a,g]),r.useEffect(()=>{if(!h)return;function T(Q){const W=Q.target;M.current&&M.current.contains(W)||N.current&&N.current.contains(W)||W.closest(".dropdown-menu-popup")||W.closest(".add-to-collection-dropdown-menu")||W.closest(".additional-executables-dropdown-menu")||v(!1)}const L=setTimeout(()=>{document.addEventListener("mousedown",T,!0)},100);return()=>{clearTimeout(L),document.removeEventListener("mousedown",T,!0)}},[h]),r.useEffect(()=>(E.showConfirmModal||k.showReloadConfirmModal?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[E.showConfirmModal,k.showReloadConfirmModal]),r.useEffect(()=>{if(!E.showConfirmModal&&!k.showReloadConfirmModal)return;function T(L){L.key==="Escape"&&(E.showConfirmModal&&E.handleCancelDelete(),k.showReloadConfirmModal&&k.handleCancelReload())}return document.addEventListener("keydown",T),()=>{document.removeEventListener("keydown",T)}},[E.showConfirmModal,k.showReloadConfirmModal,E,k]);const P=T=>{T.stopPropagation();const L=!h;v(L),a?L?window.dispatchEvent(new CustomEvent("dropdownMenuOpened",{detail:{gameId:a}})):window.dispatchEvent(new CustomEvent("dropdownMenuClosed",{detail:{gameId:a}})):g&&(L?window.dispatchEvent(new CustomEvent("dropdownMenuOpened",{detail:{collectionId:g}})):window.dispatchEvent(new CustomEvent("dropdownMenuClosed",{detail:{collectionId:g}})))},V=T=>{T.stopPropagation(),v(!1),p&&p(),e&&e()},B=T=>{const L=T.currentTarget;window.dispatchEvent(new CustomEvent("openAddToCollectionDropdown",{detail:{gameId:a,menuItem:L}}))},J=T=>{const L=T.relatedTarget;L&&!L.closest(".add-to-collection-dropdown-menu")&&window.dispatchEvent(new CustomEvent("closeAddToCollectionDropdown",{detail:{gameId:a}}))},me=()=>{window.dispatchEvent(new CustomEvent("closeAddToCollectionDropdown",{detail:{gameId:a}})),window.dispatchEvent(new CustomEvent("closeAdditionalExecutablesDropdown",{detail:{gameId:a}}))},ae=()=>{window.dispatchEvent(new CustomEvent("openAdditionalExecutablesDropdown",{detail:{gameId:a}}))},ue=T=>{const L=T.relatedTarget;L&&!L.closest(".additional-executables-dropdown-menu")&&window.dispatchEvent(new CustomEvent("closeAdditionalExecutablesDropdown",{detail:{gameId:a}}))},ne=T=>{const L=T.relatedTarget;L&&!L.closest(".dropdown-menu-popup")&&!L.closest(".add-to-collection-dropdown-menu")&&window.dispatchEvent(new CustomEvent("closeAddToCollectionDropdown",{detail:{gameId:a}}))},le=T=>{T.stopPropagation(),v(!1),a&&f||g&&c?(p&&p(),E.handleDeleteClick()):o&&o()},I=T=>{if(T.stopPropagation(),T.preventDefault(),v(!1),a||g){n?n():k.handleConfirmReload();return}setTimeout(()=>{p&&p(),k.handleReloadClick()},0)},U=async T=>{T.stopPropagation(),v(!1),await S.handleUnlinkExecutable()},O=t.jsx("button",{onClick:P,className:"dropdown-menu-button","aria-label":"Menu",children:x?t.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsx("circle",{cx:"5",cy:"12",r:"1"}),t.jsx("circle",{cx:"12",cy:"12",r:"1"}),t.jsx("circle",{cx:"19",cy:"12",r:"1"})]}):t.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsx("circle",{cx:"12",cy:"5",r:"1"}),t.jsx("circle",{cx:"12",cy:"12",r:"1"}),t.jsx("circle",{cx:"12",cy:"19",r:"1"})]})});return t.jsxs("div",{className:`dropdown-menu-wrapper ${D}`,ref:M,children:[R>0?t.jsx(Xe,{text:C("common.more","More"),delay:R,children:O}):O,h&&(()=>{const T=t.jsxs("div",{ref:N,className:`dropdown-menu-popup ${$?"dropdown-menu-popup-in-search":""}`,onMouseLeave:ne,style:(()=>{if(M.current){if(A){const L=M.current.getBoundingClientRect();return{position:"fixed",bottom:`${window.innerHeight-L.top+4}px`,right:`${window.innerWidth-L.right}px`,top:"auto"}}if($){const L=M.current.getBoundingClientRect();return{position:"fixed",top:`${L.bottom+4}px`,right:`${window.innerWidth-L.right}px`,zIndex:10007}}}})(),children:[a&&s&&s.length>1&&t.jsxs("div",{className:"dropdown-menu-item dropdown-menu-item-with-submenu additional-executables-menu-item",onMouseEnter:ae,onMouseLeave:ue,children:[t.jsx("span",{children:C("gameDetail.additionalExecutables","Additional executables")}),t.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("polyline",{points:"9 18 15 12 9 6"})})]}),d&&t.jsx(t.Fragment,{children:t.jsxs("div",{className:"dropdown-menu-item dropdown-menu-item-with-submenu",onMouseEnter:B,onMouseLeave:J,children:[t.jsx("span",{children:C("collections.addTo","Add to")}),t.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("polyline",{points:"9 18 15 12 9 6"})})]})}),a&&l&&t.jsx("button",{onClick:L=>{L.stopPropagation(),v(!1),l&&l()},className:"dropdown-menu-item",children:t.jsx("span",{children:C("manageInstallation.title","Manage Installation")})}),(a&&s&&s.length>1||d||a&&l)&&!(i&&a&&g)&&(e||n||a&&u||!a&&!g&&!e&&!o||a&&s&&s.length>0&&u||o||se()&&(a||g))&&t.jsx("div",{className:"dropdown-menu-divider",onMouseEnter:me}),i&&a&&g&&t.jsx("button",{onClick:async L=>{L.stopPropagation(),v(!1),await j.removeGameFromCollection(a,g)},className:"dropdown-menu-item dropdown-menu-item-danger",disabled:j.isRemoving,children:t.jsx("span",{children:j.isRemoving?C("common.removing","Removing..."):C("collections.removeFromCollection","Remove from collection")})}),i&&a&&g&&(e||n||a&&u||!a&&!g&&!e&&!o||a&&s&&s.length>0&&u||o||se()&&(a||g))&&t.jsx("div",{className:"dropdown-menu-divider"}),e&&t.jsx("button",{onClick:V,className:"dropdown-menu-item",children:t.jsx("span",{children:C("common.edit","Edit")})}),(n||a&&u||!a&&!g&&!e&&!o)&&t.jsx("button",{onClick:I,className:"dropdown-menu-item",disabled:k.isReloading,children:t.jsx("span",{children:a?C("common.reloadSingleMetadata","Reload metadata"):C("common.reloadMetadata","Reload all metadata")})}),a&&s&&s.length>0&&u&&t.jsx("button",{onClick:U,className:"dropdown-menu-item",disabled:S.isUnlinking,children:t.jsx("span",{children:s.length>1?C("gameDetail.unlinkAllExecutables","Unlink All Executables"):C("gameDetail.unlinkExecutable","Unlink Executable")})}),(o||se()&&(a||g))&&t.jsx("button",{onClick:le,className:"dropdown-menu-item dropdown-menu-item-danger",children:t.jsx("span",{children:C("common.delete","Delete")})})]});return $||A?Ce.createPortal(T,document.body):T})(),k.showReloadConfirmModal&&Ce.createPortal(t.jsx("div",{className:"dropdown-menu-confirm-overlay",onClick:k.handleCancelReload,children:t.jsxs("div",{className:"dropdown-menu-confirm-container",onClick:T=>T.stopPropagation(),children:[t.jsxs("div",{className:"dropdown-menu-confirm-header",children:[t.jsxs("h2",{children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"8px",verticalAlign:"middle"},children:[t.jsx("path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"}),t.jsx("path",{d:"M21 3v5h-5"}),t.jsx("path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"}),t.jsx("path",{d:"M3 21v-5h5"})]}),C("common.reloadMetadata","Reload all metadata")]}),t.jsx("button",{className:"dropdown-menu-confirm-close",onClick:k.handleCancelReload,"aria-label":"Close",children:"×"})]}),t.jsxs("div",{className:"dropdown-menu-confirm-content",children:[t.jsx("p",{children:C("common.confirmReload","Are you sure you want to reload all metadata? This will refresh all games, collections, and categories.")}),k.reloadError&&t.jsx("div",{className:"dropdown-menu-confirm-error",children:k.reloadError})]}),t.jsxs("div",{className:"dropdown-menu-confirm-footer",children:[t.jsx("button",{className:"dropdown-menu-confirm-cancel",onClick:k.handleCancelReload,disabled:k.isReloading,children:C("common.cancel","Cancel")}),t.jsx("button",{className:"dropdown-menu-confirm-reload",onClick:k.handleConfirmReload,disabled:k.isReloading,children:k.isReloading?C("common.reloading","Reloading..."):C("common.reloadMetadata","Reload all metadata")})]})]})}),document.body),E.showConfirmModal&&Ce.createPortal(t.jsx("div",{className:"dropdown-menu-confirm-overlay",onClick:E.handleCancelDelete,children:t.jsxs("div",{className:"dropdown-menu-confirm-container",onClick:T=>T.stopPropagation(),children:[t.jsxs("div",{className:"dropdown-menu-confirm-header",children:[t.jsxs("h2",{children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"8px",verticalAlign:"middle"},children:[t.jsx("path",{d:"M3 6h18"}),t.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"}),t.jsx("path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]}),C("common.deleteTitle","Delete")]}),t.jsx("button",{className:"dropdown-menu-confirm-close",onClick:E.handleCancelDelete,"aria-label":"Close",children:"×"})]}),t.jsxs("div",{className:"dropdown-menu-confirm-content",children:[t.jsx("p",{children:C("common.confirmDelete",{title:f||c||""})}),E.deleteError&&t.jsx("div",{className:"dropdown-menu-confirm-error",children:E.deleteError})]}),t.jsxs("div",{className:"dropdown-menu-confirm-footer",children:[t.jsx("button",{className:"dropdown-menu-confirm-cancel",onClick:E.handleCancelDelete,disabled:E.isDeleting,children:C("common.cancel","Cancel")}),t.jsx("button",{className:"dropdown-menu-confirm-delete",onClick:E.handleConfirmDelete,disabled:E.isDeleting,children:E.isDeleting?C("common.deleting","Deleting..."):C("common.delete","Delete")})]})]})}),document.body)]})}function Lt({isOpen:e,onClose:o,game:n,allCollections:d,onCollectionAdded:i}){const{t:l}=ge(),[a,f]=r.useState(""),[s,m]=r.useState(n.title),u=r.useRef(null),{collectionGameIds:g}=Oe(),c=r.useMemo(()=>d.filter(y=>{const R=g.get(String(y.id));return!R||!R.includes(String(n.id))}),[d,g,n.id]),b=ct({onSuccess:()=>{i?.(),o()}}),w=At({onSuccess:async y=>{y&&await b.addGameToCollection(n.id,y.id)}});r.useEffect(()=>(e?(m(n.title),f(""),document.body.style.overflow="hidden",setTimeout(()=>{u.current&&(u.current.focus(),u.current.select())},0)):document.body.style.overflow="",()=>{document.body.style.overflow=""}),[e,n.title]);const D=r.useMemo(()=>{if(!a.trim())return c;const y=a.toLowerCase();return c.filter(R=>R.title.toLowerCase().includes(y))},[a,c]),x=async y=>{await b.addGameToCollection(n.id,y)},p=async()=>{s.trim()&&await w.createCollection(s.trim())};return e?Ce.createPortal(t.jsx("div",{className:"add-to-collection-modal-overlay",onClick:o,children:t.jsxs("div",{className:"add-to-collection-modal",onClick:y=>y.stopPropagation(),children:[t.jsxs("div",{className:"add-to-collection-modal-header",children:[t.jsx("h2",{children:l("collections.addToCollection","Add to Collection")}),t.jsx("button",{className:"add-to-collection-modal-close",onClick:o,children:"×"})]}),t.jsx("div",{className:"add-to-collection-modal-search",children:t.jsx("input",{id:"add-to-collection-search",name:"collectionSearch",type:"text",placeholder:l("collections.searchCollections","Search collections..."),value:a,onChange:y=>f(y.target.value),autoFocus:!0,"aria-label":l("collections.searchCollections","Search collections...")})}),t.jsx("div",{className:"add-to-collection-modal-collections",children:D.length>0?D.map(y=>t.jsxs("div",{className:"add-to-collection-modal-collection-item",onClick:()=>x(y.id),children:[t.jsx("div",{className:"add-to-collection-modal-collection-title",children:y.title}),y.gameCount!==void 0&&t.jsxs("div",{className:"add-to-collection-modal-collection-count",children:[y.gameCount," ",l("collections.games","games")]})]},y.id)):t.jsx("div",{className:"add-to-collection-modal-empty",children:l("collections.noCollectionsFound","No collections found")})}),t.jsxs("div",{className:"add-to-collection-modal-create",children:[t.jsx("input",{ref:u,id:"add-to-collection-create-title",name:"newCollectionTitle",type:"text",placeholder:l("collections.newCollectionTitle","New collection title"),value:s,onChange:y=>m(y.target.value),onFocus:y=>{y.target.value&&y.target.select()},onKeyDown:y=>{y.key==="Enter"&&p()},"aria-label":l("collections.newCollectionTitle","New collection title")}),t.jsx("button",{onClick:p,disabled:!s.trim()||w.isCreating,className:"add-to-collection-modal-create-button",children:w.isCreating?l("common.creating","Creating..."):l("common.create","Create")})]})]})}),document.body):null}function $t({game:e,allCollections:o,onCollectionAdded:n}){const{t:d}=ge(),[i,l]=r.useState(!1),[a,f]=r.useState(!1),[s,m]=r.useState(!1),[u,g]=r.useState(!1),c=r.useRef(null),b=r.useRef(null),{collectionGameIds:w}=Oe(),D=ct({onSuccess:()=>{n?.(),l(!1)}});r.useEffect(()=>{const h=M=>{const N=M;if(N.detail?.gameId===e.id&&!a){if(N.detail.menuItem)b.current=N.detail.menuItem;else{const E=document.querySelectorAll(".dropdown-menu-item-with-submenu");for(const k of E){const S=k.closest(".dropdown-menu-popup");if(S){const j=window.getComputedStyle(S);if(j.display!=="none"&&j.visibility!=="hidden"){b.current=k;break}}}}l(!0)}},v=M=>{const N=M;(!N.detail?.gameId||N.detail.gameId===e.id)&&!a&&l(!1)};return window.addEventListener("openAddToCollectionDropdown",h),window.addEventListener("closeAddToCollectionDropdown",v),()=>{window.removeEventListener("openAddToCollectionDropdown",h),window.removeEventListener("closeAddToCollectionDropdown",v)}},[e.id,a]);const x=r.useMemo(()=>o.filter(h=>{const v=w.get(String(h.id));return!v||!v.includes(String(e.id))}),[o,w,e.id]),p=r.useMemo(()=>JSON.parse(localStorage.getItem("recentCollections")||"[]").map(v=>x.find(M=>M.id===v)).filter(v=>v!==void 0).slice(0,5),[x]);r.useEffect(()=>{g(i)},[i]),r.useEffect(()=>{if(!i||!c.current){m(!1);return}m(!1);const h=()=>{let E=b.current;if(!E||!document.contains(E)){const me=document.querySelectorAll(".dropdown-menu-item-with-submenu");for(const ae of me){const ue=ae.closest(".dropdown-menu-popup");if(ue){const ne=window.getComputedStyle(ue);if(ne.display!=="none"&&ne.visibility!=="hidden"){E=ae,b.current=E;break}}}}if(E||(E=document.querySelector(".dropdown-menu-item-with-submenu")),!E)return;let k=u?document.querySelector(".add-to-collection-dropdown-menu"):c.current?.querySelector(".add-to-collection-dropdown-menu");if(!k){u&&requestAnimationFrame(h);return}const S=E.getBoundingClientRect(),j=0,A=window.innerWidth,$=window.innerHeight,F=8,P=k.offsetWidth||200,V=k.offsetHeight||100;let B=S.right+j;B+P+F>A&&(B=S.left-P-j),B<F&&(B=F);let J=S.top;J+V+F>$&&(J=S.bottom-V,J+V+F>$&&(J=$-V-F)),J<F&&(J=F),u&&(k.style.position="fixed",k.style.right="auto",k.style.bottom="auto"),k.style.top=`${J}px`,k.style.left=`${B}px`,m(!0)};requestAnimationFrame(u?()=>{requestAnimationFrame(()=>{setTimeout(()=>{h()},50)})}:()=>{requestAnimationFrame(h)});const v=()=>{h()},M=()=>{h()};window.addEventListener("resize",v),window.addEventListener("scroll",M,!0);function N(E){const k=E.target;c.current&&!c.current.contains(k)&&!k.closest(".dropdown-menu-item-with-submenu")&&!k.closest(".dropdown-menu-popup")&&l(!1)}return c.current&&c.current.addEventListener("mouseleave",N),()=>{window.removeEventListener("resize",v),window.removeEventListener("scroll",M,!0),c.current&&c.current.removeEventListener("mouseleave",N)}},[i,u]);const y=async(h,v)=>{h.stopPropagation(),h.preventDefault(),l(!1),await D.addGameToCollection(e.id,v)},R=h=>{h.stopPropagation(),h.preventDefault(),l(!1),setTimeout(()=>{f(!0)},50)},C=i?t.jsxs("div",{className:"add-to-collection-dropdown-menu",style:{opacity:s?1:0,pointerEvents:s?"auto":"none"},onMouseEnter:()=>l(!0),onMouseLeave:h=>{const v=h.relatedTarget;(!v||!v.closest(".add-to-collection-dropdown-menu")&&!v.closest(".dropdown-menu-item-with-submenu")&&!v.closest(".dropdown-menu-popup"))&&setTimeout(()=>{const M=document.querySelector(".dropdown-menu-item-with-submenu"),N=document.querySelector(".add-to-collection-dropdown-menu");if(M&&N){const E=M.getBoundingClientRect(),k=N.getBoundingClientRect(),S=h.clientX,j=h.clientY,A=S>=E.left&&S<=E.right&&j>=E.top&&j<=E.bottom,$=S>=k.left&&S<=k.right&&j>=k.top&&j<=k.bottom;!A&&!$&&l(!1)}else l(!1)},200)},onClick:h=>{h.stopPropagation()},children:[t.jsx("div",{className:"add-to-collection-dropdown-item",onClick:R,children:d("collections.addToCollection","Add to Collection...")}),p.length>0&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"add-to-collection-dropdown-divider"}),t.jsx("div",{className:"add-to-collection-dropdown-section-title",children:d("collections.recent","RECENT")}),p.map(h=>t.jsx("div",{className:"add-to-collection-dropdown-item",onClick:v=>y(v,h.id),children:h.title},h.id))]})]}):null;return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"add-to-collection-dropdown",ref:c,children:u&&C?Ce.createPortal(C,document.body):C}),t.jsx(Lt,{isOpen:a,onClose:()=>f(!1),game:e,allCollections:o,onCollectionAdded:n})]})}function Pt({gameId:e,gameExecutables:o,onPlayExecutable:n}){const[d,i]=r.useState(!1),[l,a]=r.useState(!1),[f,s]=r.useState(!1),[m,u]=r.useState(!1),g=r.useRef(null),c=r.useRef(null),b=o.slice(1);r.useEffect(()=>{if(g.current){const x=g.current.closest(".search-dropdown-item")!==null;s(x)}},[]),r.useEffect(()=>{u(d)},[d]),r.useEffect(()=>{const x=y=>{y.detail?.gameId===e&&i(!0)},p=y=>{const R=y;(!R.detail?.gameId||R.detail.gameId===e)&&i(!1)};return window.addEventListener("openAdditionalExecutablesDropdown",x),window.addEventListener("closeAdditionalExecutablesDropdown",p),()=>{window.removeEventListener("openAdditionalExecutablesDropdown",x),window.removeEventListener("closeAdditionalExecutablesDropdown",p)}},[e]),r.useEffect(()=>{if(!d||!g.current){a(!1);return}a(!1);const x=()=>{const R=document.querySelector(".dropdown-menu-item-with-submenu.additional-executables-menu-item");if(!R){requestAnimationFrame(x);return}let C=m?document.querySelector(".additional-executables-dropdown-menu"):c.current;if(!C&&g.current&&!m&&(C=g.current.querySelector(".additional-executables-dropdown-menu")),!C){requestAnimationFrame(x);return}const h=R.getBoundingClientRect(),v=0,M=window.innerWidth,N=window.innerHeight,E=8,k=C.offsetWidth||200,S=C.offsetHeight||100;let j=h.right+v;j+k+E>M&&(j=h.left-k-v),j<E&&(j=E);let A=h.top;A+S+E>N&&(A=h.bottom-S,A+S+E>N&&(A=N-S-E)),A<E&&(A=E),C.style.position="fixed",C.style.top=`${A}px`,C.style.left=`${j}px`,C.style.right="auto",C.style.bottom="auto",a(!0)};requestAnimationFrame(()=>{requestAnimationFrame(x)});const p=()=>{x()},y=()=>{x()};return window.addEventListener("resize",p),window.addEventListener("scroll",y,!0),()=>{window.removeEventListener("resize",p),window.removeEventListener("scroll",y,!0)}},[d]);const w=(x,p)=>{x.stopPropagation(),x.preventDefault(),n&&n(p),setTimeout(()=>{i(!1)},50)};if(b.length===0)return null;const D=d?t.jsx("div",{ref:c,className:`additional-executables-dropdown-menu ${f?"additional-executables-dropdown-menu-in-popup":""}`,style:{visibility:l?"visible":"hidden",pointerEvents:l?"auto":"none"},onMouseLeave:x=>{setTimeout(()=>{const p=document.querySelector(".dropdown-menu-item-with-submenu.additional-executables-menu-item");if(p){const y=p.getBoundingClientRect();let R=c.current;!R&&g.current&&(R=g.current.querySelector(".additional-executables-dropdown-menu"));const C=R?.getBoundingClientRect();if(C){const h=x.clientX,v=x.clientY,M=h>=y.left&&h<=y.right&&v>=y.top&&v<=y.bottom,N=h>=C.left&&h<=C.right&&v>=C.top&&v<=C.bottom;!M&&!N&&i(!1)}else i(!1)}},200)},onClick:x=>{x.stopPropagation()},onMouseDown:x=>{x.stopPropagation()},children:b.map(x=>t.jsx("button",{type:"button",className:"additional-executables-dropdown-item",onClick:p=>w(p,x),onMouseDown:p=>{p.stopPropagation()},children:x},x))}):null;return t.jsx("div",{className:"additional-executables-dropdown",ref:g,children:m&&typeof document<"u"?Ce.createPortal(D,document.body):D})}function Le({title:e,coverUrl:o,width:n,height:d,onPlay:i,onClick:l,onEdit:a,onDelete:f,gameId:s,gameTitle:m,game:u,onGameDelete:g,onGameUpdate:c,collectionId:b,collectionTitle:w,onCollectionDelete:D,onCollectionUpdate:x,onRemoveFromCollection:p,showTitle:y=!1,subtitle:R,detail:C=!0,play:h=!0,showBorder:v=!0,aspectRatio:M="3/4",overlayContent:N,titlePosition:E="bottom",editButtonPosition:k="bottom-left",onUpload:S,uploading:j=!1,allCollections:A=[],showRemoveButton:$=!1,removeMediaType:F,removeResourceId:P,removeResourceType:V,onRemoveSuccess:B,removeDisabled:J=!1}){const{t:me}=ge(),[ae,ue]=r.useState(!1),[ne,le]=r.useState(!1),[I,U]=r.useState(!1),O=r.useRef(null),T=!o||ae;r.useEffect(()=>{ue(!1)},[o]),r.useEffect(()=>{if(!s&&!b)return;const te=be=>{const ye=be;(s&&ye.detail?.gameId===s||b&&!s&&ye.detail?.collectionId===b)&&le(!0)},we=be=>{const ye=be;(s&&ye.detail?.gameId===s||b&&!s&&ye.detail?.collectionId===b)&&le(!1)};return window.addEventListener("dropdownMenuOpened",te),window.addEventListener("dropdownMenuClosed",we),()=>{window.removeEventListener("dropdownMenuOpened",te),window.removeEventListener("dropdownMenuClosed",we)}},[s,b]),r.useEffect(()=>{if(!ne){U(!1);return}const te=()=>{if(!O.current)return;const ye=O.current.querySelectorAll(".games-list-play-button, .games-list-upload-button, .games-list-edit-button");if(ye.length===0){U(!1);return}const Te=document.querySelectorAll(".dropdown-menu-popup, .add-to-collection-dropdown-menu");let $e=!1;ye.forEach(De=>{const de=De.getBoundingClientRect();Te.forEach(he=>{const Pe=window.getComputedStyle(he);if(Pe.display==="none"||Pe.opacity==="0"||Pe.visibility==="hidden")return;const Re=he.getBoundingClientRect();!(Re.right<de.left||Re.left>de.right||Re.bottom<de.top||Re.top>de.bottom)&&($e=!0)})}),U(De=>De===$e?De:$e)};te();const we=setInterval(te,100);return window.addEventListener("scroll",te,!0),window.addEventListener("resize",te),()=>{clearInterval(we),window.removeEventListener("scroll",te,!0),window.removeEventListener("resize",te)}},[ne]);let L=Math.max(10,Math.min(16,Math.floor(n/8)));M==="16/9"&&E==="overlay"&&(L=Math.max(14,Math.min(24,Math.floor(n/5))));const Q=Math.max(4,Math.floor(n/20)),W=Math.max(2,Math.floor(d/(L*1.5))),re=te=>{h&&!C&&i?(te.stopPropagation(),i()):C&&l&&(te.stopPropagation(),l())},K=te=>{te.stopPropagation(),i&&i()},X=te=>{te.stopPropagation(),a&&a()},z=te=>{te.stopPropagation(),S&&!j&&S()},fe=h&&i&&!S,ie=S!==void 0,pe=C||h||ie;return t.jsxs(t.Fragment,{children:[t.jsxs("div",{ref:O,className:`games-list-cover relative bg-[#2a2a2a] rounded overflow-hidden transition-all ${v?"cover-hover-effect":""} ${h?"games-list-cover-play":""} ${C?"games-list-cover-detail":""} ${ie?"games-list-cover-upload":""} ${ne?"cover-dropdown-open":""} ${I?"cover-popup-overlay":""}`,style:{width:`${n}px`,aspectRatio:M,cursor:pe&&!ie||ie?"pointer":"default"},onClick:ie?z:re,children:[T?t.jsx("div",{className:"cover-placeholder",style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#2a2a2a",border:"1px solid rgba(255, 255, 255, 0.2)",boxSizing:"border-box"},children:t.jsx("div",{className:"cover-placeholder-text",style:{padding:`${Q}px`,fontSize:`${L}px`,textAlign:"center",color:"rgba(255, 255, 255, 0.85)",fontWeight:600,lineHeight:1.3,wordBreak:"break-word",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:W,WebkitBoxOrient:"vertical",width:"100%",maxHeight:"100%"},children:e})}):t.jsx("img",{src:o,alt:e,className:"object-cover w-full h-full",loading:o.startsWith("data:")?void 0:"lazy",onError:()=>{ue(!0)},onLoad:()=>{ue(!1)}},o||"cover-image"),fe&&t.jsx("button",{onClick:K,className:`games-list-play-button ${C?"games-list-play-button-detail":"games-list-play-button-play-only"}`,"aria-label":me("common.play"),children:t.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{d:"M8 5v14l11-7z",fill:"currentColor"})})}),ie&&t.jsx("button",{onClick:z,className:`games-list-upload-button ${C?"games-list-upload-button-detail":"games-list-upload-button-upload-only"}`,"aria-label":me("gameDetail.uploadCover","Upload Cover"),disabled:j,children:j?t.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:"spinning",style:{animation:"spin 1s linear infinite"},children:t.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"2",fill:"none",strokeDasharray:"31.416",strokeDashoffset:"31.416",strokeLinecap:"round"})}):t.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{d:"M12 5v14M5 12h14",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}),a&&t.jsx("button",{onClick:X,className:`games-list-edit-button ${k==="bottom-right"?"games-list-edit-button-bottom-right":""}`,"aria-label":me("common.edit","Edit"),children:t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),t.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]})}),a&&s&&u&&t.jsx("div",{className:"games-list-dropdown-wrapper games-list-dropdown-wrapper-bottom-right",children:t.jsx($t,{game:u,allCollections:A})}),a&&(s||b)&&t.jsxs("div",{className:"games-list-dropdown-wrapper games-list-dropdown-wrapper-bottom-right",children:[s&&u&&u.executables&&u.executables.length>1&&i&&t.jsx(Pt,{gameId:s,gameExecutables:u.executables,onPlayExecutable:te=>{i&&i(u,te)}}),t.jsx(qe,{onDelete:f,gameId:s,gameTitle:m,gameExecutables:u?.executables,onAddToCollection:s&&u?()=>{}:void 0,onRemoveFromCollection:p,onGameDelete:g,onGameUpdate:c,collectionId:b,collectionTitle:w,onCollectionDelete:D,onCollectionUpdate:x,className:"games-list-dropdown-menu"})]}),$&&F&&P&&V&&t.jsx("button",{className:"cover-remove-media-button",onClick:te=>{te.stopPropagation(),B&&B()},disabled:J||j,title:F==="cover"?me("gameDetail.removeCover","Remove cover"):me("gameDetail.removeBackground","Remove background")}),N&&t.jsx("div",{className:"cover-overlay-content",children:N}),E==="overlay"&&y&&!T&&t.jsx("div",{className:"cover-overlay-content",style:{display:"flex",alignItems:"center",justifyContent:"center",padding:`${Q}px`},children:t.jsx("div",{style:{textAlign:"center",color:"rgba(255, 255, 255, 0.95)",fontWeight:600,fontSize:`${L}px`,lineHeight:1.3,wordBreak:"break-word",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:W,WebkitBoxOrient:"vertical",textShadow:"2px 2px 4px rgba(0, 0, 0, 0.8)"},children:e})})]}),(y||R!=null)&&E==="bottom"&&t.jsxs("div",{className:"games-list-title-wrapper",children:[y&&t.jsx(Xe,{text:e,position:"bottom",children:t.jsx("div",{className:`truncate games-list-title ${C?"games-list-title-clickable":""}`,onClick:C&&l?te=>{te.stopPropagation(),l()}:void 0,children:e})}),R!=null&&t.jsx("div",{className:"games-list-year",children:R})]})]})}function It({t:e,title:o,summary:n,year:d,month:i,day:l,saving:a,setTitle:f,setSummary:s,setYear:m,setMonth:u,setDay:g}){return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("label",{htmlFor:"edit-game-title",children:e("gameDetail.title","Title")}),t.jsx("input",{id:"edit-game-title",name:"title",type:"text",value:o,onChange:c=>f(c.target.value),disabled:a})]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("label",{htmlFor:"edit-game-summary",children:e("gameDetail.summary","Summary")}),t.jsx("textarea",{id:"edit-game-summary",name:"summary",value:n,onChange:c=>s(c.target.value),disabled:a,rows:5})]}),t.jsxs("div",{className:"edit-game-modal-row",children:[t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("label",{htmlFor:"edit-game-year",children:e("gameDetail.year","Year")}),t.jsx("input",{id:"edit-game-year",name:"year",type:"number",value:d,onChange:c=>m(c.target.value),disabled:a,placeholder:"YYYY"})]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("label",{htmlFor:"edit-game-month",children:e("gameDetail.month","Month")}),t.jsx("input",{id:"edit-game-month",name:"month",type:"number",value:i,onChange:c=>u(c.target.value),disabled:a,placeholder:"MM",min:"1",max:"12"})]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("label",{htmlFor:"edit-game-day",children:e("gameDetail.day","Day")}),t.jsx("input",{id:"edit-game-day",name:"day",type:"number",value:l,onChange:c=>g(c.target.value),disabled:a,placeholder:"DD",min:"1",max:"31"})]})]})]})}const dt=r.createContext(void 0);function Nn({children:e}){const[o,n]=r.useState([]),[d,i]=r.useState(!1),[l,a]=r.useState(null),{isLoading:f,token:s}=at(),m=r.useCallback(async()=>{if(!(f||!(se()||s))){i(!0),a(null);try{const x=_(H,"/categories"),p=await fetch(x,{headers:Be({Accept:"application/json"})});if(!p.ok)throw new Error(`HTTP ${p.status}`);const C=((await p.json()).categories||[]).map(h=>({id:h.id,title:h.title,cover:h.cover}));n(C)}catch(x){const p=String(x.message||x);console.error("Error fetching categories:",p),a(p)}finally{i(!1)}}},[f,s]);r.useEffect(()=>{f||m()},[f,m]),r.useEffect(()=>{const D=p=>{const R=p.detail?.category;R&&n(C=>C.map(h=>String(h.id)===String(R.id)?R:h))},x=()=>{m()};return window.addEventListener("categoryUpdated",D),window.addEventListener("metadataReloaded",x),()=>{window.removeEventListener("categoryUpdated",D),window.removeEventListener("metadataReloaded",x)}},[m]);const u=r.useCallback(async()=>{await m()},[m]),g=r.useCallback(D=>{n(x=>{if(x.some(y=>String(y.id)===String(D.id)))return x;const p=[...x,D];return p.sort((y,R)=>y.title.localeCompare(R.title)),p})},[]),c=r.useCallback(D=>{n(x=>x.map(p=>String(p.id)===String(D.id)?D:p))},[]),b=r.useCallback(D=>{n(x=>x.filter(p=>String(p.id)!==String(D)))},[]),w=r.useMemo(()=>({categories:o,isLoading:d,error:l,refreshCategories:u,addCategory:g,updateCategory:c,removeCategory:b}),[o,d,l,u,g,c,b]);return t.jsx(dt.Provider,{value:w,children:e})}function Ft(){const e=r.useContext(dt);if(e===void 0)throw new Error("useCategories must be used within a CategoriesProvider");return e}function ke({selectedTags:e,onTagsChange:o,disabled:n=!1,placeholder:d,mode:i="categories",availableTags:l,getDisplayName:a,allowCreate:f=!0}){const{t:s}=ge(),{setLoading:m}=ve(),{categories:u,addCategory:g}=Ft(),[c,b]=r.useState(""),[w,D]=r.useState(!1),x=i==="categories";async function p(N){if(!x)return null;try{m(!0),D(!0);const E=_(H,"/categories"),k=await fetch(E,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Auth-Token":se()},body:JSON.stringify({title:N})});if(!k.ok){const F=await k.json();throw new Error(F.error||`HTTP ${k.status}`)}const j=(await k.json()).category,A=typeof j=="string"?j:j.title,$=typeof j=="string"?j:j.id;return g({id:$,title:A}),A}catch(E){return console.error("Error creating category:",E),null}finally{m(!1),D(!1)}}const y=N=>{o(e.filter(E=>E!==N))},R=N=>{e.includes(N)||(o([...e,N]),b(""))},C=async N=>{if(N.key==="Enter"&&c.trim()&&!w){N.preventDefault();const E=c.trim(),k=E.toLowerCase();if(x){const S=u.find(A=>{const $=A.title.toLowerCase(),F=s(`genre.${A.title}`,A.title).toLowerCase();return $===k||F===k||F.includes(k)});if(S&&!e.includes(S.title)){R(S.title);return}const j=await p(E);j&&!e.includes(j)&&R(j)}else{const j=(l||[]).find(A=>A.toLowerCase()===k);if(j&&!e.includes(j)){R(j);return}f&&R(E)}}},h=x?u.map(N=>N.title):l||[],v=N=>x?s(`genre.${N}`,N):a?a(N):N,M=h.filter(N=>{if(e.includes(N))return!1;const E=c.toLowerCase();if(!E)return!1;if(x){const S=s(`genre.${N}`,N).toLowerCase();return N.toLowerCase().includes(E)||S.includes(E)}const k=v(N).toLowerCase();return N.toLowerCase().includes(E)||k.includes(E)});return t.jsxs("div",{className:"tag-editor-container",children:[t.jsxs("div",{className:"tag-editor-tags",children:[e.map(N=>t.jsxs("span",{className:"tag-editor-tag",children:[v(N),t.jsx("button",{type:"button",className:"tag-editor-tag-remove",onClick:()=>y(N),disabled:n,children:"×"})]},N)),t.jsx("input",{id:"tag-editor-input",name:"tag",type:"text",value:c,onChange:N=>b(N.target.value),onKeyDown:C,disabled:n,placeholder:d||s("gameDetail.addTag","Add tag..."),className:"tag-editor-input","aria-label":d||s("gameDetail.addTag","Add tag...")})]}),c&&M.length>0&&t.jsx("div",{className:"tag-editor-suggestions",children:M.slice(0,5).map(N=>t.jsx("button",{type:"button",className:"tag-editor-suggestion",onClick:()=>R(N),disabled:n,children:v(N)},N))})]})}function Ot({t:e,isOpen:o,gameId:n,selectedGenres:d,selectedThemes:i,selectedKeywords:l,selectedPlatforms:a,selectedGameModes:f,selectedPublishers:s,selectedDevelopers:m,selectedPlayerPerspectives:u,selectedGameEngines:g,saving:c,setSelectedGenres:b,setSelectedThemes:w,setSelectedKeywords:D,setSelectedPlatforms:x,setSelectedGameModes:p,setSelectedPublishers:y,setSelectedDevelopers:R,setSelectedPlayerPerspectives:C,setSelectedGameEngines:h}){return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:e("gameDetail.genre","Genre")}),o&&t.jsx(ke,{selectedTags:d,onTagsChange:b,disabled:c,placeholder:e("gameDetail.addGenre","Add genre...")},`tag-editor-genres-${n}-${o}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:e("gameDetail.themes","Themes")}),o&&t.jsx(ke,{mode:"freeform",selectedTags:i,onTagsChange:w,disabled:c,placeholder:e("gameDetail.addTheme","Add theme...")},`tag-editor-themes-${n}-${o}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:e("gameDetail.keywords","Keywords")}),o&&t.jsx(ke,{mode:"freeform",selectedTags:l,onTagsChange:D,disabled:c,placeholder:e("gameDetail.addKeyword","Add keyword...")},`tag-editor-keywords-${n}-${o}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:e("gameDetail.platforms","Platforms")}),o&&t.jsx(ke,{mode:"freeform",selectedTags:a,onTagsChange:x,disabled:c,placeholder:e("gameDetail.addPlatform","Add platform...")},`tag-editor-platforms-${n}-${o}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:e("gameDetail.gameModes","Game Modes")}),o&&t.jsx(ke,{mode:"freeform",selectedTags:f,onTagsChange:p,disabled:c,placeholder:e("gameDetail.addGameMode","Add game mode..."),getDisplayName:v=>e(`gameModes.${v}`,v)},`tag-editor-game-modes-${n}-${o}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:e("gameDetail.publishers","Publishers")}),o&&t.jsx(ke,{mode:"freeform",selectedTags:s,onTagsChange:y,disabled:c,placeholder:e("gameDetail.addPublisher","Add publisher...")},`tag-editor-publishers-${n}-${o}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:e("gameDetail.developers","Developers")}),o&&t.jsx(ke,{mode:"freeform",selectedTags:m,onTagsChange:R,disabled:c,placeholder:e("gameDetail.addDeveloper","Add developer...")},`tag-editor-developers-${n}-${o}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:e("gameDetail.playerPerspectives","Player Perspectives")}),o&&t.jsx(ke,{mode:"freeform",selectedTags:u,onTagsChange:C,disabled:c,placeholder:e("gameDetail.addPlayerPerspective","Add player perspective..."),getDisplayName:v=>e(`playerPerspectives.${v}`,v)},`tag-editor-player-perspectives-${n}-${o}`)]}),t.jsxs("div",{className:"edit-game-modal-field",children:[t.jsx("div",{className:"edit-game-modal-label",children:e("gameDetail.gameEngines","Game Engines")}),o&&t.jsx(ke,{mode:"freeform",selectedTags:g,onTagsChange:h,disabled:c,placeholder:e("gameDetail.addGameEngine","Add game engine...")},`tag-editor-game-engines-${n}-${o}`)]})]})}function zt({t:e,game:o,saving:n,coverRemoved:d,coverPreview:i,coverUrlWithTimestamp:l,uploadingCover:a,coverInputRef:f,handleCoverFileSelect:s,onGameUpdate:m,handleCoverRemoveSuccess:u,backgroundRemoved:g,backgroundPreview:c,backgroundUrlWithTimestamp:b,uploadingBackground:w,backgroundInputRef:D,handleBackgroundFileSelect:x,handleBackgroundRemoveSuccess:p}){return t.jsxs("div",{className:"edit-game-modal-media",children:[t.jsxs("div",{className:"edit-game-modal-media-row",children:[t.jsxs("div",{className:"edit-game-modal-media-info",children:[t.jsx("div",{className:"edit-game-modal-label",children:e("gameDetail.cover","Cover")}),t.jsx("div",{className:"edit-game-modal-media-description",children:e("gameDetail.coverFormat","Recommended format: WebP, ratio 2:3 (e.g., 400x600px)")})]}),t.jsx("div",{className:"edit-game-modal-media-image-container",children:(()=>{const y=d?"":i||l,R=y&&y.trim()!=="";return t.jsxs(t.Fragment,{children:[t.jsx(Le,{title:o.title,coverUrl:y,width:150,height:200,showTitle:!1,detail:!1,play:!1,showBorder:!0,aspectRatio:"3/4",onUpload:()=>!a&&!n&&f.current?.click(),uploading:a,showRemoveButton:!!R&&!d&&!0,removeMediaType:"cover",removeResourceId:o.id,removeResourceType:"games",onGameUpdate:m,onRemoveSuccess:u,removeDisabled:n||a},`cover-${d?"removed":i?"preview":l}`),t.jsx("input",{ref:f,id:"edit-game-cover-input",name:"cover",type:"file",accept:"image/*",style:{display:"none"},onChange:s,"aria-label":e("gameDetail.cover","Cover")})]})})()})]}),t.jsxs("div",{className:"edit-game-modal-media-row",children:[t.jsxs("div",{className:"edit-game-modal-media-info",children:[t.jsx("div",{className:"edit-game-modal-label",children:e("gameDetail.background","Background")}),t.jsx("div",{className:"edit-game-modal-media-description",children:e("gameDetail.backgroundFormat","Recommended format: WebP, ratio 16:9 (e.g., 1920x1080px)")})]}),t.jsx("div",{className:"edit-game-modal-media-image-container",children:(()=>{const y=g?"":c||b,R=y&&y.trim()!=="";return t.jsxs(t.Fragment,{children:[t.jsx(Le,{title:o.title,coverUrl:y,width:300,height:169,showTitle:!1,detail:!1,play:!1,showBorder:!0,aspectRatio:"16/9",onUpload:()=>!w&&!n&&D.current?.click(),uploading:w,showRemoveButton:!!R&&!g&&!0,removeMediaType:"background",removeResourceId:o.id,removeResourceType:"games",onGameUpdate:m,onRemoveSuccess:p,removeDisabled:n||w},`background-${g?"removed":c?"preview":b}`),t.jsx("input",{ref:D,id:"edit-game-background-input",name:"background",type:"file",accept:"image/*",style:{display:"none"},onChange:x,"aria-label":e("gameDetail.background","Background")})]})})()})]})]})}function Bt({isOpen:e,onClose:o,game:n,onGameUpdate:d}){const{t:i}=ge(),{setLoading:l}=ve(),[a,f]=r.useState(n.title),[s,m]=r.useState(n.summary||""),[u,g]=r.useState(n.year?.toString()||""),[c,b]=r.useState(n.month?.toString()||""),[w,D]=r.useState(n.day?.toString()||""),[x,p]=r.useState(Array.isArray(n.genre)?n.genre:n.genre?[n.genre]:[]),[y,R]=r.useState(Array.isArray(n.themes)?n.themes:[]),[C,h]=r.useState(Array.isArray(n.keywords)?n.keywords:[]),[v,M]=r.useState(Array.isArray(n.platforms)?n.platforms:[]),[N,E]=r.useState(Array.isArray(n.gameModes)?n.gameModes:[]),[k,S]=r.useState(Array.isArray(n.publishers)?n.publishers:[]),[j,A]=r.useState(Array.isArray(n.developers)?n.developers:[]),[$,F]=r.useState(Array.isArray(n.playerPerspectives)?n.playerPerspectives:[]),[P,V]=r.useState(Array.isArray(n.gameEngines)?n.gameEngines:[]),[B,J]=r.useState(!1),[me,ae]=r.useState(null),[ue,ne]=r.useState("INFO"),[le,I]=r.useState(!1),[U,O]=r.useState(!1),T=r.useRef(null),L=r.useRef(null),[Q,W]=r.useState(null),[re,K]=r.useState(null),[X,z]=r.useState(null),[fe,ie]=r.useState(null),[pe,te]=r.useState(!1),[we,be]=r.useState(!1),[ye,Te]=r.useState(Date.now()),$e=r.useMemo(()=>{if(!n?.cover)return"";const q=n.cover.split("?")[0].split("&")[0];if(q.startsWith("http"))return"";const Z=_(H,q),ee=Z.includes("?")?"&":"?";return`${Z}${ee}t=${ye}`},[n?.cover,ye]),De=r.useMemo(()=>{if(!n?.background)return"";const q=n.background.split("?")[0].split("&")[0];if(q.startsWith("http"))return"";const Z=_(H,q),ee=Z.includes("?")?"&":"?";return`${Z}${ee}t=${ye}`},[n?.background,ye]);r.useEffect(()=>{e&&(f(n.title),m(n.summary||""),g(n.year?.toString()||""),b(n.month?.toString()||""),D(n.day?.toString()||""),p(Array.isArray(n.genre)?n.genre:n.genre?[n.genre]:[]),R(Array.isArray(n.themes)?n.themes:[]),h(Array.isArray(n.keywords)?n.keywords:[]),M(Array.isArray(n.platforms)?n.platforms:[]),E(Array.isArray(n.gameModes)?n.gameModes:[]),S(Array.isArray(n.publishers)?n.publishers:[]),A(Array.isArray(n.developers)?n.developers:[]),F(Array.isArray(n.playerPerspectives)?n.playerPerspectives:[]),V(Array.isArray(n.gameEngines)?n.gameEngines:[]),ae(null),ne("INFO"),W(null),K(null),z(null),ie(null),te(!1),be(!1),Te(Date.now()))},[e,n]),r.useEffect(()=>{n&&(!n.cover&&!pe&&!X&&(te(!0),W(null),Te(Date.now())),!n.background&&!we&&!fe&&(be(!0),K(null),Te(Date.now())))},[n?.cover,n?.background]),r.useEffect(()=>{if(!e)return;function q(Z){Z.key==="Escape"&&(Z.stopPropagation(),o())}return document.addEventListener("keydown",q,!0),document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",q,!0),document.body.style.overflow=""}},[e,o]);const de=(q,Z)=>{if(q.length!==Z.length)return!1;const ee=[...q].sort(),Ue=[...Z].sort();return ee.every((Y,oe)=>Y===Ue[oe])},he=q=>Array.isArray(q)?q:[],Pe=()=>{if(a!==n.title||s!==(n.summary||"")||u!==(n.year?.toString()||"")||c!==(n.month?.toString()||"")||w!==(n.day?.toString()||""))return!0;const q=Array.isArray(n.genre)?n.genre:n.genre?[n.genre]:[];return!!(!de(x,q)||!de(y,he(n.themes))||!de(C,he(n.keywords))||!de(v,he(n.platforms))||!de(N,he(n.gameModes))||!de(k,he(n.publishers))||!de(j,he(n.developers))||!de($,he(n.playerPerspectives))||!de(P,he(n.gameEngines))||X||fe||pe||we)},Re=async()=>{J(!0),ae(null),l(!0);try{let q=null,Z=null;if(pe)try{const Y=_(H,`/games/${n.id}/delete-cover`),oe=await fetch(Y,{method:"DELETE",headers:{"X-Auth-Token":se()||""}});if(!oe.ok){const ce=await oe.json().catch(()=>({error:"Failed to remove cover"}));throw new Error(ce.error||"Failed to remove cover")}const G=await oe.json();G.game&&(q=G.game.cover||null)}catch(Y){ae(String(Y.message||Y)),J(!1),l(!1);return}if(we)try{const Y=_(H,`/games/${n.id}/delete-background`),oe=await fetch(Y,{method:"DELETE",headers:{"X-Auth-Token":se()||""}});if(!oe.ok){const ce=await oe.json().catch(()=>({error:"Failed to remove background"}));throw new Error(ce.error||"Failed to remove background")}const G=await oe.json();G.game&&(Z=G.game.background||null)}catch(Y){ae(String(Y.message||Y)),J(!1),l(!1);return}if(X){I(!0);try{const Y=new FormData;Y.append("file",X);const oe=_(H,`/games/${n.id}/upload-cover`),G=await fetch(oe,{method:"POST",headers:{"X-Auth-Token":se()||""},body:Y});if(!G.ok){const xe=await G.json().catch(()=>({error:"Failed to upload cover"}));throw new Error(xe.error||"Failed to upload cover")}const ce=await G.json();ce.game&&(q=ce.game.cover||null,ce.game.background&&(Z=ce.game.background))}catch(Y){I(!1),l(!1),J(!1),ae(String(Y.message||Y));return}finally{I(!1)}}if(fe){O(!0);try{const Y=new FormData;Y.append("file",fe);const oe=_(H,`/games/${n.id}/upload-background`),G=await fetch(oe,{method:"POST",headers:{"X-Auth-Token":se()||""},body:Y});if(!G.ok){const xe=await G.json().catch(()=>({error:"Failed to upload background"}));throw new Error(xe.error||"Failed to upload background")}const ce=await G.json();ce.game&&(Z=ce.game.background||null,ce.game.cover&&!q&&(q=ce.game.cover))}catch(Y){O(!1),l(!1),J(!1),ae(String(Y.message||Y));return}finally{O(!1)}}const ee={};a!==n.title&&(ee.title=a),s!==(n.summary||"")&&(ee.summary=s),u!==(n.year?.toString()||"")&&(ee.year=u?parseInt(u,10):null),c!==(n.month?.toString()||"")&&(ee.month=c?parseInt(c,10):null),w!==(n.day?.toString()||"")&&(ee.day=w?parseInt(w,10):null);const Ue=Array.isArray(n.genre)?n.genre:n.genre?[n.genre]:[];if(de(x,Ue)||(ee.genre=x.length===1?x[0]:x),de(y,he(n.themes))||(ee.themes=y.length>0?y:[]),de(C,he(n.keywords))||(ee.keywords=C.length>0?C:[]),de(v,he(n.platforms))||(ee.platforms=v.length>0?v:[]),de(N,he(n.gameModes))||(ee.gameModes=N.length>0?N:[]),de(k,he(n.publishers))||(ee.publishers=k.length>0?k:[]),de(j,he(n.developers))||(ee.developers=j.length>0?j:[]),de($,he(n.playerPerspectives))||(ee.playerPerspectives=$.length>0?$:[]),de(P,he(n.gameEngines))||(ee.gameEngines=P.length>0?P:[]),Object.keys(ee).length>0){const Y=_(H,`/games/${n.id}`),oe=await fetch(Y,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":Ae},body:JSON.stringify(ee)});if(!oe.ok){const Ne=await oe.json();throw new Error(Ne.error||"Failed to update game")}const G=await oe.json();let ce=q!==null?q:G.game.cover,xe=Z!==null?Z:G.game.background;if(q&&ce){const Ne=ce.includes("?")?"&":"?";ce=`${ce}${Ne}t=${Date.now()}`}if(Z&&xe){const Ne=xe.includes("?")?"&":"?";xe=`${xe}${Ne}t=${Date.now()}`}const je={id:G.game.id,title:G.game.title,summary:G.game.summary,cover:ce,background:xe,day:G.game.day,month:G.game.month,year:G.game.year,stars:G.game.stars,genre:G.game.genre,criticratings:G.game.criticratings||null,userratings:G.game.userratings||null,executables:G.game.executables||null,themes:G.game.themes??n.themes??null,platforms:G.game.platforms??n.platforms??null,gameModes:G.game.gameModes??n.gameModes??null,playerPerspectives:G.game.playerPerspectives??n.playerPerspectives??null,websites:G.game.websites??n.websites??null,ageRatings:G.game.ageRatings??n.ageRatings??null,developers:G.game.developers??n.developers??null,publishers:G.game.publishers??n.publishers??null,franchise:G.game.franchise??n.franchise??null,collection:G.game.collection??n.collection??null,screenshots:G.game.screenshots??n.screenshots??null,videos:G.game.videos??n.videos??null,gameEngines:G.game.gameEngines??n.gameEngines??null,keywords:G.game.keywords??n.keywords??null,alternativeNames:G.game.alternativeNames??n.alternativeNames??null,similarGames:G.game.similarGames??n.similarGames??null};if(ee.genre!==void 0){const Ne=Array.isArray(n.genre)?n.genre:n.genre?[n.genre]:[],kt=Array.isArray(je.genre)?je.genre:je.genre?[je.genre]:[],Ct=Ne.filter(We=>!kt.includes(We));for(const We of Ct)try{const Ke=_(H,`/categories/${encodeURIComponent(We)}`),ze=await fetch(Ke,{method:"DELETE",headers:{Accept:"application/json","X-Auth-Token":Ae}});ze.ok||(ze.status===409?await ze.json().catch(()=>{}):await ze.json().catch(()=>{}))}catch{}}d(je)}else if(X||fe||pe||we){let Y=q??n.cover,oe=Z??n.background;if(X&&(!Y||Y==="")||fe&&(!oe||oe==="")||pe&&Y===void 0||we&&oe===void 0){const ce=_(H,`/games/${n.id}`),xe=await fetch(ce,{method:"GET",headers:{Accept:"application/json","X-Auth-Token":Ae}});if(xe.ok){const je=await xe.json();(X||pe)&&Y===void 0&&(Y=je.game.cover||null),(fe||we)&&oe===void 0&&(oe=je.game.background||null)}}if((X||pe)&&Y){const ce=Y.includes("?")?"&":"?";Y=`${Y}${ce}t=${Date.now()}`}if((fe||we)&&oe){const ce=oe.includes("?")?"&":"?";oe=`${oe}${ce}t=${Date.now()}`}const G={...n,cover:Y,background:oe};d(G)}W(null),K(null),z(null),ie(null),te(!1),be(!1),o()}catch(q){ae(String(q.message||q))}finally{J(!1),l(!1)}},Je=q=>{const Z=q.target.files?.[0];if(Z){if(!Z.type.startsWith("image/")){ae(i("gameDetail.invalidImageType","File must be an image")),q.target.value="";return}const ee=new FileReader;ee.onloadend=()=>{W(ee.result)},ee.readAsDataURL(Z),z(Z),te(!1),ae(null),q.target.value=""}},yt=q=>{const Z=q.target.files?.[0];if(Z){if(!Z.type.startsWith("image/")){ae(i("gameDetail.invalidImageType","File must be an image")),q.target.value="";return}const ee=new FileReader;ee.onloadend=()=>{K(ee.result)},ee.readAsDataURL(Z),ie(Z),be(!1),ae(null),q.target.value=""}},xt=()=>{te(!0),W(null),z(null),Te(Date.now())},bt=()=>{be(!0),K(null),ie(null),Te(Date.now())};return e?Ce.createPortal(t.jsx("div",{className:"edit-game-modal-overlay",onClick:o,children:t.jsxs("div",{className:"edit-game-modal-container",onClick:q=>q.stopPropagation(),children:[t.jsxs("div",{className:"edit-game-modal-header",children:[t.jsxs("h2",{children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"8px",verticalAlign:"middle"},children:[t.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),t.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]}),i("gameDetail.editGame","Edit Game")]}),t.jsx("button",{className:"edit-game-modal-close",onClick:o,"aria-label":"Close",children:"×"})]}),t.jsxs("div",{className:"edit-game-modal-content",children:[me&&t.jsx("div",{className:"edit-game-modal-error",children:me}),t.jsxs("div",{className:"edit-game-modal-tabs",children:[t.jsx("button",{className:`edit-game-modal-tab ${ue==="INFO"?"active":""}`,onClick:()=>ne("INFO"),disabled:B,children:i("gameDetail.info","INFO")}),t.jsx("button",{className:`edit-game-modal-tab ${ue==="TAGS"?"active":""}`,onClick:()=>ne("TAGS"),disabled:B,children:i("gameDetail.tags","TAGS")}),t.jsx("button",{className:`edit-game-modal-tab ${ue==="MEDIA"?"active":""}`,onClick:()=>ne("MEDIA"),disabled:B,children:i("gameDetail.media","MEDIA")})]}),ue==="INFO"&&t.jsx(It,{t:i,title:a,summary:s,year:u,month:c,day:w,saving:B,setTitle:f,setSummary:m,setYear:g,setMonth:b,setDay:D}),ue==="TAGS"&&t.jsx(Ot,{t:i,isOpen:e,gameId:n.id,selectedGenres:x,selectedThemes:y,selectedKeywords:C,selectedPlatforms:v,selectedGameModes:N,selectedPublishers:k,selectedDevelopers:j,selectedPlayerPerspectives:$,selectedGameEngines:P,saving:B,setSelectedGenres:p,setSelectedThemes:R,setSelectedKeywords:h,setSelectedPlatforms:M,setSelectedGameModes:E,setSelectedPublishers:S,setSelectedDevelopers:A,setSelectedPlayerPerspectives:F,setSelectedGameEngines:V}),ue==="MEDIA"&&t.jsx(zt,{t:i,game:n,saving:B,coverRemoved:pe,coverPreview:Q,coverUrlWithTimestamp:$e,uploadingCover:le,coverInputRef:T,handleCoverFileSelect:Je,onGameUpdate:d,handleCoverRemoveSuccess:xt,backgroundRemoved:we,backgroundPreview:re,backgroundUrlWithTimestamp:De,uploadingBackground:U,backgroundInputRef:L,handleBackgroundFileSelect:yt,handleBackgroundRemoveSuccess:bt})]}),t.jsxs("div",{className:"edit-game-modal-footer",children:[t.jsx("button",{className:"edit-game-modal-cancel",onClick:o,disabled:B,children:i("common.cancel","Cancel")}),t.jsx("button",{className:"edit-game-modal-save",onClick:Re,disabled:B||!Pe(),children:B?i("common.saving","Saving..."):i("common.save","Save")})]})]})}),document.body):null}function Ut({isOpen:e,onClose:o,collection:n,onCollectionUpdate:d}){const{t:i}=ge(),{setLoading:l}=ve(),[a,f]=r.useState(n.title),[s,m]=r.useState(n.summary||""),[u,g]=r.useState(!1),[c,b]=r.useState(null),[w,D]=r.useState("INFO"),[x,p]=r.useState(!1),[y,R]=r.useState(!1),C=r.useRef(null),h=r.useRef(null),[v,M]=r.useState(null),[N,E]=r.useState(null),[k,S]=r.useState(null),[j,A]=r.useState(null),[$,F]=r.useState(!1),[P,V]=r.useState(!1),[B,J]=r.useState(Date.now()),me=r.useMemo(()=>{if(!n?.cover||n.cover.trim()==="")return"";const T=n.cover.split("?")[0].split("&")[0];if(T.startsWith("http"))return`${T}?t=${B}`;const L=_(H,T),Q=L.includes("?")?"&":"?";return`${L}${Q}t=${B}`},[n?.cover,B]),ae=r.useMemo(()=>{if(!n?.background||n.background.trim()==="")return"";const T=n.background.split("?")[0].split("&")[0];if(T.startsWith("http"))return`${T}?t=${B}`;const L=_(H,T),Q=L.includes("?")?"&":"?";return`${L}${Q}t=${B}`},[n?.background,B]);r.useEffect(()=>{e&&n?(f(n.title||""),m(n.summary||""),b(null),D("INFO"),M(null),E(null),S(null),A(null),F(!1),V(!1),J(Date.now())):e||(M(null),E(null),S(null),A(null))},[e,n]),r.useEffect(()=>{n&&(!n.cover&&!$&&!k&&(F(!0),M(null),J(Date.now())),!n.background&&!P&&!j&&(V(!0),E(null),J(Date.now())))},[n?.cover,n?.background]),r.useEffect(()=>{if(!e)return;function T(L){L.key==="Escape"&&(L.stopPropagation(),o())}return document.addEventListener("keydown",T,!0),document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",T,!0),document.body.style.overflow=""}},[e,o]);const ue=()=>a.trim()!==n.title.trim()||s.trim()!==(n.summary||"").trim()||k!==null||j!==null||$||P,ne=T=>{const L=T.target.files?.[0];if(L){if(!L.type.startsWith("image/")){b(i("gameDetail.invalidImageType","File must be an image")),T.target.value="";return}const Q=new FileReader;Q.onloadend=()=>{M(Q.result)},Q.readAsDataURL(L),S(L),F(!1),b(null),T.target.value=""}},le=T=>{const L=T.target.files?.[0];if(L){if(!L.type.startsWith("image/")){b(i("gameDetail.invalidImageType","File must be an image")),T.target.value="";return}const Q=new FileReader;Q.onloadend=()=>{E(Q.result)},Q.readAsDataURL(L),A(L),V(!1),b(null),T.target.value=""}},I=()=>{F(!0),M(null),S(null),J(Date.now())},U=()=>{V(!0),E(null),A(null),J(Date.now())},O=async()=>{g(!0),b(null),l(!0);try{let T=null,L=null;if($)try{const W=_(H,`/collections/${n.id}/delete-cover`),re=await fetch(W,{method:"DELETE",headers:{"X-Auth-Token":se()||""}});if(!re.ok){const X=await re.json().catch(()=>({error:"Failed to remove cover"}));throw new Error(X.error||"Failed to remove cover")}const K=await re.json();K.collection&&(T=K.collection.cover||null)}catch(W){b(String(W.message||W)),g(!1),l(!1);return}if(P)try{const W=_(H,`/collections/${n.id}/delete-background`),re=await fetch(W,{method:"DELETE",headers:{"X-Auth-Token":se()||""}});if(!re.ok){const X=await re.json().catch(()=>({error:"Failed to remove background"}));throw new Error(X.error||"Failed to remove background")}const K=await re.json();K.collection&&(L=K.collection.background||null)}catch(W){b(String(W.message||W)),g(!1),l(!1);return}if(k){p(!0);try{const W=new FormData;W.append("file",k);const re=_(H,`/collections/${n.id}/upload-cover`),K=await fetch(re,{method:"POST",headers:{"X-Auth-Token":se()||""},body:W});if(!K.ok){const z=await K.json().catch(()=>({error:"Failed to upload cover"}));throw new Error(z.error||"Failed to upload cover")}const X=await K.json();X.collection&&(X.collection.cover&&(T=X.collection.cover),X.collection.background&&!L&&(L=X.collection.background))}catch(W){p(!1),l(!1),g(!1),b(String(W.message||W));return}finally{p(!1)}}if(j){R(!0);try{const W=new FormData;W.append("file",j);const re=_(H,`/collections/${n.id}/upload-background`),K=await fetch(re,{method:"POST",headers:{"X-Auth-Token":se()||""},body:W});if(!K.ok){const z=await K.json().catch(()=>({error:"Failed to upload background"}));throw new Error(z.error||"Failed to upload background")}const X=await K.json();X.collection&&(X.collection.background&&(L=X.collection.background),X.collection.cover&&!T&&(T=X.collection.cover))}catch(W){R(!1),l(!1),g(!1),b(String(W.message||W));return}finally{R(!1)}}const Q={};if(a.trim()!==n.title.trim()&&(Q.title=a.trim()),s.trim()!==(n.summary||"").trim()&&(Q.summary=s.trim()),Object.keys(Q).length>0){const W=_(H,`/collections/${n.id}`),re=await fetch(W,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":Ae},body:JSON.stringify(Q)});if(!re.ok){const ie=await re.json();throw new Error(ie.error||"Failed to update collection")}const K=await re.json();let X=T!==null?T:K.collection.cover,z=L!==null?L:K.collection.background;if(T&&X){const ie=X.includes("?")?"&":"?";X=`${X}${ie}t=${Date.now()}`}if(L&&z){const ie=z.includes("?")?"&":"?";z=`${z}${ie}t=${Date.now()}`}const fe={id:K.collection.id,title:K.collection.title,summary:K.collection.summary,cover:X,background:z};window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collection:fe}})),d(fe)}else if(k||j||$||P){const W=_(H,`/collections/${n.id}`),re=await fetch(W,{method:"GET",headers:{Accept:"application/json","X-Auth-Token":Ae}});if(re.ok){const K=await re.json();let X=T!==null?T:K.cover,z=L!==null?L:K.background;if((T!==null||$)&&X){const ie=X.includes("?")?"&":"?";X=`${X}${ie}t=${Date.now()}`}if((L!==null||P)&&z){const ie=z.includes("?")?"&":"?";z=`${z}${ie}t=${Date.now()}`}const fe={id:K.id,title:K.title,summary:K.summary||"",cover:X,background:z};window.dispatchEvent(new CustomEvent("collectionUpdated",{detail:{collection:fe}})),d(fe)}}else{o();return}o()}catch(T){b(String(T.message||T))}finally{g(!1),l(!1)}};return e?Ce.createPortal(t.jsx("div",{className:"edit-collection-modal-overlay",onClick:o,children:t.jsxs("div",{className:"edit-collection-modal-container",onClick:T=>T.stopPropagation(),children:[t.jsxs("div",{className:"edit-collection-modal-header",children:[t.jsxs("h2",{children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{marginRight:"8px",verticalAlign:"middle"},children:[t.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),t.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]}),i("collectionDetail.editCollection","Edit Collection")]}),t.jsx("button",{className:"edit-collection-modal-close",onClick:o,"aria-label":"Close",children:"×"})]}),t.jsxs("div",{className:"edit-collection-modal-content",children:[c&&t.jsx("div",{className:"edit-collection-modal-error",children:c}),t.jsxs("div",{className:"edit-collection-modal-tabs",children:[t.jsx("button",{className:`edit-collection-modal-tab ${w==="INFO"?"active":""}`,onClick:()=>D("INFO"),disabled:u,children:i("gameDetail.info","INFO")}),t.jsx("button",{className:`edit-collection-modal-tab ${w==="MEDIA"?"active":""}`,onClick:()=>D("MEDIA"),disabled:u,children:i("gameDetail.media","MEDIA")})]}),w==="INFO"&&t.jsxs("div",{className:"edit-collection-modal-info",children:[t.jsxs("div",{className:"edit-collection-modal-field",children:[t.jsx("label",{htmlFor:"edit-collection-title",children:i("collectionDetail.title","Title")}),t.jsx("input",{id:"edit-collection-title",name:"title",type:"text",value:a,onChange:T=>f(T.target.value),disabled:u})]}),t.jsxs("div",{className:"edit-collection-modal-field",children:[t.jsx("label",{htmlFor:"edit-collection-summary",children:i("collectionDetail.summary","Summary")}),t.jsx("textarea",{id:"edit-collection-summary",name:"summary",value:s,onChange:T=>m(T.target.value),disabled:u,rows:15})]})]}),w==="MEDIA"&&t.jsxs("div",{className:"edit-collection-modal-media",children:[t.jsxs("div",{className:"edit-collection-modal-media-row",children:[t.jsxs("div",{className:"edit-collection-modal-media-info",children:[t.jsx("div",{className:"edit-collection-modal-label",children:i("gameDetail.cover","Cover")}),t.jsx("div",{className:"edit-collection-modal-media-description",children:i("gameDetail.coverFormat","Recommended format: WebP, ratio 2:3 (e.g., 400x600px)")})]}),t.jsx("div",{className:"edit-collection-modal-media-image-container",children:(()=>{const T=$?"":v||me,L=T&&T.trim()!=="";return t.jsxs(t.Fragment,{children:[t.jsx(Le,{title:n.title,coverUrl:T,width:150,height:200,showTitle:!1,detail:!1,play:!1,showBorder:!0,aspectRatio:"3/4",onUpload:()=>!x&&!u&&C.current?.click(),uploading:x,showRemoveButton:!!L&&!$,removeMediaType:"cover",removeResourceId:n.id,removeResourceType:"collections",onCollectionUpdate:d,onRemoveSuccess:I,removeDisabled:u||x},`cover-${$?"removed":v?"preview":me}`),t.jsx("input",{ref:C,id:"edit-collection-cover-input",name:"cover",type:"file",accept:"image/*",style:{display:"none"},onChange:ne,"aria-label":i("gameDetail.cover","Cover")})]})})()})]}),t.jsxs("div",{className:"edit-collection-modal-media-row",children:[t.jsxs("div",{className:"edit-collection-modal-media-info",children:[t.jsx("div",{className:"edit-collection-modal-label",children:i("gameDetail.background","Background")}),t.jsx("div",{className:"edit-collection-modal-media-description",children:i("gameDetail.backgroundFormat","Recommended format: WebP, ratio 16:9 (e.g., 1920x1080px)")})]}),t.jsx("div",{className:"edit-collection-modal-media-image-container",children:(()=>{const T=P?"":N||ae,L=T&&T.trim()!=="";return t.jsxs(t.Fragment,{children:[t.jsx(Le,{title:n.title,coverUrl:T,width:300,height:169,showTitle:!1,detail:!1,play:!1,showBorder:!0,aspectRatio:"16/9",onUpload:()=>!y&&!u&&h.current?.click(),uploading:y,showRemoveButton:!!L&&!P,removeMediaType:"background",removeResourceId:n.id,removeResourceType:"collections",onCollectionUpdate:d,onRemoveSuccess:U,removeDisabled:u||y},`background-${P?"removed":N?"preview":ae}`),t.jsx("input",{ref:h,id:"edit-collection-background-input",name:"background",type:"file",accept:"image/*",style:{display:"none"},onChange:le,"aria-label":i("gameDetail.background","Background")})]})})()})]})]})]}),t.jsxs("div",{className:"edit-collection-modal-footer",children:[t.jsx("button",{className:"edit-collection-modal-cancel",onClick:o,disabled:u,children:i("common.cancel","Cancel")}),t.jsx("button",{className:"edit-collection-modal-save",onClick:O,disabled:u||!ue(),children:u?i("common.saving","Saving..."):i("common.save","Save")})]})]})}),document.body):null}function Wt({rating:e,starSize:o=16,gap:n=4,color:d="#ffffff",noStroke:i=!1,readOnly:l=!0,onRatingChange:a}){const[f,s]=r.useState(null),m=(b,w)=>{if(!l&&a){const x=(w?b-.5:b)*2;a(x)}},u=(b,w)=>{if(!l){const D=w?b-.5:b;s(D)}},g=()=>{l||s(null)},c=f!==null?f:e;return t.jsx("div",{style:{display:"flex",alignItems:"center",gap:`${n}px`},onMouseLeave:g,children:[1,2,3,4,5].map(b=>{const w=c>=b,D=c>=b-.5&&c<b,x=`star-${b}-${c}`;return t.jsxs("div",{style:{position:"relative",width:`${o}px`,height:`${o}px`,cursor:l?"default":"pointer"},children:[t.jsx("svg",{width:o,height:o,viewBox:"0 0 24 24",fill:"none",stroke:"rgba(255, 255, 255, 0.3)",strokeWidth:"1.5",style:{position:"absolute",top:0,left:0},children:t.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"})}),!l&&t.jsx("div",{style:{position:"absolute",top:0,left:0,width:`${o/2}px`,height:`${o}px`,cursor:"pointer",zIndex:10},onClick:()=>m(b,!0),onMouseEnter:()=>u(b,!0)}),!l&&t.jsx("div",{style:{position:"absolute",top:0,right:0,width:`${o/2}px`,height:`${o}px`,cursor:"pointer",zIndex:10},onClick:()=>m(b,!1),onMouseEnter:()=>u(b,!1)}),w&&t.jsx("svg",{width:o,height:o,viewBox:"0 0 24 24",fill:d,stroke:i?"none":d,strokeWidth:i?"0":"1.5",style:{position:"absolute",top:0,left:0,pointerEvents:"none"},children:t.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"})}),D&&t.jsxs("svg",{width:o,height:o,viewBox:"0 0 24 24",fill:"none",stroke:i?"none":d,strokeWidth:i?"0":"1.5",style:{position:"absolute",top:0,left:0,pointerEvents:"none"},children:[t.jsx("defs",{children:t.jsxs("linearGradient",{id:x,x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[t.jsx("stop",{offset:"50%",stopColor:d}),t.jsx("stop",{offset:"50%",stopColor:"transparent"})]})}),t.jsx("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z",fill:`url(#${x})`})]})]},b)})})}function Ht({summary:e,truncateOnly:o=!1,maxLines:n=4,fontSize:d}){const{t:i}=ge(),[l,a]=r.useState(!1),[f,s]=r.useState(!1),m=r.useRef(null);return r.useEffect(()=>{if(m.current&&!o){const g=parseFloat(getComputedStyle(m.current).lineHeight)*n;m.current.scrollHeight>g&&s(!0)}},[e,o,n]),e?t.jsxs("div",{style:{marginTop:"16px"},children:[t.jsx("div",{ref:m,className:"text-white",style:{opacity:.8,fontFamily:"var(--font-body-1-font-family)",fontSize:d||"var(--font-body-1-font-size)",lineHeight:"var(--font-body-1-line-height)",display:"-webkit-box",WebkitLineClamp:l?"none":n,WebkitBoxOrient:"vertical",overflow:l?"visible":"hidden",textOverflow:l?"clip":"ellipsis"},children:e}),f&&!o&&t.jsxs("button",{onClick:()=>a(!l),style:{backgroundColor:"transparent",border:"none",color:"#E5A00D",cursor:"pointer",padding:0,marginTop:"8px",fontFamily:"var(--font-body-1-font-family)",fontSize:"var(--font-body-1-font-size)",lineHeight:"var(--font-body-1-line-height)",display:"flex",alignItems:"center",gap:"4px"},children:[t.jsx("span",{children:i(l?"common.less":"common.more")}),t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",style:{transform:l?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.2s ease"},children:t.jsx("path",{d:"M7 10l5 5 5-5",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})]})]}):null}const ut=r.createContext(null);function mt(){const e=r.useContext(ut);return e||{hasBackground:!1,isBackgroundVisible:!1,setBackgroundVisible:()=>{}}}const ft="backgroundStates",ht=()=>{try{const e=localStorage.getItem(ft);return e?JSON.parse(e):{}}catch{return{}}},Vt=(e,o)=>{const n=ht();n[e]=o,localStorage.setItem(ft,JSON.stringify(n))},Ze=(e,o)=>ht()[e]??o;function Gt({backgroundUrl:e,hasBackground:o,elementId:n,children:d}){const[i,l]=r.useState(()=>Ze(n,o));r.useEffect(()=>{if(o){const s=Ze(n,o);l(s)}else l(!1)},[o,e,n]);const a=r.useCallback(s=>{l(s),Vt(n,s)},[n]),f=r.useMemo(()=>({hasBackground:o,isBackgroundVisible:i,setBackgroundVisible:a}),[o,i,a]);return t.jsxs(ut.Provider,{value:f,children:[t.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:o&&i?"transparent":"#1a1a1a",backgroundImage:o&&i?`url(${e})`:void 0,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundAttachment:"fixed",zIndex:0,cursor:o&&i?"pointer":"default"},onClick:()=>{o&&i&&a(!1)},children:o&&i&&t.jsxs(t.Fragment,{children:[t.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(26, 26, 26, 0.85)",zIndex:1}}),t.jsx("img",{src:e,alt:"",style:{display:"none"}})]})}),t.jsx("div",{style:{position:"relative",zIndex:2},children:d})]})}function _t({value:e,onChange:o,min:n=100,max:d=200}){return t.jsx("div",{className:"cover-size-slider-container",children:t.jsx("input",{id:"cover-size-slider",name:"coverSize",type:"range",min:n,max:d,value:e,onChange:i=>o(Number(i.target.value)),className:"cover-size-slider","aria-label":"Cover size"})})}function Xt({value:e,onChange:o,disabled:n=!1}){const{t:d,i18n:i}=ge(),[l,a]=r.useState(!1),[f,s]=r.useState(!1),m=r.useRef(null),u=r.useMemo(()=>[{key:"grid",label:d("viewMode.grid"),icon:"⊞"},{key:"detail",label:d("viewMode.detail"),icon:"☰"},{key:"table",label:d("viewMode.table"),icon:"☷"}],[d,i.language]),g=u.find(c=>c.key===e)||u[0];return r.useEffect(()=>{function c(w){m.current&&!m.current.contains(w.target)&&a(!1)}function b(w){w.key==="Escape"&&a(!1)}if(l)return document.addEventListener("mousedown",c),document.addEventListener("keydown",b),()=>{document.removeEventListener("mousedown",c),document.removeEventListener("keydown",b)}},[l]),t.jsxs("div",{ref:m,className:"view-mode-selector",children:[t.jsxs("button",{onClick:()=>!n&&a(!l),type:"button",className:`view-mode-button ${n?"disabled":""}`,disabled:n,onMouseEnter:()=>{n||s(!0)},onMouseLeave:()=>{n||s(!1)},children:[t.jsx("span",{className:`view-mode-icon ${f&&!n?"hover":""}`,children:g.icon}),!n&&t.jsx("svg",{width:"12",height:"12",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:2,className:`view-mode-arrow ${l?"open":""}`,children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 9l-7 7-7-7"})})]}),l&&!n&&t.jsx("div",{className:"view-mode-dropdown",children:u.map(c=>t.jsxs("button",{onClick:()=>{o(c.key),a(!1)},type:"button",className:`view-mode-option ${e===c.key?"active":""}`,children:[t.jsx("span",{className:"view-mode-option-icon",children:c.icon}),t.jsx("span",{children:c.label})]},c.key))})]})}function qt({isVisible:e,onChange:o,disabled:n=!1}){const{t:d}=ge();return t.jsx("button",{className:"background-toggle-button",onClick:()=>!n&&o(!e),disabled:n,"aria-label":d(e?"common.hideBackground":"common.showBackground"),title:d(e?"common.hideBackground":"common.showBackground"),children:t.jsx("span",{className:"background-toggle-icon",children:t.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e?t.jsx("path",{d:"M4 4h16v16H4V4zm2 2v12h12V6H6zm2 2h8v8H8V8z",fill:"currentColor"}):t.jsx("path",{d:"M4 4h16v16H4V4zm2 2v12h12V6H6z",fill:"currentColor",opacity:"0.5"})})})})}function Jt({libraries:e,activeLibrary:o,onSelectLibrary:n,loading:d,error:i,coverSize:l=150,onCoverSizeChange:a,viewMode:f="grid",onViewModeChange:s,hideBackgroundToggle:m=!1,onReloadMetadata:u}){const{t:g}=ge(),{isLoading:c}=ve(),{hasBackground:b,isBackgroundVisible:w,setBackgroundVisible:D}=mt(),x=d!==void 0?d:c,[p,y]=r.useState(!1),R=r.useRef(null),C=r.useRef(null);r.useEffect(()=>{if(!o){y(!1);return}const v=()=>{if(window.innerWidth<800){y(!0);return}if(R.current&&C.current){const E=R.current.offsetWidth,k=C.current.offsetWidth,S=E-k-180,j=e.length*110;y(S<j)}};v();const M=setTimeout(v,100);return window.addEventListener("resize",v),()=>{clearTimeout(M),window.removeEventListener("resize",v)}},[e,f,l,o]);const h=v=>{const M=e.find(N=>N.key===v.target.value);M&&n(M)};return t.jsx("div",{className:"mhg-libraries-bar",children:t.jsxs("div",{className:"mhg-libraries-bar-container",ref:R,children:[se()&&t.jsx("div",{className:"mhg-libraries-menu-container",children:t.jsx(qe,{className:"mhg-libraries-menu-dropdown",onReload:u})}),o&&t.jsx(t.Fragment,{children:p?t.jsxs("div",{className:"mhg-libraries-combobox-container",children:[x&&e.length===0?null:t.jsx("select",{id:"libraries-select",name:"library",className:"mhg-libraries-combobox",value:o?.key||"",onChange:h,children:e.map(v=>t.jsx("option",{value:v.key,children:v.title||g(`libraries.${v.key}`)},v.key))}),i&&t.jsx("div",{className:"mhg-libraries-error",children:i})]}):t.jsxs("div",{className:"mhg-libraries-container",children:[x&&e.length===0?null:e.map(v=>t.jsx("button",{className:`mhg-library-button ${o?.key===v.key?"mhg-library-active":""}`,onClick:()=>n(v),children:v.title||g(`libraries.${v.key}`)},v.key)),i&&t.jsx("div",{className:"mhg-libraries-error",children:i})]})}),t.jsxs("div",{className:"mhg-libraries-actions",ref:C,children:[b&&!m&&t.jsx("div",{className:"mhg-libraries-actions-background-toggle-container",children:t.jsx(qt,{isVisible:w,onChange:D})}),a&&t.jsx("div",{className:`mhg-libraries-actions-slider-container ${f==="grid"?"":"hidden"}`,children:t.jsx(_t,{value:l,onChange:a})}),s&&t.jsx("div",{className:"mhg-libraries-actions-view-mode-container",children:t.jsx(Xt,{value:f,onChange:s,disabled:o?o.key!=="library"&&o.key!=="category":!1})})]})]})})}function Kt(e){let o=e;for(;o;){if(o.dir)return o.dir==="rtl";o=o.parentElement}return!1}function Yt(e,o){const[n,d]=r.useState(o==="rtl");return r.useLayoutEffect(()=>{e&&(o||d(Kt(e)))},[o,e]),n}const Fe=typeof window<"u"?r.useLayoutEffect:r.useEffect;function et(e){if(e!==void 0)switch(typeof e){case"number":return e;case"string":{if(e.endsWith("px"))return parseFloat(e);break}}}function Qt({box:e,defaultHeight:o,defaultWidth:n,disabled:d,element:i,mode:l,style:a}){const{styleHeight:f,styleWidth:s}=r.useMemo(()=>({styleHeight:et(a?.height),styleWidth:et(a?.width)}),[a?.height,a?.width]),[m,u]=r.useState({height:o,width:n}),g=d||l==="only-height"&&f!==void 0||l==="only-width"&&s!==void 0||f!==void 0&&s!==void 0;return Fe(()=>{if(i===null||g)return;const c=new ResizeObserver(b=>{for(const w of b){const{contentRect:D,target:x}=w;i===x&&u(p=>p.height===D.height&&p.width===D.width?p:{height:D.height,width:D.width})}});return c.observe(i,{box:e}),()=>{c?.unobserve(i)}},[e,g,i,f,s]),r.useMemo(()=>({height:f??m.height,width:s??m.width}),[m,f,s])}function Zt(e){const o=r.useRef(()=>{throw new Error("Cannot call during render.")});return Fe(()=>{o.current=e},[e]),r.useCallback(n=>o.current?.(n),[o])}let Me=null;function en(e=!1){if(Me===null||e){const o=document.createElement("div"),n=o.style;n.width="50px",n.height="50px",n.overflow="scroll",n.direction="rtl";const d=document.createElement("div"),i=d.style;return i.width="100px",i.height="100px",o.appendChild(d),document.body.appendChild(o),o.scrollLeft>0?Me="positive-descending":(o.scrollLeft=1,o.scrollLeft===0?Me="negative":Me="positive-ascending"),document.body.removeChild(o),Me}return Me}function Ve({containerElement:e,direction:o,isRtl:n,scrollOffset:d}){if(o==="horizontal"&&n)switch(en()){case"negative":return-d;case"positive-descending":{if(e){const{clientWidth:i,scrollLeft:l,scrollWidth:a}=e;return a-i-l}break}}return d}function Ee(e,o="Assertion error"){if(!e)throw console.error(o),Error(o)}function Ie(e,o){if(e===o)return!0;if(!!e!=!!o||(Ee(e!==void 0),Ee(o!==void 0),Object.keys(e).length!==Object.keys(o).length))return!1;for(const n in e)if(!Object.is(o[n],e[n]))return!1;return!0}function gt({cachedBounds:e,itemCount:o,itemSize:n}){if(o===0)return 0;if(typeof n=="number")return o*n;{const d=e.get(e.size===0?0:e.size-1);Ee(d!==void 0,"Unexpected bounds cache miss");const i=(d.scrollOffset+d.size)/e.size;return o*i}}function tn({align:e,cachedBounds:o,index:n,itemCount:d,itemSize:i,containerScrollOffset:l,containerSize:a}){if(n<0||n>=d)throw RangeError(`Invalid index specified: ${n}`,{cause:`Index ${n} is not within the range of 0 - ${d-1}`});const f=gt({cachedBounds:o,itemCount:d,itemSize:i}),s=o.get(n),m=Math.max(0,Math.min(f-a,s.scrollOffset)),u=Math.max(0,s.scrollOffset-a+s.size);switch(e==="smart"&&(l>=u&&l<=m?e="auto":e="center"),e){case"start":return m;case"end":return u;case"center":return s.scrollOffset<=a/2?0:s.scrollOffset+s.size/2>=f-a/2?f-a:s.scrollOffset+s.size/2-a/2;case"auto":default:return l>=u&&l<=m?l:l<u?u:m}}function Ge({cachedBounds:e,containerScrollOffset:o,containerSize:n,itemCount:d,overscanCount:i}){const l=d-1;let a=0,f=-1,s=0,m=-1,u=0;for(;u<l;){const g=e.get(u);if(g.scrollOffset+g.size>o)break;u++}for(a=u,s=Math.max(0,a-i);u<l;){const g=e.get(u);if(g.scrollOffset+g.size>=o+n)break;u++}return f=Math.min(l,u),m=Math.min(d-1,f+i),a<0&&(a=0,f=-1,s=0,m=-1),{startIndexVisible:a,stopIndexVisible:f,startIndexOverscan:s,stopIndexOverscan:m}}function nn({itemCount:e,itemProps:o,itemSize:n}){const d=new Map;return{get(i){for(Ee(i<e,`Invalid index ${i}`);d.size-1<i;){const a=d.size;let f;switch(typeof n){case"function":{f=n(a,o);break}case"number":{f=n;break}}if(a===0)d.set(a,{size:f,scrollOffset:0});else{const s=d.get(a-1);Ee(s!==void 0,`Unexpected bounds cache miss for index ${i}`),d.set(a,{scrollOffset:s.scrollOffset+s.size,size:f})}}const l=d.get(i);return Ee(l!==void 0,`Unexpected bounds cache miss for index ${i}`),l},set(i,l){d.set(i,l)},get size(){return d.size}}}function on({itemCount:e,itemProps:o,itemSize:n}){return r.useMemo(()=>nn({itemCount:e,itemProps:o,itemSize:n}),[e,o,n])}function sn({containerSize:e,itemSize:o}){let n;switch(typeof o){case"string":{Ee(o.endsWith("%"),`Invalid item size: "${o}"; string values must be percentages (e.g. "100%")`),Ee(e!==void 0,"Container size must be defined if a percentage item size is specified"),n=e*parseInt(o)/100;break}default:{n=o;break}}return n}function _e({containerElement:e,containerStyle:o,defaultContainerSize:n=0,direction:d,isRtl:i=!1,itemCount:l,itemProps:a,itemSize:f,onResize:s,overscanCount:m}){const{height:u=n,width:g=n}=Qt({defaultHeight:d==="vertical"?n:void 0,defaultWidth:d==="horizontal"?n:void 0,element:e,mode:d==="vertical"?"only-height":"only-width",style:o}),c=r.useRef({height:0,width:0}),b=d==="vertical"?u:g,w=sn({containerSize:b,itemSize:f});r.useLayoutEffect(()=>{if(typeof s=="function"){const k=c.current;(k.height!==u||k.width!==g)&&(s({height:u,width:g},{...k}),k.height=u,k.width=g)}},[u,s,g]);const D=on({itemCount:l,itemProps:a,itemSize:w}),x=r.useCallback(k=>D.get(k),[D]),[p,y]=r.useState(()=>Ge({cachedBounds:D,containerScrollOffset:0,containerSize:b,itemCount:l,overscanCount:m})),{startIndexVisible:R,startIndexOverscan:C,stopIndexVisible:h,stopIndexOverscan:v}={startIndexVisible:Math.min(l-1,p.startIndexVisible),startIndexOverscan:Math.min(l-1,p.startIndexOverscan),stopIndexVisible:Math.min(l-1,p.stopIndexVisible),stopIndexOverscan:Math.min(l-1,p.stopIndexOverscan)},M=r.useCallback(()=>gt({cachedBounds:D,itemCount:l,itemSize:w}),[D,l,w]),N=r.useCallback(k=>{const S=Ve({containerElement:e,direction:d,isRtl:i,scrollOffset:k});return Ge({cachedBounds:D,containerScrollOffset:S,containerSize:b,itemCount:l,overscanCount:m})},[D,e,b,d,i,l,m]);Fe(()=>{const k=(d==="vertical"?e?.scrollTop:e?.scrollLeft)??0;y(N(k))},[e,d,N]),Fe(()=>{if(!e)return;const k=()=>{y(S=>{const{scrollLeft:j,scrollTop:A}=e,$=Ve({containerElement:e,direction:d,isRtl:i,scrollOffset:d==="vertical"?A:j}),F=Ge({cachedBounds:D,containerScrollOffset:$,containerSize:b,itemCount:l,overscanCount:m});return Ie(F,S)?S:F})};return e.addEventListener("scroll",k),()=>{e.removeEventListener("scroll",k)}},[D,e,b,d,l,m]);const E=Zt(({align:k="auto",containerScrollOffset:S,index:j})=>{let A=tn({align:k,cachedBounds:D,containerScrollOffset:S,containerSize:b,index:j,itemCount:l,itemSize:w});if(e){if(A=Ve({containerElement:e,direction:d,isRtl:i,scrollOffset:A}),typeof e.scrollTo!="function"){const $=N(A);Ie(p,$)||y($)}return A}});return{getCellBounds:x,getEstimatedSize:M,scrollToIndex:E,startIndexOverscan:C,startIndexVisible:R,stopIndexOverscan:v,stopIndexVisible:h}}function pt(e){return r.useMemo(()=>e,Object.values(e))}function vt(e,o){const{ariaAttributes:n,style:d,...i}=e,{ariaAttributes:l,style:a,...f}=o;return Ie(n,l)&&Ie(d,a)&&Ie(i,f)}function rn({cellComponent:e,cellProps:o,children:n,className:d,columnCount:i,columnWidth:l,defaultHeight:a=0,defaultWidth:f=0,dir:s,gridRef:m,onCellsRendered:u,onResize:g,overscanCount:c=3,rowCount:b,rowHeight:w,style:D,tagName:x="div",...p}){const y=pt(o),R=r.useMemo(()=>r.memo(e,vt),[e]),[C,h]=r.useState(null),v=Yt(C,s),{getCellBounds:M,getEstimatedSize:N,startIndexOverscan:E,startIndexVisible:k,scrollToIndex:S,stopIndexOverscan:j,stopIndexVisible:A}=_e({containerElement:C,containerStyle:D,defaultContainerSize:f,direction:"horizontal",isRtl:v,itemCount:i,itemProps:y,itemSize:l,onResize:g,overscanCount:c}),{getCellBounds:$,getEstimatedSize:F,startIndexOverscan:P,startIndexVisible:V,scrollToIndex:B,stopIndexOverscan:J,stopIndexVisible:me}=_e({containerElement:C,containerStyle:D,defaultContainerSize:a,direction:"vertical",itemCount:b,itemProps:y,itemSize:w,onResize:g,overscanCount:c});r.useImperativeHandle(m,()=>({get element(){return C},scrollToCell({behavior:ne="auto",columnAlign:le="auto",columnIndex:I,rowAlign:U="auto",rowIndex:O}){const T=S({align:le,containerScrollOffset:C?.scrollLeft??0,index:I}),L=B({align:U,containerScrollOffset:C?.scrollTop??0,index:O});typeof C?.scrollTo=="function"&&C.scrollTo({behavior:ne,left:T,top:L})},scrollToColumn({align:ne="auto",behavior:le="auto",index:I}){const U=S({align:ne,containerScrollOffset:C?.scrollLeft??0,index:I});typeof C?.scrollTo=="function"&&C.scrollTo({behavior:le,left:U})},scrollToRow({align:ne="auto",behavior:le="auto",index:I}){const U=B({align:ne,containerScrollOffset:C?.scrollTop??0,index:I});typeof C?.scrollTo=="function"&&C.scrollTo({behavior:le,top:U})}}),[C,S,B]),r.useEffect(()=>{E>=0&&j>=0&&P>=0&&J>=0&&u&&u({columnStartIndex:k,columnStopIndex:A,rowStartIndex:V,rowStopIndex:me},{columnStartIndex:E,columnStopIndex:j,rowStartIndex:P,rowStopIndex:J})},[u,E,k,j,A,P,V,J,me]);const ae=r.useMemo(()=>{const ne=[];if(i>0&&b>0)for(let le=P;le<=J;le++){const I=$(le),U=[];for(let O=E;O<=j;O++){const T=M(O);U.push(r.createElement(R,{...y,ariaAttributes:{"aria-colindex":O+1,role:"gridcell"},columnIndex:O,key:O,rowIndex:le,style:{position:"absolute",left:v?void 0:0,right:v?0:void 0,transform:`translate(${v?-T.scrollOffset:T.scrollOffset}px, ${I.scrollOffset}px)`,height:I.size,width:T.size}}))}ne.push(t.jsx("div",{role:"row","aria-rowindex":le+1,children:U},le))}return ne},[R,y,i,E,j,M,$,v,b,P,J]),ue=t.jsx("div",{"aria-hidden":!0,style:{height:F(),width:N(),zIndex:-1}});return r.createElement(x,{"aria-colcount":i,"aria-rowcount":b,role:"grid",...p,className:d,dir:s,ref:h,style:{position:"relative",maxHeight:"100%",maxWidth:"100%",flexGrow:1,overflow:"auto",...D}},ae,n,ue)}function an(e){return e!=null&&typeof e=="object"&&"getAverageRowHeight"in e&&typeof e.getAverageRowHeight=="function"}const ln="data-react-window-index";function Dn({children:e,className:o,defaultHeight:n=0,listRef:d,onResize:i,onRowsRendered:l,overscanCount:a=3,rowComponent:f,rowCount:s,rowHeight:m,rowProps:u,tagName:g="div",style:c,...b}){const w=pt(u),D=r.useMemo(()=>r.memo(f,vt),[f]),[x,p]=r.useState(null),y=an(m),R=r.useMemo(()=>y?A=>m.getRowHeight(A)??m.getAverageRowHeight():m,[y,m]),{getCellBounds:C,getEstimatedSize:h,scrollToIndex:v,startIndexOverscan:M,startIndexVisible:N,stopIndexOverscan:E,stopIndexVisible:k}=_e({containerElement:x,containerStyle:c,defaultContainerSize:n,direction:"vertical",itemCount:s,itemProps:w,itemSize:R,onResize:i,overscanCount:a});r.useImperativeHandle(d,()=>({get element(){return x},scrollToRow({align:A="auto",behavior:$="auto",index:F}){const P=v({align:A,containerScrollOffset:x?.scrollTop??0,index:F});typeof x?.scrollTo=="function"&&x.scrollTo({behavior:$,top:P})}}),[x,v]),Fe(()=>{if(!x)return;const A=Array.from(x.children).filter(($,F)=>{if($.hasAttribute("aria-hidden"))return!1;const P=`${M+F}`;return $.setAttribute(ln,P),!0});if(y)return m.observeRowElements(A)},[x,y,m,M,E]),r.useEffect(()=>{M>=0&&E>=0&&l&&l({startIndex:N,stopIndex:k},{startIndex:M,stopIndex:E})},[l,M,N,E,k]);const S=r.useMemo(()=>{const A=[];if(s>0)for(let $=M;$<=E;$++){const F=C($);A.push(r.createElement(D,{...w,ariaAttributes:{"aria-posinset":$+1,"aria-setsize":s,role:"listitem"},key:$,index:$,style:{position:"absolute",left:0,transform:`translateY(${F.scrollOffset}px)`,height:y?void 0:F.size,width:"100%"}}))}return A},[D,C,y,s,w,M,E]),j=t.jsx("div",{"aria-hidden":!0,style:{height:h(),width:"100%",zIndex:-1}});return r.createElement(g,{role:"list",...b,className:o,ref:p,style:{position:"relative",maxHeight:"100%",flexGrow:1,overflowY:"auto",...c}},S,e,j)}function cn(e){try{const o=sessionStorage.getItem(e);if(!o)return null;const n=JSON.parse(o);return{scrollTop:n.scrollTop??0,scrollLeft:n.scrollLeft??0}}catch{return null}}function dn(e,o,n){try{sessionStorage.setItem(e,JSON.stringify({scrollTop:o,scrollLeft:n}))}catch{}}const Se=40,un=2;function mn({games:e,coverSize:o,containerRef:n,itemRefs:d,onGameClick:i,onPlay:l,onEditClick:a,onGameDelete:f,onGameUpdate:s,buildCoverUrl:m,allCollections:u=[],collectionId:g,onRemoveFromCollection:c}){const b=st(),[w,D]=r.useState({width:0,height:0}),[x,p]=r.useState(!1),y=r.useRef(null),R=r.useRef(!1),C=r.useRef(null),h=`${b.pathname}:grid`;r.useEffect(()=>{n&&"current"in n&&n.current&&(n.current.__virtualizedGridRef=y)},[n]);const v=r.useMemo(()=>{if(w.width===0)return 1;const S=o+Se;return Math.max(1,Math.floor((w.width+Se)/S))},[w.width,o]),M=r.useMemo(()=>Math.ceil(e.length/v),[e.length,v]),N=o,E=o*1.5+Se;r.useEffect(()=>{const S=()=>{if(n.current){const A=n.current.getBoundingClientRect();D({width:A.width-40,height:A.height||window.innerHeight-200})}};S(),window.addEventListener("resize",S);const j=new ResizeObserver(S);return n.current&&j.observe(n.current),()=>{window.removeEventListener("resize",S),j.disconnect()}},[n]),r.useEffect(()=>{const S=cn(h);if(!S||S.scrollTop===0&&S.scrollLeft===0){p(!0);return}if(w.height===0||M===0||v===0)return;R.current=!0,p(!1);const j=($=0)=>{const F=y.current;if(!F){$<50?setTimeout(()=>j($+1),50):R.current=!1;return}let P=null;if(F.element)P=F.element;else if(n.current){const V=n.current.querySelector('[style*="overflow"]');V&&(V.scrollHeight>V.clientHeight||V.scrollWidth>V.clientWidth)&&(P=V)}if(!P){$<50?setTimeout(()=>j($+1),50):(R.current=!1,p(!0));return}try{P.scrollTop=S.scrollTop,P.scrollLeft=S.scrollLeft,setTimeout(()=>{const V=P.scrollTop,B=P.scrollLeft;(Math.abs(V-S.scrollTop)>10||Math.abs(B-S.scrollLeft)>10)&&$<5&&(P.scrollTop=S.scrollTop,P.scrollLeft=S.scrollLeft),setTimeout(()=>{R.current=!1,p(!0)},50)},50)}catch{$<10?setTimeout(()=>j($+1),100):R.current=!1}},A=setTimeout(()=>{j()},300);return()=>{clearTimeout(A),R.current=!1}},[b.pathname,h,w.height,M,v]),r.useEffect(()=>{let S=null,j=null;const A=($=0)=>{const F=y.current;if(!F){$<20&&setTimeout(()=>A($+1),100);return}let P=null;if(F.element)P=F.element;else if(n.current){const B=n.current.querySelector('[style*="overflow"]');B&&(B.scrollHeight>B.clientHeight||B.scrollWidth>B.clientWidth)&&(P=B)}if(!P){$<20&&setTimeout(()=>A($+1),100);return}const V=()=>{R.current||(S&&clearTimeout(S),S=setTimeout(()=>{const B=P.scrollTop,J=P.scrollLeft;(!C.current||C.current.scrollTop!==B||C.current.scrollLeft!==J)&&(dn(h,B,J),C.current={scrollTop:B,scrollLeft:J})},150))};P.addEventListener("scroll",V,{passive:!0}),j=()=>{S&&clearTimeout(S),P.removeEventListener("scroll",V)}};return A(),()=>{j&&j()}},[y.current,h,E,N,M,v]);const k=({columnIndex:S,rowIndex:j,style:A})=>{const $=j*v+S;if($>=e.length)return t.jsx("div",{style:A});const F=e[$];return t.jsx("div",{style:{...A,paddingLeft:S===0?0:Se/2,paddingRight:S===v-1?0:Se/2,paddingTop:j===0?0:Se/2,paddingBottom:j===M-1?0:Se/2},children:t.jsx(wt,{game:F,onGameClick:i,onPlay:l,onEditClick:a,onGameDelete:f,onGameUpdate:s,buildCoverUrl:m,coverSize:o,itemRefs:d,index:$,onDragStart:()=>{},onDragOver:()=>{},onDragEnd:()=>{},isDragging:!1,dragOverIndex:null,viewMode:"grid",allCollections:u,collectionId:g,onRemoveFromCollection:c})})};return w.width===0||w.height===0?t.jsx("div",{style:{width:"100%",height:"100%"}}):t.jsx("div",{style:{opacity:x?1:0,transition:x?"opacity 0.1s":"none"},children:t.jsx(rn,{gridRef:y,className:"virtualized-games-grid",columnCount:v,columnWidth:N+Se,defaultHeight:w.height,defaultWidth:w.width,rowCount:M,rowHeight:E,overscanCount:un,cellComponent:k,cellProps:{},style:{height:w.height,width:w.width},onResize:S=>{D({width:S.width,height:S.height})}})})}const fn=100;function wt({game:e,onGameClick:o,onPlay:n,onEditClick:d,onGameDelete:i,onGameUpdate:l,buildCoverUrl:a,coverSize:f,itemRefs:s,draggable:m=!1,index:u,onDragStart:g,onDragOver:c,onDragEnd:b,isDragging:w,dragOverIndex:D,viewMode:x,allCollections:p=[],collectionId:y,onRemoveFromCollection:R}){const C=f*1.5,h=r.useRef(e.cover),v=h.current!==e.cover;v&&(h.current=e.cover);const M=r.useMemo(()=>e.cover?a(H,e.cover,v):"",[e.cover,v,a]),N=j=>{m&&(j.dataTransfer.effectAllowed="move",j.dataTransfer.setData("text/html",u.toString()),g(u))},E=j=>{m&&(j.preventDefault(),j.dataTransfer.dropEffect="move",c(u))},k=()=>{m&&b()},S=D===u&&w;return t.jsx("div",{ref:j=>{j&&s?.current&&s.current.set(e.id,j)},className:`group cursor-pointer games-list-item ${m?"games-list-item-draggable":""} ${S?"games-list-item-drag-over":""}`,style:{width:`${f}px`,minWidth:`${f}px`},draggable:m,onDragStart:N,onDragOver:E,onDragEnd:k,onDragLeave:j=>{if(!m)return;const A=j.currentTarget.getBoundingClientRect(),$=j.clientX,F=j.clientY;($<A.left||$>A.right||F<A.top||F>A.bottom)&&D===u&&c(-1)},children:t.jsx(Le,{title:e.title,coverUrl:M,width:f,height:C,onPlay:n?()=>n(e):void 0,onClick:()=>o(e),onEdit:()=>d(e),gameId:e.id,gameTitle:e.title,game:e,onGameDelete:i?j=>{const A=e.id===j?e:null;A&&i(A)}:void 0,onGameUpdate:l?j=>{j.id===e.id&&l(j)}:void 0,collectionId:y,onRemoveFromCollection:R?()=>R(e.id):void 0,showTitle:!0,subtitle:e.year,detail:!0,play:!!(e.executables&&e.executables.length>0),showBorder:x!=="detail",allCollections:p},`${e.id}-${e.cover}`)})}function hn({games:e,onGameClick:o,onPlay:n,onGameUpdate:d,onGameDelete:i,buildCoverUrl:l,coverSize:a=150,itemRefs:f,draggable:s=!1,onDragEnd:m,style:u,viewMode:g,allCollections:c=[],collectionId:b,onRemoveFromCollection:w,scrollContainerRef:D,enableVirtualization:x=!0}){const{t:p}=ge(),y=Tt(),[R,C]=r.useState(null),[h,v]=r.useState(null),M=A=>{C(A)},N=A=>{R===null||R===A||v(A)},E=()=>{R!==null&&h!==null&&R!==h&&m&&m(R,h),C(null),v(null)},k=A=>{d&&d(A),y.closeEditModal()},S=x&&e.length>fn&&!s,j=r.useRef(null);return e.length===0?t.jsx("div",{className:"centered-content h-full min-h-[400px]",children:t.jsx("div",{className:"text-gray-400 text-center",children:p("table.noGames")})}):t.jsxs(t.Fragment,{children:[t.jsx("div",{ref:j,className:"games-list-container",style:{gridTemplateColumns:S?void 0:`repeat(auto-fill, ${a}px)`,height:S?"100%":void 0,...u},children:S?t.jsx(mn,{games:e,coverSize:a,containerRef:D||j,itemRefs:f,onGameClick:o,onPlay:n,onEditClick:y.openEditModal,onGameDelete:i,onGameUpdate:d,buildCoverUrl:l,allCollections:c,collectionId:b,onRemoveFromCollection:w}):e.map((A,$)=>t.jsx(wt,{game:A,onGameClick:o,onPlay:n,onEditClick:y.openEditModal,onGameDelete:i,onGameUpdate:d,buildCoverUrl:l,coverSize:a,itemRefs:f,draggable:s,index:$,onDragStart:M,onDragOver:N,onDragEnd:E,isDragging:R!==null,dragOverIndex:h,viewMode:g,allCollections:c,collectionId:b,onRemoveFromCollection:w},A.id))}),y.selectedGame&&Ae&&t.jsx(Bt,{isOpen:y.isEditModalOpen,onClose:y.closeEditModal,game:y.selectedGame,onGameUpdate:k})]})}function tt(e){try{const o=sessionStorage.getItem(e);return o?parseInt(o,10):0}catch{return 0}}function nt(e,o){try{sessionStorage.setItem(e,o.toString())}catch{}}function gn(e,o){const n=st(),d=r.useRef(!1),i=o?`${n.pathname}:${o}`:n.pathname;r.useLayoutEffect(()=>{if(!e.current){const m=setTimeout(()=>{const u=e.current;if(u){const g=tt(i);g>0&&(u.scrollTop=g)}},200);return()=>clearTimeout(m)}d.current=!0;const a=tt(i);if(a<=0){d.current=!1;return}const f=(m=0)=>{const u=e.current;if(!u){m<30?setTimeout(()=>f(m+1),50):d.current=!1;return}const c=o==="table"?u.querySelector("tbody tr"):!0;if(!(u.scrollHeight>u.clientHeight)||!c){m<100?m<20?requestAnimationFrame(()=>f(m+1)):setTimeout(()=>f(m+1),50):d.current=!1;return}u.scrollTop=a,m<10?setTimeout(()=>{const w=u.scrollTop;Math.abs(w-a)>10?(u.scrollTop=a,f(m+1)):d.current=!1},100):d.current=!1},s=setTimeout(()=>{f()},150);return()=>{clearTimeout(s),d.current=!1}},[n.pathname,i,e,o]),r.useEffect(()=>{const l=e.current;if(!l)return;const a=()=>{if(d.current)return;const f=l.scrollTop;f>0&&nt(i,f)};return l.addEventListener("scroll",a,{passive:!0}),()=>{l.removeEventListener("scroll",a);const f=l.scrollTop;f>0&&!d.current&&nt(i,f)}},[n.pathname,i,e,o])}function pn({setGames:e,enabledEvents:o=["gameUpdated","gameDeleted","gameAdded"]}){const n=r.useRef(o);n.current=o,r.useEffect(()=>{const d=[];if(n.current.includes("gameUpdated")){const i=l=>{const f=l.detail?.game;f&&e(s=>s.map(m=>String(m.id)===String(f.id)?f:m))};window.addEventListener("gameUpdated",i),d.push({event:"gameUpdated",handler:i})}if(n.current.includes("gameDeleted")){const i=l=>{const f=l.detail?.gameId;f&&e(s=>s.filter(m=>String(m.id)!==String(f)))};window.addEventListener("gameDeleted",i),d.push({event:"gameDeleted",handler:i})}if(n.current.includes("gameAdded")){const i=l=>{const f=l.detail?.game;f&&e(s=>{const m={...f,id:String(f.id)},u=s.findIndex(g=>String(g.id)===String(m.id));if(u>=0){const g=[...s];return g[u]=m,g}else return[...s,m]})};window.addEventListener("gameAdded",i),d.push({event:"gameAdded",handler:i})}return()=>{d.forEach(({event:i,handler:l})=>{window.removeEventListener(i,l)})}},[e])}function ot(e){return e?e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/g,"").trim():""}function vn(e,o){const n=ot(e||""),d=ot(o||"");return n.localeCompare(d)}function Rn({onGameClick:e,onGamesLoaded:o,onPlay:n,allCollections:d=[]}){const{t:i}=ge(),{setLoading:l,isLoading:a}=ve(),{collections:f}=Oe(),{collectionId:s}=jt(),[m,u]=r.useState(null),[g,c]=r.useState([]),[b,w]=r.useState(!1),[D]=r.useState("grid"),[x,p]=r.useState(()=>{const I=localStorage.getItem("coverSize");return I?parseInt(I,10):150}),[y,R]=r.useState(null),[C,h]=r.useState(!1),v=r.useRef(null),M=r.useRef(new Map),N=r.useRef(!1),E=r.useRef(void 0);gn(v);const k=I=>{p(I),localStorage.setItem("coverSize",I.toString())};r.useEffect(()=>{if(s&&s!==E.current){E.current=s,N.current=!1;const I=f.find(U=>String(U.id)===String(s));I?u({id:String(I.id),title:I.title,summary:I.summary,cover:I.cover,background:I.background}):S(s),N.current||j(s)}},[s]),r.useEffect(()=>{if(s&&!m){const I=f.find(U=>String(U.id)===String(s));I&&u({id:String(I.id),title:I.title,summary:I.summary,cover:I.cover,background:I.background})}},[f,s,m]),pn({setGames:c,enabledEvents:["gameUpdated","gameDeleted"]}),r.useLayoutEffect(()=>{!a&&m?requestAnimationFrame(()=>{requestAnimationFrame(()=>{w(!0)})}):a&&w(!1)},[a,m,g.length]);async function S(I){try{const U=_(H,`/collections/${I}`),O=await fetch(U,{headers:{Accept:"application/json","X-Auth-Token":se()}});if(O.ok){const L=await O.json();u({id:String(L.id),title:L.title,summary:L.summary,cover:L.cover,background:L.background});return}const T=f.find(L=>String(L.id)===String(I));T&&u({id:String(T.id),title:T.title,summary:T.summary,cover:T.cover,background:T.background})}catch(U){const O=String(U.message||U);console.error("Error fetching collection info:",O)}}async function j(I){if(!N.current){N.current=!0,l(!0);try{const U=_(H,`/collections/${I}/games`),O=await fetch(U,{headers:{Accept:"application/json","X-Auth-Token":se()}});if(!O.ok)throw new Error(`HTTP ${O.status}`);const Q=((await O.json()).games||[]).map(z=>({id:z.id,title:z.title,summary:z.summary,cover:z.cover,background:z.background,day:z.day,month:z.month,year:z.year,stars:z.stars,executables:z.executables||null,themes:z.themes||null,platforms:z.platforms||null,gameModes:z.gameModes||null,playerPerspectives:z.playerPerspectives||null,websites:z.websites||null,ageRatings:z.ageRatings||null,developers:z.developers||null,publishers:z.publishers||null,franchise:z.franchise||null,collection:z.collection||null,screenshots:z.screenshots||null,videos:z.videos||null,gameEngines:z.gameEngines||null,keywords:z.keywords||null,alternativeNames:z.alternativeNames||null,similarGames:z.similarGames||null})),W=[...Q].sort((z,fe)=>{const ie=z.year??0,pe=fe.year??0;return ie!==0&&pe!==0?ie-pe:ie!==0&&pe===0?-1:ie===0&&pe!==0?1:0}),re=Q.map(z=>z.id),K=W.map(z=>z.id),X=re.length===K.length&&re.every((z,fe)=>z===K[fe]);R(X?null:re),c(Q),o(Q)}catch(U){const O=String(U.message||U);console.error("Error fetching collection games:",O)}finally{l(!1),N.current=!1}}}const A=r.useMemo(()=>{if(y&&y.length===g.length){const U=new Map(g.map(O=>[O.id,O]));return y.map(O=>U.get(O)).filter(Boolean)}const I=[...g];return I.sort((U,O)=>{const T=U.year??0,L=O.year??0;return T!==0&&L!==0?T-L:T!==0&&L===0?-1:T===0&&L!==0?1:vn(U.title||"",O.title||"")}),I},[g,y]),$=I=>{c(U=>U.map(O=>O.id===I.id?I:O)),window.dispatchEvent(new CustomEvent("gameUpdated",{detail:{game:I}})),s&&j(s)},F=I=>{c(U=>U.filter(O=>String(O.id)!==String(I.id)))},P=I=>{c(U=>U.filter(O=>String(O.id)!==String(I)))},V=async(I,U)=>{if(I===U)return;const O=[...A],[T]=O.splice(I,1);O.splice(U,0,T);const L=O.map(Q=>Q.id);if(R(L),c(O),s)try{const Q=_(H,`/collections/${s}/games/order`),W=await fetch(Q,{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":se()},body:JSON.stringify({gameIds:L})});if(!W.ok)throw new Error(`HTTP ${W.status}`)}catch(Q){const W=String(Q.message||Q);console.error("Error saving collection order:",W),R(null),j(s)}},B=r.useMemo(()=>{const I=g.map(T=>T.year).filter(T=>T!=null);if(I.length===0)return null;const U=Math.min(...I),O=Math.max(...I);return U===O?U.toString():`${U} - ${O}`},[g]),J=r.useMemo(()=>{const I=g.map(T=>T.stars).filter(T=>T!=null);return I.length===0?null:I.reduce((T,L)=>T+L,0)/I.length/10*5},[g]);if(!s)return t.jsx("div",{className:"bg-[#1a1a1a] text-white flex items-center justify-center",style:{width:"100%",height:"100%"},children:t.jsx("div",{className:"text-center",children:t.jsx("div",{className:"text-gray-400",children:"Collection not found"})})});const me=m?.cover?Qe(H,m.cover,!0):"",ae=240,ue=360,ne=Et(H,m?.background),le=!!(ne&&ne.trim()!=="");return t.jsx(Gt,{backgroundUrl:ne,hasBackground:le,elementId:s||"",children:t.jsx(wn,{collection:m,collectionCoverUrl:me,collectionCoverWidth:ae,collectionCoverHeight:ue,yearRange:B,averageRating:J,onPlay:n,sortedGames:A,onGameClick:e,onGameUpdate:$,onGameDelete:F,buildCoverUrl:(I,U,O)=>Qe(I,U,O??!1),coverSize:x,handleCoverSizeChange:k,viewMode:D,itemRefs:M,handleDragEnd:V,scrollContainerRef:v,isReady:b,isEditModalOpen:C,onEditModalOpen:()=>h(!0),onEditModalClose:()=>h(!1),onCollectionUpdate:I=>{u(I)},t:i,allCollections:d,collectionId:s,onRemoveFromCollection:P})})}function wn({collection:e,collectionCoverUrl:o,collectionCoverWidth:n,collectionCoverHeight:d,yearRange:i,averageRating:l,onPlay:a,sortedGames:f,onGameClick:s,onGameUpdate:m,onGameDelete:u,buildCoverUrl:g,coverSize:c,handleCoverSizeChange:b,viewMode:w,itemRefs:D,handleDragEnd:x,scrollContainerRef:p,isReady:y,isEditModalOpen:R,onEditModalOpen:C,onEditModalClose:h,onCollectionUpdate:v,t:M,allCollections:N=[],collectionId:E,onRemoveFromCollection:k}){const{hasBackground:S,isBackgroundVisible:j}=mt(),{isLoading:A}=ve(),F=(()=>{let P=1;return i&&P++,l!==null&&P++,(a&&f.length>0||e)&&P++,Math.max(2,Math.min(6,7-P))})();return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:S&&j?"game-detail-libraries-bar-transparent":"",style:{position:"relative",zIndex:1e3,pointerEvents:"auto"},children:t.jsx(Jt,{libraries:[],activeLibrary:{key:"collection",type:"collection"},onSelectLibrary:()=>{},loading:!1,error:null,coverSize:c,onCoverSizeChange:b,viewMode:w,onViewModeChange:()=>{}})}),t.jsx("div",{style:{position:"relative",zIndex:2,height:"100vh",display:"flex",flexDirection:"column"},children:t.jsx("div",{className:"home-page-main-container",style:{backgroundColor:"transparent",position:"relative",flex:1,overflow:"hidden",display:"flex",flexDirection:"column",minHeight:0},children:t.jsx("main",{className:"flex-1 home-page-content",style:{minHeight:0},children:t.jsx("div",{className:"home-page-layout",style:{minHeight:0},children:t.jsx("div",{className:"home-page-content-wrapper",style:{opacity:y?1:0,transition:"opacity 0.2s ease-in-out",minHeight:0},children:t.jsxs("div",{ref:p,className:"home-page-scroll-container",style:{paddingLeft:"64px",paddingRight:"64px",paddingTop:"5px",paddingBottom:"32px"},children:[e&&t.jsxs("div",{className:"pt-8",style:{display:"flex",flexDirection:"row",gap:"48px",alignItems:"flex-start",width:"100%",boxSizing:"border-box",marginBottom:"32px"},children:[t.jsx("div",{style:{flexShrink:0},children:t.jsx(Le,{title:e.title,coverUrl:o,width:n,height:d,onPlay:a&&f.length>0?()=>{const P=f.find(V=>V.executables&&V.executables.length>0);P&&a(P)}:void 0,showTitle:!1,detail:!1,play:f.some(P=>P.executables&&P.executables.length>0),showBorder:!0})}),t.jsx("div",{style:{flex:1,display:"flex",flexDirection:"column",justifyContent:"flex-start",gap:"16px",minHeight:`${d}px`,minWidth:0,visibility:"visible"},children:t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"8px",visibility:"visible"},children:[t.jsx("h1",{className:"text-white",style:{visibility:"visible",display:"block",fontFamily:"var(--font-heading-1-font-family)",fontSize:"var(--font-heading-1-font-size)",lineHeight:"var(--font-heading-1-line-height)"},children:e.title}),i&&t.jsx("div",{className:"text-white",style:{opacity:.8,fontFamily:"var(--font-body-2-font-family)",fontSize:"var(--font-body-2-font-size)",lineHeight:"var(--font-body-2-line-height)"},children:i}),l!==null&&t.jsx(Wt,{rating:l}),a&&f.length>0||e?t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",marginTop:"16px"},children:[a&&f.length>0&&f.some(P=>P.executables&&P.executables.length>0)&&t.jsxs("button",{onClick:()=>{const P=f.find(V=>V.executables&&V.executables.length>0);P&&a(P)},style:{backgroundColor:"#E5A00D",color:"#000000",border:"none",borderRadius:"4px",paddingTop:"6px",paddingBottom:"6px",paddingLeft:"8px",paddingRight:"12px",fontSize:"1.25rem",fontWeight:600,cursor:"pointer",transition:"background-color 0.2s ease",width:"fit-content",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px",lineHeight:"1.2"},onMouseEnter:P=>{P.currentTarget.style.backgroundColor="#F5B041"},onMouseLeave:P=>{P.currentTarget.style.backgroundColor="#E5A00D"},children:[t.jsx("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"currentColor",style:{display:"block"},children:t.jsx("path",{d:"M8 5v14l11-7z"})}),M("common.play")]}),e&&t.jsx(Xe,{text:M("common.edit"),delay:200,children:t.jsx("button",{onClick:C,className:"collection-detail-edit-button",children:t.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),t.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]})})}),e&&t.jsx(qe,{collectionId:e.id,collectionTitle:e.title,onCollectionDelete:P=>{e.id===P&&window.history.back()},onCollectionUpdate:v,horizontal:!0,className:"collection-detail-dropdown-menu",toolTipDelay:200})]}):null,e&&t.jsx(Ut,{isOpen:R,onClose:h,collection:e,onCollectionUpdate:v}),e.summary&&t.jsx(Ht,{summary:e.summary,maxLines:F})]})})]}),!A&&t.jsxs("div",{style:{width:"100%"},children:[t.jsx("div",{style:{paddingLeft:"0",marginBottom:"32px",marginTop:"8px"},children:t.jsxs("h2",{className:"text-white",style:{fontFamily:"var(--font-heading-2-font-family)",fontSize:"var(--font-heading-2-font-size)",lineHeight:"var(--font-heading-2-line-height)",fontWeight:600},children:[f.length," ",M("common.games")]})}),t.jsx("style",{children:`
                  .collection-detail-games-list .games-list-container {
                    justify-content: flex-start !important;
                  }
                `}),t.jsx("div",{className:"collection-detail-games-list",children:t.jsx(hn,{games:f,onGameClick:s,onPlay:a,onGameUpdate:m,onGameDelete:u,buildCoverUrl:(P,V,B)=>g(P,V,B??!1),coverSize:c,itemRefs:D,draggable:!0,onDragEnd:x,allCollections:N,collectionId:E,onRemoveFromCollection:k})})]})]})})})})})})]})}export{Dn as A,Gt as B,Le as C,qe as D,rn as E,hn as G,Jt as L,Ht as S,Xe as T,Be as a,_ as b,Oe as c,Ut as d,ve as e,gn as f,vn as g,Qe as h,Sn as i,mt as j,Ft as k,pn as l,Tt as m,Bt as n,Wt as o,$t as p,Pt as q,jn as r,Et as s,Rn as t,at as u,En as v,Cn as w,Nn as x,Tn as y};
